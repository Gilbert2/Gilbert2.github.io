<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width, initial-scale=1, maximum-scale=2"><meta name=theme-color content=#222><meta name=generator content="Hexo 4.2.0"><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-next.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32-next.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16-next.png><link rel=mask-icon href=/images/logo.svg color=#222><meta name=msvalidate.01 content=true><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><link rel=stylesheet href=//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css><script id=hexo-configurations>
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pdxblog.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"b2t":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":{"enable":true,"onlypost":false,"loadingImg":null},"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script><meta name=description content=MySQL><meta property=og:type content=article><meta property=og:title content=XtraBacup备份与恢复><meta property=og:url content=https://pdxblog.top/XtraBacup%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.html><meta property=og:site_name content=Maisyの博客><meta property=og:description content=MySQL><meta property=og:locale content=zh_CN><meta property=og:image content="https://img-blog.csdnimg.cn/20200711173552112.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=article:published_time content=2020-07-10T16:00:00.000Z><meta property=article:modified_time content=2020-07-11T11:38:11.008Z><meta property=article:author content=Maisy><meta property=article:tag content=MySQL><meta name=twitter:card content=summary><meta name=twitter:image content="https://img-blog.csdnimg.cn/20200711173552112.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><link rel=canonical href=https://pdxblog.top/XtraBacup%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.html><script id=page-configurations>
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script><title>XtraBacup备份与恢复 | Maisyの博客</title><noscript><style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style></noscript><link rel=alternate href=/atom.xml title=Maisyの博客 type=application/atom+xml></head><body itemscope itemtype=http://schema.org/WebPage><div class="container use-motion"><div class=headband></div><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class=site-meta><a href="/" class=brand rel=start><span class=logo-line-before><i></i></span><h1 class=site-title>Maisyの博客</h1><span class=logo-line-after><i></i></span></a><p class=site-subtitle itemprop=description>记录生活中的点点滴滴</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul id=menu class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel=section><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-top"><a href="/top/" rel=section><i class="fa fa-signal fa-fw"></i>排行榜</a></li><li class="menu-item menu-item-about"><a href="/about/" rel=section><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel=section><i class="fa fa-tags fa-fw"></i>标签<span class=badge>7</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel=section><i class="fa fa-th fa-fw"></i>分类<span class=badge>7</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel=section><i class="fa fa-archive fa-fw"></i>归档<span class=badge>69</span></a></li></ul></nav></div></header><div class=back-to-top><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class=main><div class=main-inner><div class=content-wrap><div class="content post posts-expand"><article itemscope itemtype=http://schema.org/Article class=post-block lang=zh-CN><link itemprop=mainEntityOfPage href=https://pdxblog.top/XtraBacup%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/author.jpg><meta itemprop=name content=Maisy><meta itemprop=description content=人的一生就是一个储蓄的过程，在奋斗的时候储存了希望；在耕耘的时候储存了一粒种子；在旅行的时候储存了风景；在微笑的时候储存了快乐。聪明的人善于储蓄，在漫长而短暂的人生旅途中，学会储蓄每一个闪光的瞬间，然后用它们酿成一杯美好的回忆，在四季的变幻与交替之间，散发浓香，珍藏一生></span> <span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content=Maisyの博客></span><header class=post-header><h1 class=post-title itemprop="name headline">XtraBacup备份与恢复</h1><div class=post-meta><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span> <span class=post-meta-item-text>发表于</span><time title="创建时间：2020-07-11 00:00:00 / 修改时间：19:38:11" itemprop="dateCreated datePublished" datetime=2020-07-11T00:00:00+08:00>2020-07-11</time></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder"></i></span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href="/categories/MySQL/" itemprop=url rel=index><span itemprop=name>MySQL</span></a></span></span><br><span class=post-meta-item title=本文字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span> <span class=post-meta-item-text>本文字数：</span> <span>15k</span></span> <span class=post-meta-item title=阅读时长><span class=post-meta-item-icon><i class="far fa-clock"></i></span> <span class=post-meta-item-text>阅读时长 &asymp;</span> <span>14 分钟</span></span><div class=post-description>MySQL</div></div></header><div class=post-body itemprop=articleBody><h2 id=XtraBacup备份与恢复><a class=header-anchor href=#XtraBacup备份与恢复>¶</a>XtraBacup备份与恢复</h2><h3 id=一、XtraBacup简介><a class=header-anchor href=#一、XtraBacup简介>¶</a>一、XtraBacup简介</h3><p>MySQL冷备、mysqldump、MySQL热拷贝都无法实现对数据库进行增量备份。在实际生产环境中增量备份是非常实用的，如果数据大于50G或100G，存储空间足够的情况下，可以每天进行完整备份，如果每天产生的数据量较大，需要定制数据备份策略。例如每周实用完整备份，周一到周六实用增量备份。而Percona-Xtrabackup就是为了实现增量备份而出现的一款主流备份工具，XtraBacup有2个工具，分别是xtrabakup、innobakupe。</p><p>Percona-xtrabackup是 Percona公司开发的一个用于MySQL数据库物理热备的备份工具，支持MySQL、Percona server和MariaDB，开源免费，是目前较为受欢迎的主流备份工具。xtrabackup只能备份innoDB和xtraDB两种数据引擎的表，而不能备份MyISAM数据表。</p><h3 id=二、XtraBacup优点><a class=header-anchor href=#二、XtraBacup优点>¶</a>二、XtraBacup优点</h3><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>（1）备份速度快，物理备份可靠</span><br><span class=line>（2）备份过程不会打断正在执行的事务（无需锁表）</span><br><span class=line>（3）能够基于压缩等功能节约磁盘空间和流量</span><br><span class=line>（4）自动备份校验</span><br><span class=line>（5）还原速度快</span><br><span class=line>（6）可以流传将备份传输到另外一台机器上</span><br><span class=line>（7）在不增加服务器负载的情况备份数据</span><br></pre></td></tr></table></figure><h3 id=三、Xtrabackup备份原理><a class=header-anchor href=#三、Xtrabackup备份原理>¶</a>三、Xtrabackup备份原理</h3><h4 id=1、Xtrabackup备份流程图><a class=header-anchor href=#1、Xtrabackup备份流程图>¶</a>1、Xtrabackup备份流程图</h4><p><img data-src="https://img-blog.csdnimg.cn/20200711173552112.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line>（1）innobackupex启动后，会先fork一个进程，用于启动xtrabackup，然后等待xtrabackup备份ibd数据文件；</span><br><span class=line>（2）xtrabackup在备份innoDB数据是，有2种线程：redo拷贝线程和ibd数据拷贝线程。xtrabackup进程开始执行后，会启动一个redo拷贝的线程，用于从最新的checkpoint点开始顺序拷贝redo.log；再启动ibd数据拷贝线程，进行拷贝ibd数据。这里是先启动redo拷贝线程的。在此阶段，innobackupex进行处于等待状态（等待文件被创建）</span><br><span class=line>（3）xtrabackup拷贝完成ibd数据文件后，会通知innobackupex（通过创建文件），同时xtrabackup进入等待状态（redo线程依旧在拷贝redo.log）</span><br><span class=line>（4）innobackupex收到xtrabackup通知后哦，执行FLUSH TABLES WITH READ LOCK（FTWRL），取得一致性位点，然后开始备份非InnoDB文件（如frm、MYD、MYI、CSV、opt、par等格式的文件），在拷贝非InnoDB文件的过程当中，数据库处于全局只读状态。</span><br><span class=line>（5）当innobackup拷贝完所有的非InnoDB文件后，会通知xtrabackup，通知完成后，进入等待状态；</span><br><span class=line>（6）xtrabackup收到innobackupex备份完成的通知后，会停止redo拷贝线程，然后通知innobackupex，redo.log文件拷贝完成；</span><br><span class=line>（7）innobackupex收到redo.log备份完成后，就进行解锁操作，执行：UNLOCK TABLES；</span><br><span class=line>（8）最后innbackupex和xtrabackup进程各自释放资源，写备份元数据信息等，innobackupex等xtrabackup子进程结束后退出。</span><br></pre></td></tr></table></figure><h4 id=2、XtraBackup的备份原理><a class=header-anchor href=#2、XtraBackup的备份原理>¶</a>2、XtraBackup的备份原理</h4><p>在InnoDB内部会维护一个redo日志文件，我们也可以叫做事务日志文件（transaction log，事务日志）。事务日志会存储每一个InnoDB表数据的记录修改。当InnoDB启动时，InnoDB会检查数据文件和事务日志，并执行两个步骤：它应用已经提交的事务日志到数据文件，并将修改过但没有提交的数据进行回滚操作。 XtraBacup在启动时会记住log sequence number（LSN），并且复制所有的数据文件。复制过程需要一些时间，所以这期间如果数据文件有改动，那么将会使数据库处于一个不同的时间点。这时，XtraBacup会运行一个后台进程，用于监视事务日志，并从事务日志复制最新的修改。XtraBacup必须持续的做这个操作，是因为事务日志是会轮转重复的写入，并且事务日志可以被重用。所以XtraBacup自启动开始，就不停的将事务日志中每个数据文件的修改都记录下来。这就是XtraBacup的备份过程。</p><h4 id=3、XtraBackup命令行工具><a class=header-anchor href=#3、XtraBackup命令行工具>¶</a>3、XtraBackup命令行工具</h4><p>XtraBackup中主要包含两个命令行工具：</p><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>（1）xtrabackup：专用于备份InnoDB和XtraDB引擎的数据，不能备份其他类型的表，也不能备份数据表结构；</span><br><span class=line>（2）innobackupex：这是一个perl脚本，在执行过程中会调用xtrabackup命令，这样用该命令既可以实现备份InnoDB，也可以备份MyISAM引擎的对象。</span><br></pre></td></tr></table></figure><p>常用选项:</p><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line>--host     指定主机</span><br><span class=line>--user     指定用户名</span><br><span class=line>--password    指定密码</span><br><span class=line>--port     指定端口</span><br><span class=line>--databases     指定数据库</span><br><span class=line></span><br><span class=line>--incremental    创建增量备份</span><br><span class=line>--incremental-basedir   指定包含完全备份的目录</span><br><span class=line>--incremental-dir      指定包含增量备份的目录 </span><br><span class=line></span><br><span class=line>--apply-log        对备份进行预处理操作             </span><br><span class=line>    一般情况下，在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处理不一致状态。“准备”的主要作用正是通过回滚未提交的事务及同步已经提交的事务至数据文件也使得数据文件处于一致性状态。</span><br><span class=line>--redo-only      不回滚未提交事务</span><br><span class=line>--copy-back     恢复备份目录</span><br></pre></td></tr></table></figure><p>使用innobackupex备份时，其会调用xtrabackup备份所有的InnoDB表，复制所有关于表结构定义的相关文件(.frm)、以及MyISAM、MERGE、CSV和ARCHIVE表的相关文件，同时还会备份触发器和数据库配置信息相关的文件，这些文件会被保存到一个以时间命名的目录当中。在备份的同时，innobackupex还会在备份目录中创建如下文件：</p><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>(1)xtrabackup_checkpoints -- 备份类型(如完全或增量)、备份状态(如是否已经为prepared状态)和LSN(日志序列号)范围信息：</span><br><span class=line>每个InnoDB页(通常为16k大小)都会包含一个日志序列号，即LSN，LSN是整个数据库系统的系统版本号，每个页面相关的LSN能够表明此页面最近是如何发生改变的。</span><br><span class=line>(2)xtrabackup_binlog_info  --  mysql服务器当前正在使用的二进制日志文件及备份这一刻位置二进制日志时间的位置。</span><br><span class=line>(3)xtrabackup_binlog_pos_innodb  --  二进制日志文件及用于InnoDB或XtraDB表的二进制日志文件的当前position。</span><br><span class=line>(4)xtrabackup_binary  --  备份中用到的xtrabackup的可执行文件；</span><br><span class=line>(5)backup-my.cnf  --  备份命令用到的配置选项信息：</span><br><span class=line>在使用innobackupex进行备份时，还可以使用--no-timestamp选项来阻止命令自动创建一个以时间命名的目录：如此一来，innobackupex命令将会创建一个BACKUP-DIR目录来存储备份数据。</span><br></pre></td></tr></table></figure><p>如果要使用一个最小权限的用户进行备份，则可基于如下命令创建此类用户：如果要使用一个最小权限的用户进行备份，则可基于如下命令创建此类用户：</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line># 创建用户</span><br><span class=line>mysql&gt; CREATE USER &#39;bkpuser&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;123456&#39;;</span><br><span class=line># 回收此用户所有权限</span><br><span class=line>mysql&gt; REVOKE ALL PRIVILEGES,GRANT OPTION FROM &#39;bkpuser&#39;;</span><br><span class=line># 授权刷新、锁定表、用户查看服务器状态</span><br><span class=line>mysql&gt; GRANT RELOAD,LOCK TABLES,RELICATION CLIENT ON *.* TO &#39;bkpuser&#39;@&#39;localhost&#39;;</span><br><span class=line># 刷新授权表</span><br><span class=line>mysql&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><blockquote><p>注意：备份时需启动MySQL,恢复时需关闭MySQL,清空mysql数据目录且不能重新初始化，恢复数据后应该立即进行一次完全备份。</p></blockquote><h3 id=四、XtraBackup安装><a class=header-anchor href=#四、XtraBackup安装>¶</a>四、XtraBackup安装</h3><p>下载地址：</p><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>https://www.percona.com/downloads/Percona-XtraBackup-2.4/LATEST/</span><br></pre></td></tr></table></figure><p>可以选择rpm包方式安装，也可以下载源码包编译安装，这里直接采用rpm包的方式进行安装。</p><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># yum install -y percona-xtrabackup-24-2.4.9-1.el7.x86_64.rpm</span></span><br><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># rpm -qa |grep xtrabackup</span></span><br><span class=line>percona<span class=literal>-xtrabackup</span><span class=literal>-24</span><span class=literal>-2</span>.<span class=number>4.9</span><span class=literal>-1</span>.el7.x86_64</span><br></pre></td></tr></table></figure><h3 id=五、XtraBackup完全备份与恢复><a class=header-anchor href=#五、XtraBackup完全备份与恢复>¶</a>五、XtraBackup完全备份与恢复</h3><p>命令行语法格式：</p><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>备份：</span><br><span class=line>innobackupex --user=DBUSER --password=DBUSERPASS --defaults-file=/etc/my.cnf /path/to/BACKUP-DIR/</span><br><span class=line></span><br><span class=line>恢复：</span><br><span class=line>innobackupex --apply-log /backups/2018-07-30_11-04-55/</span><br><span class=line>innobackupex --copy-back --defaults-file=/etc/my.cnf  /backups/2018-07-30_11-04-55/</span><br></pre></td></tr></table></figure><h4 id=1、准备-prepare-一个完全备份><a class=header-anchor href=#1、准备-prepare-一个完全备份>¶</a>1、准备(prepare)一个完全备份</h4><p>一般情况下，在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或者已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处于不一致状态。&quot;准备&quot;的主要作用正是通过回滚未提交的事务及同步已经提交的事务至数据文件也使用得数据文件处于一致性状态。</p><p>innobackupex命令的–apply-log选项可用于实现上述功能，如下面的命令：</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line># innobackupex --apply-log &#x2F;path&#x2F;to&#x2F;BACKUP-DIR</span><br><span class=line>如果执行正确，其最后输出的几行信息通常如下：</span><br><span class=line></span><br><span class=line>120407 09:01:04 innobackupex: completed OK!</span><br></pre></td></tr></table></figure><p>在实现&quot;准备&quot;的过程中，innobackupex通常还可以使用–user-memory选项来指定其可以使用的内存的大小，默认为100M。如果有足够的内存空间可用，可以多划分一些内存给prepare的过程，以提高其完成备份的速度。</p><h4 id=2、从一个完全备份中恢复数据><a class=header-anchor href=#2、从一个完全备份中恢复数据>¶</a>2、从一个完全备份中恢复数据</h4><p>注意：恢复不用启动MySQL</p><p>innobackupex命令的–copy-back选项用于恢复操作，其通过复制所有数据相关的文件至mysql服务器DATADIR目录中来执行恢复过程。innobackupex通过backup-my.cnf来获取DATADIR目录的相关信息。</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line># innobackupex --copy-back &#x2F;path&#x2F;to&#x2F;BACKUP-DIR</span><br></pre></td></tr></table></figure><p>当数据恢复至DATADIR目录以后，还需要确保所有的数据文件的属主和属组均为正确的用户，如mysql，否则，在启动mysqld之前还需要事先修改数据文件的属主和属组。如：</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line># chown -R mysql.mysql &#x2F;mydata&#x2F;data&#x2F;</span><br></pre></td></tr></table></figure><h4 id=3、实战练习><a class=header-anchor href=#3、实战练习>¶</a>3、实战练习</h4><h5 id=（1）准备测试环境><a class=header-anchor href=#（1）准备测试环境>¶</a>（1）准备测试环境</h5><p>测试环境准备 创建一个测试数据库，并创建一张表输入几行数据：</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; create database test2;</span><br><span class=line>Query OK, 1 row affected (0.00 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; use test2;</span><br><span class=line>Database changed</span><br><span class=line>mysql&gt; create table yy(id int,name varchar(20));</span><br><span class=line>Query OK, 0 rows affected (0.08 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; insert into yy values(1,&#39;tomcat1&#39;);</span><br><span class=line>Query OK, 1 row affected (0.00 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; insert into yy values(2,&#39;tomcat2&#39;);</span><br><span class=line>Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure><h5 id=（2）全量备份><a class=header-anchor href=#（2）全量备份>¶</a>（2）全量备份</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre></td><td class=code><pre><span class=line>[root@192 ~]# innobackupex --user&#x3D;root --password&#x3D;1234 --host&#x3D;127.0.0.1 &#x2F;backups&#x2F;</span><br><span class=line>200628 16:31:18 innobackupex: Starting the backup operation</span><br><span class=line></span><br><span class=line>IMPORTANT: Please check that the backup run completes successfully.</span><br><span class=line>           At the end of a successful backup run innobackupex</span><br><span class=line>           prints &quot;completed OK!&quot;.</span><br><span class=line></span><br><span class=line>200628 16:31:18  version_check Connecting to MySQL server with DSN &#39;dbi:mysql:;mysql_read_default_group&#x3D;xtrabackup;host&#x3D;127.0.0.1&#39; as &#39;root&#39;  (using password: YES).</span><br><span class=line>200628 16:31:18  version_check Connected to MySQL server</span><br><span class=line></span><br><span class=line># 省略部分输出信息</span><br><span class=line></span><br><span class=line>200628 16:31:21 [00] Writing &#x2F;backups&#x2F;2020-06-28_16-31-18&#x2F;backup-my.cnf</span><br><span class=line>200628 16:31:21 [00]        ...done</span><br><span class=line>200628 16:31:21 [00] Writing &#x2F;backups&#x2F;2020-06-28_16-31-18&#x2F;xtrabackup_info</span><br><span class=line>200628 16:31:21 [00]        ...done</span><br><span class=line>xtrabackup: Transaction log of lsn (2637610) to (2637619) was copied.</span><br><span class=line>200628 16:31:21 completed OK!</span><br></pre></td></tr></table></figure><h5 id=（3）查看完全备份文件><a class=header-anchor href=#（3）查看完全备份文件>¶</a>（3）查看完全备份文件</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre></td><td class=code><pre><span class=line>[root@192 ~]# ll &#x2F;backups&#x2F;</span><br><span class=line>总用量 0</span><br><span class=line>drwxr-x---. 6 root root 206 6月  28 16:31 2020-06-28_16-31-18</span><br><span class=line>[root@192 ~]# ll &#x2F;backups&#x2F;2020-06-28_16-31-18&#x2F;</span><br><span class=line>总用量 12336</span><br><span class=line>-rw-r-----. 1 root root      424 6月  28 16:31 backup-my.cnf</span><br><span class=line>-rw-r-----. 1 root root      425 6月  28 16:31 ib_buffer_pool</span><br><span class=line>-rw-r-----. 1 root root 12582912 6月  28 16:31 ibdata1</span><br><span class=line>drwxr-x---. 2 root root     4096 6月  28 16:31 mysql</span><br><span class=line>drwxr-x---. 2 root root     8192 6月  28 16:31 performance_schema</span><br><span class=line>drwxr-x---. 2 root root     8192 6月  28 16:31 sys</span><br><span class=line>drwxr-x---. 2 root root       48 6月  28 16:31 test2</span><br><span class=line>-rw-r-----. 1 root root      113 6月  28 16:31 xtrabackup_checkpoints</span><br><span class=line>-rw-r-----. 1 root root      435 6月  28 16:31 xtrabackup_info</span><br><span class=line>-rw-r-----. 1 root root     2560 6月  28 16:31 xtrabackup_logfile</span><br></pre></td></tr></table></figure><h5 id=（4）模拟完全恢复><a class=header-anchor href=#（4）模拟完全恢复>¶</a>（4）模拟完全恢复</h5><h6 id=1）完全备份><a class=header-anchor href=#1）完全备份>¶</a>1）完全备份</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># innobackupex --user=root --password=1234 /backups/</span></span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>43</span>:<span class=number>32</span> innobackupex: Starting the backup operation</span><br><span class=line></span><br><span class=line>IMPORTANT: Please check that the backup run completes successfully.</span><br><span class=line>           At the <span class=keyword>end</span> of a successful backup run innobackupex</span><br><span class=line>           prints <span class=string>"completed OK!"</span>.</span><br><span class=line></span><br><span class=line><span class=comment># 省略部分输出信息</span></span><br><span class=line></span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>43</span>:<span class=number>34</span> [<span class=number>00</span>] Writing /backups/<span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_20</span><span class=literal>-43</span><span class=literal>-32</span>/xtrabackup_info</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>43</span>:<span class=number>34</span> [<span class=number>00</span>]        ...done</span><br><span class=line>xtrabackup: Transaction log of lsn (<span class=number>2630081</span>) to (<span class=number>2630090</span>) was copied.</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>43</span>:<span class=number>34</span> completed OK!</span><br></pre></td></tr></table></figure><h6 id=2）删除数据库目录下的所有文件><a class=header-anchor href=#2）删除数据库目录下的所有文件>¶</a>2）删除数据库目录下的所有文件</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># rm -rf /var/lib/mysql/*</span></span><br></pre></td></tr></table></figure><h6 id=3）准备恢复><a class=header-anchor href=#3）准备恢复>¶</a>3）准备恢复</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># innobackupex --apply-log --redo-only /backups/2020-06-28_20-43-32</span></span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>48</span>:<span class=number>37</span> innobackupex: Starting the apply<span class=literal>-log</span> operation</span><br><span class=line></span><br><span class=line>IMPORTANT: Please check that the apply<span class=literal>-log</span> run completes successfully.</span><br><span class=line>           At the <span class=keyword>end</span> of a successful apply<span class=literal>-log</span> run innobackupex</span><br><span class=line>           prints <span class=string>"completed OK!"</span>.</span><br><span class=line></span><br><span class=line><span class=comment># 省略部分输出信息</span></span><br><span class=line></span><br><span class=line>xtrabackup: starting shutdown with innodb_fast_shutdown = <span class=number>1</span></span><br><span class=line>InnoDB: Starting shutdown...</span><br><span class=line>InnoDB: Shutdown completed; log sequence number <span class=number>2630099</span></span><br><span class=line>InnoDB: Number of pools: <span class=number>1</span></span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>48</span>:<span class=number>39</span> completed OK!</span><br></pre></td></tr></table></figure><h6 id=4）完全恢复><a class=header-anchor href=#4）完全恢复>¶</a>4）完全恢复</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># innobackupex --user=root --password=1234 --copy-back /backups/2020-06-28_20-43-32</span></span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>52</span>:<span class=number>55</span> innobackupex: Starting the <span class=built_in>copy-back</span> operation</span><br><span class=line></span><br><span class=line>IMPORTANT: Please check that the <span class=built_in>copy-back</span> run completes successfully.</span><br><span class=line>           At the <span class=keyword>end</span> of a successful <span class=built_in>copy-back</span> run innobackupex</span><br><span class=line>           prints <span class=string>"completed OK!"</span>.</span><br><span class=line></span><br><span class=line><span class=comment># 省略部分输出信息</span></span><br><span class=line></span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>52</span>:<span class=number>56</span> [<span class=number>01</span>] Copying ./ib_buffer_pool to /var/lib/mysql/ib_buffer_pool</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>52</span>:<span class=number>56</span> [<span class=number>01</span>]        ...done</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>52</span>:<span class=number>56</span> [<span class=number>01</span>] Copying ./xtrabackup_info to /var/lib/mysql/xtrabackup_info</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>52</span>:<span class=number>56</span> [<span class=number>01</span>]        ...done</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>52</span>:<span class=number>56</span> completed OK!</span><br></pre></td></tr></table></figure><h6 id=5）更改mysql目录属性><a class=header-anchor href=#5）更改mysql目录属性>¶</a>5）更改mysql目录属性</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># chown -R mysql.mysql /var/lib/mysql/</span></span><br></pre></td></tr></table></figure><h6 id=6）启动mysql><a class=header-anchor href=#6）启动mysql>¶</a>6）启动mysql</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># mysql -uroot -p -e "show databases;"</span></span><br><span class=line>Enter password: </span><br><span class=line>ERROR <span class=number>2002</span> (HY000): Can<span class=string>'t connect to local MySQL server through socket '</span>/var/lib/mysql/mysql.sock<span class=string>' (2)</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string># 如果发生以上错误，查看mysql进程的pid，结束mysql，再启动mysql即可。</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>[root@192 ~]# ps -aux | grep mysql</span></span><br><span class=line><span class=string>mysql     77011  0.1  9.0 1319504 169428 ?      Sl   19:28   0:07 /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid</span></span><br><span class=line><span class=string>root      77053  0.0  0.0 135604  1820 pts/3    S+   19:30   0:00 mysql -uroot -p</span></span><br><span class=line><span class=string>root      77193  0.0  0.1 135604  1880 pts/2    S+   19:37   0:00 mysql -uroot -p</span></span><br><span class=line><span class=string>root      80486  0.0  0.0 112724   988 pts/4    S+   20:56   0:00 grep --color=auto mysql</span></span><br><span class=line><span class=string>[root@192 ~]# kill -9 77011</span></span><br><span class=line><span class=string>[root@192 ~]# systemctl start mysqld</span></span><br><span class=line><span class=string>[root@192 ~]# ps -aux | grep mysql</span></span><br><span class=line><span class=string>root      77053  0.0  0.0 135604  1820 pts/3    S+   19:30   0:00 mysql -uroot -p</span></span><br><span class=line><span class=string>root      77193  0.0  0.1 135604  1880 pts/2    S+   19:37   0:00 mysql -uroot -p</span></span><br><span class=line><span class=string>mysql     80514 30.8  9.0 1122096 168328 ?      Sl   20:57   0:01 /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid</span></span><br><span class=line><span class=string>root      80558  0.0  0.0 112724   988 pts/4    S+   20:57   0:00 grep --color=auto mysql</span></span><br></pre></td></tr></table></figure><h6 id=7）查看数据是否恢复><a class=header-anchor href=#7）查看数据是否恢复>¶</a>7）查看数据是否恢复</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># mysql -uroot -p -e "show databases;"</span></span><br><span class=line>Enter password: </span><br><span class=line>+--------------------+</span><br><span class=line>| Database           |</span><br><span class=line>+--------------------+</span><br><span class=line>| information_schema |</span><br><span class=line>| mysql              |</span><br><span class=line>| performance_schema |</span><br><span class=line>| sys                |</span><br><span class=line>+--------------------+</span><br></pre></td></tr></table></figure><h3 id=六、XtraBacup增量备份与恢复><a class=header-anchor href=#六、XtraBacup增量备份与恢复>¶</a>六、XtraBacup增量备份与恢复</h3><h4 id=1、XtraBacup的增量备份原理><a class=header-anchor href=#1、XtraBacup的增量备份原理>¶</a>1、XtraBacup的增量备份原理</h4><p>使用innobackupex进行增量备份，每个InnoDB的页面都会包含一个LSN信息，每当相关的数据发生改变，相关的页面的LSN就会自动增长。这正是InnoDB表可以进行增量备份的基础，即innobackupex通过备份上次完全备份之后发生改变的页面来实现。</p><p>在进行增量备份时，首先要进行一次全量备份，第一次增量备份是基于全备的，之后的增量备份都是基于上一次的增量备份的，以此类推。</p><p>要实现第一次增量备份，可以使用下面的命令进行：</p><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre></td><td class=code><pre><span class=line>基于全量备份的增量备份与恢复</span><br><span class=line>做一次增量备份（基于当前最新的全量备份）</span><br><span class=line>innobackupex --user=root --password=root --defaults-file=/etc/my.cnf --incremental /backups/ --incremental-basedir=/backups/2018-07-30_11-01-37</span><br><span class=line>1. 准备基于全量</span><br><span class=line>innobackupex --user=root --password=root --defaults-file=/etc/my.cnf --apply-log --redo-only /backups/2018-07-30_11-01-37</span><br><span class=line>2. 准备基于增量</span><br><span class=line>innobackupex --user=root --password=root --defaults-file=/etc/my.cnf --apply-log --redo-only /backups/2018-07-30_11-01-37 --incremental-dir=/backups/2018-07-30_13-51-47/</span><br><span class=line>3. 恢复</span><br><span class=line>innobackupex --copy-back --defaults-file=/etc/my.cnf /opt/2017-01-05_11-04-55/</span><br><span class=line>解释：</span><br><span class=line>1. 2018-07-30_11-01-37指的是完全备份所在的目录。</span><br><span class=line>2. 2018-07-30_13-51-47指定是第一次基于2018-07-30_11-01-37增量备份的目录，其他类似以此类推，即如果有多次增量备份。每一次都要执行如上操作。</span><br></pre></td></tr></table></figure><p>需要注意的是，增量备份仅能应用于InnoDB或XtraDB表，对于MyISAM表而言，执行增量备份时其实进行的是完全备份。</p><p>“准备”(prepare)增量备份与整理完全备份有着一些不同，尤其要注意的是：</p><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>（1）需要在每个备份 (包括完全和各个增量备份)上，将已经提交的事务进行"重放"。"重放"之后，所有的备份数据将合并到完全备份上。</span><br><span class=line>（2）基于所有的备份将未提交的事务进行"回滚"</span><br></pre></td></tr></table></figure><h4 id=2、实战练习><a class=header-anchor href=#2、实战练习>¶</a>2、实战练习</h4><h5 id=（1）完全备份><a class=header-anchor href=#（1）完全备份>¶</a>（1）完全备份</h5><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># innobackupex --user=root --password=1234 --host=127.0.0.1 /backups/</span></span><br><span class=line></span><br><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># ll /backups/</span></span><br><span class=line>总用量 <span class=number>0</span></span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>8</span> root root <span class=number>262</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>18</span>:<span class=number>17</span> <span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_18</span><span class=literal>-17</span><span class=literal>-57</span></span><br></pre></td></tr></table></figure><h5 id=（2）增量备份><a class=header-anchor href=#（2）增量备份>¶</a>（2）增量备份</h5><h6 id=1）准备测试环境><a class=header-anchor href=#1）准备测试环境>¶</a>1）准备测试环境</h6><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; use student;</span><br><span class=line>Reading table information for completion of table and column names</span><br><span class=line>You can turn off this feature to get a quicker startup with -A</span><br><span class=line></span><br><span class=line>Database changed</span><br><span class=line></span><br><span class=line>mysql&gt; create table grade(id int);</span><br><span class=line>Query OK, 0 rows affected (0.01 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; insert into grade values(1),(2),(3);</span><br><span class=line>Query OK, 3 rows affected (0.00 sec)</span><br><span class=line>Records: 3  Duplicates: 0  Warnings: 0</span><br><span class=line></span><br><span class=line>mysql&gt; select * from grade;</span><br><span class=line>+------+</span><br><span class=line>| id   |</span><br><span class=line>+------+</span><br><span class=line>|    1 |</span><br><span class=line>|    2 |</span><br><span class=line>|    3 |</span><br><span class=line>+------+</span><br><span class=line>3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h6 id=2）增量备份><a class=header-anchor href=#2）增量备份>¶</a>2）增量备份</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># innobackupex --user=root --password=1234 --host=127.0.0.1 --incremental /backups/ --incremental-basedir=/backups/2020-06-28_18-17-57</span></span><br><span class=line></span><br><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># ll /backups/</span></span><br><span class=line>总用量 <span class=number>4</span></span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>8</span> root root  <span class=number>262</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>18</span>:<span class=number>17</span> <span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_18</span><span class=literal>-17</span><span class=literal>-57</span></span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>8</span> root root <span class=number>4096</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>18</span>:<span class=number>18</span> <span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_18</span><span class=literal>-18</span><span class=literal>-38</span></span><br></pre></td></tr></table></figure><h5 id=（3）查看备份数据><a class=header-anchor href=#（3）查看备份数据>¶</a>（3）查看备份数据</h5><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 查看全量备份的xtrabackup_checkpoints</span></span><br><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># cat /backups/2020-06-28_18-17-57/xtrabackup_checkpoints </span></span><br><span class=line>backup_type = full<span class=literal>-backuped</span>		<span class=comment>#备份类型为全量备份</span></span><br><span class=line>from_lsn = <span class=number>0</span>					<span class=comment>#lsn从0开始</span></span><br><span class=line>to_lsn = <span class=number>2644619</span>				<span class=comment>#lsn到2644619结束</span></span><br><span class=line>last_lsn = <span class=number>2644628</span></span><br><span class=line>compact = <span class=number>0</span></span><br><span class=line>recover_binlog_info = <span class=number>0</span></span><br><span class=line></span><br><span class=line><span class=comment># 查看增量备份的xtrabackup_checkpoints</span></span><br><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># cat /backups/2020-06-28_18-18-38/xtrabackup_checkpoints </span></span><br><span class=line>backup_type = incremental		<span class=comment>#备份类型为增量备份</span></span><br><span class=line>from_lsn = <span class=number>2644619</span>				<span class=comment>#lsn从2644619开始</span></span><br><span class=line>to_lsn = <span class=number>2644628</span>				<span class=comment>#lsn到2644628结束</span></span><br><span class=line>last_lsn = <span class=number>2644628</span></span><br><span class=line>compact = <span class=number>0</span></span><br><span class=line>recover_binlog_info = <span class=number>0</span></span><br></pre></td></tr></table></figure><h5 id=（4）数据恢复><a class=header-anchor href=#（4）数据恢复>¶</a>（4）数据恢复</h5><h6 id=1）模拟mysql故障，删除数据目录所有数据><a class=header-anchor href=#1）模拟mysql故障，删除数据目录所有数据>¶</a>1）模拟mysql故障，删除数据目录所有数据</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># systemctl stop mysqld</span></span><br><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># rm -rf /var/lib/mysql/*</span></span><br></pre></td></tr></table></figure><h6 id=2）合并全备数据目录，确保数据的一致性><a class=header-anchor href=#2）合并全备数据目录，确保数据的一致性>¶</a>2）合并全备数据目录，确保数据的一致性</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># innobackupex --apply-log --redo-only /backups/2020-06-28_18-17-57</span></span><br><span class=line></span><br><span class=line><span class=comment># 省略部分输出信息</span></span><br><span class=line></span><br><span class=line>xtrabackup: starting shutdown with innodb_fast_shutdown = <span class=number>1</span></span><br><span class=line>InnoDB: Starting shutdown...</span><br><span class=line>InnoDB: Shutdown completed; log sequence number <span class=number>2644637</span></span><br><span class=line>InnoDB: Number of pools: <span class=number>1</span></span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>08</span>:<span class=number>23</span> completed OK!</span><br></pre></td></tr></table></figure><h6 id=3）将增量备份数据合并到全备数据目录当中><a class=header-anchor href=#3）将增量备份数据合并到全备数据目录当中>¶</a>3）将增量备份数据合并到全备数据目录当中</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># innobackupex --apply-log --redo-only /backups/2020-06-28_18-17-57 --incremental-dir=/backups/2020-06-28_18-18-38</span></span><br><span class=line></span><br><span class=line><span class=comment># 省略部分输出信息</span></span><br><span class=line></span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>10</span>:<span class=number>14</span> [<span class=number>01</span>] Copying /backups/<span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_18</span><span class=literal>-18</span><span class=literal>-38</span>/<span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_17</span><span class=literal>-43</span><span class=literal>-27</span>/db.opt to ./<span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_17</span><span class=literal>-43</span><span class=literal>-27</span>/db.opt</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>10</span>:<span class=number>14</span> [<span class=number>01</span>]        ...done</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>10</span>:<span class=number>14</span> [<span class=number>01</span>] Copying /backups/<span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_18</span><span class=literal>-18</span><span class=literal>-38</span>/<span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_17</span><span class=literal>-44</span><span class=literal>-04</span>/db.opt to ./<span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_17</span><span class=literal>-44</span><span class=literal>-04</span>/db.opt</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>10</span>:<span class=number>14</span> [<span class=number>01</span>]        ...done</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>10</span>:<span class=number>14</span> [<span class=number>00</span>] Copying /backups/<span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_18</span><span class=literal>-18</span><span class=literal>-38</span>//xtrabackup_info to ./xtrabackup_info</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>10</span>:<span class=number>14</span> [<span class=number>00</span>]        ...done</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>10</span>:<span class=number>14</span> completed OK!</span><br></pre></td></tr></table></figure><h6 id=4）查看数据备份类型><a class=header-anchor href=#4）查看数据备份类型>¶</a>4）查看数据备份类型</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># cat /backups/2020-06-28_18-17-57/xtrabackup_checkpoints </span></span><br><span class=line>backup_type = log<span class=literal>-applied</span>			<span class=comment>#查看到数据备份类型是增加</span></span><br><span class=line>from_lsn = <span class=number>0</span>						<span class=comment>#lsn从0开始</span></span><br><span class=line>to_lsn = <span class=number>2644619</span>					<span class=comment>#lsn结束号为最新的lsn</span></span><br><span class=line>last_lsn = <span class=number>2644628</span></span><br><span class=line>compact = <span class=number>0</span></span><br><span class=line>recover_binlog_info = <span class=number>0</span></span><br></pre></td></tr></table></figure><h6 id=5）恢复数据><a class=header-anchor href=#5）恢复数据>¶</a>5）恢复数据</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># innobackupex --copy-back /backups/2020-06-28_18-17-57</span></span><br><span class=line></span><br><span class=line><span class=comment># 省略部分输出信息</span></span><br><span class=line></span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>14</span>:<span class=number>39</span> [<span class=number>01</span>] Copying ./ib_buffer_pool to /var/lib/mysql/ib_buffer_pool</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>14</span>:<span class=number>39</span> [<span class=number>01</span>]        ...done</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>14</span>:<span class=number>39</span> [<span class=number>01</span>] Copying ./xtrabackup_info to /var/lib/mysql/xtrabackup_info</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>14</span>:<span class=number>39</span> [<span class=number>01</span>]        ...done</span><br><span class=line><span class=number>200628</span> <span class=number>20</span>:<span class=number>14</span>:<span class=number>39</span> completed OK!</span><br></pre></td></tr></table></figure><h6 id=6）查看数据库目录><a class=header-anchor href=#6）查看数据库目录>¶</a>6）查看数据库目录</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># ll /var/lib/mysql</span></span><br><span class=line>总用量 <span class=number>12324</span></span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>2</span> root root       <span class=number>20</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> <span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_17</span><span class=literal>-43</span><span class=literal>-27</span></span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>2</span> root root       <span class=number>20</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> <span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_17</span><span class=literal>-44</span><span class=literal>-04</span></span><br><span class=line><span class=literal>-rw</span><span class=literal>-r</span>-----. <span class=number>1</span> root root      <span class=number>425</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> ib_buffer_pool</span><br><span class=line><span class=literal>-rw</span><span class=literal>-r</span>-----. <span class=number>1</span> root root <span class=number>12582912</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> ibdata1</span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>2</span> root root     <span class=number>4096</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> mysql</span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>2</span> root root     <span class=number>8192</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> performance_schema</span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>2</span> root root       <span class=number>84</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> student</span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>2</span> root root     <span class=number>8192</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> sys</span><br><span class=line><span class=literal>-rw</span><span class=literal>-r</span>-----. <span class=number>1</span> root root      <span class=number>507</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> xtrabackup_info</span><br></pre></td></tr></table></figure><h6 id=7）更改数据的属主属组><a class=header-anchor href=#7）更改数据的属主属组>¶</a>7）更改数据的属主属组</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># chown -R mysql.mysql /var/lib/mysql/</span></span><br><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># ll /var/lib/mysql</span></span><br><span class=line>总用量 <span class=number>12324</span></span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>2</span> mysql mysql       <span class=number>20</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> <span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_17</span><span class=literal>-43</span><span class=literal>-27</span></span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>2</span> mysql mysql       <span class=number>20</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> <span class=number>2020</span><span class=literal>-06</span><span class=literal>-28_17</span><span class=literal>-44</span><span class=literal>-04</span></span><br><span class=line><span class=literal>-rw</span><span class=literal>-r</span>-----. <span class=number>1</span> mysql mysql      <span class=number>425</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> ib_buffer_pool</span><br><span class=line><span class=literal>-rw</span><span class=literal>-r</span>-----. <span class=number>1</span> mysql mysql <span class=number>12582912</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> ibdata1</span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>2</span> mysql mysql     <span class=number>4096</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> mysql</span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>2</span> mysql mysql     <span class=number>8192</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> performance_schema</span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>2</span> mysql mysql       <span class=number>84</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> student</span><br><span class=line>drwxr<span class=literal>-x</span>---. <span class=number>2</span> mysql mysql     <span class=number>8192</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> sys</span><br><span class=line><span class=literal>-rw</span><span class=literal>-r</span>-----. <span class=number>1</span> mysql mysql      <span class=number>507</span> <span class=number>6</span>月  <span class=number>28</span> <span class=number>20</span>:<span class=number>14</span> xtrabackup_info</span><br></pre></td></tr></table></figure><h6 id=8）启动mysql><a class=header-anchor href=#8）启动mysql>¶</a>8）启动mysql</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># systemctl start mysqld</span></span><br><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># ps -aux | grep mysqld</span></span><br><span class=line>mysql     <span class=number>83275</span>  <span class=number>4.0</span>  <span class=number>9.0</span> <span class=number>1122096</span> <span class=number>168576</span> ?      Sl   <span class=number>20</span>:<span class=number>18</span>   <span class=number>0</span>:<span class=number>02</span> /usr/sbin/mysqld -<span class=literal>-daemonize</span> -<span class=literal>-pid</span><span class=operator>-file</span>=/var/run/mysqld/mysqld.pid</span><br><span class=line>root      <span class=number>83320</span>  <span class=number>0.0</span>  <span class=number>0.0</span> <span class=number>112724</span>   <span class=number>988</span> pts/<span class=number>1</span>    S+   <span class=number>20</span>:<span class=number>19</span>   <span class=number>0</span>:<span class=number>00</span> grep -<span class=literal>-color</span>=auto mysqld</span><br></pre></td></tr></table></figure><h6 id=9）查看数据是否恢复><a class=header-anchor href=#9）查看数据是否恢复>¶</a>9）查看数据是否恢复</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre></td><td class=code><pre><span class=line>[<span class=type>root</span>@<span class=number>192</span> ~]<span class=comment># mysql -uroot -p -e "show databases;"</span></span><br><span class=line>Enter password: </span><br><span class=line>+------------------------------+</span><br><span class=line>| Database                     |</span><br><span class=line>+------------------------------+</span><br><span class=line>| information_schema           |</span><br><span class=line>| mysql                        |</span><br><span class=line>| performance_schema           |</span><br><span class=line>| student                      |</span><br><span class=line>| sys                          |</span><br><span class=line>+------------------------------+</span><br></pre></td></tr></table></figure><h6 id=10）总结><a class=header-anchor href=#10）总结>¶</a>10）总结</h6><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>（1）增量备份需要使用参数--incremental指定需要备份到哪个目录，使用incremental-dir指定全备目录；</span><br><span class=line>（2）进行数据备份时，需要使用参数--apply-log redo-only先合并全备数据目录数据，确保全备数据目录数据的一致性；</span><br><span class=line>（3）再将增量备份数据使用参数--incremental-dir合并到全备数据当中；</span><br><span class=line>（4）最后通过最后的全备数据进行恢复数据，注意，如果有多个增量备份，需要逐一合并到全备数据当中，再进行恢复。</span><br></pre></td></tr></table></figure></div><div><ul class=post-copyright><li class=post-copyright-author><strong>本文作者：</strong>Maisy</li><li class=post-copyright-link><strong>本文链接：</strong> <a href=https://pdxblog.top/XtraBacup%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.html title=XtraBacup备份与恢复>https://pdxblog.top/XtraBacup备份与恢复.html</a></li><li class=post-copyright-license><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel=noopener target=_blank><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class=post-footer><div class=post-tags><a href="/tags/MySQL/" rel=tag># MySQL</a></div><div class=post-nav><div class=post-nav-item><a href=/%E5%88%9D%E8%AF%86MySQL.html rel=prev title=初识MySQL><i class="fa fa-chevron-left"></i> 初识MySQL</a></div><div class=post-nav-item><a href=/MySQL+MMM%E9%AB%98%E5%8F%AF%E7%94%A8.html rel=next title=MySQL+MMM高可用>MySQL+MMM高可用 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class=nav><li class="nav-item nav-level-2"><a class=nav-link href=#XtraBacup备份与恢复><span class=nav-number>1.</span> <span class=nav-text>¶XtraBacup备份与恢复</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#一、XtraBacup简介><span class=nav-number>1.1.</span> <span class=nav-text>¶一、XtraBacup简介</span></a></li><li class="nav-item nav-level-3"><a class=nav-link href=#二、XtraBacup优点><span class=nav-number>1.2.</span> <span class=nav-text>¶二、XtraBacup优点</span></a></li><li class="nav-item nav-level-3"><a class=nav-link href=#三、Xtrabackup备份原理><span class=nav-number>1.3.</span> <span class=nav-text>¶三、Xtrabackup备份原理</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、Xtrabackup备份流程图><span class=nav-number>1.3.1.</span> <span class=nav-text>¶1、Xtrabackup备份流程图</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、XtraBackup的备份原理><span class=nav-number>1.3.2.</span> <span class=nav-text>¶2、XtraBackup的备份原理</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#3、XtraBackup命令行工具><span class=nav-number>1.3.3.</span> <span class=nav-text>¶3、XtraBackup命令行工具</span></a></li></ol></li><li class="nav-item nav-level-3"><a class=nav-link href=#四、XtraBackup安装><span class=nav-number>1.4.</span> <span class=nav-text>¶四、XtraBackup安装</span></a></li><li class="nav-item nav-level-3"><a class=nav-link href=#五、XtraBackup完全备份与恢复><span class=nav-number>1.5.</span> <span class=nav-text>¶五、XtraBackup完全备份与恢复</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、准备-prepare-一个完全备份><span class=nav-number>1.5.1.</span> <span class=nav-text>¶1、准备(prepare)一个完全备份</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、从一个完全备份中恢复数据><span class=nav-number>1.5.2.</span> <span class=nav-text>¶2、从一个完全备份中恢复数据</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#3、实战练习><span class=nav-number>1.5.3.</span> <span class=nav-text>¶3、实战练习</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）准备测试环境><span class=nav-number>1.5.3.1.</span> <span class=nav-text>¶（1）准备测试环境</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）全量备份><span class=nav-number>1.5.3.2.</span> <span class=nav-text>¶（2）全量备份</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（3）查看完全备份文件><span class=nav-number>1.5.3.3.</span> <span class=nav-text>¶（3）查看完全备份文件</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（4）模拟完全恢复><span class=nav-number>1.5.3.4.</span> <span class=nav-text>¶（4）模拟完全恢复</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#1）完全备份><span class=nav-number>1.5.3.4.1.</span> <span class=nav-text>¶1）完全备份</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#2）删除数据库目录下的所有文件><span class=nav-number>1.5.3.4.2.</span> <span class=nav-text>¶2）删除数据库目录下的所有文件</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#3）准备恢复><span class=nav-number>1.5.3.4.3.</span> <span class=nav-text>¶3）准备恢复</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#4）完全恢复><span class=nav-number>1.5.3.4.4.</span> <span class=nav-text>¶4）完全恢复</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#5）更改mysql目录属性><span class=nav-number>1.5.3.4.5.</span> <span class=nav-text>¶5）更改mysql目录属性</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#6）启动mysql><span class=nav-number>1.5.3.4.6.</span> <span class=nav-text>¶6）启动mysql</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#7）查看数据是否恢复><span class=nav-number>1.5.3.4.7.</span> <span class=nav-text>¶7）查看数据是否恢复</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class=nav-link href=#六、XtraBacup增量备份与恢复><span class=nav-number>1.6.</span> <span class=nav-text>¶六、XtraBacup增量备份与恢复</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、XtraBacup的增量备份原理><span class=nav-number>1.6.1.</span> <span class=nav-text>¶1、XtraBacup的增量备份原理</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、实战练习><span class=nav-number>1.6.2.</span> <span class=nav-text>¶2、实战练习</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）完全备份><span class=nav-number>1.6.2.1.</span> <span class=nav-text>¶（1）完全备份</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）增量备份><span class=nav-number>1.6.2.2.</span> <span class=nav-text>¶（2）增量备份</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#1）准备测试环境><span class=nav-number>1.6.2.2.1.</span> <span class=nav-text>¶1）准备测试环境</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#2）增量备份><span class=nav-number>1.6.2.2.2.</span> <span class=nav-text>¶2）增量备份</span></a></li></ol></li><li class="nav-item nav-level-5"><a class=nav-link href=#（3）查看备份数据><span class=nav-number>1.6.2.3.</span> <span class=nav-text>¶（3）查看备份数据</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（4）数据恢复><span class=nav-number>1.6.2.4.</span> <span class=nav-text>¶（4）数据恢复</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#1）模拟mysql故障，删除数据目录所有数据><span class=nav-number>1.6.2.4.1.</span> <span class=nav-text>¶1）模拟mysql故障，删除数据目录所有数据</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#2）合并全备数据目录，确保数据的一致性><span class=nav-number>1.6.2.4.2.</span> <span class=nav-text>¶2）合并全备数据目录，确保数据的一致性</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#3）将增量备份数据合并到全备数据目录当中><span class=nav-number>1.6.2.4.3.</span> <span class=nav-text>¶3）将增量备份数据合并到全备数据目录当中</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#4）查看数据备份类型><span class=nav-number>1.6.2.4.4.</span> <span class=nav-text>¶4）查看数据备份类型</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#5）恢复数据><span class=nav-number>1.6.2.4.5.</span> <span class=nav-text>¶5）恢复数据</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#6）查看数据库目录><span class=nav-number>1.6.2.4.6.</span> <span class=nav-text>¶6）查看数据库目录</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#7）更改数据的属主属组><span class=nav-number>1.6.2.4.7.</span> <span class=nav-text>¶7）更改数据的属主属组</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#8）启动mysql><span class=nav-number>1.6.2.4.8.</span> <span class=nav-text>¶8）启动mysql</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#9）查看数据是否恢复><span class=nav-number>1.6.2.4.9.</span> <span class=nav-text>¶9）查看数据是否恢复</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#10）总结><span class=nav-number>1.6.2.4.10.</span> <span class=nav-text>¶10）总结</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Maisy src=/images/author.jpg><p class=site-author-name itemprop=name>Maisy</p><div class=site-description itemprop=description>人的一生就是一个储蓄的过程，在奋斗的时候储存了希望；在耕耘的时候储存了一粒种子；在旅行的时候储存了风景；在微笑的时候储存了快乐。聪明的人善于储蓄，在漫长而短暂的人生旅途中，学会储蓄每一个闪光的瞬间，然后用它们酿成一杯美好的回忆，在四季的变幻与交替之间，散发浓香，珍藏一生</div></div><div class="site-state-wrap motion-element"><nav class=site-state><div class="site-state-item site-state-posts"><a href="/archives/"><span class=site-state-item-count>69</span> <span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class=site-state-item-count>7</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class=site-state-item-count>7</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/Gilbert2/Gilbert2.github.io title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Gilbert2&#x2F;Gilbert2.github.io" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a></span> <span class=links-of-author-item><a href=https://blog.csdn.net/weixin_45636702 title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_45636702" rel=noopener target=_blank><i class="fab fa-crosshairs fa-fw"></i>CSDN</a></span></div><div class="cc-license motion-element" itemprop=license><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class=cc-opacity rel=noopener target=_blank><img src=/images/cc-by-nc-sa.svg alt="Creative Commons"></a></div></div></div></aside><div id=sidebar-dimmer></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy; 2019 – <span itemprop=copyrightYear>2020</span> <span class=with-love><i class="fa fa-heart"></i></span> <span class=author itemprop=copyrightHolder>Maisy</span> <span class=post-meta-divider>|</span> <span class=post-meta-item-icon><i class="fa fa-chart-area"></i></span> <span class=post-meta-item-text>站点总字数：</span> <span title=站点总字数>572k</span> <span class=post-meta-divider>|</span> <span class=post-meta-item-icon><i class="fa fa-coffee"></i></span> <span class=post-meta-item-text>站点阅读时长 &asymp;</span> <span title=站点阅读时长>8:40</span></div><div class=powered-by>由 <a href="https://hexo.io/" class=theme-link rel=noopener target=_blank>Hexo</a> & <a href="https://muse.theme-next.org/" class=theme-link rel=noopener target=_blank>NexT.Muse</a> 强力驱动</div></div></footer></div><script src=/lib/anime.min.js></script><script src=//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js></script><script src=//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js></script><script src=//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js></script><script src=/lib/velocity/velocity.min.js></script><script src=/lib/velocity/velocity.ui.min.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/schemes/muse.js></script><script src=/js/next-boot.js></script><script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script></body></html>