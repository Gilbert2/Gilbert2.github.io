<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width, initial-scale=1, maximum-scale=2"><meta name=theme-color content=#222><meta name=generator content="Hexo 4.2.0"><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-next.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32-next.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16-next.png><link rel=mask-icon href=/images/logo.svg color=#222><meta name=msvalidate.01 content=true><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><link rel=stylesheet href=//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css><script id=hexo-configurations>
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pdxblog.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"b2t":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":{"enable":true,"onlypost":false,"loadingImg":null},"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script><meta name=description content=架构><meta property=og:type content=article><meta property=og:title content=Apache深度优化><meta property=og:url content=https://pdxblog.top/Apache%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%8C%96.html><meta property=og:site_name content=Maisyの博客><meta property=og:description content=架构><meta property=og:locale content=zh_CN><meta property=og:image content=https://img-blog.csdnimg.cn/20200609130213307.png><meta property=og:image content=https://img-blog.csdnimg.cn/20200609130236625.png><meta property=og:image content="https://img-blog.csdnimg.cn/2020060913031552.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200609130341874.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content=https://img-blog.csdnimg.cn/20200609130353734.png><meta property=og:image content="https://img-blog.csdnimg.cn/20200609130430605.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200609130444922.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=article:published_time content=2020-06-08T16:00:00.000Z><meta property=article:modified_time content=2020-06-09T05:13:28.246Z><meta property=article:author content=Maisy><meta property=article:tag content=架构><meta name=twitter:card content=summary><meta name=twitter:image content=https://img-blog.csdnimg.cn/20200609130213307.png><link rel=canonical href=https://pdxblog.top/Apache%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%8C%96.html><script id=page-configurations>
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script><title>Apache深度优化 | Maisyの博客</title><noscript><style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style></noscript><link rel=alternate href=/atom.xml title=Maisyの博客 type=application/atom+xml></head><body itemscope itemtype=http://schema.org/WebPage><div class="container use-motion"><div class=headband></div><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class=site-meta><a href="/" class=brand rel=start><span class=logo-line-before><i></i></span><h1 class=site-title>Maisyの博客</h1><span class=logo-line-after><i></i></span></a><p class=site-subtitle itemprop=description>记录生活中的点点滴滴</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul id=menu class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel=section><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-top"><a href="/top/" rel=section><i class="fa fa-signal fa-fw"></i>排行榜</a></li><li class="menu-item menu-item-about"><a href="/about/" rel=section><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel=section><i class="fa fa-tags fa-fw"></i>标签<span class=badge>6</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel=section><i class="fa fa-th fa-fw"></i>分类<span class=badge>6</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel=section><i class="fa fa-archive fa-fw"></i>归档<span class=badge>57</span></a></li></ul></nav></div></header><div class=back-to-top><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class=main><div class=main-inner><div class=content-wrap><div class="content post posts-expand"><article itemscope itemtype=http://schema.org/Article class=post-block lang=zh-CN><link itemprop=mainEntityOfPage href=https://pdxblog.top/Apache%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%8C%96.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/author.jpg><meta itemprop=name content=Maisy><meta itemprop=description content=人的一生就是一个储蓄的过程，在奋斗的时候储存了希望；在耕耘的时候储存了一粒种子；在旅行的时候储存了风景；在微笑的时候储存了快乐。聪明的人善于储蓄，在漫长而短暂的人生旅途中，学会储蓄每一个闪光的瞬间，然后用它们酿成一杯美好的回忆，在四季的变幻与交替之间，散发浓香，珍藏一生></span> <span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content=Maisyの博客></span><header class=post-header><h1 class=post-title itemprop="name headline">Apache深度优化</h1><div class=post-meta><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span> <span class=post-meta-item-text>发表于</span><time title="创建时间：2020-06-09 00:00:00 / 修改时间：13:13:28" itemprop="dateCreated datePublished" datetime=2020-06-09T00:00:00+08:00>2020-06-09</time></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder"></i></span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href="/categories/%E6%9E%B6%E6%9E%84/" itemprop=url rel=index><span itemprop=name>架构</span></a></span></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-comment"></i></span> <span class=post-meta-item-text>Valine：</span> <a title=valine href=/Apache%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%8C%96.html#valine-comments itemprop=discussionUrl><span class="post-comments-count valine-comment-count" data-xid=/Apache%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%8C%96.html itemprop=commentCount></span></a></span><br><span class=post-meta-item title=本文字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span> <span class=post-meta-item-text>本文字数：</span> <span>13k</span></span> <span class=post-meta-item title=阅读时长><span class=post-meta-item-icon><i class="far fa-clock"></i></span> <span class=post-meta-item-text>阅读时长 &asymp;</span> <span>12 分钟</span></span><div class=post-description>架构</div></div></header><div class=post-body itemprop=articleBody><h3 id=Apache深度优化><a class=header-anchor href=#Apache深度优化>¶</a>Apache深度优化</h3><h4 id=1）开启apache的Gzip（defate）功能><a class=header-anchor href=#1）开启apache的Gzip（defate）功能>¶</a>1）开启apache的Gzip（defate）功能</h4><p>gzip 可以极大的加速网站，有时压缩比率高到 80%,最少都有 40%以上，还是相当不错的。 在 Apache2 之后的版本，模块名不叫 gzip,而叫 mod_deflate</p><p>未使用 Gzip：<br><img data-src=https://img-blog.csdnimg.cn/20200609130213307.png><br>开始使用Gzip：<br><img data-src=https://img-blog.csdnimg.cn/20200609130236625.png><br>如果要开启 deflate 的话,一定要打开下面二个模块</p><blockquote><p>LoadModule deflate_module modules/mod_deflate.so</p><p>LoadModule headers_module modules/mod_headers.so</p></blockquote><p>设置压缩比率,取值范围在 1(最低) 到 9(最高)之间,不建议设置太高,虽然有很高的压缩率, 但是占用更多的 CPU 资源.</p><h5 id=mod-deflate-模块检查及安装><a class=header-anchor href=#mod-deflate-模块检查及安装>¶</a>mod_deflate 模块检查及安装</h5><p>检查模块是否安装：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@apache ~]<span class=comment># apachectl -M | grep deflte</span></span><br></pre></td></tr></table></figure><p>如果没有安装，有两种安装方法：</p><h6 id=a、编译时安装方法><a class=header-anchor href=#a、编译时安装方法>¶</a>a、编译时安装方法</h6><p>在编译安装Apache的时候跟上–enable-deflate 即可实现安装，<a href=https://blog.csdn.net/weixin_45636702/article/details/106614543 target=_blank rel=noopener>Apache安装部署点击这里</a></p><h6 id=b、DSO方式安装><a class=header-anchor href=#b、DSO方式安装>¶</a>b、DSO方式安装</h6><p>切到apache 源码包 mod_deflate 所在 的目录下</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@apache ~]<span class=comment># cd  /root/httpd-2.4.23/modules/filters/</span></span><br></pre></td></tr></table></figure><p>以 dso 的方式编译安装到 apache 中</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@apache filters]<span class=comment># apxs -c -i -a mod_deflate.c</span></span><br></pre></td></tr></table></figure><p>如果报错：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line>[root@apache filters]<span class=comment># apxs -c -i -a mod_deflate.c</span></span><br><span class=line>/usr/<span class=built_in>local</span>/apr/build-1/libtool --silent --mode=compile gcc -std=gnu99 -prefer-pic   -DLINUX -D_REENTRANT -D_GNU_SOURCE -g -O2 -pthread -I/usr/<span class=built_in>local</span>/http-2.4.23/include  -I/usr/<span class=built_in>local</span>/apr/include/apr-1   -I/usr/<span class=built_in>local</span>/apr-util/include/apr-1   -c -o mod_deflate.lo mod_deflate.c &amp;&amp; touch mod_deflate.slo</span><br><span class=line>mod_deflate.c:51:18: fatal error: zlib.h: No such file or directory</span><br><span class=line> <span class=comment>#include "zlib.h"</span></span><br><span class=line>                  ^</span><br><span class=line>compilation terminated.</span><br><span class=line>apxs:Error: Command failed with rc=65536</span><br><span class=line>.</span><br></pre></td></tr></table></figure><p>原因是缺少了zlib-devel 的安装包，装上就可以了</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@apache filters]<span class=comment># yum -y install zlib-devel</span></span><br></pre></td></tr></table></figure><p>再次安装模块，检查mod_deflate是否安装，成功安装这里会显示出该文件</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@apache filters]<span class=comment># ll /usr/local/http-2.4.23/modules/mod_deflate.so</span></span><br><span class=line>-rwxr-xr-x. 1 root root 98104 6月   9 09:20 /usr/<span class=built_in>local</span>/http-2.4.23/modules/mod_deflate.so</span><br></pre></td></tr></table></figure><p>apxs 命令参数说明：</p><ul><li>-i：此选项表示需要执行安装操作，以安装一个或多个动态共享对象到服务器的 modules 目 录中</li><li>-a：此选项自动增加一个 LoadModule 行到 httpd.conf 文件中，以启用此模块，或者，如果 此行已经存在，则启用之</li><li>-c：此选项表示需要执行编译操作</li></ul><p>如果重启的时候出现错误：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>[root@apache ~]<span class=comment># apachectl -t</span></span><br><span class=line>httpd: Syntax error on line 104 of /usr/<span class=built_in>local</span>/http-2.4.23/conf/httpd.conf: Cannot load modules/mod_deflate.so into server: /usr/<span class=built_in>local</span>/http-2.4.23/modules/mod_deflate.so: undefined symbol: inflate</span><br><span class=line>[root@apache ~]<span class=comment># apachectl -M</span></span><br><span class=line>httpd: Syntax error on line 104 of /usr/<span class=built_in>local</span>/http-2.4.23/conf/httpd.conf: Cannot load modules/mod_deflate.so into server: /usr/<span class=built_in>local</span>/http-2.4.23/modules/mod_deflate.so: undefined symbol: inflate</span><br><span class=line>[root@apache ~]<span class=comment># httpd -M</span></span><br><span class=line>httpd: Syntax error on line 104 of /usr/<span class=built_in>local</span>/http-2.4.23/conf/httpd.conf: Cannot load modules/mod_deflate.so into server: /usr/<span class=built_in>local</span>/http-2.4.23/modules/mod_deflate.so: undefined symbol: inflate</span><br></pre></td></tr></table></figure><p>需要在 LoadModule deflate_module modules/mod_deflate.so 的前面加载 <a href=http://zlib.so target=_blank rel=noopener>zlib.so</a> 这里需要注意的是 LoadModule deflate_module 需要放在 LoadModule php5_module 之后 LoadFile /usr/lib/libz.so(x64 系统中该库文件位于/usr/lib64 目录下，可以软链接到/usr/lib 下 或者就在 LoadModule deflate_module modules/mod_deflate.so 这行的上一行添加 LoadFile /usr/lib64/libz.so 即可</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>[root@apache ~]<span class=comment># vim /usr/local/http-2.4.23/conf/httpd.conf</span></span><br><span class=line>LoadFile /usr/lib64/libz.so <span class=comment># 追加</span></span><br><span class=line>LoadModule deflate_module modules/mod_deflate.so <span class=comment># 去掉注释</span></span><br><span class=line>LoadModule headers_module modules/mod_headers.so <span class=comment># 去掉注释</span></span><br></pre></td></tr></table></figure><p>这样 apache 就会启用这两个模块，</p><p>mod_deflate 是压缩模块，就是对要传输到客户端的代码进行 gzip 压缩</p><p>mod_headers 模块的作用是告诉浏览器页面使用了 gzip 压缩，如果不开启 mod_headers 那么浏览器就会 对 gzip 压缩过的页面进行下载，而无法正常显示</p><p>LoadModule /usr/lib64/libz.so：如果使用DSO方式安装的deflate模块需要声明，没用可以不用写</p><h6 id=在添加压缩级别等参数：><a class=header-anchor href=#在添加压缩级别等参数：>¶</a>在添加压缩级别等参数：</h6><p>在 httpd.conf 中加入以下代码，可以加到任何空白地方，不了解 apache 的话，如果担心加 错地方，就放到 http.conf 文件的最后一行</p><p>注：在添加代码前最好先查一查要添加的代码是否存在</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line>&lt;IfModule mod_deflate.c&gt;</span><br><span class=line>DeflateCompressionLevel 9</span><br><span class=line>SetOutputFilter DEFLATE </span><br><span class=line>AddOutputFilterByType DEFLATE text/*</span><br><span class=line>AddOutputFilterByType DEFLATE application/x-httpd-php application/x-httpd-fastphp</span><br><span class=line>SetEnvIfNoCase Request_URI .(?:gif|jpe?g|png)$ no-gzip dont-vary</span><br><span class=line>SetEnvIfNoCase Request_URI .(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary</span><br><span class=line>SetEnvIfNoCase Request_URI .(?:pdf|mov|avi|mp3|mp4|rm)$ no-gzip dont-vary</span><br><span class=line>&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure><p>DeflateCompressionLevel 9：</p><blockquote><p>压缩程度的等级，预设可以采用 6 这个数值，以维持 耗用处理器效能与网页压缩质量的平衡</p></blockquote><p>SetOutputFilter DEFLATE：</p><blockquote><p>设置输出过滤器，对输出启用压缩，必须的，就像一个 开关一样，告诉 apache 对传输到浏览器的内容进行压缩</p></blockquote><p>AddOutputFilterByType DEFLATE text/*：</p><blockquote><p>设置对文件是文本的内容进行压缩，例如 text/html text/css text/plain 等</p></blockquote><p>AddOutputFilterByType DEFLATE application/x-httpd-php application/x-httpd-fastphp：</p><blockquote><p>对 php 类型的文件进行压缩</p></blockquote><p>SetEnvIfNoCase Request_URI .(?:gif|jpe?g|png)$ no-gzip dont-vary：</p><blockquote><p>设置不对后缀 gif，jpg，jpeg，png 的图片文件进行压缩。注：?:表示不会捕获 ( )里内容了</p></blockquote><p>SetEnvIfNoCase Request_URI .(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary：</p><blockquote><p>同上，设置不对 exe，tgz，gz 等的文件进行压缩</p></blockquote><p>SetEnvIfNoCase Request_URI .(?:pdf|mov|avi|mp3|mp4|rm)$ no-gzip dont-vary</p><blockquote><p>同上，设置不对 pdf，avi，mp3 等的文件进行压缩</p></blockquote><h6 id=设置日志输出><a class=header-anchor href=#设置日志输出>¶</a>设置日志输出</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>DeflateFilterNote Input input_info</span><br><span class=line>DeflateFilterNote Output output_info</span><br><span class=line>DeflateFilterNote Ratio ratio_info</span><br><span class=line>LogFormat <span class=string>'"%r" %&#123;output_info&#125;n/%&#123;input_info&#125;n (%&#123;ratio_info&#125;n%%)'</span> deflate</span><br><span class=line>CustomLog logs/deflate_log.log deflate</span><br></pre></td></tr></table></figure><p>DeflateFilterNote Input input_info：</p><blockquote><p>声明输入流的 byte 数量</p></blockquote><p>DeflateFilterNote Output output_info：</p><blockquote><p>声明输出流的 byte 数量</p></blockquote><p>DeflateFilterNote Ratio ratio_info：</p><blockquote><p>声明压缩的百分比</p></blockquote><p>LogFormat ‘&quot;%r&quot; %{output_info}n/%{input_info}n (%{ratio_info}n%%)’ deflate：</p><blockquote><p>声明日志格式</p></blockquote><p>修改完成后保存退出并重启 apache服务</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@apache ~]<span class=comment># systemctl  restart  httpd</span></span><br></pre></td></tr></table></figure><p>使用谷歌浏览器测试访问，如下图显示结果：（提示：在访问测试页之前按 F12 键）<br><img data-src="https://img-blog.csdnimg.cn/2020060913031552.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><p>查看日志：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>[root@apache ~]<span class=comment># cat /usr/local/http-2.4.23/logs/deflate_log.log</span></span><br><span class=line><span class=string>"GET /test.html HTTP/1.1"</span> 6421/19949 (32%)</span><br><span class=line><span class=string>"GET /test1.html HTTP/1.1"</span> 1360/4266 (31%)</span><br></pre></td></tr></table></figure><p>注：图片是不需要启用 GZip 压缩的，从 GZip 检测结果来看，压缩后的图片体积竟然大过原 体积！这就解释了为什么图片不用启用 GZip 压缩的原因了！</p><p>可以检测了几个门户网站的图片，还有 Google、baidu 的图片，统统都没有启用图片 GZip 压缩，只是启用了 html、css、js 等文件的 GZip 压缩，这就更加说明了 GZip 压缩不适用于图 片上。另外，除了图片之外，flash 的 swf 文件也是不用启用 GZip 压缩的</p><h4 id=2）配置-mod-expires-模块><a class=header-anchor href=#2）配置-mod-expires-模块>¶</a>2）配置 mod_expires 模块</h4><p>这个非常有用的优化，mod_expires 可以减少 20-30%左右的重复请求，让重复的用户对指定 的页面请求结果都 CACHE 在本地，根本不向服务器发出请求。但要注意更新快的文件不要 这么做</p><p>这个模块控制服务器应答时的 Expires 头内容和 Cache-Control 头的 max-age 指令。有效期 (expiration date)可以设置为相对于源文件的最后修改时刻或者客户端的访问时刻。</p><p>未启用 expire 的效果：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line>[root@apache ~]<span class=comment># curl -I 192.168.1.70/12.png</span></span><br><span class=line>HTTP/1.1 200 OK</span><br><span class=line>Date: Tue, 09 Jun 2020 02:11:04 GMT</span><br><span class=line>Server: Apache/2.4.23 (Unix)</span><br><span class=line>Last-Modified: Sat, 28 Sep 2019 02:39:14 GMT</span><br><span class=line>ETag: <span class=string>"206701-59393e8841880"</span></span><br><span class=line>Accept-Ranges: bytes</span><br><span class=line>Content-Length: 2123521</span><br><span class=line>Content-Type: image/png</span><br></pre></td></tr></table></figure><h6 id=启用-expire-缓存：><a class=header-anchor href=#启用-expire-缓存：>¶</a>启用 expire 缓存：</h6><p>mod_expires 的安装配置：</p><p>启用 expires_module</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>LoadModule expires_module modules/mod_expires.so <span class=comment># 去掉注释</span></span><br></pre></td></tr></table></figure><p>然后添加 Expires 配置规则</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre></td><td class=code><pre><span class=line>&lt;IfModule mod_expires.c&gt;</span><br><span class=line>ExpiresActive On</span><br><span class=line>ExpiresByType text/css <span class=string>"now plus 1 month"</span></span><br><span class=line>ExpiresByType application/x-javascript <span class=string>"now plus 5 day"</span></span><br><span class=line>ExpiresByType image/jpeg <span class=string>"access plus 1 month"</span></span><br><span class=line>ExpiresByType image/gif <span class=string>"access plus 1 month"</span></span><br><span class=line>ExpiresByType image/bmp <span class=string>"access plus 1 month"</span></span><br><span class=line>ExpiresByType image/x-icon <span class=string>"access plus 1 month"</span></span><br><span class=line>ExpiresByType image/png <span class=string>"access plus 1 minute"</span></span><br><span class=line>ExpiresByType application/x-shockwave-flash <span class=string>"access plus 1 month"</span></span><br><span class=line>ExpiresDefault <span class=string>"now plus 0 minute"</span></span><br><span class=line>&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure><p>语法：</p><ul><li>ExpiresByType：定义缓存页面</li><li>text/html：指定缓存界面的类型</li><li>A60：缓存页面的时间</li><li>ExpireActive On：开启缓存功能</li><li>ExpiresByType text/html M60：页面最后一次修改缓存60</li><li>ExpiresByType image/png A60：图片缓存，和ExpiresByType image/png &quot;access plus 1 month&quot;意思相同</li><li>ExpiresDefault “now plus 0 minute”：其他页面不进行缓存</li></ul><p>验证：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre></td><td class=code><pre><span class=line>[root@apache ~]<span class=comment># curl -I 192.168.1.70/12.png</span></span><br><span class=line>HTTP/1.1 200 OK</span><br><span class=line>Date: Tue, 09 Jun 2020 02:14:55 GMT</span><br><span class=line>Server: Apache/2.4.23 (Unix)</span><br><span class=line>Last-Modified: Sat, 28 Sep 2019 02:39:14 GMT</span><br><span class=line>ETag: <span class=string>"206701-59393e8841880"</span></span><br><span class=line>Accept-Ranges: bytes</span><br><span class=line>Content-Length: 2123521</span><br><span class=line>Cache-Control: max-age=60</span><br><span class=line>Expires: Tue, 09 Jun 2020 02:15:55 GMT</span><br><span class=line>Content-Type: image/png</span><br></pre></td></tr></table></figure><p>ExpiresDefault 和 ExpiresByType 指令同样能够用易懂的语法格式进行定义：</p><blockquote><p>ExpiresDefault &quot; [plus] {}&quot;</p><p>ExpiresByType type/encoding &quot; [plus] {}&quot;</p></blockquote><p>其中bash是下列之一：</p><ul><li>access</li><li>now (等价于’access ')</li><li>modification</li></ul><p>plus 关键字是可选的。num必须是整数，type是下列之一</p><ul><li>years</li><li>moths</li><li>weeks</li><li>days</li><li>hours</li><li>minutes</li><li>seconds</li></ul><p>例如，下列 3 个指令都表示文档默认的有效期是一个月：</p><blockquote><p>ExpiresDefault “access plus 1 month”</p><p>ExpiresDefault “access plus 4 weeks”</p><p>ExpiresDefault “access plus 30 days”</p></blockquote><p>有效期可以通过增加&quot;num type&quot;子句进一步调整</p><blockquote><p>ExpiresByType text/html “access plus 1 month 15 days 2 hours”</p><p>ExpiresByType image/gif “modification plus 5 hours 3 minutes”</p></blockquote><p>注意，如果你使用基于最后修改日期的设置，&quot;Expires:&quot;头将不会 被添加到那些并非来自于 磁盘文件的内容。这是因为这些内容并不存在&quot;最后修改时间&quot;的属性</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line><span class=comment># GIF 有效期为 1 个月（秒数）</span></span><br><span class=line>ExpiresByType image/gif A2592000</span><br><span class=line>ExpiresByType image/jpeg A2592000</span><br><span class=line>ExpiresByType image/png A2592000</span><br><span class=line>ExpiresByType image/x-icon A2592000</span><br><span class=line>ExpiresByType application/x-javascript A604800</span><br><span class=line>ExpiresByType text/plain A604800</span><br><span class=line><span class=comment># HTML 文档的有效期是最后修改时刻后的一星期</span></span><br><span class=line>ExpiresByType text/html M604800</span><br><span class=line>&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure><p>&quot;M&quot;表示源文件的最后修改时刻，&quot;A&quot;表示客户端对源文件的访问时刻。后面的时间则以秒计 算</p><p>有关 Apache Expires Module 的介绍，可以参阅其<a href=http://httpd.apache.org/docs/2.4/mod/mod_expires.html target=_blank rel=noopener>官方文档</a>:</p><h4 id=3）Apache禁止目录遍历><a class=header-anchor href=#3）Apache禁止目录遍历>¶</a>3）Apache禁止目录遍历</h4><p>未禁用的效果：<br><img data-src="https://img-blog.csdnimg.cn/20200609130341874.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><p>将 Options Indexes FollowSymLinks 中的 Indexes 去掉，就可以禁止 Apache 显示该目录结构。</p><p>Indexes 的作用就是当该目录下没有 index.html 文件时，就显示目录结构</p><p>在配置文件（httpd.conf）中搜索Options，找到Options Indexes FollowSymLinks 并修改为Options FollowSymLinks</p><p>重启服务验证：<br><img data-src=https://img-blog.csdnimg.cn/20200609130353734.png></p><h4 id=4）Apache隐藏版本信息><a class=header-anchor href=#4）Apache隐藏版本信息>¶</a>4）Apache隐藏版本信息</h4><p>测试默认 apache 的状态信息</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@apache ~]<span class=comment># curl -I 192.168.1.70</span></span><br><span class=line>HTTP/1.1 403 Forbidden</span><br><span class=line>Date: Tue, 09 Jun 2020 02:29:20 GMT</span><br><span class=line>Server: Apache/2.4.23 (Unix) <span class=comment># 版本信息直接暴露</span></span><br><span class=line>Content-Type: text/html; charset=iso-8859-1</span><br></pre></td></tr></table></figure><h5 id=1、主配置中启用httpd-default-conf><a class=header-anchor href=#1、主配置中启用httpd-default-conf>¶</a>1、主配置中启用httpd-default.conf</h5><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>Include conf/extra/httpd-default.conf  <span class=comment># 去掉注释</span></span><br></pre></td></tr></table></figure><h5 id=2、修改-httpd-default-conf><a class=header-anchor href=#2、修改-httpd-default-conf>¶</a>2、修改 httpd-default.conf</h5><p>文件：/usr/local/http-2.4.23/conf/extra/httpd-default.conf</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>找到</span><br><span class=line>ServerTokens Full</span><br><span class=line>ServerSignature On</span><br><span class=line>改成</span><br><span class=line>ServerTokens Prod</span><br><span class=line>ServerSignature Off</span><br></pre></td></tr></table></figure><p>重启 apache 测试</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>[root@apache ~]<span class=comment># apachectl restart</span></span><br><span class=line>[root@apache ~]<span class=comment># curl -I 192.168.1.70</span></span><br><span class=line>HTTP/1.1 403 Forbidden</span><br><span class=line>Date: Tue, 09 Jun 2020 02:34:30 GMT</span><br><span class=line>Server: Apache</span><br><span class=line>Content-Type: text/html; charset=iso-8859-1</span><br></pre></td></tr></table></figure><p>如果你需要彻底将版本之类的信息进行改头换面，你就需要在编译之前做准备或者进行从新 编译了。在重新编译时，修改源码包下 include 目录下的 ap_release.h 文件</p><p>#define AP_SERVER_BASEVENDOR “Apache Software Foundation” #服务的供应商名称</p><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>#define AP_SERVER_BASEPROJECT “Apache HTTP Server” #服务的项目名称</span><br><span class=line>#define AP_SERVER_BASEPRODUCT “Apache” #服务的产品名</span><br><span class=line>#define AP_SERVER_MAJORVERSION_NUMBER 2 #主要版本号</span><br><span class=line>#define AP_SERVER_MINORVERSION_NUMBER 4 #小版本号</span><br><span class=line>#define AP_SERVER_PATCHLEVEL_NUMBER 23 #补丁级别</span><br><span class=line>#define AP_SERVER_DEVBUILD_BOOLEAN 0 #</span><br></pre></td></tr></table></figure><p>上述列出的行，已经给出了注释，大家可以修改成自己想要的，然后编译安装之后，对方就彻底不知道你的版本号了</p><h4 id=5）Apache日志分割><a class=header-anchor href=#5）Apache日志分割>¶</a>5）Apache日志分割</h4><h5 id=为什么要分割日志><a class=header-anchor href=#为什么要分割日志>¶</a>为什么要分割日志</h5><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>随着网站的访问越来越大，WebServer 产生的日志文件也会越来越大，如果不对日志进行分 割，那么只能一次将大的日志(如 Apache 的日志)整个删除，这样也丢失了很多对网站比较 宝贵的信息，因为这些日志可以用来进行访问分析、网络安全监察、网络运行状况监控等， 因此管理好这些海量的日志对网站的意义是很大的</span><br></pre></td></tr></table></figure><h5 id=方法-1-使用-rotatelogs（apache-自带的工具）每隔一天记录一个日志><a class=header-anchor href=#方法-1-使用-rotatelogs（apache-自带的工具）每隔一天记录一个日志>¶</a>方法 1:使用 rotatelogs（apache 自带的工具）每隔一天记录一个日志</h5><p>编辑Apache 的主配置文件，更改内容如下：</p><p>注释掉如下两行</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>ErrorLog <span class=string>"logs/error_log"</span></span><br><span class=line>CustomLog <span class=string>"logs/access_log"</span> common</span><br></pre></td></tr></table></figure><p>然后添加如下两行</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>ErrorLog <span class=string>"|/usr/local/http-2.4.23/bin/rotatelogs -l logs/error_%Y%m%d.log 86400"</span></span><br><span class=line>CustomLog <span class=string>"|/usr/local/http-2.4.23/bin/rotatelogs -l logs/access_%Y%m%d.log 86400"</span> combined</span><br></pre></td></tr></table></figure><p>注：其中 86400 为轮转的时间单位为秒</p><p>注：rotatelogs这个要写绝对路径，可以使用which来查询它的路径</p><p>验证：查看 logs 目录下的日志文件</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@apache ~]<span class=comment># ls /usr/local/http-2.4.23/logs/</span></span><br><span class=line>access_20200609.log  access_log  deflate_log.log  error_20200609.log  error_log  httpd.pid</span><br></pre></td></tr></table></figure><p>由于 apache 自带的日志轮询工具 rotatelogs，据说在进行日志切割时容易丢日志，因此我们 通常使用 cronolog 进行日志轮询</p><h5 id=方法-2、使用-cronolog-为每一天建立一个新的日志><a class=header-anchor href=#方法-2、使用-cronolog-为每一天建立一个新的日志>¶</a>方法 2、使用 cronolog 为每一天建立一个新的日志</h5><p>安装 cronolog 程序</p><p>下载 <a href=https://pan.baidu.com/s/1N7qCgA7KESqS_Tdp4tU-dg target=_blank rel=noopener>cronolog</a><br>提取码：uzra</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>[root@apache ~]<span class=comment># tar zxf cronolog-1.6.2.tar.gz </span></span><br><span class=line>[root@apache ~]<span class=comment># cd cronolog-1.6.2/</span></span><br><span class=line>[root@apache cronolog-1.6.2]<span class=comment># ./configure &amp;&amp; make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><p>主配置文件中的使用方法，添加如下两行</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>ErrorLog <span class=string>"|/usr/local/sbin/cronolog logs/error-%Y%m%d.log"</span> </span><br><span class=line>CustomLog <span class=string>"|/usr/local/sbin/cronolog logs/access-%Y%m%d.log"</span> combined</span><br></pre></td></tr></table></figure><p>如果 Apache 中有多个虚拟主机，最好每个虚拟主机中放置一个这样的代码，并将日志文件 名改成不同的名字</p><p>扩展：</p><p>这个保证了每天一个文件夹文件夹下每个小时产生一个 log</p><blockquote><p>CustomLog “|/usr/local/sbin/cronolog logs /%Y%m%d/access_log.%H” combined</p></blockquote><p>按天轮询（生产环境常见用法，推荐使用）：</p><blockquote><p>CustomLog “|/usr/local/sbin/cronolog logs/access_www_%Y%m%d.log” combined</p></blockquote><p>按小时轮询（生产环境较常见用法）：</p><blockquote><p>CustomLog “|/usr/local/sbin/cronolog logs /access_www_ %Y%m%d%H.log” combined</p></blockquote><p>验证：查看 logs 目录下的日志文件</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>[root@apache ~]<span class=comment># ls /usr/local/http-2.4.23/logs/</span></span><br><span class=line>access_20200609.log  access_log       error_20200609.log  error_log</span><br><span class=line>access-20200609.log  deflate_log.log  error-20200609.log  httpd.pid</span><br></pre></td></tr></table></figure><p>注意： 这两个管道日志文件程序还有一点不同之处是使用 cronolog 时如果日志是放在某个不存 在的路径则会自动创建目录，而使用 rotatelogs 时不能自动创建，这一点要特别注意</p><h4 id=6）配置防盗链><a class=header-anchor href=#6）配置防盗链>¶</a>6）配置防盗链</h4><p>有时候，你的网站莫名其妙的访问量变大，不要高兴的太早，有可能是被别人盗链了。 举个例子：比如你搭了个 discuz 论坛，里面有些热点图片、视频；然后别人将他网站上访问 图片的地址重定向到你的 discuz 上，这样他的服务器就可以空闲出来了；也就是说别人访问 他网站的图片视频，消耗的确是你服务器的资源</p><p>解决这个问题的方法是配置下防盗链，让外来的盗不了链</p><h5 id=方法-1：Apache-防盗链的第一种实现方法，可以用-rewrite-实现><a class=header-anchor href=#方法-1：Apache-防盗链的第一种实现方法，可以用-rewrite-实现>¶</a>方法 1：Apache 防盗链的第一种实现方法，可以用 rewrite 实现</h5><p>打开 httpd.conf，确保有这么一行配置:</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>LoadModule rewrite_module modules/mod_rewrite.so <span class=comment># 去掉注释</span></span><br></pre></td></tr></table></figure><p>防盗链配置</p><p>在<code>&lt;Directory &quot;/usr/local/http-2.4.23/htdocs&quot;&gt;</code>这个区域下添加</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>RewriteEngine On</span><br><span class=line>RewriteCond %&#123;HTTP_REFERER&#125; !^$</span><br><span class=line>RewriteCond %&#123;HTTP_REFERER&#125; !^http://192.168.1.70/.*$ [NC]</span><br><span class=line>RewriteCond %&#123;HTTP_REFERER&#125; !^http://192.168.1.70$ [NC]</span><br><span class=line>RewriteCond %&#123;HTTP_REFERER&#125; !^http://192.168.1.70/.*$ [NC]</span><br><span class=line>RewriteCond %&#123;HTTP_REFERER&#125; !^http://192.168.1.70$ [NC]</span><br><span class=line>RewriteRule .*\.(gif|jpg|swf)<span class=variable>$http</span>://192.168.1.70/image/error.png[R,NC,L]</span><br></pre></td></tr></table></figure><p>注：相关选项的解释</p><ul><li>RewriteEngine On：</li></ul><blockquote><p>启用 rewrite，要想 rewrite 起作用，必须要写上</p></blockquote><ul><li>RewriteCond test-string condPattern ：</li></ul><blockquote><p>写在 RewriteRule 之前，可以有一或 N 条，用于测试 rewrite 的匹配条件，具体怎么写，后面会详细说到</p></blockquote><ul><li>RewriteRule Pattern Substitution：</li></ul><blockquote><p>规则</p></blockquote><ul><li>%{HTTP_REFERER}：</li></ul><blockquote><p>服务器变量，HTTPReferer 是 header 的一部分，当浏览器向 web 服务器发送请求的时候，一般会带上 Referer，告诉服务器我是从哪个页面链接过来的，服 务器藉此可以获得一些信息用于处理。比如从我主页上链接到一个朋友那里，他的服务器就 能够从 HTTP Referer 中统计出每天有多少用户点击我主页上的链接访问他的网站</p></blockquote><ul><li>[ NC]：</li></ul><blockquote><p>指的是不区分大小写,[R]强制重定向 redirect</p></blockquote><ul><li>字母 L 表示如果能匹配本条规则，那么本条规则是最后一条(Last)，忽略之后的规则</li></ul><p>防盗链配置的说明：</p><p><strong>192.168.1.70：</strong></p><blockquote><p>表示自己的信任站点，如果有域名的可以写域名</p></blockquote><p><strong>gif|jpg|swf：</strong></p><blockquote><p>要保护文件的扩展名(以|分开)。以这些为扩展名的文件，必须通过红色标注的网址引用， 才可以访问</p></blockquote><p><strong>192.168.1.70/image/error.png：</strong></p><blockquote><p>定义被盗链时替代的图片，让所有盗链 jpg、gif、swf 等文件的网页，显示网页文档根目 录下的 image/ error.png 文件。注意：替换显示的图片不要放在设置防盗链的目录中，并且该图片文件体积越小越好。当然你也可以不设置替换图片，而是使用下面的语句即可：RewriteRule .*.(gif|jpg|png)$ - [F]</p></blockquote><p>注：[F] (强制 URL 为被禁止的 forbidden),强制当前 URL 为被禁止的，即，立即反馈一 个 HTTP 响应代码 403(被禁止的)</p><h6 id=验证><a class=header-anchor href=#验证>¶</a>验证</h6><p>再打开一个虚拟机（192.168.1.50），验证防盗链是否配置成功：</p><p>1、安装一个httpd服务：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@localhost ~]<span class=comment># yum -y install httpd</span></span><br></pre></td></tr></table></figure><p>2、模拟web页面：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@localhost ~]<span class=comment># vim /var/www/html/index.html</span></span><br><span class=line>&lt;a  href=<span class=string>"http://192.168.1.70/12.png"</span>&gt;lianjie&lt;/a&gt;</span><br></pre></td></tr></table></figure><p><img data-src="https://img-blog.csdnimg.cn/20200609130430605.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><br><img data-src="https://img-blog.csdnimg.cn/20200609130444922.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><h5 id=方法-2><a class=header-anchor href=#方法-2>¶</a>方法 2</h5><p>通过判断浏览器头信息来阻止某些请求，即利用 SetEnvIfNoCase 和 access。</p><p>这个方法可以通过阻止某些机器人或蜘蛛爬虫抓取你的网站来节省你的带宽流量</p><p>语法: SetEnvIfNoCase attribute regex [!]env-variable[=value] [[!]env-variable[=value]] … SetEnvIfNoCase 当满足某个条件时，为变量赋值，即根据客户端请求属性设置环境变量</p><p>注：Referer ：指明了请求当前资源原始资源的 URL，使用 referer 是可以防盗链 然后在找到自己网站对应的配置的地方（如在主配置文件中或虚拟主机中），加入下列代码：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>SetEnvIfNoCase Referer <span class=string>"^$"</span> local_ref</span><br><span class=line>SetEnvIfNoCase Referer<span class=string>"^http://www.benet.com/.*$"</span> local_ref</span><br><span class=line>SetEnvIfNoCase Referer<span class=string>"^http://benet.com/.*$"</span>local_ref</span><br><span class=line>&lt;filesmatch<span class=string>"\.(mp3|mp4|zip|rar|jpg|gif|png)"</span>&gt;</span><br></pre></td></tr></table></figure><p>2.4 版本以下的：</p><p>方法一：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>Order Deny,Allow</span><br><span class=line>Allow from env=local_ref</span><br><span class=line>Deny from all</span><br></pre></td></tr></table></figure><p>方法二：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>Order Allow,Deny</span><br><span class=line>Allow from env=local_ref</span><br></pre></td></tr></table></figure><p>2.4 版本以上，方法如下：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>Require all denied</span><br><span class=line> Require env local_ref</span><br><span class=line>&lt;/filesmatch&gt;</span><br></pre></td></tr></table></figure></div><div><ul class=post-copyright><li class=post-copyright-author><strong>本文作者：</strong>Maisy</li><li class=post-copyright-link><strong>本文链接：</strong> <a href=https://pdxblog.top/Apache%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%8C%96.html title=Apache深度优化>https://pdxblog.top/Apache深度优化.html</a></li><li class=post-copyright-license><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel=noopener target=_blank><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class=post-footer><div class=post-tags><a href="/tags/%E6%9E%B6%E6%9E%84/" rel=tag># 架构</a></div><div class=post-nav><div class=post-nav-item><a href=/Apache%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F.html rel=prev title=Apache安装部署及工作模式><i class="fa fa-chevron-left"></i> Apache安装部署及工作模式</a></div><div class=post-nav-item><a href=/Apache%E4%B9%8BFCGI%E6%A8%A1%E5%BC%8F%E9%83%A8%E7%BD%B2LAMP.html rel=next title=Apache之FCGI模式部署LAMP>Apache之FCGI模式部署LAMP <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class=comments id=valine-comments></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class=nav><li class="nav-item nav-level-3"><a class=nav-link href=#Apache深度优化><span class=nav-number>1.</span> <span class=nav-text>¶Apache深度优化</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1）开启apache的Gzip（defate）功能><span class=nav-number>1.1.</span> <span class=nav-text>¶1）开启apache的Gzip（defate）功能</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#mod-deflate-模块检查及安装><span class=nav-number>1.1.1.</span> <span class=nav-text>¶mod_deflate 模块检查及安装</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#a、编译时安装方法><span class=nav-number>1.1.1.1.</span> <span class=nav-text>¶a、编译时安装方法</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#b、DSO方式安装><span class=nav-number>1.1.1.2.</span> <span class=nav-text>¶b、DSO方式安装</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#在添加压缩级别等参数：><span class=nav-number>1.1.1.3.</span> <span class=nav-text>¶在添加压缩级别等参数：</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#设置日志输出><span class=nav-number>1.1.1.4.</span> <span class=nav-text>¶设置日志输出</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#2）配置-mod-expires-模块><span class=nav-number>1.2.</span> <span class=nav-text>¶2）配置 mod_expires 模块</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#启用-expire-缓存：><span class=nav-number>1.2.0.1.</span> <span class=nav-text>¶启用 expire 缓存：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#3）Apache禁止目录遍历><span class=nav-number>1.3.</span> <span class=nav-text>¶3）Apache禁止目录遍历</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#4）Apache隐藏版本信息><span class=nav-number>1.4.</span> <span class=nav-text>¶4）Apache隐藏版本信息</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#1、主配置中启用httpd-default-conf><span class=nav-number>1.4.1.</span> <span class=nav-text>¶1、主配置中启用httpd-default.conf</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#2、修改-httpd-default-conf><span class=nav-number>1.4.2.</span> <span class=nav-text>¶2、修改 httpd-default.conf</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#5）Apache日志分割><span class=nav-number>1.5.</span> <span class=nav-text>¶5）Apache日志分割</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#为什么要分割日志><span class=nav-number>1.5.1.</span> <span class=nav-text>¶为什么要分割日志</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#方法-1-使用-rotatelogs（apache-自带的工具）每隔一天记录一个日志><span class=nav-number>1.5.2.</span> <span class=nav-text>¶方法 1:使用 rotatelogs（apache 自带的工具）每隔一天记录一个日志</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#方法-2、使用-cronolog-为每一天建立一个新的日志><span class=nav-number>1.5.3.</span> <span class=nav-text>¶方法 2、使用 cronolog 为每一天建立一个新的日志</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#6）配置防盗链><span class=nav-number>1.6.</span> <span class=nav-text>¶6）配置防盗链</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#方法-1：Apache-防盗链的第一种实现方法，可以用-rewrite-实现><span class=nav-number>1.6.1.</span> <span class=nav-text>¶方法 1：Apache 防盗链的第一种实现方法，可以用 rewrite 实现</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#验证><span class=nav-number>1.6.1.1.</span> <span class=nav-text>¶验证</span></a></li></ol></li><li class="nav-item nav-level-5"><a class=nav-link href=#方法-2><span class=nav-number>1.6.2.</span> <span class=nav-text>¶方法 2</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Maisy src=/images/author.jpg><p class=site-author-name itemprop=name>Maisy</p><div class=site-description itemprop=description>人的一生就是一个储蓄的过程，在奋斗的时候储存了希望；在耕耘的时候储存了一粒种子；在旅行的时候储存了风景；在微笑的时候储存了快乐。聪明的人善于储蓄，在漫长而短暂的人生旅途中，学会储蓄每一个闪光的瞬间，然后用它们酿成一杯美好的回忆，在四季的变幻与交替之间，散发浓香，珍藏一生</div></div><div class="site-state-wrap motion-element"><nav class=site-state><div class="site-state-item site-state-posts"><a href="/archives/"><span class=site-state-item-count>57</span> <span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class=site-state-item-count>6</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class=site-state-item-count>6</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/Gilbert2/Gilbert2.github.io title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Gilbert2&#x2F;Gilbert2.github.io" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a></span> <span class=links-of-author-item><a href=https://blog.csdn.net/weixin_45636702 title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_45636702" rel=noopener target=_blank><i class="fab fa-crosshairs fa-fw"></i>CSDN</a></span></div><div class="cc-license motion-element" itemprop=license><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class=cc-opacity rel=noopener target=_blank><img src=/images/cc-by-nc-sa.svg alt="Creative Commons"></a></div></div></div></aside><div id=sidebar-dimmer></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy; 2019 – <span itemprop=copyrightYear>2020</span> <span class=with-love><i class="fa fa-heart"></i></span> <span class=author itemprop=copyrightHolder>Maisy</span> <span class=post-meta-divider>|</span> <span class=post-meta-item-icon><i class="fa fa-chart-area"></i></span> <span class=post-meta-item-text>站点总字数：</span> <span title=站点总字数>369k</span> <span class=post-meta-divider>|</span> <span class=post-meta-item-icon><i class="fa fa-coffee"></i></span> <span class=post-meta-item-text>站点阅读时长 &asymp;</span> <span title=站点阅读时长>5:35</span></div><div class=powered-by>由 <a href="https://hexo.io/" class=theme-link rel=noopener target=_blank>Hexo</a> & <a href="https://muse.theme-next.org/" class=theme-link rel=noopener target=_blank>NexT.Muse</a> 强力驱动</div></div></footer></div><script src=/lib/anime.min.js></script><script src=//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js></script><script src=//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js></script><script src=//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js></script><script src=/lib/velocity/velocity.min.js></script><script src=/lib/velocity/velocity.ui.min.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/schemes/muse.js></script><script src=/js/next-boot.js></script><script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script><script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.3.9/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'yK6nF3Ng27WevBtHAbTkt8Jv-gzGzoHsz',
      appKey     : 'DXAxzx0igQL9KzyblmtXnVkh',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script></body></html>