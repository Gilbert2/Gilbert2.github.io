<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>派大星の博客</title>
  
  <subtitle>记录生活中的点点滴滴</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-02-14T03:25:48.428Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>派大星</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>StatefulSet</title>
    <link href="http://yoursite.com/2020/02/12/StatefulSet/"/>
    <id>http://yoursite.com/2020/02/12/StatefulSet/</id>
    <published>2020-02-11T16:00:00.000Z</published>
    <updated>2020-02-14T03:25:48.428Z</updated>
    
    <content type="html"><![CDATA[<h2 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h2><p>RC、RS、Deployment、DS（DaemonSet）这些Pod控制器都是面向无状态的服务，它们所管理的Pod的IP、名字、启停顺序等都是随机的</p><p>这些Pod控制器都有一个相同点    </p><blockquote><p>​    <strong>template（模板）：根据模板创建出来的Pod，它们的状态都是一摸一样的（除了名称、IP、域名之外）</strong></p><p>​    <strong>可以理解为：任何一个Pod都可以被删除，然后用新生成的Pod进行替换</strong></p></blockquote><p><strong>StatefulSet：</strong></p><p>顾名思义：有状态的集合，管理所有有状态的服务，比如MySQL、MongoDB集群等</p><p>它之前的名字是：PetSet</p><p>Pet：宠物</p><p>把之前按无状态的服务比喻为牛、羊等牲畜。把有状态的服务比喻为：宠物</p><p>StatefulSet本质上是Deployment的一种变体，在v1.9版本中已成为<strong>GA</strong>版本，它为了解决有状态服务的问题，它所管理的Pod拥有固定的Pod名称，启停顺序，在StatefulSet中，Pod名字称为网络标识(hostname)，还必须要用到共享存储</p><blockquote><p><strong>有状态的服务：后端生成的每一个Pod都具有自己的唯一性，不可随意被删除</strong></p><p><strong>需要记录前一次或者多次通信中的相关事件，以作为下一次通信的分类标准。比如：mysql等数据库服务。（Pod的名称不能随意变化，数据持久化的目录也是不一样的，每一个Pod都有自己独有的数据持久化存储目录）</strong></p></blockquote><p>一个小实例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span>  <span class="string">statefulset.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">headless-svc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">headless-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">headless-pod</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">statefulset-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">headless-svc</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">headless-pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">headless-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myhttpd</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">apply</span>  <span class="string">-f</span>  <span class="string">statefulset.yaml</span> </span><br><span class="line"><span class="string">service/headless-svc</span> <span class="string">created</span></span><br><span class="line"><span class="string">statefulset.apps/statefulset-test</span> <span class="string">created</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">svc</span></span><br><span class="line"><span class="string">NAME</span>           <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>   <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">headless-svc</span>   <span class="string">ClusterIP</span>   <span class="string">None</span>         <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">/TCP</span>    <span class="string">4m</span></span><br></pre></td></tr></table></figure><p>Deployment控制的pod的名称由来：</p><p>​    Deployment+RS+随机字符串（Pod的名称），没有顺序的额，可以被随意替代</p><p>StategulSet的三个组成部分：</p><p>1、headless-svc：无头服务。因为没有IP地址，所以它不具备负载均衡的功能了</p><p>作用：为后端的每一个Pod去命名</p><p>因为statefulset要求Pod的名称是有顺序的，每一个Pod都不能被随意取代，也就是说即使Pod重建之后，名称依然不变</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  get pod</span><br><span class="line">NAME                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">statefulset-test-0   1/1     Running   0          23m</span><br><span class="line">statefulset-test-1   1/1     Running   0          22m</span><br><span class="line">statefulset-test-2   1/1     Running   0          22m</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  delete  pod  statefulset-test-0</span><br><span class="line">[root@master ~]# kubectl  get pod</span><br><span class="line">NAME                 READY   STATUS              RESTARTS   AGE</span><br><span class="line">statefulset-test-0   0/1     ContainerCreating   0          6s</span><br><span class="line">statefulset-test-1   1/1     Running             0          25m</span><br><span class="line">statefulset-test-2   1/1     Running             0          25m</span><br><span class="line">//Pod重建之后名称没有发生变化</span><br></pre></td></tr></table></figure><p>2、statefulset：定义具体的应用</p><p>3、volumeClaimTeplates：自动创建PVC，为后端的Pod提供专有的存储</p><p>存储卷申请模板，创建PVC，指定pvc名称大小，将自动创建pvc，且pvc必须由存储类供应</p><blockquote><p><strong>为什么需要 headless service 无头服务？</strong><br>在用Deployment时，每一个Pod名称是没有顺序的，是随机字符串，因此是Pod名称是无序的，但是在statefulset中要求必须是有序 ，每一个pod不能被随意取代，pod重建后pod名称还是一样的。而pod IP是变化的，所以是以Pod名称来识别。pod名称是pod唯一性的标识符，必须持久稳定有效。这时候要用到无头服务，它可以给每个Pod一个唯一的名称 。<br><strong>为什么需要volumeClaimTemplate？</strong><br>对于有状态的副本集都会用到持久存储，对于分布式系统来讲，它的最大特点是数据是不一样的，所以各个节点不能使用同一存储卷，每个节点有自已的专用存储，但是如果在Deployment中的Pod template里定义的存储卷，是所有副本集共用一个存储卷，数据是相同的，因为是基于模板来的 ，而statefulset中每个Pod都要自已的专有存储卷，所以statefulset的存储卷就不能再用Pod模板来创建了，于是statefulSet使用volumeClaimTemplate，称为卷申请模板，它会为每个Pod生成不同的pvc，并绑定pv， 从而实现各pod有专用存储。这就是为什么要用volumeClaimTemplate的原因</p></blockquote><p>每一个pod—&gt;对应一个pvc—-&gt;每一个pvc对应一个pv</p><p>​    storageclass：自动创建PV</p><p>​    需要解决：自动创建PVC—–&gt;volumeClaimTeplates</p><p>一、创建StorageClass资源对象</p><p>​    1、基于NFS服务，创建NFS服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# showmount  -e</span><br><span class="line">Export list for master:</span><br><span class="line">/nfsdata *</span><br></pre></td></tr></table></figure><p>​    2、创建rbac权限</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">rbac-rolebind.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["persistentvolumes"]</span></span><br><span class="line">      <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"delete"</span><span class="string">]</span></span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["persistentvolumeclaims"]</span></span><br><span class="line">      <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> <span class="string">["storage.k8s.io"]</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["storageclasses"]</span></span><br><span class="line">      <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["events"]</span></span><br><span class="line">      <span class="attr">verbs:</span> <span class="string">["watch",</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["services",</span> <span class="string">"endpoints"</span><span class="string">]</span></span><br><span class="line">      <span class="attr">verbs:</span> <span class="string">["get","create","list",</span> <span class="string">"watch"</span><span class="string">,"update"]</span></span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> <span class="string">["extensions"]</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["podsecuritypolicies"]</span></span><br><span class="line">      <span class="attr">resourceNames:</span> <span class="string">["nfs-provisioner"]</span></span><br><span class="line">      <span class="attr">verbs:</span> <span class="string">["use"]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span>  <span class="string">default</span>   <span class="string">//这个字段必须要写，不然会报错</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span>  <span class="string">rbac-rolebind.yaml</span> </span><br><span class="line"><span class="string">serviceaccount/nfs-provisioner</span> <span class="string">unchanged</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/nfs-provisioner-runner</span> <span class="string">unchanged</span></span><br><span class="line"><span class="string">clusterrolebinding.rbac.authorization.k8s.io/run-nfs-provisioner</span> <span class="string">created</span></span><br></pre></td></tr></table></figure><p>​    3、创建Deployment资源对象，用Pod代替真正的NFS服务</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">nfs-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/open-ali/nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span>  <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">bdqn</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.70</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/nfsdata</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.70</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/nfsdata</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">apply</span>  <span class="string">-f</span> <span class="string">nfs-deployment.yaml</span> </span><br><span class="line"><span class="string">deployment.extensions/nfs-client-provisioner</span> <span class="string">created</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">pod</span></span><br><span class="line"><span class="string">NAME</span>                                     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nfs-client-provisioner-f6cb6688b-5zn8d</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">7s</span></span><br></pre></td></tr></table></figure><p>​    4、创建storaclass</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">test-storageclass.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sc-nfs</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">bdqn</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">apply</span>  <span class="string">-f</span>  <span class="string">test-storageclass.yaml</span> </span><br><span class="line"><span class="string">storageclass.storage.k8s.io/sc-nfs</span> <span class="string">created</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">sc</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">PROVISIONER</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">sc-nfs</span>   <span class="string">bdqn</span>          <span class="string">10s</span></span><br></pre></td></tr></table></figure><p>二、解决自动创建PVC</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span>  <span class="string">statefulset.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">headless-svc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">headless-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">headless-pod</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">statefulset-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">headless-svc</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">headless-pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">headless-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">myhttpd</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mnt</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span>  <span class="string">//自动的创建PVC</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">annotations:</span>   <span class="string">//这是指定storageclass</span></span><br><span class="line">        <span class="attr">volume.beta.kubernetes.io/storage-class:</span> <span class="string">sc-nfs</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">100Mi</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">apply</span>  <span class="string">-f</span>  <span class="string">statefulset.yaml</span> </span><br><span class="line"><span class="string">service/headless-svc</span> <span class="string">created</span></span><br><span class="line"><span class="string">statefulset.apps/statefulset-test</span> <span class="string">created</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">pod</span></span><br><span class="line"><span class="string">NAME</span>                                     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nfs-client-provisioner-f6cb6688b-5zn8d</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">13m</span></span><br><span class="line"><span class="string">statefulset-test-0</span>                       <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">23s</span></span><br><span class="line"><span class="string">statefulset-test-1</span>                       <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">16s</span></span><br><span class="line"><span class="string">statefulset-test-2</span>                       <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">9s</span></span><br></pre></td></tr></table></figure><p>注意：</p><p>​    如果生成的Pod，第一个出现了问题，后面的都不会生成</p><p>根据volumeClaimTemplates自动创建的PVC：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  get pvc</span><br><span class="line">NAME                      STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">test-statefulset-test-0   Bound    pvc-3a105a9d-5892-4080-a993-20fd2540cd3e   100Mi      RWO            sc-nfs         46m</span><br><span class="line">test-statefulset-test-1   Bound    pvc-123bf53d-a72b-4bfa-a901-bb98efcda056   100Mi      RWO            sc-nfs         45m</span><br><span class="line">test-statefulset-test-2   Bound    pvc-8529c668-5b38-4024-93af-b18fa238b0ba   100Mi      RWO            sc-nfs         45m</span><br></pre></td></tr></table></figure><blockquote><p>如果集群中没有StorageClass的动态供应PVC的机制，也可以提前手动创建多个PV、PVC，手动创建的PVC名称必须符合之后创建的StatefulSet命名规则：<strong>(volumeClaimTemplates.name)-(pod_name)</strong></p></blockquote><blockquote><p>Statefulset名称为statefulset-test  </p><p>三个Pod副本: statefulset-test-0，statefulset-test-1，statefulset-test-2</p><p>volumeClaimTemplates名称为：test</p><p>那么自动创建出来的PVC名称为test-statefulset-test-[0-2]，为每个Pod创建一个PVC</p></blockquote><p><strong>规律总结：</strong></p><blockquote><ul><li>匹配Pod name(网络标识)的模式为：<strong>$(statefulset名称)-$(序号)</strong>，比如上面的示例：statefulset-test-0，statefulset-test-1，statefulset-test-2。</li><li>StatefulSet为每个Pod副本创建了一个DNS域名，这个域名的格式为： <strong>$(podname).(headless server name)</strong>，也就意味着服务间是通过Pod域名来通信而非Pod IP，因为当Pod所在Node发生故障时，Pod会被飘移到其它Node上，Pod IP会发生变化，但是Pod域名不会有变化。</li><li>StatefulSet使用Headless服务来控制Pod的域名，这个域名的FQDN为：<strong>$(service name).$(namespace).svc.cluster.local</strong>，其中，“cluster.local”指的是集群的域名。</li><li>根据volumeClaimTemplates，为每个Pod创建一个pvc，pvc的命名规则匹配模式：<strong>(volumeClaimTemplates.name)-(pod_name)</strong>，比如上面的volumeMounts.name=test， Pod name=statefulset-test-[0-2]，因此创建出来的PVC是test-statefulset-test-0，test-statefulset-test-1，test-statefulset-test-2</li><li>删除Pod不会删除其pvc，手动删除pvc将自动释放pv。<br>关于Cluster Domain、headless service名称、StatefulSet 名称如何影响StatefulSet的Pod的</li></ul></blockquote><p><strong>StatefulSet的启停顺序：</strong></p><blockquote><ul><li>有序部署：部署StatefulSet时，如果有多个Pod副本，它们会被顺序地创建（从0到N-1）并且，在下一个Pod运行之前所有之前的Pod必须都是Running和Ready状态。</li><li>有序删除：当Pod被删除时，它们被终止的顺序是从N-1到0。</li><li>有序扩展：当对Pod执行扩展操作时，与部署一样，它前面的Pod必须都处于Running和Ready状态</li></ul></blockquote><p><strong>StatefulSet Pod管理策略</strong>：</p><blockquote><p>在v1.7以后，通过允许修改Pod排序策略，同时通过.spec.podManagementPolicy字段确保其身份的唯一性。</p><ul><li>OrderedReady：上述的启停顺序，默认设置。</li><li>Parallel：告诉StatefulSet控制器并行启动或终止所有Pod，并且在启动或终止另一个Pod之前不等待前一个Pod变为Running and Ready或完全终止</li></ul></blockquote><p><strong>StatefulSet使用场景</strong>：</p><blockquote><ul><li>稳定的持久化存储，即Pod重新调度后还是能访问到相同的持久化数据，基于PVC来实现</li><li>稳定的网络标志，即Pod重新调度后其PodName和HostName不变，基于Headless Service（即没有Cluster IP的Service）来实现</li><li>有序部署，有序扩展，即Pod是有顺序的，在部署或者扩展的时候要依据定义的顺序依次依次进行（即从0到N-1，在下一个Pod运行之前所有之前的Pod必须都是Running和Ready状态），基于init containers来实现</li><li>有序收缩，有序删除（即从N-1到0）</li></ul></blockquote><p><strong>更新策略：</strong></p><blockquote><p>在Kubernetes 1.7及更高版本中，通过.spec.updateStrategy字段允许配置或禁用Pod、labels、source request/limits、annotations自动滚动更新功能。</p><p><strong>OnDelete：</strong>通过.spec.updateStrategy.type 字段设置为OnDelete，StatefulSet控制器不会自动更新StatefulSet中的Pod。用户必须手动删除Pod，以使控制器创建新的Pod。</p><p><strong>RollingUpdate：</strong>通过.spec.updateStrategy.type 字段设置为RollingUpdate，实现了Pod的自动滚动更新，如果.spec.updateStrategy未指定，则此为默认策略。<br>StatefulSet控制器将删除并重新创建StatefulSet中的每个Pod。它将以Pod终止（从最大序数到最小序数）的顺序进行，一次更新每个Pod。在更新下一个Pod之前，必须等待这个Pod Running and Ready。</p><p><strong>Partitions：</strong>通过指定 .spec.updateStrategy.rollingUpdate.partition 来对 RollingUpdate 更新策略进行分区，如果指定了分区，则当 StatefulSet 的 .spec.template 更新时，具有大于或等于分区序数的所有 Pod 将被更新。</p><p>具有小于分区的序数的所有 Pod 将不会被更新，即使删除它们也将被重新创建。如果 StatefulSet 的 .spec.updateStrategy.rollingUpdate.partition 大于其 .spec.replicas，则其 .spec.template 的更新将不会传播到 Pod。在大多数情况下，不需要使用分区</p></blockquote><p><strong>StatefulSet注意事项：</strong></p><blockquote><ol><li>还在beta状态，需要kubernetes v1.5版本以上才支持</li><li>所有Pod的Volume必须使用PersistentVolume或者是管理员事先创建好</li><li>为了保证数据安全，删除StatefulSet时不会删除Volume</li><li>StatefulSet需要一个Headless Service来定义DNS domain，需要在StatefulSet之前创建好</li><li>目前StatefulSet还没有feature complete，比如更新操作还需要手动patch</li></ol></blockquote><p><strong>更多可以参考：<a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/</a></strong></p><p>进入容器，验证持久化是否成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  get pod</span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner-f6cb6688b-5zn8d   1/1     Running   0          30m</span><br><span class="line">statefulset-test-0                       1/1     Running   0          17m</span><br><span class="line">statefulset-test-1                       1/1     Running   0          16m</span><br><span class="line">statefulset-test-2                       1/1     Running   0          16m</span><br><span class="line">[root@master ~]# kubectl exec  -it  statefulset-test-0  /bin/sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span>  /mnt</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> touch  testfile</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">exit</span></span></span><br><span class="line">[root@master ~]# ls  /nfsdata/default-test-statefulset-test-0-pvc-3a105a9d-5892-4080-a993-20fd2540cd3e/</span><br><span class="line">testfile</span><br></pre></td></tr></table></figure><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a><strong>小结</strong></h2><p>Deployment、RC、RS、DS：</p><blockquote><p>这些Pod控制器都是面向无状态的服务，他们管理的Pod的IP、名字、启停顺序等都是随机的</p><p>这些根据模板创建出来的Pod，特们的状态都是一摸一样的（除了名称、IP、域名之外）</p><p>任何一个Pod都可以被删除，然后用因生成的Pod进项替换</p></blockquote><p>StatefulSet：</p><blockquote><p>顾名思义：有状态的集合，管理所有的有状态服务，比如MySQL集群等</p><p>后端生成的每一个Pod都具有自己的唯一性，不可被随意删除</p><p>需要记录前一次或者多次通信中的相关事件，以作为下一次通信的分类标准</p><p>Pod的名称不能随意变化，数据持久化的目录也是不一样的，每一个Pod又都自己独有的数据持久化存储目录</p></blockquote><p>扩容、缩容：在此过程中，Pod的生成或删除操作也是有顺序性的</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">pod</span>  <span class="string">-n</span> <span class="string">zhb</span></span><br><span class="line"><span class="string">NAME</span>                                     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nfs-client-provisioner-f6cb6688b-x2zls</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span>          <span class="string">42h</span></span><br><span class="line"><span class="string">statefulset-test-0</span>                       <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span>          <span class="string">42h</span></span><br><span class="line"><span class="string">statefulset-test-1</span>                       <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span>          <span class="string">42h</span></span><br><span class="line"><span class="string">statefulset-test-2</span>                       <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span>          <span class="string">42h</span></span><br><span class="line"><span class="string">statefulset-test-3</span>                       <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">76s</span></span><br><span class="line"><span class="string">statefulset-test-4</span>                       <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">66s</span></span><br></pre></td></tr></table></figure><p>升级操作：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl explain sts.spec.updateStrategy.rollingUpdate.partition</span><br></pre></td></tr></table></figure><p>partition：如果partition后面的值等于N，N+的都会更新，默认值为0（所有都会更新）</p><p>如果N等于2，那么它会从statefulset-test-2开始更新，以此类推</p><p>statefulset-test-0<br>statefulset-test-1<br>statefulset-test-2<br>statefulset-test-3<br>statefulset-test-4</p>]]></content>
    
    <summary type="html">
    
      K8s
    
    </summary>
    
    
      <category term="k8s" scheme="http://yoursite.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="http://yoursite.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>k8s的存储类</title>
    <link href="http://yoursite.com/2020/02/11/k8s%E7%9A%84%E5%AD%98%E5%82%A8%E7%B1%BB/"/>
    <id>http://yoursite.com/2020/02/11/k8s%E7%9A%84%E5%AD%98%E5%82%A8%E7%B1%BB/</id>
    <published>2020-02-10T16:00:00.000Z</published>
    <updated>2020-02-12T07:04:51.200Z</updated>
    
    <content type="html"><![CDATA[<h1 id="k8s存储类"><a href="#k8s存储类" class="headerlink" title="k8s存储类"></a>k8s存储类</h1><p>如果，k8s集群中，有很多类似的PV，PVC在去向PV申请空间的时候，不仅会考虑名称以及访问控制模式，还会考虑你申请空间的大小，会分配给你最合适大小的PV</p><p>运行一个web服务，采用Deployment资源，基于nginx镜像。数据持久化目录为nginx服务的主访问目录：/usr/share/nginx/html</p><p>创建一个PVC，与上述资源进行关联</p><p>​    先创建两个PV：web-pv1（1G），web-pv2（2G）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span>  <span class="string">web1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-pv1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span>  <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span>  <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfsdata/web1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.70</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">mkdir</span> <span class="string">/nfsdata/web1</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">apply</span>  <span class="string">-f</span>  <span class="string">web1.yaml</span> </span><br><span class="line"><span class="string">persistentvolume/web-pv1</span> <span class="string">created</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">pv</span></span><br><span class="line"><span class="string">NAME</span>      <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>      <span class="string">CLAIM</span>   <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">web-pv1</span>   <span class="string">1Gi</span>        <span class="string">RWO</span>            <span class="string">Recycle</span>          <span class="string">Available</span>           <span class="string">nfs</span>                     <span class="string">6s</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">web2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-pv2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span>  <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span>  <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfsdata/web2</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.70</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">pv</span></span><br><span class="line"><span class="string">NAME</span>      <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>      <span class="string">CLAIM</span>   <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">web-pv1</span>   <span class="string">1Gi</span>        <span class="string">RWO</span>            <span class="string">Recycle</span>          <span class="string">Available</span>           <span class="string">nfs</span>                     <span class="string">97s</span></span><br><span class="line"><span class="string">web-pv2</span>   <span class="string">2Gi</span>        <span class="string">RWO</span>            <span class="string">Recycle</span>          <span class="string">Available</span>           <span class="string">nfs</span>                     <span class="string">6s</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">mkdir</span>  <span class="string">/nfsdata/web2</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span>  <span class="string">web.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span>  <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span>  <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-web</span></span><br><span class="line">          <span class="attr">mountPath:</span>  <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-web</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span>  <span class="string">web-pvc</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim web-pvc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: web-pvc</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage:  1Gi</span><br><span class="line">  storageClassName: nfs</span><br><span class="line">[root@master ~]# kubectl  apply -f web-pvc.yaml</span><br><span class="line">[root@master ~]# kubectl  get pvc</span><br><span class="line">NAME      STATUS   VOLUME    CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">web-pvc   Bound    web-pv1   1Gi        RWO            nfs            6s</span><br><span class="line">[root@master ~]# kubectl  get pv</span><br><span class="line">NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM             STORAGECLASS   REASON   AGE</span><br><span class="line">web-pv1   1Gi        RWO            Recycle          Bound       default&#x2F;web-pvc   nfs                     9m8s</span><br><span class="line">web-pv2   2Gi        RWO            Recycle          Available                     nfs                     7m37s</span><br><span class="line">[root@master ~]# kubectl  apply  -f web.yaml</span><br><span class="line">[root@master ~]# kubectl  get pod -o wide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE    IP           NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">test-web-67989b6d78-2b774   1&#x2F;1     Running   0          2m1s   10.244.2.5   node02   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p><strong>如果名称和访问模式都一样，它会考虑空间大小进行分配，分配比较接近的PV进行关联</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  exec -it test-web-67989b6d78-2b774 /bin/bash</span><br><span class="line">root@test-web-67989b6d78-2b774:/# cd  /usr/share/nginx/html/</span><br><span class="line">root@test-web-67989b6d78-2b774:/usr/share/nginx/html# echo 12345 &gt; index.html</span><br><span class="line">root@test-web-67989b6d78-2b774:/usr/share/nginx/html# exit</span><br><span class="line">exit</span><br><span class="line">command terminated with exit code 127</span><br><span class="line">[root@master ~]# curl  10.244.2.5</span><br><span class="line">12345</span><br></pre></td></tr></table></figure><p>很多的服务，很多的资源对象</p><p>​    如果要去创建服务，做数据持久化，需要预先知道可用PV有哪些？</p><p>​    如果为了这个服务去提前创建PV，那么我们还需要知道，这个服务大概需要多大的空间？</p><p><strong>Storage Class（存储类）：它可以动态的自动的创建所需要的 PV</strong></p><p>PV是运维人员来创建的，开发操作PVC，可是大规模集群中可能会有很多PV，如果这些PV都需要运维手动来处理这也是一件很繁琐的事情，所以就有了动态供给概念，也就是Dynamic Provisioning。而我们上面的创建的PV都是静态供给方式，也就是Static Provisioning。而动态供给的关键就是StorageClass，它的作用就是创建PV模板。</p><p>创建StorageClass里面需要定义PV属性比如存储类型、大小等；另外创建这种PV需要用到存储插件。最终效果是，用户提交PVC，里面指定存储类型，如果符合我们定义的StorageClass，则会为其自动创建PV并进行绑定</p><blockquote><p><strong>存储类（Storage class）是k8s资源类型的一种，它是有管理员为管理PV更加方便创建的一个逻辑组，可以按照存储系统的性能高低，或者综合服务质量，备份策略等分类。不过k8s本身不知道类别到底是什么，它这是作为一个描述</strong></p></blockquote><p><strong>Provisioner（供给方、提供者）：</strong></p><blockquote><p><strong>及提供了存储资源的存储系统。k8s内建有多重供给方，这些供给方的名字都以“kubernetes.io”为前缀。并且还可以自定义</strong></p></blockquote><p><strong>Parmeters（参数）：</strong></p><blockquote><p><strong>存储类使用参数描述要关联到的存储卷，注意不同的供给方参数也不同</strong></p></blockquote><p><strong>ReclaimPolicy：</strong></p><blockquote><p><strong>PV的回收策略，可用值有Delete(默认)和Retain</strong></p></blockquote><p>基于StorageClass的动态存储供应整体过程如下图所示：<br><img src="https://img-blog.csdnimg.cn/20200211223953249.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><blockquote><p><strong>1）集群管理员预先创建存储类（StorageClass）；</strong></p><p><strong>2）用户创建使用存储类的持久化存储声明(PVC：PersistentVolumeClaim)；</strong></p><p><strong>3）存储持久化声明通知系统，它需要一个持久化存储(PV: PersistentVolume)；</strong></p><p><strong>4）系统读取存储类的信息；</strong></p><p><strong>5）系统基于存储类的信息，在后台自动创建PVC需要的PV；</strong></p><p><strong>6）用户创建一个使用PVC的Pod；</strong></p><p><strong>7）Pod中的应用通过PVC进行数据的持久化；</strong></p><p><strong>8）而PVC使用PV进行数据的最终持久化处理。</strong></p></blockquote><p><strong>更多可以参考：<a href="https://www.kubernetes.org.cn/4078.html" target="_blank" rel="noopener">https://www.kubernetes.org.cn/4078.html</a></strong></p><p>1）确定基于NFS服务来做的sc，NFS服务需要开启</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# showmount -e</span><br><span class="line">Export list for master:</span><br><span class="line">/nfsdata *</span><br></pre></td></tr></table></figure><p>2）需要RBAC权限</p><p>RBAC：</p><blockquote><p><strong>rbac是k8s的API安全策略，是基于用户的访问权限</strong></p><p><strong>规定了谁可以有什么样的权限</strong></p><p><strong>为了给SC资源操作k8s集群的权限</strong></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">rbac-rolebind.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bdqn-test</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">bdqn-test</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-runner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">bdqn-test</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["persistentvolumes"]</span></span><br><span class="line">      <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"delete"</span><span class="string">]</span></span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["persistentvolumeclaims"]</span></span><br><span class="line">      <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> <span class="string">["storage.k8s.io"]</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["storageclasses"]</span></span><br><span class="line">      <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["events"]</span></span><br><span class="line">      <span class="attr">verbs:</span> <span class="string">["watch",</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["services",</span> <span class="string">"endpoints"</span><span class="string">]</span></span><br><span class="line">      <span class="attr">verbs:</span> <span class="string">["get","create","list",</span> <span class="string">"watch"</span><span class="string">,"update"]</span></span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> <span class="string">["extensions"]</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["podsecuritypolicies"]</span></span><br><span class="line">      <span class="attr">resourceNames:</span> <span class="string">["nfs-provisioner"]</span></span><br><span class="line">      <span class="attr">verbs:</span> <span class="string">["use"]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">bdqn-test</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">apply</span>  <span class="string">-f</span>  <span class="string">rbac-rilebind.yaml</span> </span><br><span class="line"><span class="string">namespace/bdqn-test</span> <span class="string">created</span></span><br><span class="line"><span class="string">serviceaccount/nfs-provisioner</span> <span class="string">created</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/nfs-provisioner-runner</span> <span class="string">created</span></span><br><span class="line"><span class="string">clusterrolebinding.rbac.authorization.k8s.io/run-nfs-provisioner</span> <span class="string">created</span></span><br></pre></td></tr></table></figure><p>3）nfs-deployment.</p><blockquote><p><strong>作用：其实它是NFS的客户端，但是它通过K8S的内置的NFS驱动挂载远端的NFS服务器到本地目录；然后将自身作为storage provider，关联storage class</strong></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">nfs-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">bdqn-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/open-ali/nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span>  <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span>  <span class="string">//提供者的名称</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">bdqn-test</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span>   <span class="string">//nfs服务器地址</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.70</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/nfsdata</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.70</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/nfsdata</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">apply</span>  <span class="string">-f</span>  <span class="string">nfs-deployment.yaml</span> </span><br><span class="line"><span class="string">deployment.extensions/nfs-client-provisioner</span> <span class="string">created</span></span><br></pre></td></tr></table></figure><p>4）创建storageclass</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim test-storageclass.yaml</span><br><span class="line">apiVersion: storage.k8s.io&#x2F;v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: sc-nfs</span><br><span class="line">  namespace: bdqn-test  &#x2F;&#x2F;属于哪个名称空间</span><br><span class="line">provisioner: bdqn-test  &#x2F;&#x2F;供给着，和nfs-deployment的名称要一样：value: bdqn-test</span><br><span class="line">reclaimPolicy: Retain</span><br><span class="line">[root@master ~]# kubectl apply  -f  test-storageclass.yaml </span><br><span class="line">storageclass.storage.k8s.io&#x2F;sc-nfs created</span><br></pre></td></tr></table></figure><p>provisioner: bdqn-test //通过preovisioner字段关联到上述Deployment</p><p>5）创建PVC</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">test-pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-claim</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">bdqn-test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">sc-nfs</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">20Mi</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">apply</span>  <span class="string">-f</span> <span class="string">test-pvc.yaml</span> </span><br><span class="line"><span class="string">persistentvolumeclaim/test-claim</span> <span class="string">created</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">pvc</span> <span class="string">-n</span> <span class="string">bdqn-test</span> </span><br><span class="line"><span class="string">NAME</span>         <span class="string">STATUS</span>   <span class="string">VOLUME</span>                                     <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">STORAGECLASS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">test-claim</span>   <span class="string">Bound</span>    <span class="string">pvc-0c606810-9f93-441b-bc6b-391d7813dcab</span>   <span class="string">20Mi</span>       <span class="string">RWX</span>            <span class="string">sc-nfs</span>         <span class="string">2m15s</span></span><br></pre></td></tr></table></figure><p>它会为我们自动生成一个pv</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ls  /nfsdata/</span><br><span class="line">bdqn-test-test-claim-pvc-0c606810-9f93-441b-bc6b-391d7813dcab</span><br><span class="line">[root@master ~]# kubectl  get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                  STORAGECLASS   REASON   AGE</span><br><span class="line">pvc-0c606810-9f93-441b-bc6b-391d7813dcab   20Mi       RWX            Delete           Bound       bdqn-test/test-claim   sc-nfs                  4m24s</span><br></pre></td></tr></table></figure><p>6）创建Pod测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim test-pod.yaml</span><br><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: test-pod</span><br><span class="line">  namespace: bdqn-test</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: test-pod</span><br><span class="line">    image: busybox</span><br><span class="line">    args:</span><br><span class="line">      - /bin/sh</span><br><span class="line">      - -c</span><br><span class="line">      - sleep 30000</span><br><span class="line">    volumeMounts:</span><br><span class="line">      - name: nfs-pvc</span><br><span class="line">        mountPath: /test</span><br><span class="line">  restartPolicy: OnFailure</span><br><span class="line">  volumes:</span><br><span class="line">    - name: nfs-pvc</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: test-claim</span><br><span class="line">[root@master ~]# kubectl  apply  -f  test-pod.yaml </span><br><span class="line">pod/test-pod created</span><br><span class="line">[root@master ~]# kubectl  get pod -n  bdqn-test </span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner-57f49c99c7-lhd8n   1/1     Running   0          27m</span><br><span class="line">test-pod                                  1/1     Running   0          32s</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  exec -it test-pod -n bdqn-test /bin/sh</span><br><span class="line">/ # cd  /test</span><br><span class="line">/test # touch test-file</span><br><span class="line">/test # echo 123456 &gt; test-file </span><br><span class="line">/test # exit</span><br><span class="line">[root@master ~]# cat /nfsdata/bdqn-test-test-claim-pvc-0c606810-9f93-441b-bc6b-391d7813dcab/test-file </span><br><span class="line">123456</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  exec  -it  -n bdqn-test  nfs-client-provisioner-57f49c99c7-lhd8n /bin/sh</span><br><span class="line">/ # ls /</span><br><span class="line">persistentvolumes </span><br><span class="line">/ # cd  /persistentvolumes/</span><br><span class="line">/persistentvolumes # ls</span><br><span class="line">bdqn-test-test-claim-pvc-0c606810-9f93-441b-bc6b-391d7813dcab</span><br><span class="line"><span class="meta">#</span><span class="bash">这个目录和/nfsdata下面的目录一样</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      K8s
    
    </summary>
    
    
      <category term="k8s" scheme="http://yoursite.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="http://yoursite.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>k8s数据持久化</title>
    <link href="http://yoursite.com/2020/02/10/k8s%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/"/>
    <id>http://yoursite.com/2020/02/10/k8s%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/</id>
    <published>2020-02-10T08:53:18.320Z</published>
    <updated>2020-02-14T03:50:17.919Z</updated>
    
    <content type="html"><![CDATA[<h1 id="k8s数据持久化"><a href="#k8s数据持久化" class="headerlink" title="k8s数据持久化"></a>k8s数据持久化</h1><p>Docker容器是有生命周期的，因此数据卷可以实现数据持久化</p><p>数据卷主要解决的问题：</p><ul><li>数据持久性：当我们写入数据时，文件都是暂时性的存在，当容器崩溃后，host就会将这个容器杀死，然后重新从镜像创建容器，数据就会丢失</li><li>数据共享：在同一个Pod中运行容器，会存在共享文件的需求</li></ul><h4 id="Volume："><a href="#Volume：" class="headerlink" title="Volume："></a>Volume：</h4><p><strong>emptyDir（空目录）：</strong>使用情况比较少，一般只做临时使用，类似Docker数据 持久化的：docker manager volume，该数据卷初始分配时，是一个空目录，同一个Pod中的容器可以对该目录有执行读写操作，并且共享数据</p><blockquote><p>​    <strong>使用场景：在同一个Pod里，不同的容器，共享数据卷</strong></p><p>​    <strong>如果容器被删除，数据仍然存在，如果Pod被删除，数据也会被删除</strong></p></blockquote><p><strong>使用实例：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">emptyDir.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">producer-consumer</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span>  <span class="string">busybox</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">producer</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span>  <span class="string">/producer_dir</span>  <span class="string">//容器内的路径</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">shared-volume</span>  <span class="string">//指定本地的目录名</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span>  <span class="string">"hello k8s"</span> <span class="string">&gt;</span> <span class="string">/producer_dir/hello;</span>  <span class="string">sleep</span> <span class="number">30000</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span>  <span class="string">busybox</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consumer</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span>  <span class="string">/consumer_dir</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">shared-volume</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat</span> <span class="string">/consumer_dir/hello;</span>  <span class="string">sleep</span> <span class="number">30000</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-volume</span>  <span class="string">//这里的名字必须与上面的Pod的mountPath的name相对应</span></span><br><span class="line">    <span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span>   <span class="string">//定义数据持久化类型，即表示空目录</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">apply</span>   <span class="string">-f</span>  <span class="string">emptyDir.yaml</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">get</span>  <span class="string">pod</span></span><br><span class="line"><span class="string">NAME</span>                <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>  </span><br><span class="line"><span class="string">producer-consumer</span>   <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">14s</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">logs</span>  <span class="string">producer-consumer</span>  <span class="string">consumer</span> </span><br><span class="line"><span class="string">hello</span>  <span class="string">k8s</span></span><br></pre></td></tr></table></figure><p><strong>使用inspect查看挂载的目录在哪（查看Mount字段）</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  get  pod -o wide</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE   IP           NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">producer-consumer   2/2     Running   0          69s   10.244.1.2   node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">//可以看到容器运行在node01上，在node01上找到这个容器并查看并查看详细信息</span><br><span class="line">[root@node01 ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE</span><br><span class="line">f117beb235cf        busybox</span><br><span class="line">13c7a18109a1        busybox</span><br><span class="line">[root@node01 ~]# docker inspect 13c7a18109a1</span><br><span class="line">        "Mounts": [</span><br><span class="line">            &#123;</span><br><span class="line">                "Type": "bind",</span><br><span class="line">                "Source": "/var/lib/kubelet/pods/5225f542-0859-4a6a-8d99-1f23b9781807/volumes/kubernetes.io~empty-dir/shared-volume",</span><br><span class="line">                "Destination": "/producer_dir", //容器内的挂载目录</span><br><span class="line">                "Mode": "",</span><br><span class="line">                "RW": true,</span><br><span class="line">                "Propagation": "rprivate"</span><br><span class="line">//再查看另一个容器</span><br><span class="line">[root@node01 ~]# docker inspect f117beb235cf</span><br><span class="line">        "Mounts": [</span><br><span class="line">            &#123;</span><br><span class="line">                "Type": "bind",</span><br><span class="line">                "Source": "/var/lib/kubelet/pods/5225f542-0859-4a6a-8d99-1f23b9781807/volumes/kubernetes.io~empty-dir/shared-volume",</span><br><span class="line">                "Destination": "/consumer_dir",  //容器内的挂载目录</span><br><span class="line">                "Mode": "",</span><br><span class="line">                "RW": true,</span><br><span class="line">                "Propagation": "rprivate"</span><br><span class="line">//可以看到两个容器使用的同一个挂载目录</span><br><span class="line">[root@node01 ~]# cd  /var/lib/kubelet/pods/5225f542-0859-4a6a-8d99-1f23b9781807/volumes/kubernetes.io~empty-dir/shared-volume</span><br><span class="line">[root@node01 shared-volume]# ls</span><br><span class="line">hello</span><br><span class="line">[root@node01 shared-volume]# cat hello </span><br><span class="line">hello  k8s</span><br></pre></td></tr></table></figure><p><strong>将容器删除，验证目录是否存在</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# docker rm  -f  13c7a18109a1 </span><br><span class="line">13c7a18109a1</span><br><span class="line">[root@node01 ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE</span><br><span class="line">a809717b1aa5        busybox</span><br><span class="line">f117beb235cf        busybox</span><br><span class="line">//它会重新生成一个新的容器，来达到我们用户所期望的状态，所以这个目录还是存在的</span><br></pre></td></tr></table></figure><p><strong>删除Pod</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  delete  pod producer-consumer</span><br><span class="line">[root@master ~]# ls  /var/lib/kubelet/pods/5225f542-0859-4a6a-8d99-1f23b9781807/volumes/kubernetes.io~empty-dir/shared-volume</span><br><span class="line">ls: 无法访问/var/lib/kubelet/pods/5225f542-0859-4a6a-8d99-1f23b9781807/volumes/kubernetes.io~empty-dir/shared-volume: 没有那个文件或目录</span><br><span class="line">//Pod删除后数据也会被删除</span><br></pre></td></tr></table></figure><p><strong>hostPath Volume（使用场景也比较少）：</strong>类似Docker数据持久化的：bind mount</p><p>将Pod所在节点的文件系统上某一个文件或目录挂载进容器内</p><blockquote><p>​    <strong>如果Pod被删除，数据会保留，相比较emptyDir会好一点，不过，一旦host崩溃，hostPath也无法访问</strong></p><p><strong>docker或者k8s集群本身的存储会采用hostPath这种方式</strong></p></blockquote><p><strong>k8s集群中会有很多pod，如果都是用hostPath Volume的话管理起来很不方便，所以就用到了PV</strong></p><p><strong>Persistent Volume | PV（持久卷）提前做好的，数据持久化的数据存放目录</strong></p><blockquote><p><strong>是集群中的一块存储空间，由集群管理员管理或者由Storage class（存储类）自动管理，PV和pod、deployment、Service一样，都是一个资源对象</strong></p><p><strong>PersistentVolume（PV）是集群中已由管理员配置的一段网络存储。 集群中的资源就像一个节点是一个集群资源。 PV是诸如卷之类的卷插件，但是具有独立于使用PV的任何单个pod的生命周期。 该API对象捕获存储的实现细节，即NFS，iSCSI或云提供商特定的存储系统</strong></p></blockquote><p><strong>Psesistent Volume Claim | PVC（持久卷使用声明|申请）</strong></p><blockquote><p><strong>PVC代表用户使用存储的请求，应用申请PV持久化空间的一个申请、声明。K8s集群可能会有多个PV，你需要不停的为不同的应用创建多个PV</strong></p><p><strong>它类似于pod。Pod消耗节点资源，PVC消耗存储资源。 pod可以请求特定级别的资源（CPU和内存）。 权限要求可以请求特定的大小和访问模式</strong></p></blockquote><p>更多可以参考：<a href="https://www.kubernetes.org.cn/pvpvcstorageclass" target="_blank" rel="noopener">https://www.kubernetes.org.cn/pvpvcstorageclass</a></p><p><strong>基于NFS服务来做的PV</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# yum  -y  install  nfs-utils (需要节点全部下载，会报挂载类型错误)</span><br><span class="line">[root@master ~]# yum  -y  install  rpcbind</span><br><span class="line">[root@master ~]# mkdir  &#x2F;nfsdata</span><br><span class="line">[root@master ~]# vim  &#x2F;etc&#x2F;exports</span><br><span class="line">&#x2F;nfsdata  *(rw,sync,no_root_squash)</span><br><span class="line">[root@master ~]# systemctl  start  rpcbind</span><br><span class="line">[root@master ~]# systemctl  start  nfs-server</span><br><span class="line">[root@master ~]# showmount  -e</span><br><span class="line">Export list for master:</span><br><span class="line">&#x2F;nfsdata *</span><br></pre></td></tr></table></figure><p>1.创建PV（实际的存储目录）  2.创建PVC  3.创建pod</p><p><strong>创建PV资源对象：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">nfs-pv.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span> <span class="string">//PV容量的大小</span></span><br><span class="line">    <span class="attr">storage:</span>  <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span> <span class="string">//PV支持的访问模式</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span>  <span class="string">Recycle</span> <span class="string">//PV的存储空间的回收策略是什么</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfsdata/pv1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.70</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">apply</span>  <span class="string">-f</span>  <span class="string">nfs-pv.yaml</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">pv</span></span><br><span class="line"><span class="string">NAME</span>      <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>      <span class="string">CLAIM</span>   <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">test-pv</span>   <span class="string">1Gi</span>        <span class="string">RWO</span>            <span class="string">Recycle</span>          <span class="string">Available</span>           <span class="string">nfs</span>                     <span class="string">9m30s</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>accessModes: （PV支持的访问模式）</strong></p><p>​    <strong>-  ReadWriteOnce：能以读-写的方式mount到单个节点</strong></p><p>​    <strong>-  ReadWriteMany：能以读-写的方式mount到多个节点</strong></p><p>​    <strong>-  ReadOnlyMany：能以只读的方式mount到多个节点</strong></p></blockquote><blockquote><p><strong>persistentVolumeReclaimPolicy：（PV的存储空间的回收策略是什么）</strong></p><p>​    <strong>Recycle：自动清除数据</strong></p><p>​    <strong>Retain：需要管理员手动回收</strong></p><p>​    <strong>Delete：云存储专用。直接删除数据</strong></p></blockquote><blockquote><p><strong>PV和PVC相互的关联：通过的是storageClassName &amp;&amp; accessModes</strong></p></blockquote><p><strong>创建PVC</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span>  <span class="string">nfs-pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span>    <span class="string">//访问模式</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span>  </span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span>  <span class="string">1Gi</span>   <span class="string">//申请的容量大小</span></span><br><span class="line">  <span class="attr">storageClassName:</span>  <span class="string">nfs</span>    <span class="string">//向哪个PV申请</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">nfs-pvc.yaml</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pvc</span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">STATUS</span>   <span class="string">VOLUME</span>    <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">STORAGECLASS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">test-pvc</span>   <span class="string">Bound</span>    <span class="string">test-pv</span>   <span class="string">1Gi</span>        <span class="string">RWO</span>            <span class="string">nfs</span>            <span class="string">14s</span></span><br></pre></td></tr></table></figure><h4 id="PV的应用："><a href="#PV的应用：" class="headerlink" title="PV的应用："></a><strong>PV的应用：</strong></h4><p><strong>创建一个Pod资源：</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span>  <span class="string">pod.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line">    <span class="attr">image:</span>  <span class="string">busybox</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span>  <span class="string">"/mydata"</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">mydata</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span>  <span class="string">test-pvc</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">apply</span>  <span class="string">-f</span>  <span class="string">pod.yaml</span></span><br></pre></td></tr></table></figure><p>之前创建PV的时候指定的挂载目录是/nfsdata/pv1，我们并没有创建pv1这个目录，所以这个pod是运行不成功的。</p><p>以下是排错方法：</p><blockquote><ol><li><strong>kubectl  describe</strong></li><li><strong>kubectl  logs</strong></li><li><strong>/var/log/messages</strong></li><li><strong>查看该节点的kubelet的日志</strong></li></ol></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//使用kubectl describe</span><br><span class="line">[root@master ~]# kubectl  describe  pod  test-pod</span><br><span class="line">mount.nfs: mounting 192.168.1.70:/nfsdata/pv1 failed, reason given by server: No such file or directory  //提示没有文件或目录</span><br></pre></td></tr></table></figure><p>创建目录，再查看pod状态：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mkdir  /nfsdata/pv1</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP           NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">test-pod   1/1     Running   0          12m   10.244.1.3   node01   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p>验证是否应用成功：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  exec  test-pod  touch /mydata/hello</span><br><span class="line">[root@master ~]# ls  /nfsdata/pv1/</span><br><span class="line">hello</span><br><span class="line">[root@master ~]# echo  123  &gt;  /nfsdata/pv1/hello </span><br><span class="line">[root@master ~]# kubectl  exec  test-pod  cat /mydata/hello</span><br><span class="line">123</span><br></pre></td></tr></table></figure><p>删除Pod，验证回收策略（Recycle）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  delete  pod  test-pod</span><br><span class="line">[root@master ~]# kubectl  delete  pvc test-pvc</span><br><span class="line">[root@master ~]# kubectl  get pv</span><br><span class="line">NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">test-pv   1Gi        RWO            Recycle          Available           nfs                     42h</span><br><span class="line">[root@master ~]# ls  &#x2F;nfsdata&#x2F;pv1&#x2F;</span><br><span class="line">[root@master ~]#</span><br><span class="line">&#x2F;&#x2F;验证成功，数据已经回收</span><br></pre></td></tr></table></figure><p>通常情况下不会设置为自动删除，不然就和emptyDir就差不多了</p><p>删除pv，修改回收策略：</p><p>之前是先创建PV—&gt;PVC—&gt;Pod，现在调整一下，先创建PV—&gt;—Pod—&gt;PVC</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim  nfs-pv.yaml </span><br><span class="line">  persistentVolumeReclaimPolicy:  Retain</span><br><span class="line">[root@master ~]# kubectl  apply  -f  nfs-pv.yaml </span><br><span class="line">[root@master ~]# kubectl  get pv</span><br><span class="line">NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">test-pv   1Gi        RWO            Retain           Available           nfs                     7s</span><br><span class="line">[root@master ~]# kubectl  apply  -f  pod.yaml </span><br><span class="line">[root@master ~]# kubectl  get pod</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">test-pod   0&#x2F;1     Pending   0          5s  &#x2F;&#x2F;Pending正在被调度</span><br><span class="line">[root@master ~]# kubectl  describe  pod test-pod</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age                From               Message</span><br><span class="line">  ----     ------            ----               ----               -------</span><br><span class="line">  Warning  FailedScheduling  41s (x2 over 41s)  default-scheduler  persistentvolumeclaim &quot;test-pvc&quot; not found</span><br><span class="line">&#x2F;&#x2F;没有发现对应的pvc</span><br><span class="line"></span><br><span class="line">创建pvc</span><br><span class="line">[root@master ~]# kubectl  apply  -f  nfs-pvc.yaml</span><br><span class="line">[root@master ~]# kubectl  get pod</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">test-pod   1&#x2F;1     Running   0          114s</span><br></pre></td></tr></table></figure><p>验证Retain（管理员手动删除）回收策略：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  exec test-pod  touch  /mydata/k8s</span><br><span class="line">[root@master ~]# ls  /nfsdata/pv1/</span><br><span class="line">k8s</span><br><span class="line">[root@master ~]# kubectl  delete  pod test-pod </span><br><span class="line">[root@master ~]# kubectl  delete  pvc test-pvc</span><br><span class="line">[root@master ~]# ls  /nfsdata/pv1/</span><br><span class="line">k8s</span><br><span class="line">//可以看到并没有回收</span><br><span class="line">[root@master ~]# kubectl get pv</span><br><span class="line">NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">test-pv   1Gi        RWO            Retain           Available           nfs                     6s</span><br></pre></td></tr></table></figure><p><strong>mysql对数据持久化的应用：</strong></p><p>//这里就不再创建PV，PVC了，用之前的就行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  apply  -f  nfs-pvc.yaml </span><br><span class="line">[root@master ~]# kubectl  get pvc</span><br><span class="line">NAME       STATUS   VOLUME    CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">test-pvc   Bound    test-pv   1Gi        RWO            nfs            7s</span><br></pre></td></tr></table></figure><p>创建Deploment资源对象，mysql容器</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">mysql.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span>  <span class="string">//基于等值的标签</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">mysql:5.6</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">123.</span><span class="string">com</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-storage</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">test-pvc</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">deployments.</span></span><br><span class="line"><span class="string">NAME</span>         <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">test-mysql</span>   <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">61s</span></span><br></pre></td></tr></table></figure><p>进入容器创建数据，验证是否应用PV：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  get pod -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP           NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">test-mysql-569f8df4db-fnnxc   1/1     Running   0          32m   10.244.1.5   node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@master ~]# kubectl  exec  -it  test-mysql-569f8df4db-fnnxc  --  mysql -u root -p123.com</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> create database yun33;  //创建数据库</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> use yun33;  //选择使用数据路</span></span><br><span class="line">Database changed</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> create table my_id( id int(4));  创建表</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> insert my_id values(9527);  //在表中插入数据</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from my_id;  //查看表中所有数据</span></span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">| 9527 |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">[root@master ~]# ls /nfsdata/pv1/</span><br><span class="line">auto.cnf  ibdata1  ib_logfile0  ib_logfile1  k8s  mysql  performance_schema  yun33</span><br></pre></td></tr></table></figure><p>关闭node01节点，模拟节点宕机：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">nodes</span> </span><br><span class="line"><span class="string">NAME</span>     <span class="string">STATUS</span>     <span class="string">ROLES</span>    <span class="string">AGE</span>   <span class="string">VERSION</span></span><br><span class="line"><span class="string">master</span>   <span class="string">Ready</span>      <span class="string">master</span>   <span class="string">36d</span>   <span class="string">v1.15.0</span></span><br><span class="line"><span class="string">node01</span>   <span class="string">NotReady</span>   <span class="string">&lt;none&gt;</span>   <span class="string">36d</span>   <span class="string">v1.15.0</span></span><br><span class="line"><span class="string">node02</span>   <span class="string">Ready</span>      <span class="string">&lt;none&gt;</span>   <span class="string">36d</span>   <span class="string">v1.15.0</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-o</span> <span class="string">wide</span> <span class="string">-w</span></span><br><span class="line"><span class="string">NAME</span>                          <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>           <span class="string">NODE</span>     <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">test-mysql-569f8df4db-fnnxc</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">36m</span>   <span class="number">10.244</span><span class="number">.1</span><span class="number">.5</span>   <span class="string">node01</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">test-mysql-569f8df4db-fnnxc</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">38m</span>   <span class="number">10.244</span><span class="number">.1</span><span class="number">.5</span>   <span class="string">node01</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">test-mysql-569f8df4db-2m5rd</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>       <span class="number">0</span>          <span class="string">0s</span>    <span class="string">&lt;none&gt;</span>       <span class="string">&lt;none&gt;</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">test-mysql-569f8df4db-2m5rd</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>       <span class="number">0</span>          <span class="string">0s</span>    <span class="string">&lt;none&gt;</span>       <span class="string">node02</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">test-mysql-569f8df4db-2m5rd</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">0s</span>    <span class="string">&lt;none&gt;</span>       <span class="string">node02</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">test-mysql-569f8df4db-2m5rd</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">2s</span>    <span class="number">10.244</span><span class="number">.2</span><span class="number">.4</span>   <span class="string">node02</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-o</span> <span class="string">wide</span> </span><br><span class="line"><span class="string">NAME</span>                          <span class="string">READY</span>   <span class="string">STATUS</span>        <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>           <span class="string">NODE</span>     <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">test-mysql-569f8df4db-2m5rd</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>       <span class="number">0</span>          <span class="string">20s</span>   <span class="number">10.244</span><span class="number">.2</span><span class="number">.4</span>   <span class="string">node02</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">test-mysql-569f8df4db-fnnxc</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">38m</span>   <span class="number">10.244</span><span class="number">.1</span><span class="number">.5</span>   <span class="string">node01</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure><p>验证：在node02上新生成的pod，它内部是否有我们创建的数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  exec -it test-mysql-569f8df4db-2m5rd  -- mysql -u root -p123.com</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show databases;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| yun33              |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> use yun33;</span></span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show tables;</span></span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_yun33 |</span><br><span class="line">+-----------------+</span><br><span class="line">| my_id           |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select *  from my_id;</span></span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">| 9527 |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line">[root@master ~]# ls  /nfsdata/pv1/</span><br><span class="line">auto.cnf  ibdata1  ib_logfile0  ib_logfile1  k8s  mysql  performance_schema  yun33</span><br></pre></td></tr></table></figure><p><strong>Pod不断的重启：</strong></p><blockquote><p>​    <strong>1.swap，没有关闭。导致集群运行不正常</strong></p><p>​    <strong>2.内存不足，运行服务也会重启</strong></p></blockquote><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>负责把PVC绑定到PV的是一个持久化存储卷控制循环，这个控制器也是kube-manager-controller的一部分运行在master上。而真正把目录挂载到容器上的操作是在POD所在主机上发生的，所以通过kubelet来完成。而且创建PV以及PVC的绑定是在POD被调度到某一节点之后进行的，完成这些操作，POD就可以运行了。下面梳理一下挂载一个PV的过程：</p><blockquote><ol><li><strong>用户提交一个包含PVC的POD</strong></li><li><strong>调度器把根据各种调度算法把该POD分配到某个节点，比如node01</strong></li><li><strong>Node01上的kubelet等待Volume Manager准备存储设备</strong></li><li><strong>PV控制器调用存储插件创建PV并与PVC进行绑定</strong></li><li><strong>Attach/Detach Controller或Volume Manager通过存储插件实现设备的attach。（这一步是针对块设备存储）</strong></li><li><strong>Volume Manager等待存储设备变为可用后，挂载该设备到<code>/var/lib/kubelet/pods//volumes/kubernetes.io~/</code>目录上</strong></li><li><strong>Kubelet被告知卷已经准备好，开始启动POD，通过映射方式挂载到容器中</strong></li></ol></blockquote>]]></content>
    
    <summary type="html">
    
      K8s
    
    </summary>
    
    
      <category term="k8s" scheme="http://yoursite.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="http://yoursite.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>Docker swarm</title>
    <link href="http://yoursite.com/2020/01/25/Docker%20swarm/"/>
    <id>http://yoursite.com/2020/01/25/Docker%20swarm/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-02-02T09:31:18.463Z</updated>
    
    <content type="html"><![CDATA[<p>Docker swarm</p><hr><p>docker swarm集群：三剑客之一</p><table><thead><tr><th>docker01</th><th>192.168.1.70</th><th>node1</th></tr></thead><tbody><tr><td>docker02</td><td>192.168.1.50</td><td>node2</td></tr><tr><td>docker03</td><td>192.168.1.40</td><td>node3</td></tr></tbody></table><p>关闭防火墙、禁用linux、3台dockerhost区别主机名，时间同步</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# setenforce  0</span><br><span class="line">[root@localhost ~]# systemctl  stop  firewalld</span><br><span class="line">[root@localhost ~]# hostnamectl  set-hostname  node1</span><br><span class="line">[root@localhost ~]# su -</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>docker版本必须是：v1.12版本开始</p><p>Swarm：</p><blockquote><p>作用docker engin（引擎）的多个主机组成的集群</p></blockquote><p>node：</p><blockquote><p>每一个docker engin都是一个node（节点），分为manager和worker</p></blockquote><p>manager node：</p><blockquote><p>负责执行编排和集群管理的工作，保持并维护swarm处于期望的状态，swarm可以有多个manager node，他们会自动协调并选举出一个Leader执行编排任务，但相反不能没有manager node</p></blockquote><p>worker node：</p><blockquote><p>接受并执行由manager node派发的任务，并且默认manager node也是一个worker node，不过可以将它设置为manager-noly node，让他只负责编排和管理工作</p></blockquote><p>service：</p><blockquote><p>用来定义worker上执行的命令</p></blockquote><p>1）初始化集群</p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker swarm init  --advertise-addr  192.168.1.70</span><br><span class="line">Swarm initialized: current node (g26pbaqiozkn99qw9ngtgncke) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-3fp7qnihbzzy8u0esfjmmdfncdud4yh628e7bey5tu8fo3cl5p-4x021jwoh1bryxpwqd4bsj8xd 192.168.1.70:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &#39;docker swarm join-token manager&#39; and follow the instructions.</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><blockquote><p>–advertise-addr：指定与其他Node通信的地址</p></blockquote><p>上边返回的结果告诉我们：初始化成功，并且，如果想要添加work节点运行下面的命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join --token SWMTKN-1-3fp7qnihbzzy8u0esfjmmdfncdud4yh628e7bey5tu8fo3cl5p-4x021jwoh1bryxpwqd4bsj8xd 192.168.1.70:2377</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>PS：这里注意，token只有24小时的有效期</p><p>如果想要添加manager节点：运行下边的命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join-token manager</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>当两个节点加入成功之后，我们可以执行docker node ls查看节点详情</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker node ls</span><br><span class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</span><br><span class="line">g26pbaqiozkn99qw9ngtgncke *   node1               Ready               Active              Leader              18.09.0</span><br><span class="line">w11nz7pzgmhq6wn5b51g6b8ao     node2               Ready               Active                                  18.09.0</span><br><span class="line">zqi7od9q0v7zo2tkabnseuqdf     node3               Ready               Active                                  18.09.0</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>基本操作命令：</p><blockquote><p>docker swarm leave：申请离开一个集群，之后查看节点状态会变成down然后通过manager node将其删除</p><p>docker node rm xxx：删除某个节点</p><p>docker swarm join-token {manager|worker}：生成令牌，可以是manager身份或worker身份</p><p>docker node demote（降级）：将swarm节点的manager降级为work</p><p>docker node promote（升级）：将swarm节点的work升级为manager</p></blockquote><p>2）部署docker swarm集群网络</p><hr><p>overlay：覆盖型网络</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker network  create  -d  overlay  --attachable  docker</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><blockquote><p>attacheable：这个参数必须要加，否则不能用于容器</p><p>在创建网络的时候，我们并没有部署一个存储 服务，比如consul，那是因为docker swarm自带存储</p></blockquote><p>3）部署一个图形化webUI界面</p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker run  -d  -p  8080:8080  -e  HOST&#x3D;192.168.1.70  -e  PORT&#x3D;8080  \</span><br><span class="line">&gt;  -v &#x2F;var&#x2F;run&#x2F;docker.sock:&#x2F;var&#x2F;run&#x2F;docker.sock  --name viswalizer  dockersamples&#x2F;visualizer</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>然后通过浏览器验证：192.168.1.70:8080</p><p>如果访问网页访问不到，需要开启路由转发：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# echo  net.ipv4.ip_forward &#x3D; 1 &gt;&gt; &#x2F;etc&#x2F;sysctl.conf </span><br><span class="line">[root@node1 ~]# sysctl -p</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/20200120155851918.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>4）创建service（服务）</p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker service create --replicas 1 --network docker --name web1 -p 80:80 nginx</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/20200120155950198.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>PS：</p><blockquote><p>如果node2或node3宕机，这些服务会自动转到节点中没有宕机的host上，并继续运行</p></blockquote><blockquote><p>–replicas：副本数量</p><p>大概可以理解为以个副本等于一个容器</p></blockquote><blockquote><p>查看service：</p><p>docker service ls</p><p>查看service信息：</p><p>docker service ps xxx</p><p>删除server：</p><p>docker service rm xxx</p></blockquote><p>设置manager node不参加工作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker node update node1 --availability  drain</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>5)搭建私有仓库</p><hr><p>过程：略，详情请查看看<a href="https://blog.csdn.net/weixin_45636702/article/details/104002017" target="_blank" rel="noopener">https://blog.csdn.net/weixin_45636702/article/details/104002017</a></p><p>6）自定义镜像</p><hr><p>要求：基于httpd镜像，更改访问界面内容。镜像tag版本为v1，对应主机页面内容为111，2222，3333</p><p>v1，v2，v3目录下的操作一样</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# mkdir  &#123;v1,v2,v3&#125;</span><br><span class="line">[root@node01 ~]# cd  v1</span><br><span class="line">[root@node01 v1]# vim  index.html</span><br><span class="line">[root@node01 v1]# cat  index.html</span><br><span class="line">111111111111111111111111111</span><br><span class="line">.................</span><br><span class="line">[root@node01 v1]# vim  Dockerfile</span><br><span class="line">[root@node01 v1]# cat  Dockerfile </span><br><span class="line">FROM  httpd</span><br><span class="line">ADD index.html  &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;htdocs&#x2F;index.html</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>7）发布一个服务，基于上述镜像</p><hr><p>要求：副本数量为3个，服务的名称为：bdqn</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# docker service create --replicas 3  --name bdqn -p  80:80    192.168.1.70:5000&#x2F;httpd:v1</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>默认的ingress网络，包括创建的自定义overlay网络，为后端真正为用户提供服务的container，提供了一个统一的入口</p><p>随机映射的端口范围：30000-32767</p><p>8）服务的扩容与缩容</p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# docker  service  scale  bdqn&#x3D;6</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>扩容与缩容可以直接通过scale进行设置副本数量</p><p>9）服务的升级与回滚</p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# docker service  update --image  192.168.1.70:5000&#x2F;httpd:v2  bdqn</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//平滑的更新</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# docker service  update  --image 192.168.1.70:5000&#x2F;httpd:v3  --update-parallelism 2  --update-delay 1m  bdqn</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>PS：</p><blockquote><p>默认情况下，swarm一次只更新一个副本，并且两个副本之间没有等待时间，我们可以通过</p><p>–update-parallelisnm：设置并更新的副本数量</p><p>–update-delay：指定滚动更新时间间隔</p></blockquote><p>//回滚操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# docker service  rollback  bdqn</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>PS：</p><blockquote><p>docker swarm的回滚操作，默认只能回滚到上一次的操作状态，并不能连续回滚操作</p></blockquote>]]></content>
    
    <summary type="html">
    
      Docker
    
    </summary>
    
    
      <category term="Docker" scheme="http://yoursite.com/categories/Docker/"/>
    
    
      <category term="Docker" scheme="http://yoursite.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker的底层原理</title>
    <link href="http://yoursite.com/2020/01/25/Docker%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/"/>
    <id>http://yoursite.com/2020/01/25/Docker%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.240Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Docker底层原理"><a href="#Docker底层原理" class="headerlink" title="Docker底层原理"></a><strong>Docker底层原理</strong></h1><p>如果虚拟机内服务对内核版本有要求，这个服务就不太适合用docker来实现了</p><p>Busybox：欺骗层</p><p>解耦：解除耦合、解除冲突</p><p>耦合：冲突现象</p><p>run—–&gt;Centos系统（nginx、web）</p><p>对于docker host来说这个系统仅仅是一个进程</p><p>Namespace（名称空间）：</p><p>用来隔离容器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ns]# pwd</span><br><span class="line">&#x2F;proc&#x2F;2971&#x2F;ns</span><br><span class="line">[root@localhost ns]# ls</span><br><span class="line">ipc  mnt  net  pid  user  uts</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>ipc：共享内存、消息列队</p><p>mnt：挂载点、文件系统</p><p>net：网络栈</p><p>pid：进程编号</p><p>user：用户、组</p><p>uts：主机名、域名</p><p>//namespace六项隔离，实现了容器与宿主机、容器与容器之间的隔离</p><p>Cgroup（控制组）：</p><p>资源的限制</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@d9d679199f74 cgroup]# pwd</span><br><span class="line">&#x2F;sys&#x2F;fs&#x2F;cgroup</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost cpu]# cat  tasks</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>PS：task这个文件内的数字，记录的是进程编号。PID</p><p>四大功能：</p><p>1）资源限制：cgroup可以对进程组使用的资源总额进行限制</p><p>2）优先级分配：通过分配的cpu时间片数量以及硬盘IO带宽大小，实际上相当于控制了进程运行的优先级别</p><p>3）资源统计：cgroup可以统计西系统资源使用量，比如cpu使用时间，内存使用量等，用于按量计费。同时还支持挂起功能，也就是说用过cgroup把所有的资源限制起来，对资源都不能使用，注意并不算是说我们的程序不能使用了，只是不能使用资源，处于挂起等待状态</p><p>4）进程控制：可以对进程组执行挂起、恢复等操作</p><p>内存限额：</p><p>容器内存包括两个部分：物理内存和swap</p><p>可以通过参数控制容器内存的使用量：</p><p>-m或者–memory：设置内存的使用限额</p><p>–memory-swap：设置内存+swap的使用限额</p><p>举个例子：</p><p>如果运行一个容器，并且限制该容器最多使用200M内存和100M的swap</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run  -it  -m 200M --memory-swap 300M centos:7</span><br><span class="line">[root@5bc0e71faba3 memory]# pwd</span><br><span class="line">&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//内存使用限制</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@5bc0e71faba3 memory]# cat memory.limit_in_bytes </span><br><span class="line">209715200（字节）</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//内存+swap限制</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@5bc0e71faba3 memory]# cat memory.memsw.limit_in_bytes</span><br><span class="line">314572800（字节）</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>对比一个没有限制的容器，我们会发现，如果运行容器之后不限制内存的话，意味着没有限制</p><p>CPU使用：</p><p>通过-c或者–cpu-shares设置容器使用cpu的权重，如果 不设置默认为1024</p><p>举个例子：</p><p>//没有限制：1024</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run  -it --name  containerA  centos:7</span><br><span class="line">[root@e2d88b8f8b87 &#x2F;]# cd  &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu</span><br><span class="line">[root@e2d88b8f8b87 cpu]# cat cpu.shares </span><br><span class="line">1024</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//限制CPU使用权重为512：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run  -it  --name  containerB  -c  512  centos:7</span><br><span class="line">[root@f8165e07c8d7 &#x2F;]# cd  &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu</span><br><span class="line">[root@f8165e07c8d7 cpu]# cat  cpu.shares </span><br><span class="line">512</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>容器的Block IO（磁盘的读写）：</p><p>docker中可以通过设置权重，限制bps和iops的方式控制容器读写磁盘的IO</p><p>bps：每秒的读写的数据量（byte per second）</p><p>iops：每秒IO的次数 （io per second）</p><p>默认情况下，所有容器都能够平等的读写磁盘，也可以通过–blkio-weight参数改变容器的blockIO的优先级</p><p>–device-read-bps：显示读取某个设备的bps</p><p>–device-write-bps：显示写入某个设备的bps</p><p>–device-read-iops：显示读取某个设备的iops</p><p>–device-write-iops：显示写入某个设备的iops</p><p>//限制testA这个容器，写入/dev/sda这块磁盘的bps为30MB</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run  -it --name  testA  --device-write-bps  &#x2F;dev&#x2F;sda:30MB centos:7</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//从/dev/zero输入，然后输出到test.out文件中，每次大小为1M，总共为800次，oflg=direct用来指定directIO方式写文件，这样才会使–device-write-bps生效</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@0e659ca3e85d &#x2F;]# time dd  if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;test.out bs&#x3D;1M count&#x3D;800 oflag&#x3D;direct</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
    
    <summary type="html">
    
      Docker
    
    </summary>
    
    
      <category term="Docker" scheme="http://yoursite.com/categories/Docker/"/>
    
    
      <category term="Docker" scheme="http://yoursite.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker的基本操作命令</title>
    <link href="http://yoursite.com/2020/01/25/Docker%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/"/>
    <id>http://yoursite.com/2020/01/25/Docker%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.240Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Docker的基本操作命令："><a href="#Docker的基本操作命令：" class="headerlink" title="Docker的基本操作命令："></a><strong>Docker的基本操作命令：</strong></h1><p>//查找镜像：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker search mysql &#x2F;&#x2F;默认在docker hub公共仓库进行查找</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//拉取镜像，下载镜像:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker pull busybox</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//导出镜像到本地：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker save -o busybox.tar busybox:latest （docker save &gt; busybox.tar busybox:latest）</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//查看本地镜像：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker images （docker image ls）</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>PS：虽然我们查看到镜像标签位latest（最新的），但并不表示它一定是最新的，而且镜像如果没有写标签，默认是以latest为标签</p><p>//删除镜像：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker rmi busybox:latest</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//根据本地镜像包导入镜像：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker load -i busybox.tar （docker load &lt; busybox.tar ）</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//查看容器–正在运行的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//查看所有的容器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps -a</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//删除容器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker rm centos [CONTAINER ID&#x2F;容器名称]</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//停止容器运行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker stop centos</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//启动容器:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker start centos</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>PS:开启容器后记得去验证一下容器是否开启</p><p>//强制删除容器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker rm centos -f</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//强制删除所有容器（生产环境严禁使用）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps -a -q | xargs docker rm -f</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>-———————————————————————————————</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps -a -q | xargs docker start -f &#x2F;&#x2F;开启所有容器</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# docker ps -a -q | xargs docker stop -f &#x2F;&#x2F;关闭所有容器</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//重启一个容器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker restart test2</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//运行一个容器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -it --name test1 centos:7</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>-i：交互</p><p>-t：伪终端</p><p>-d（daemon）：后台运行</p><p>–name：给容器命名</p><p>–restart=always：始终保持运行（随着docker开启而运行）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker create -it --name test3 centos:7 &#x2F;&#x2F;不常用</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//进入一个容器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker exec -it test2 &#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# docker attach test2</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>区别：</p><p>exec进入的方式需要添加-i，-t选项，后面还需要给容器一个shell环境，但attach就不需要这么麻烦</p><p>exec进入的方式：如果exit退出，容器仍然保持运行</p><p>attach：如果执行exit退出，容器会被关闭，如果想要保持容器不被关闭，可以使用键盘：ctrl+p ctrl+q可以实现</p><p>本质上区别：</p><p>exec进入的方法，会产生新的进程</p><p>attach进入的方法，不会产生新的进程</p><p>Docker的基本操作逻辑：</p><p><img src="https://img-blog.csdnimg.cn/20200116115431346.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>小实验：</p><p>基于centos:7镜像运行一个容器，并且在这个容器内部署nginx服务</p><p>1）下载镜像：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker pull centos:7</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>2）运行容器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -itd --name webapp --restart&#x3D;always centos:7</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>3）进入容器，开始部署nginx服务：//将nginx包导入到容器内：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker cp nginx-1.14.0.tar.gz</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker exec  -it  webapp  &#x2F;bin&#x2F;bash</span><br><span class="line">[root@01b870908942 ~]# tar zxf nginx-1.14.0.tar.gz   </span><br><span class="line">[root@01b870908942 ~]# cd  nginx-1.14.0</span><br><span class="line">[root@01b870908942 nginx-1.14.0]# yum  -y  install  gcc  pcre  pcre-devel  openssl  openssl-devevl zlib zlib-devel</span><br><span class="line">[root@01b870908942 nginx-1.14.0]# useradd  -s  &#x2F;sbin&#x2F;nologin  nginx</span><br><span class="line">[root@01b870908942 nginx-1.14.0]# .&#x2F;configure  --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx  --user&#x3D;nginx  --group&#x3D;nginx</span><br><span class="line">[root@01b870908942 nginx-1.14.0]# make  &amp;&amp;  make  install</span><br><span class="line">[root@01b870908942 nginx-1.14.0]# ln  -s  &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;*   &#x2F;usr&#x2F;local&#x2F;sbin&#x2F;</span><br><span class="line">[root@01b870908942 nginx-1.14.0]# nginx</span><br><span class="line">[root@01b870908942 nginx-1.14.0]# cd  &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html&#x2F;</span><br><span class="line">[root@01b870908942 html]# echo  This  is  a  resrweb  in  container  &gt;  index.html</span><br><span class="line">[root@01b870908942 html]# curl  127.0.0.1</span><br><span class="line">This is a resrweb in container</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//把容器制作成镜像：（可移植性）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker commit webapp myweb:12-10</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
    
    <summary type="html">
    
      Docker
    
    </summary>
    
    
      <category term="Docker" scheme="http://yoursite.com/categories/Docker/"/>
    
    
      <category term="Docker" scheme="http://yoursite.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker架构+Docker镜像分层+Dockerfile</title>
    <link href="http://yoursite.com/2020/01/25/Docker%E6%9E%B6%E6%9E%84+Docker%E9%95%9C%E5%83%8F%E5%88%86%E5%B1%82+Dockerfile/"/>
    <id>http://yoursite.com/2020/01/25/Docker%E6%9E%B6%E6%9E%84+Docker%E9%95%9C%E5%83%8F%E5%88%86%E5%B1%82+Dockerfile/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.224Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Docker架构："><a href="#Docker架构：" class="headerlink" title="Docker架构："></a>Docker架构：</h1><p><img src="https://img-blog.csdnimg.cn/20200116115726787.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>Docker架构总结：</p><p>Docker是属于C/S架构，用户是使用 Docker Client 与 Docker Daemon 建立通信，并发送请求。请求接收后，Docker server通过http协议与路由，找到相应的 Handler 来执行请求</p><p>Docker Engine 是 Docker 架构中的运行引擎，同时也 Docker 运行的核心模块。Docker Engine 执行 Docker 内部的一系列工作，每一项工作都是以一个 Job 的形式的存在</p><p>Job 的运行过程中，当需要容器镜像时，则从 Docker Registry 中下载镜像，并通过镜像管理驱动 Graphdriver 将下载镜像以 Graph 的形式存储</p><p>当需要为 Docker 创建网络环境时，通过网络管理驱动 Networkdriver 创建并配置 Docker容器网络环境</p><p>当需要限制 Docker 容器运行资源或执行用户指令等操作时，则通过 Execdriver 来完成</p><p>Libcontainer 是一项独立的容器管理包，Networkdriver 以及 Execdriver 都是通过 Libcontainer 来实现具体对容器进行的操作</p><h2 id="Docker镜像分层："><a href="#Docker镜像分层：" class="headerlink" title="Docker镜像分层："></a>Docker镜像分层：</h2><p>Docker的最小镜像：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker pull hello-world</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM  scratch</span><br><span class="line">CORP  hello&#x2F;</span><br><span class="line">CMD  [&quot;&#x2F;hello&quot;]</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><strong>Dockerfile的组成：</strong></p><p>1）FROM：scratch（抓、挠）</p><p>2）COPY：hello/</p><p>3）CMD：[“/hello”]</p><p>base镜像(基础镜像)：</p><p>Centos:7镜像的dockerfile</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FROM scratch  &#x2F;&#x2F;从零开始构建</span><br><span class="line"></span><br><span class="line">ADD centos-7-x86 64-docker.tar.xz &#x2F;</span><br><span class="line"></span><br><span class="line">LABEL org. label-schema. schema-version&#x3D;&quot;1.0&quot;\</span><br><span class="line">org. label-schema.namem&quot;centos Base Image&quot;\</span><br><span class="line">org. label-schema.vendore&quot;Centos&quot;\</span><br><span class="line">org. label-schema.Ticenses&quot;GPLv2&quot; \</span><br><span class="line">org. labe1-schema.build-date&quot;20190305</span><br><span class="line"></span><br><span class="line">CMD [&quot;&#x2F;bin&#x2F;bash&quot;]</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost test]# docker build -t centos7-vim-net-tools:12-11 .</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/20200116115958270.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>Dockerfile镜像分层总结：</p><p>镜像是容器的基石，容器是镜像运行后的实例，当镜像运行为容器之后，对镜像的所有数据仅有只读权限，如果需要对镜像源文件进行修改或删除操作时，此时是在容器层（可写层）进行的，用到了COW（copy on write）写时复制机制</p><p>Docker镜像的缓存特性</p><p>创建一个新的Dockerfile文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:7</span><br><span class="line">RUN yum -y install vim</span><br><span class="line">RUN yum -y install net-tools</span><br><span class="line">RUN yum -y install wget</span><br><span class="line">CMD [&quot;&#x2F;bin&#x2F;bash&quot;]</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker build -t new-centos .</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>1）如果在相同层，有用到相同的镜像，可以不必再去下载，可以直接使用缓存</p><p>创建一个新的Dockefile文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:7</span><br><span class="line">RUN yum -y install vim</span><br><span class="line">RUN yum -y install wget</span><br><span class="line">RUN yum -y install net-tools</span><br><span class="line">CMD [&quot;&#x2F;bin&#x2F;bash&quot;]</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost test1]# docker build -t centos-new .</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>2）即使镜像层里的操作一样，也必须是在同一层才可以使用dockerfile的缓存特性</p><p>如果制作镜像过程中，不想使用缓存可以加–no-cache选项</p><p>3）如果前面的曾发生改变，即使后边的层操作和顺序一样，也不能使用缓存特性</p><p>Dockerfile常用指令：</p><p>1）FROM：构建镜像基于哪个镜像</p><p>例如：FROM:centos:7</p><p>2）MAINTAINER：镜像维护者姓名或邮箱</p><p>例如：MAINTAINER admin</p><p>3）RUN：构建镜像时运行的shell命令</p><p>例如：</p><p>RUN [“yum”,”install”,”httpd”]</p><p>RUN yum -y install httpd</p><p>4）CMD：运行容器时执行的shell命令</p><p>例如：</p><p>CMD [“/bin/bash”]</p><p>5）EXPOSE：声明容器的服务端口</p><p>例如：EXPOSE 80 443</p><p>6）ENV：设置容器环境变量</p><p>例如：</p><p>ENV MYSQL_ROOT_PASSWORD 123.com</p><p>7）ADD：拷贝文件或目录到镜像，如果时URL或压缩包会自动下载或解压</p><p>ADD &lt;源文件&gt;… &lt;目标目录&gt;</p><p>ADD [“源文件”…”目标目录”]</p><p>8）COPY：拷贝文件或目录到镜像容器内，跟ADD相似，但不具备自动下载或解压功能</p><p>9）ENTRYPOINT：运行容器时执行的shell命令</p><p>例如：</p><p>ENTRYPOINT [“/bin/bash”,”-c”,”command”]</p><p>ENTRYPOINT /bin/bash -c ‘command’</p><p>10）VOLUME：指定容器挂在点到宿主机自动生成的目录或其他容器</p><p>例如：</p><p>VOLUME [“/va/lib/mysql”]</p><p>11）USER：为RUN、CMD、和ENTRYPOINT执行命令指定运行用户</p><p>12）WORKDIR：为RUN、CMD、ENTRYPOINT、COPY和ADD设置工作目录，意思为切换目录</p><p>例如：</p><p>WORKDIR：/var/lib/mysql</p><p>13）HEALTHCHECK：健康检查</p><p>14）ARG：构建时指定的一些参数</p><p>例如：</p><p>FROM centos:7</p><p>ARG user</p><p>USER $user</p><p>注意：</p><p>1、RUN在building时运行，可以写多条</p><p>2、CMD和ENTRYPOINT在运行container时，只能写一条，如果写多条，最后一条生效</p><p>3、CMD在run时可以被COMMAND覆盖，ENTRYPOINT不会被不会被COMMAND覆盖，但可以指定–entrypoint覆盖</p><p>4、如果在Dockerfile里需要往镜像内导入文件，则此文件必须在dockerfile所在目录或子目录下</p><p>小实验：</p><p>写一个dockerfile，基于cenyos:7镜像，部署安装NGINX服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir  web</span><br><span class="line">[root@localhost ~]# mv nginx-1.14.0.tar.gz  web&#x2F;</span><br><span class="line">[root@localhost ~]# cd web&#x2F;</span><br><span class="line">[root@localhost web]# vim  Dockerfile</span><br><span class="line">FROM centos:7</span><br><span class="line">RUN yum -y install gcc pcre pcre-devel openssl openssl-devel zlib zlib-devel</span><br><span class="line">COPY  nginx-1.14.0.tar.gz  &#x2F;</span><br><span class="line">RUN tar -zxf nginx-1.14.0.tar.gz -C &#x2F;usr&#x2F;src</span><br><span class="line">RUN useradd -M -s &#x2F;sbin&#x2F;nologin nginx</span><br><span class="line">WORKDIR &#x2F;usr&#x2F;src&#x2F;nginx-1.14.0</span><br><span class="line">RUN .&#x2F;configure  --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx  --user&#x3D;nginx  --group&#x3D;nginx</span><br><span class="line">RUN  make  &amp;&amp;  make  install</span><br><span class="line">RUN ln -s &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;*  &#x2F;usr&#x2F;local&#x2F;sbin</span><br><span class="line">RUN nginx -t</span><br><span class="line">RUN nginx</span><br><span class="line">EXPOSE 80</span><br><span class="line">[root@localhost web]# docker build  -t  test-web  . &#x2F;&#x2F;如果Dockerfile在其他路径需要加-f参数来指定Dockerfile文件路径</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//如果想要保证容器运行之后，nginx服务就直接开启，不必手动开启，我们可以在命令最后加上：nginx -g “daemon off;”选项</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost web]# docker run -itd --name testweb_2 test-web:latest nginx -g &quot;daemon off;&quot;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//查看容器的IP：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost web]# docker inspect  testweb_2</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
    
    <summary type="html">
    
      Docker
    
    </summary>
    
    
      <category term="Docker" scheme="http://yoursite.com/categories/Docker/"/>
    
    
      <category term="Docker" scheme="http://yoursite.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker的监控</title>
    <link href="http://yoursite.com/2020/01/25/Docker%E7%9A%84%E7%9B%91%E6%8E%A7/"/>
    <id>http://yoursite.com/2020/01/25/Docker%E7%9A%84%E7%9B%91%E6%8E%A7/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.256Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Docker的监控"><a href="#Docker的监控" class="headerlink" title="Docker的监控"></a><strong>Docker的监控</strong></h1><p>docker自带的监控命令</p><p>docker top / stats / logs</p><p>sysdig</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker  load  &lt;  sysdig.tar</span><br><span class="line">[root@localhost ~]# docker  load  &lt;  scope.1.12.tar</span><br><span class="line">[root@localhost ~]# docker run  -it  --rm  --name  sysdig  \</span><br><span class="line">&gt;   --privileged&#x3D;true  \</span><br><span class="line">&gt;   --volume&#x3D;&#x2F;var&#x2F;run&#x2F;docker.sock:&#x2F;host&#x2F;var&#x2F;run&#x2F;docker.sock  \</span><br><span class="line">&gt;   --volume&#x3D;&#x2F;dev:&#x2F;host&#x2F;dev   \</span><br><span class="line">&gt;   --volume&#x3D;&#x2F;proc:&#x2F;host&#x2F;proc:ro  \</span><br><span class="line">&gt;   --volume&#x3D;&#x2F;boot:&#x2F;host&#x2F;boot:ro  \</span><br><span class="line">&gt;   --volume&#x3D;&#x2F;lib&#x2F;modules:&#x2F;host&#x2F;lib&#x2F;modules:ro  \</span><br><span class="line">&gt;   --volume&#x3D;&#x2F;usr:&#x2F;host&#x2F;usr:ro  sysdig&#x2F;sysdig</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//下载失败后可以运行下边的命令，重新下载</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@2fefbfde3db5:&#x2F;# sysdig-probe-loader</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//下载成功之后，可以运行sysdig命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@2fefbfde3db5:&#x2F;# csysdig</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="scope"><a href="#scope" class="headerlink" title="scope"></a><strong>scope</strong></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# curl -L git.io&#x2F;scope -o &#x2F;usr&#x2F;local&#x2F;bin&#x2F;scope</span><br><span class="line">[root@localhost ~]# chmod  a+x  &#x2F;usr&#x2F;local&#x2F;bin&#x2F;scope</span><br><span class="line">[root@localhost ~]# scope launch</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//访问本机的4040端口</p><p><img src="https://img-blog.csdnimg.cn/20200117112551162.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//监控两台dockerhost</p><table><thead><tr><th>docker01</th><th>192.168.1.70</th></tr></thead><tbody><tr><td>docker02</td><td>192.168.1.50</td></tr></tbody></table><p>//docker02上也需要同样的操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@docker02 ~]# curl -L git.io&#x2F;scope -o &#x2F;usr&#x2F;local&#x2F;bin&#x2F;scope</span><br><span class="line">[root@docker02 ~]# chmod  a+x  &#x2F;usr&#x2F;local&#x2F;bin&#x2F;scope</span><br><span class="line">[root@docker02 ~]# docker  load  &lt;  scope.1.12.tar</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# scope launch  192.168.1.70 192.168.1.50</span><br><span class="line">[root@docker02 ~]# scope launch  192.168.1.50  192.168.1.70</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/20200117112630969.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
    
    <summary type="html">
    
      Docker
    
    </summary>
    
    
      <category term="Docker" scheme="http://yoursite.com/categories/Docker/"/>
    
    
      <category term="Docker" scheme="http://yoursite.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker的私有仓库</title>
    <link href="http://yoursite.com/2020/01/25/Docker%E7%9A%84%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/"/>
    <id>http://yoursite.com/2020/01/25/Docker%E7%9A%84%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.256Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Registry"><a href="#Registry" class="headerlink" title="Registry"></a><strong>Registry</strong></h1><p>用docker容器运行registry私有仓库</p><p>下载registry镜像：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker  pull  registry:2  &#x2F;&#x2F;2版本是使用go语言编写的，而registry是使用python写的</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//运行私有仓库：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -itd --name registry --restart&#x3D;always -p 5000:5000 -v &#x2F;registry:&#x2F;var&#x2F;lib&#x2F;registry registry:2</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>-p：端口映射（宿主机端口：容器暴露的端口）</p><p>-v：挂载目录（宿主机的目录：容器内的目录）</p><p>镜像重命名：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker tag test-web:latest  192.168.1.70:5000&#x2F;test</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>上传镜像到私有仓库：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim  &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;docker.service</span><br><span class="line">修改：指定私有仓库地址</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;dockerd --insecure-registry 192.168.1.70:5000</span><br><span class="line">[root@localhost ~]# systemctl  daemon-reload </span><br><span class="line">[root@localhost ~]# systemctl  restart  docker</span><br><span class="line">[root@localhost ~]# docker push  192.168.1.70:5000&#x2F;test:latest</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>这里注意，既然是私有仓库，肯定是要考虑多台DockerHost共用的情况，如果有其他的DockerHost想要使用私有仓库，仅需要修改docker的配置文件，指定私有仓库的IP和端口即可。当然别忘了，更改过配置文件之后，daemon-reload ,restart docker服务</p><h1 id="企业级私有仓库镜像Harbor"><a href="#企业级私有仓库镜像Harbor" class="headerlink" title="企业级私有仓库镜像Harbor"></a><strong>企业级私有仓库镜像Harbor</strong></h1><p>下载一个docker-compse工具</p><p>//从GitHub上下载方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# curl -L https:&#x2F;&#x2F;github.com&#x2F;docker&#x2F;compose&#x2F;releases&#x2F;download&#x2F;1.25.0&#x2F;docker-compose-&#96;uname -s&#96;-&#96;uname -m&#96; -o &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose</span><br><span class="line">[root@docker01 ~]# chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# tar zxf docker-compose.tar.gz  -C  &#x2F;usr&#x2F;local&#x2F;bin</span><br><span class="line">[root@docker01 ~]# chmod  +x  &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//下载依赖包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# yum  -y  install  yum-utils  device-mapper-persistent-data  lvm2</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//导入harbo离线安装包，并解压到/usr/local/下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# tar zxf harbor-offline-installer-v1.7.4.tgz -C &#x2F;usr&#x2F;local&#x2F;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//安装harbor</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# cd  &#x2F;usr&#x2F;local&#x2F;harbor&#x2F;</span><br><span class="line">[root@docker01 harbor]# vim  harbor.cfg</span><br><span class="line">hostname &#x3D; 192.168.1.70</span><br><span class="line">[root@docker01 harbor]# .&#x2F;install.sh</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//浏览器访问：192.168.1.70</p><p>用户名：admin</p><p>密码：Harbor12345</p><p><img src="https://img-blog.csdnimg.cn/2020011611433816.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//修改docker配置文件，连接Harbor私有仓库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# vim  &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;docker.service</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;dockerd  --insecure-registry  192.168.1.70</span><br><span class="line">[root@docker01 ~]# systemctl  daemon-reload </span><br><span class="line">[root@docker01 ~]# systemctl  restart  docker</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//创建私有仓库</p><p><img src="https://img-blog.csdnimg.cn/20200116114438273.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//登录仓库上传镜像</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 harbor]# docker login  -u  admin -p  Harbor12345  192.168.1.70</span><br><span class="line">[root@docker01 harbor]# docker tag  centos:7  192.168.1.70&#x2F;bdqn&#x2F;centos:7</span><br><span class="line">[root@docker01 harbor]# docker push  192.168.1.70&#x2F;bdqn&#x2F;centos:7</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//从私有仓库下载镜像</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@docker03 ~]# docker pull  192.168.1.70&#x2F;bdqn&#x2F;centos:7</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
    
    <summary type="html">
    
      Docker
    
    </summary>
    
    
      <category term="Docker" scheme="http://yoursite.com/categories/Docker/"/>
    
    
      <category term="Docker" scheme="http://yoursite.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker部署LNMP环境</title>
    <link href="http://yoursite.com/2020/01/25/Docker%E9%83%A8%E7%BD%B2LNMP%E7%8E%AF%E5%A2%83/"/>
    <id>http://yoursite.com/2020/01/25/Docker%E9%83%A8%E7%BD%B2LNMP%E7%8E%AF%E5%A2%83/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.271Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Docker部署LNMP环境"><a href="#Docker部署LNMP环境" class="headerlink" title="Docker部署LNMP环境"></a><strong>Docker部署LNMP环境</strong></h1><p>172.16.10.0/24</p><p>Nginx：172.16.10.10</p><p>Mysql：172.16.10.20</p><p>PHP：172.16.10.30</p><p>网站的访问主目录：/wwwroot</p><p>Nginx的配置文件：/docker</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker  run  -itd  --name  test  nginx:latest</span><br><span class="line">[root@localhost ~]# mkdir  &#x2F;wwwroot</span><br><span class="line">[root@localhost ~]# mkdir  &#x2F;docker</span><br><span class="line">[root@localhost ~]# docker cp test:&#x2F;etc&#x2F;nginx  &#x2F;docker&#x2F;</span><br><span class="line">[root@localhost ~]# ls &#x2F;docker&#x2F;</span><br><span class="line">nginx</span><br><span class="line">[root@localhost ~]# docker cp test:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html &#x2F;wwwroot&#x2F;</span><br><span class="line">[root@localhost ~]# ls  &#x2F;wwwroot&#x2F;</span><br><span class="line">html</span><br><span class="line">[root@localhost ~]# vim   &#x2F;wwwroot&#x2F;html&#x2F;index.html</span><br><span class="line">[root@localhost ~]# cat  &#x2F;wwwroot&#x2F;html&#x2F;index.html </span><br><span class="line">hello  LNMP!</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>1）创建一个自定义网络</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker network create -d bridge --subnet 172.16.10.0&#x2F;24 --gateway 172.16.10.1 lnmp</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>2）运行nginx容器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run  -itd  --name  nginx  -v  &#x2F;docker&#x2F;nginx&#x2F;:&#x2F;etc&#x2F;nginx  -v  &#x2F;wwwroot&#x2F;html&#x2F;:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html  -p  80:80  --network  lnmp  --ip  172.16.10.10  nginx:latest</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>3）运行mysql容器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run  --name  mysql  -e  MYSQL_ROOT_PASSWORD&#x3D;123.com  -d  -p  3306:3306  --network  lnmp  --ip  172.16.10.20  mysql:5.7</span><br><span class="line">[root@localhost ~]# yum  -y  install  mysql</span><br><span class="line">[root@localhost ~]# mysql -u root  -p123.com  -h  127.0.0.1  -P  3306</span><br><span class="line">MySQL [(none)]&gt; create  database  name;</span><br><span class="line">MySQL [(none)]&gt; show  databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| name               |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>4）运行php容器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -itd --name phpfpm -p 9000:9000 -v &#x2F;wwwroot&#x2F;html&#x2F;:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html --network lnmp --ip 172.16.10.30 php:7.2-fpm</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//添加php测试页面：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost html]# pwd</span><br><span class="line">&#x2F;wwwroot&#x2F;html</span><br><span class="line">[root@localhost html]# cat  test.php </span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>5）修改nginx配置文件，nginx和php连接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd  &#x2F;docker&#x2F;nginx&#x2F;conf.d&#x2F;</span><br><span class="line">[root@localhost conf.d]# vim  default.conf</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        root   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">        index  index.html index.htm index.php;  &#x2F;&#x2F;添加php解析</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;打开此模块，并更改相应信息</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        root           &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">        fastcgi_pass   172.16.10.30:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//重启nginx</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf.d]# docker  restart  nginx</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//到此，去浏览器验证，nginx服务和php服务界面</p><p><img src="https://img-blog.csdnimg.cn/20200117104031897.png" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/20200117104044974.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>说明nginx和php的来连接，没有问题，接下来是php和mysql的连接，在这我们使用一个phpMyAdmin的数据库管理工具</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost html]# pwd</span><br><span class="line">&#x2F;wwwroot&#x2F;html</span><br><span class="line">[root@localhost html]# unzip phpMyAdmin-4.9.1-all-languages.zip</span><br><span class="line">[root@localhost html]# mv  phpMyAdmin-4.9.1-all-languages  phpmyadmin</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//更改nginx的配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd  &#x2F;docker&#x2F;nginx&#x2F;conf.d&#x2F;</span><br><span class="line">[root@localhost conf.d]# pwd</span><br><span class="line">&#x2F;docker&#x2F;nginx&#x2F;conf.d</span><br><span class="line">[root@localhost conf.d]# vim  default.conf</span><br><span class="line">&#x2F;&#x2F;在27行添加</span><br><span class="line">    location  &#x2F;phpmyadmin &#123;</span><br><span class="line">        root  &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">        index   index.html  index.htm  index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;在43行添加</span><br><span class="line">    location ~ &#x2F;phpmyadmin&#x2F;(?&lt;after_ali&gt;(.*)\.(php|php5)?$) &#123;</span><br><span class="line">        root           &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">        fastcgi_pass   172.16.10.30:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">        include        fastcgi_params;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//重启nginx</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf.d]# docker  restart  nginx</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//验证php主界面</p><p><img src="https://img-blog.csdnimg.cn/20200117104224331.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//需要我们对php镜像做出更改，添加php和mysql连接的模块</p><p>写一个Docker</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FROM php:7.2-fpm</span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">        libfreetype6-dev \</span><br><span class="line">        libjpeg62-turbo-dev \</span><br><span class="line">        libpng-dev \</span><br><span class="line">    &amp;&amp; docker-php-ext-install -j$(nproc) iconv \</span><br><span class="line">    &amp;&amp; docker-php-ext-configure gd --with-freetype-dir&#x3D;&#x2F;usr&#x2F;include&#x2F; --with-jpeg-dir&#x3D;&#x2F;usr&#x2F;include&#x2F; \</span><br><span class="line">    &amp;&amp; docker-php-ext-install -j$(nproc) gd \</span><br><span class="line">        &amp;&amp; docker-php-ext-install mysqli pdo pdo_mysql</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker build  -t  phpmysql  .</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//删除之前的php容器，并用我们新制作的php镜像重新运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker stop  phpfpm </span><br><span class="line">[root@localhost ~]# docker rm  phpfpm </span><br><span class="line">[root@localhost ~]# docker run  -itd  --name  phpfpm  -p 9000:9000  -v  &#x2F;wwwroot&#x2F;html&#x2F;:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html  --network lnmp  --ip 172.16.10.30  phpmysql:latest</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//修改phpmyadmin的配置文件，指定连接的数据库的IP，然后重启php容器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd  &#x2F;wwwroot&#x2F;html&#x2F;phpmyadmin&#x2F;</span><br><span class="line">[root@localhost phpmyadmin]# pwd</span><br><span class="line">&#x2F;wwwroot&#x2F;html&#x2F;phpmyadmin</span><br><span class="line">[root@localhost phpmyadmin]# cp  config.sample.inc.php  config.inc.php</span><br><span class="line">[root@localhost phpmyadmin]# vim  config.inc.php</span><br><span class="line">$cfg[&#39;Servers&#39;][$i][&#39;host&#39;] &#x3D; &#39;172.16.10.20&#39;;    &#x2F;&#x2F;修改，指定数据库的IP地址</span><br><span class="line">[root@localhost ~]# docker restart  phpfpm</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>用户名：root</p><p>密码：123.com</p><p><img src="https://img-blog.csdnimg.cn/20200117104322390.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//登录成功之后会看到我们之前创建的数据库</p><p><img src="https://img-blog.csdnimg.cn/20200117104346584.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
    
    <summary type="html">
    
      Docker
    
    </summary>
    
    
      <category term="Docker" scheme="http://yoursite.com/categories/Docker/"/>
    
    
      <category term="Docker" scheme="http://yoursite.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>KVM磁盘格式</title>
    <link href="http://yoursite.com/2020/01/25/KVM%E7%A3%81%E7%9B%98%E6%A0%BC%E5%BC%8F/"/>
    <id>http://yoursite.com/2020/01/25/KVM%E7%A3%81%E7%9B%98%E6%A0%BC%E5%BC%8F/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.318Z</updated>
    
    <content type="html"><![CDATA[<p>磁盘格式：<br>RAW：（裸格式）   //占用空间较大，性能较好，但不支持虚拟机快照功能<br>QCOW2：（copy on write）  //占用空间较小，支持快照，性能比RAW稍差一些</p><p>创建磁盘：（默认是裸格式）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm disk]# qemu-img  create 1234.raw 5G</span><br></pre></td></tr></table></figure><p>查看磁盘信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm disk]# qemu-img  info  1234.raw</span><br></pre></td></tr></table></figure><p>创建指定格式磁盘：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm disk]# qemu-img  create  -f  qcow2  bdqn.qcow2 5G</span><br></pre></td></tr></table></figure><p>转换磁盘格式：<br>qemu-img  convert [-f fmt] [-O output_fmt] filename output_filename</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm kvm-vm]# qemu-img  convert  -f  raw  -O  qcow2 centos.raw  centos.qcow2</span><br></pre></td></tr></table></figure><p>//转换之后原来的磁盘还在</p><p>拍摄快照：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# virsh  snapshot-create  test01</span><br></pre></td></tr></table></figure><p>查看快照信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# virsh  snapshot-list  test01</span><br><span class="line"> 名称               生成时间              状态</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"> 1575254957           2019-12-02 10:49:17 +0800 running</span><br></pre></td></tr></table></figure><p>时间戳：1970年1月1号（计算机C语言诞生了，Linux系统诞生了）<br>32位系统：68年之后你的系统就不能使用了<br>64位系统：使用时间没有限制</p><p>根据快照恢复系统：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# virsh  snapshot-revert  test01  1575254957</span><br></pre></td></tr></table></figure><p>//拍摄的快照是占用磁盘空间的</p>]]></content>
    
    <summary type="html">
    
      KVM
    
    </summary>
    
    
      <category term="KVM" scheme="http://yoursite.com/categories/KVM/"/>
    
    
      <category term="KVM" scheme="http://yoursite.com/tags/KVM/"/>
    
  </entry>
  
  <entry>
    <title>KVM简介</title>
    <link href="http://yoursite.com/2020/01/25/KVM%E7%AE%80%E4%BB%8B/"/>
    <id>http://yoursite.com/2020/01/25/KVM%E7%AE%80%E4%BB%8B/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.318Z</updated>
    
    <content type="html"><![CDATA[<p>KVM简介：<br>什么是云计算：<br>云计算:配置各种资源的方式</p><p>云计算的分类：<br>基础即服务Lass<br>平台即服务Pass<br>软件即服务Sass<br>如果按照不同的部署方式：公有云、私有云、混合云</p><p>KVM介绍：虚拟化的不同的方式</p><p>实现虚拟化的技术：<br>基于二进制翻译的全虚拟化：（会报错）<br>解决思路：<br>捕捉报错—-翻译—模拟（会增加服务器的开销）</p><p>半虚拟化（Xen）：更改内核，只能用到Linux系统上<br>全虚拟化：KVM、VMware<br>//所依赖的硬件全部准备好就行</p><p>KVM的概念：<br>基于内核的虚拟机（Kernel-Based VIrtul mathine）</p><p>打开KVM的方式：<br>virt-manager<br>应用程序–系统工具–虚拟系统管理器</p><p>命令创建虚拟主机域：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost iso]# virt-install  --os-type&#x3D;linux  --os-variant centos7.0</span><br><span class="line">--name test01  --ram 1024  --vcpus 1 --disk&#x3D;&#x2F;kvm-vm&#x2F;centos.raw,format&#x3D;raw,size&#x3D;10</span><br><span class="line">--location  &#x2F;iso&#x2F;CentOS-7-x86_64-DVD-1611.iso  </span><br><span class="line">--network  network&#x3D;default  --graphics  vnc,listen&#x3D;0.0.0.0  --noautoconsole（不会占用终端）</span><br></pre></td></tr></table></figure><p>vnc连接KVM虚拟机默认的端口为：5900</p>]]></content>
    
    <summary type="html">
    
      KVM
    
    </summary>
    
    
      <category term="KVM" scheme="http://yoursite.com/categories/KVM/"/>
    
    
      <category term="KVM" scheme="http://yoursite.com/tags/KVM/"/>
    
  </entry>
  
  <entry>
    <title>KVM网络</title>
    <link href="http://yoursite.com/2020/01/25/KVM%E7%BD%91%E7%BB%9C/"/>
    <id>http://yoursite.com/2020/01/25/KVM%E7%BD%91%E7%BB%9C/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.318Z</updated>
    
    <content type="html"><![CDATA[<p>NAT模式：<br>KVM默认的网络方式，如果想要应用这种模式，防火墙需要打开，因为需要用到iptables规则</p><p>//打开防火墙添加规则，打开5900端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd  --add-port&#x3D;5900&#x2F;tcp  --permanent </span><br><span class="line">success</span><br><span class="line">[root@localhost ~]# firewall-cmd  --reload</span><br><span class="line">success</span><br><span class="line">[root@localhost ~]# firewall-cmd   --list-all</span><br></pre></td></tr></table></figure><p>//添加路由转发：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# echo  net.ipv4.ip_forward &#x3D; 1  &gt;&gt;  &#x2F;etc&#x2F;sysctl.conf </span><br><span class="line">[root@localhost ~]# sysctl  -p</span><br><span class="line">net.ipv4.ip_forward &#x3D; 1</span><br></pre></td></tr></table></figure><p>总结：<br>nat模式支持主机与虚拟机的互访，也支持虚拟机访问互联网，但不支持外网访问虚拟机域</p><p>桥接网络：<br>1）创建虚拟桥接网卡br0</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl  stop  NetworkManager</span><br><span class="line">[root@localhost ~]# virsh  iface-bridge  ens33  br0  &#x2F;&#x2F;提示失败不用理会</span><br><span class="line">使用附加设备 br0 生成桥接 ens33 失败</span><br><span class="line">已启动桥接接口 br0</span><br></pre></td></tr></table></figure><p>//查看配置文件会看到，ens33桥接到了br0</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost network-scripts]# cat ifcfg-ens33</span><br><span class="line">DEVICE&#x3D;ens33</span><br><span class="line">ONBOOT&#x3D;yes</span><br><span class="line">BRIDGE&#x3D;&quot;br0&quot;</span><br><span class="line">[root@localhost network-scripts]# brctl  show</span><br><span class="line">bridge namebridge idSTP enabledinterfaces</span><br><span class="line">br08000.000c2901f11fyesens33</span><br><span class="line">virbr08000.525400dc381byesvirbr0-nic</span><br></pre></td></tr></table></figure><p>2）修改kvm虚拟机域的xml配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;interface type&#x3D;&#39;bridge&#39;&gt;</span><br><span class="line">&lt;mac address&#x3D;&#39;52:54:00:f8:a1:c9&#39;&#x2F;&gt;</span><br><span class="line">&lt;source bridge&#x3D;&#39;br0&#39;&#x2F;&gt;</span><br></pre></td></tr></table></figure><p>3）开启虚拟机，配置IP，验证是否能够联通外网:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vi  &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth</span><br></pre></td></tr></table></figure><p>//IP和br0的IP要在同一网段</p>]]></content>
    
    <summary type="html">
    
      KVM
    
    </summary>
    
    
      <category term="KVM" scheme="http://yoursite.com/categories/KVM/"/>
    
    
      <category term="KVM" scheme="http://yoursite.com/tags/KVM/"/>
    
  </entry>
  
  <entry>
    <title>KVM基本操作命令</title>
    <link href="http://yoursite.com/2020/01/25/KVM%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/"/>
    <id>http://yoursite.com/2020/01/25/KVM%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.334Z</updated>
    
    <content type="html"><![CDATA[<p>基于操作命令<br>1）查看虚拟机列表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# virsh  list   &#x2F;&#x2F;查看正在运行的虚拟机</span><br><span class="line">[root@kvm ~]# virsh   list  --all   &#x2F;&#x2F;查看所有虚拟机</span><br></pre></td></tr></table></figure><p>//开机的虚拟机才有ID号，而且会随时变化<br> Id    名称                         状态</p><hr><ul><li>test01                         关闭</li></ul><p>2）查看虚拟机的详细信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# virsh   dominfo  test01     &#x2F;&#x2F;dom全称domain，域的意思</span><br><span class="line">Id:             -</span><br><span class="line">名称：       test01</span><br><span class="line">UUID:           8ba94166-08dd-4805-962b-c99ed56869bc</span><br><span class="line">OS 类型：    hvm</span><br><span class="line">状态：       关闭</span><br><span class="line">CPU：          1</span><br><span class="line">最大内存： 1048576 KiB</span><br><span class="line">使用的内存： 1048576 KiB</span><br><span class="line">持久（peisistent）：       是    &#x2F;&#x2F;数据的持久化</span><br><span class="line">自动启动（autostart）： 禁用   &#x2F;&#x2F;是否开机自启</span><br><span class="line">管理的保存： 否</span><br><span class="line">安全性模式： none</span><br><span class="line">安全性 DOI： 0</span><br></pre></td></tr></table></figure><p>3）虚拟机域的开关机：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# virsh  start  test01   &#x2F;&#x2F;开机</span><br><span class="line">[root@kvm ~]# virsh  shutdown  test01  &#x2F;&#x2F;关机（shutdown：温柔的关机）</span><br><span class="line">[root@kvm ~]# virsh  shutdown  2    &#x2F;&#x2F;2为ID号</span><br></pre></td></tr></table></figure><p>//关机后再开机ID号也会变化</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# virsh   destroy  test01  &#x2F;&#x2F;强制关机，类似于拔电源</span><br></pre></td></tr></table></figure><p>4）导出配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# virsh   dumpxml  test01  &gt;  test01.xml    &#x2F;&#x2F;dump备份的意思</span><br></pre></td></tr></table></figure><p>vmnet0：桥接   //好处：外网能够访问你的虚拟机<br>vmnet1：主机<br>vmnet8：NAT   //缺点：外网访问不了你的虚拟机，好处：可以自己随意指定IP</p><p>一个完成的KVM域，生成之后会有两个文件：<br>    1）磁盘文件：在部署之处已经指定   //用来记录它的信息<br>    2）xml配置文件，默认在/etc/libvirt/qemu   //qemu模拟硬件，类型为raw</p><p>5）删除虚拟机：<br>//删除之前保证虚拟机是关闭状态</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# virsh  undefine  test01    &#x2F;&#x2F;undefine取消定义</span><br></pre></td></tr></table></figure><p>//xml配置文件也会被删除，但是磁盘文件不会被影响</p><p>6）根据配置文件恢复虚拟机：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# virsh  define  test01.xml    &#x2F;&#x2F;define：定义</span><br></pre></td></tr></table></figure><p>7）修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm qemu]# virsh   edit  test01</span><br></pre></td></tr></table></figure><p>edit：自带语法检查功能（y：是、n：不、i：忽略、f：强制）<br>vim：不会提示你语法错误</p><p>8）虚拟机重命名（7.2版本之前的不支持这条命令）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm ~]# virsh  domrename  test01   test1   &#x2F;&#x2F;重命名前关闭虚拟机</span><br></pre></td></tr></table></figure><p>9）查看虚拟机对应的vnc端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# virsh  vncdisplay  test01</span><br><span class="line">:0</span><br></pre></td></tr></table></figure><p>:0等于5900<br>:1=5901<br>:2=5902</p><p>10)挂起虚拟机</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# virsh suspend  test01</span><br><span class="line">[root@localhost ~]# virsh  resume  test01   &#x2F;&#x2F;恢复挂起的虚拟机</span><br></pre></td></tr></table></figure><p>11）开机自启</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# virsh  autostart  test01</span><br><span class="line">[root@localhost autostart]# virsh  autostart  --disable  test01  &#x2F;&#x2F;取消开机自启</span><br></pre></td></tr></table></figure><p>12）console登录KVM域<br>//在KVM域里添加</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grubby  --update-kernel&#x3D;ALL  --args&#x3D;&quot;console&#x3D;ttyS0&quot;</span><br><span class="line">reboot</span><br><span class="line">virsh console  test01    &#x2F;&#x2F;使用xshell连接kvm</span><br><span class="line">退出 ctrl+]</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      KVM
    
    </summary>
    
    
      <category term="KVM" scheme="http://yoursite.com/categories/KVM/"/>
    
    
      <category term="KVM" scheme="http://yoursite.com/tags/KVM/"/>
    
  </entry>
  
  <entry>
    <title>ReplicaSet、DaemonSet</title>
    <link href="http://yoursite.com/2020/01/25/ReplicaSet%E3%80%81DaemonSet/"/>
    <id>http://yoursite.com/2020/01/25/ReplicaSet%E3%80%81DaemonSet/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.303Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a><strong>ReplicaSet</strong></h3><hr><p>RC：ReplicationoController（老一代的Pod控制器）</p><p>RS：ReplicaSet（新一代的Pod控制器）</p><p>用于确保由其管理的控制的Pod对象副本，能够满足用户期望，多则删除，少则通过模板创建</p><p>deployment、rs、rc</p><p>特点：</p><ul><li>确保Pod资源对象的数量精准</li><li>确保Pod健康运行</li><li>弹性伸缩</li></ul><p>同样，它也可以通过yaml或json格式的资源清单来创建，其中spec字段一般嵌套一下字段</p><ul><li>replicas：期望的Pod对象副本数量</li><li>selector：当前控制器匹配Pod对象副本的标签</li><li>template：Pod副本的模板</li></ul><p>与RC相比而言，RS不仅支持基于等值的标签选择器，而且还支持集合的标签选择器</p><p>标签：解决同类型的资源对象越来越多，为了更好的管理，按照标签分组</p><p>常用标签分类：</p><ul><li>release（版本）：stable（稳定版）、canary（金丝雀）、beta（测试版）</li><li>environment（环境变量）：dev（开发）、qa（测试）、production（生产）</li><li>application（应用）：ui、as（application software应用软件）、pc、sc</li><li>tier（架构层级）：frontend（前端）、backend（后端）、cache（缓存）</li><li>partition（分区）：customerA（客户A）、customoerB（客户B）</li><li>track（品控级别）：daily（每天）、weekly（每周）</li></ul><p>标签要做到：见名知意</p><p>//通过–show-labels显示资源对象的标签</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  get pod   --show-labels</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//通过-l选项查看仅含有包含某个标签的资源</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  get pod -l env</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//通过-L显示某个键对应的值</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  get pod -L   env</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//给Pod资源添加标签</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  label pod label app&#x3D;pc</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//删除标签</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  label  pod  label app-</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//修改标签</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl label pod label env&#x3D;dev  --overwrite</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>如果标签有多个，标签选择器选择其中一个，也可以关联成功，相反，如果选择器有多个，那标签必须完全满足条件，才可以关联成功</p><p>标签选择器：标签的查询过滤条件</p><ul><li>基于等值关系的（equality-based）：”=”，”==”，”!=” =” 前面两个都是相等，最后是不等</li><li>基于集合关系（set-based）：in、notin、exists三种</li></ul><p>例子：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">selector:</span><br><span class="line">  matchLables:</span><br><span class="line">    app:  nginx</span><br><span class="line">  metchExpressions:</span><br><span class="line">    - &#123;key: name,operator:  In,values:  [zhangsan,lisi]&#125;</span><br><span class="line">    - &#123;key: age,operator: Exists,values:&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>matchLabels：指定键值对来表示的标签选择器</p><p>matchExpressions：基于表达式来指定的标签选择器，选择器列表间为”逻辑与”关系；使用In或者Notin操作时，其values不强制要求为非控的字符串，而使用Exists或DosNotExist时，其values必须为空</p><p><img src="https://img-blog.csdnimg.cn/2020012113452210.png" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>使用标签选择器的逻辑：</p><ol><li>同时指定的多个选择器之间的逻辑关系为”与”操作</li><li>使用空值的标签选择器意味着每个资源对象都将被选择中</li><li>空的标签选择器无法选中任何资源</li></ol><h3 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a><strong>DaemonSet</strong></h3><hr><p>它也是一种Pod控制器</p><p>使用场景：如果必须将Pod运行再固定的某个或某几个节点，且要优先其他Pod的启动，通常情况下，默认会每个节点都会运行，并且只能运行一个Pod，这种情况推荐使用DaemonSet资源对象</p><p>监控程序：</p><p>日志收集程序：</p><p>运行一个web服务，在每一个节点都运行一个Pod</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim  daemonset.yaml</span><br><span class="line">kind: DaemonSet</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: test-ds</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: test-ns</span><br><span class="line">    spec:</span><br><span class="line">      containers: </span><br><span class="line">      - name: test-ns</span><br><span class="line">        image:  httpd:v1</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>RC、RS、Deployment、DaemonSet，Pod控制器。statfulSet（有状态）、Ingress。Pod</p><p>RBAC：基于用户的认证授权机制</p>]]></content>
    
    <summary type="html">
    
      K8s
    
    </summary>
    
    
      <category term="k8s" scheme="http://yoursite.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="http://yoursite.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>虚拟机的克隆</title>
    <link href="http://yoursite.com/2020/01/25/%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%85%8B%E9%9A%86/"/>
    <id>http://yoursite.com/2020/01/25/%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%85%8B%E9%9A%86/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.318Z</updated>
    
    <content type="html"><![CDATA[<p>克隆：<br>克隆的两种方式：<br>1、手动克隆（完整克隆）：<br>test01———-&gt;test02：（将test01克隆为test02）<br>1）复制xml配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd  &#x2F;etc&#x2F;libvirt&#x2F;qemu&#x2F;</span><br><span class="line">[root@localhost qemu]# cp  test01.xml  test02.xml</span><br><span class="line">或者</span><br><span class="line">[root@kvm ~]# virsh   dumpxml  test01  &gt;  test02.xml</span><br></pre></td></tr></table></figure><p>2）复制磁盘文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost qemu]# cd  &#x2F;kvm-vm&#x2F;</span><br><span class="line">[root@localhost kvm-vm]# cp  centos.raw   test02.raw</span><br></pre></td></tr></table></figure><p>3）修改配置文件并重新生成一个虚拟机：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kvm-vm]# cd  &#x2F;etc&#x2F;libvirt&#x2F;qemu&#x2F;</span><br><span class="line">[root@localhost qemu]# vim  test02.xml</span><br></pre></td></tr></table></figure><p>a:name字段<br>b:删除UUID<br>c:删除mac address<br>d:修改磁盘路径以及名称</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost qemu]# virsh   define  test02.xml</span><br></pre></td></tr></table></figure><p>链接克隆：<br>//做一个链接的磁盘，然后第二个新的虚拟机更改xml配置文件，磁盘信息指定新的链接磁盘</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost kvm-vm]# qemu-img  create  -f  qcow2  -b  centos.raw  test02.qcow2</span><br></pre></td></tr></table></figure><p>自动克隆（完整克隆）:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# virt-clone  --auto-clone -o  test02  -n test03</span><br></pre></td></tr></table></figure><p>//-o:表示克隆谁，-n：指定名称</p>]]></content>
    
    <summary type="html">
    
      KVM
    
    </summary>
    
    
      <category term="KVM" scheme="http://yoursite.com/categories/KVM/"/>
    
    
      <category term="KVM" scheme="http://yoursite.com/tags/KVM/"/>
    
  </entry>
  
  <entry>
    <title>虚拟机的迁移</title>
    <link href="http://yoursite.com/2020/01/25/%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E8%BF%81%E7%A7%BB/"/>
    <id>http://yoursite.com/2020/01/25/%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E8%BF%81%E7%A7%BB/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.334Z</updated>
    
    <content type="html"><![CDATA[<p>虚拟机的迁移：</p><p>冷迁移（静态迁移）：  //服务器需要关闭<br>kvm01：192.168.1.100<br>kvm02：192.168.1.200</p><p>两台机器防火墙全部关闭，禁用selinux</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# lsmod |  grep  kvm  &#x2F;&#x2F;查看是否支持kvm</span><br><span class="line">[root@localhost ~]# systemctl  status  libvirtd  &#x2F;&#x2F;查看libvirtd服务是否正常</span><br></pre></td></tr></table></figure><p>//迁移和克隆差不多，都是需要对磁盘文件和xml配置文件进行操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm01 ~]# scp  &#x2F;etc&#x2F;libvirt&#x2F;qemu&#x2F;test01.xml root@192.168.1.200:&#x2F;etc&#x2F;libvirt&#x2F;qemu </span><br><span class="line">[root@kvm01 ~]# scp  &#x2F;kvm-vm&#x2F;centos.raw   root@192.168.1.200:&#x2F;kvm-vm&#x2F;</span><br><span class="line">[root@kvm02 ~]# virsh  define   &#x2F;etc&#x2F;libvirt&#x2F;qemu&#x2F;test01.xml</span><br></pre></td></tr></table></figure><p>热迁移（动态迁移）：<br>删除所有的KVM虚拟机<br>kvm01：192.168.1.100<br>kvm02：192.168.1.200<br>NFS：192.168.1.129</p><p>1）在NFS服务器上面操作：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@NFS ~]# yum  -y  install  nfs-utils</span><br><span class="line">[root@NFS ~]# mkdir &#x2F;kvmshare  &#x2F;&#x2F;创建共享文件夹</span><br><span class="line">[root@NFS ~]# vim  &#x2F;etc&#x2F;exports  &#x2F;&#x2F;编辑共享文件夹权限</span><br><span class="line">[root@NFS ~]# cat &#x2F;etc&#x2F;exports</span><br><span class="line">&#x2F;kvmshare  *(rw,sync,no_root_squash)</span><br><span class="line">[root@NFS ~]# systemctl  start  rpcbind  &#x2F;&#x2F;远程传输控制协议</span><br><span class="line">[root@NFS ~]# systemctl  enable  rpcbind</span><br><span class="line">[root@NFS ~]# systemctl  start  nfs-server</span><br><span class="line">[root@NFS ~]# systemctl  enable  nfs-server</span><br></pre></td></tr></table></figure><p>//确保两台KVM服务器能看到</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm01 ~]# showmount  -e  192.168.1.129</span><br><span class="line">[root@kvm02 ~]# showmount  -e  192.168.1.129</span><br></pre></td></tr></table></figure><p>2）KVM01上基于NFS服务创建虚拟机<br>添加新的存储池：<br>名称：nfsshare<br>类型：netfs<br>目标路径：/opt/nfsshare（本机挂在的目录，目录默认没有，但会自己创建）<br>主机名:192.168.1.129（nfs-server IP address）<br>源路径：/kvmshare（nfs-server上的共享目录）</p><p>验证nfs服务是否正常：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm01 ~]# touch    &#x2F;opt&#x2F;nfsshare&#x2F;test</span><br><span class="line">[root@NFS ~]# ls  &#x2F;kvmshare&#x2F;</span><br><span class="line">test</span><br></pre></td></tr></table></figure><p>创建存储卷：<br>名称：centos7<br>最大容量：10G</p><p>//存储池和存储卷完成之后，直接创建虚拟机，并最小化安装<br>选择之前的创建的iso镜像以及刚才创建的存储池和存储卷</p><p>配置虚拟机使用bridge桥接网络，使其能够ping通外网，并且在这里我们执行一个ping百度的命令，并让他保持一直是ping着的状态，用来模拟迁移到kvm02上服务不中断：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm01 ~]# virsh  destroy  centos7.0</span><br><span class="line">[root@kvm01 ~]# systemctl  stop  NetworkManager</span><br><span class="line">[root@kvm01 ~]# virsh  iface-bridge ens33  br0</span><br><span class="line">[root@kvm01 ~]# virsh  edit  centos7.0</span><br><span class="line">&lt;interface type&#x3D;&#39;bridge&#39;&gt;</span><br><span class="line">&lt;mac address&#x3D;&#39;52:54:00:12:80:97&#39;&#x2F;&gt;</span><br><span class="line">&lt;source bridge&#x3D;&#39;br0&#39;&#x2F;&gt;</span><br><span class="line">[root@kvm01 ~]# virsh  start  centos7.0</span><br></pre></td></tr></table></figure><p>配置IP为DHCP自动获取</p><p>在KVM02上操作，创建存储池：<br>名称：nfsshare<br>类型：netfs<br>目标路径：/opt/nfsshare（本机挂在的目录，目录默认没有，但会自己创建）<br>主机名:192.168.1.129（nfs-server IP address）<br>源路径：/kvmshare（nfs-server上的共享目录）<br>创建完之后会看到之前在KVM01上创建的test文件和centos.qcow2的存储卷</p><p>在KVM01上连接KVM02：<br>右上角—文件—添加连接—连接到远程主机—方法：ssh—用户名：root—-主机名：192.168.1.200（KVM02的IP）<br>会提示安装openssh-askpass，直接在KVM01和KVm02上安装：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm01 ~]# yum  -y  install  openssh-askpass</span><br><span class="line">[root@kvm02 ~]# yum  -y  install  openssh-askpass</span><br></pre></td></tr></table></figure><p>//因为KVM01使用的是bridge br0网卡，所以我们需要在KVM02上创建同样的网卡br0，用来支持虚拟机</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm02 ~]# systemctl  stop  NetworkManager</span><br><span class="line">[root@kvm02 ~]# virsh  iface-bridge  ens33  br0</span><br></pre></td></tr></table></figure><p>接下来直接在virt-manager管理器中迁移就可以了，迁移完成之后，保证我么的ping命令是不中断的，就表示实验完成了<br>右键centos7.0—迁移—地址：192.168.1.200（KVM02的IP）—高级选项—-勾选允许不可靠—-迁移<br>如果出现错误解决办法：<br>把KVM01和KVM02上挂载的目录给一个777的权限，保证双方root用户有权限调用目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm01 ~]# chmod  777  &#x2F;opt&#x2F;</span><br><span class="line">[root@kvm02 ~]# chmod  777  &#x2F;opt&#x2F;</span><br></pre></td></tr></table></figure><p>迁移完成后在KVM02上面查看ping命令是否中断</p>]]></content>
    
    <summary type="html">
    
      KVM
    
    </summary>
    
    
      <category term="KVM" scheme="http://yoursite.com/categories/KVM/"/>
    
    
      <category term="KVM" scheme="http://yoursite.com/tags/KVM/"/>
    
  </entry>
  
  <entry>
    <title>Deployment</title>
    <link href="http://yoursite.com/2020/01/24/Deployment/"/>
    <id>http://yoursite.com/2020/01/24/Deployment/</id>
    <published>2020-01-23T16:00:00.000Z</published>
    <updated>2020-01-25T13:00:44.044Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a><strong>Deployment</strong></h3><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: test-web</span><br><span class="line">spec:</span><br><span class="line">  replicas: 4</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app:  web</span><br><span class="line">   spec:</span><br><span class="line">     containers:</span><br><span class="line">     - name: test-web</span><br><span class="line">       image:  192.168.1.70:5000&#x2F;httpd:v1</span><br><span class="line">       ports:</span><br><span class="line">       - containerPort:  80</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>PS：注意，在Deployment资源对象中，可以添加Port字段，但此字段仅供用户查看，并不实际生效</p><h3 id="service"><a href="#service" class="headerlink" title="service"></a><strong>service</strong></h3><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: web-svc</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app:  web</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 80  &#x2F;&#x2F;clusterIP的端口</span><br><span class="line">    targetPort: 80  &#x2F;&#x2F;Pod的端口</span><br><span class="line">    nodePort: 30123</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>SNAT：Source NAT（源地址转换）</p><p>DNAT：Destination NAT（目标地址转换）</p><p>MASQ：动态的源地址转换</p><p>service实现的负载均衡：默认使用的是iptables规则</p><p>第二种方案：IPVS</p><h3 id="回滚到指定版本"><a href="#回滚到指定版本" class="headerlink" title="回滚到指定版本"></a><strong>回滚到指定版本</strong></h3><hr><p>准备三个版本所使用的私有镜像，来模拟每次升级到不同的镜像</p><p>Deployment1.yaml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim  deployment1.yaml</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: test-web</span><br><span class="line">spec:</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app:  web</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: test-web</span><br><span class="line">        image:  192.168.1.70:5000&#x2F;httpd:v1</span><br><span class="line">        ports:</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>Deployment2.yaml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim  deployment2.yaml</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: test-web</span><br><span class="line">spec:</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app:  web</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: test-web</span><br><span class="line">        image:  192.168.1.70:5000&#x2F;httpd:v2</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort:  80</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>Deployment3.yaml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim  deployment3.yaml</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: test-web</span><br><span class="line">spec:</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app:  web</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: test-web</span><br><span class="line">        image:  192.168.1.70:5000&#x2F;httpd:v3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort:  80</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>此处3个yaml文件，指定不同版本的镜像</p><p>//运行一个服务，并记录一个版本信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl apply  -f  deployment1.yaml  --record</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//查看有哪些版本信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  rollout history deployment test-web</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//运行并升级Deployment资源，并记录版本信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  apply  -f  deployment2.yaml --record</span><br><span class="line">[root@master ~]# kubectl  apply  -f  deployment3.yaml --record</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//此时可以运行一个关联的Service资源去验证升级是否成功</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  apply -f  web-svc.yaml</span><br><span class="line">[root@master ~]# curl  10.96.179.50</span><br><span class="line">&lt;h1&gt;zhb | test-web | httpd | v3&lt;h1&gt;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//回滚到指定版本</p><h3 id="用label控制Pod的位置"><a href="#用label控制Pod的位置" class="headerlink" title="用label控制Pod的位置"></a><strong>用label控制Pod的位置</strong></h3><hr><p>//添加节点你标签</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl label nodes node02 disk&#x3D;ssd</span><br><span class="line">[root@master ~]# kubectl get nodes --show-labels | grep node02</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: test-web</span><br><span class="line">spec:</span><br><span class="line">  revisionHistoryLimit: 10  &#x2F;&#x2F;版本历史限制</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app:  web</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: test-web</span><br><span class="line">        image:  192.168.1.70:5000&#x2F;httpd:v1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort:  80</span><br><span class="line">      nodeSelector:  &#x2F;&#x2F;添加节点选择器</span><br><span class="line">        disk: ssd   &#x2F;&#x2F;和标签内容一致</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  get  pod  -o  wide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">test-web-d58c9f847-bhswj   1&#x2F;1     Running   0          28s   10.244.2.14   node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">test-web-d58c9f847-k58nj   1&#x2F;1     Running   0          28s   10.244.2.13   node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">test-web-d58c9f847-vt7r5   1&#x2F;1     Running   0          28s   10.244.2.15   node02   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//删除节点标签</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl  label nodes node02  disk-</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
    
    <summary type="html">
    
      K8s
    
    </summary>
    
    
      <category term="k8s" scheme="http://yoursite.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="http://yoursite.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>Docker三剑客之docker-compose+wordpress的博客搭建</title>
    <link href="http://yoursite.com/2020/01/24/Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bdocker-compose+wordpress%E7%9A%84%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/"/>
    <id>http://yoursite.com/2020/01/24/Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bdocker-compose+wordpress%E7%9A%84%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/</id>
    <published>2020-01-23T16:00:00.000Z</published>
    <updated>2020-02-03T02:45:12.557Z</updated>
    
    <content type="html"><![CDATA[<p>Docker三剑客：<br>docker machine：自动化部署多台dockerHost<br>docker-compose：它可以同时控制多个容器<br>docker swarm：从单个的服务向集群的形式发展<br>为什么要做集群：<br>高可用、高性能、高并发：防止单点故障</p><h1 id="Docker三剑客之docker-compose"><a href="#Docker三剑客之docker-compose" class="headerlink" title="Docker三剑客之docker-compose"></a><strong>Docker三剑客之docker-compose</strong></h1><p>docker容器的编排工具：</p><p>解决相互有依赖关系的多个容器的管理</p><p>//验证已有docker-compose命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker-compose  -v</span><br><span class="line">docker-compose version 1.25.0, build 0a186604</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>docker-compose的配置文件实例</p><p>通过识别一个docker-compose.yml的配置文件，去管理容器</p><p>//设置tab键的空格数量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim .vimrc</span><br><span class="line">set  tabstop&#x3D;2</span><br><span class="line">[root@localhost ~]# source  .vimrc</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir  compose_test</span><br><span class="line">[root@localhost ~]# cd  compose_test&#x2F;</span><br><span class="line">[root@localhost compose_test]# vim docker-compose.yml</span><br><span class="line">version:  &quot;3&quot;</span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    container_name: web-nginx</span><br><span class="line">    image:  nginx</span><br><span class="line">    restart:  always</span><br><span class="line">    ports:</span><br><span class="line">      - 90:80</span><br><span class="line">    volumes:</span><br><span class="line">      - .&#x2F;webserver:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>第一个部分：version：指定格式的版本</p><p>第二部分：services：定义服务，（想要运行什么样的容器）</p><p>//运行docker-compose规定的容器：</p><p>PS：在执行这条命令的当前目录下，也需要有一个docker-compose.yml的配置文件，并且通常只有一个</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost compose_test]# docker-compose  up  -d</span><br><span class="line">[root@localhost compose_test]# cd  webserver&#x2F;</span><br><span class="line">[root@localhost webserver]# echo  123456  &gt;  index.html</span><br><span class="line">[root@localhost webserver]# curl  127.0.0.1:90</span><br><span class="line">123456</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//停止运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost compose_test]# docker-compose  stop</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//重启</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost compose_test]# docker-compose  restart</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//如果在当前目录没有docker-compose.yml这个文件，可以通过-f来指定docker-compose.yml文件位置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker-compose  -f compose_test&#x2F;docker-compose.yml  start</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>并且，在运行container的过程中，还可以支持Dockerfile</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost compose_test]# vim  Dockerfile</span><br><span class="line">[root@localhost compose_test]# cat Dockerfile </span><br><span class="line">FROM nginx</span><br><span class="line">ADD webserver &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;htm</span><br><span class="line">[root@localhost compose_test]# vim  docker-compose.yml</span><br><span class="line">version:  &quot;3&quot;</span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    build:  .</span><br><span class="line">    container_name: web-nginx</span><br><span class="line">    image:  new-nginx:v1.0</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 90:80</span><br><span class="line">[root@localhost compose_test]# docker-compose  stop</span><br><span class="line">[root@localhost compose_test]# docker-compose  rm</span><br><span class="line">[root@localhost compose_test]# docker-compose  up  -d</span><br><span class="line">[root@localhost compose_test]# curl  127.0.0.1:90</span><br><span class="line">123456</span><br><span class="line">[root@localhost compose_test]# cd  webserver&#x2F;</span><br><span class="line">[root@localhost webserver]# echo  654321  &gt;  index.html </span><br><span class="line">[root@localhost webserver]# curl  127.0.0.1:90</span><br><span class="line">123456</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="搭建wordpress的博客"><a href="#搭建wordpress的博客" class="headerlink" title="搭建wordpress的博客"></a><strong>搭建wordpress的博客</strong></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir  wordpress</span><br><span class="line">[root@localhost ~]# docker  load  &lt;  wordpress.tar</span><br><span class="line">[root@localhost ~]# cd  wordpress&#x2F;</span><br><span class="line">[root@localhost wordpress]# vim  docker-compose.yml</span><br><span class="line">version:  &quot;3.1&quot;</span><br><span class="line">services:</span><br><span class="line">  wordpress:</span><br><span class="line">    image: wordpress</span><br><span class="line">    restart:  always</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:80</span><br><span class="line">    environment:</span><br><span class="line">      WORDPRESS_DB_HOST:  db</span><br><span class="line">      WORDPRESS_DB_USER:  wordpress</span><br><span class="line">      WORDPRESS_DB_PASSWORD:  123.com</span><br><span class="line">      WORDPRESS_DB_NAME:  wordpress</span><br><span class="line">  db:</span><br><span class="line">    image:  mysql:5.7</span><br><span class="line">    restart:  always</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_DATABASE:  wordpress</span><br><span class="line">      MYSQL_USER: wordpress</span><br><span class="line">      MYSQL_PASSWORD:  123.com</span><br><span class="line">      MYSQL_ROOT_PASSWORD:  123.com</span><br><span class="line">[root@localhost wordpress]# docker-compose  up  -d</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//浏览器访问本机的8080端口：（192.168.1.70:8080）</p><p><img src="https://img-blog.csdnimg.cn/20200117104852120.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/2020011710490388.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/20200117104915442.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/20200117104925510.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70" alt="img">)<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
    
    <summary type="html">
    
      Docker
    
    </summary>
    
    
      <category term="Docker" scheme="http://yoursite.com/categories/Docker/"/>
    
    
      <category term="Docker" scheme="http://yoursite.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker数据持久化</title>
    <link href="http://yoursite.com/2020/01/24/Docker%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/"/>
    <id>http://yoursite.com/2020/01/24/Docker%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/</id>
    <published>2020-01-23T16:00:00.000Z</published>
    <updated>2020-01-25T13:07:32.224Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Docker数据持久化"><a href="#Docker数据持久化" class="headerlink" title="Docker数据持久化"></a><strong>Docker数据持久化</strong></h1><p>为什么要做数据持久化：</p><p>因为Docker容器本身就是一个进程，可能会因为某些原因，或某些错误导致进程被杀死，这样数据就会丢失。</p><p>Docker容器是有生命周期的，生命周期结束，进程也会被杀死，数据就会丢失，因此需要做数据持久化，保证数据不会丢失</p><h2 id="Storage-Driver"><a href="#Storage-Driver" class="headerlink" title="Storage Driver"></a>Storage Driver</h2><p>数据存储</p><p>Centos7版本的Docker，Storage Driver为：Overlay2； backing filesystem：xfs</p><h2 id="Data-Volume"><a href="#Data-Volume" class="headerlink" title="Data Volume"></a>Data Volume</h2><h3 id="Bind-mount"><a href="#Bind-mount" class="headerlink" title="Bind mount"></a>Bind mount</h3><p>持久化存储：本质上是DockerHost文件系统中的目录或文件，能够直接被Mount到容器的文件系统中，在运行容器时，可以通过-v实现</p><p>特点：</p><ul><li>Data Volume是目录或文件，不能是没有格式化的磁盘（块设备）</li><li>容器可以读写volume中的数据</li><li>volume数据可以永久保存，即使用它的容器已经被销毁</li></ul><p>小实验：</p><p>运行一个nginx服务，做数据持久化</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# mkdir  html</span><br><span class="line">[root@docker01 ~]# cd  html&#x2F;</span><br><span class="line">[root@docker01 html]# echo &quot;This is a testfile in dockerHost.&quot;  &gt;  index.html</span><br><span class="line">[root@docker01 html]# cat index.html </span><br><span class="line">This is a testfile in dockerHost.</span><br><span class="line">[root@docker01 ~]# docker run  -itd  --name  testweb  -v  &#x2F;root&#x2F;html&#x2F;:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html  nginx:latest</span><br><span class="line">[root@docker01 ~]# docker inspect testweb</span><br><span class="line">&quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">[root@docker01 ~]# curl 172.17.0.2</span><br><span class="line">This is a testfile in dockerHost.</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>PS:DockerHost上需要挂在的源文件或目录，必须是已经存在的，否则，当做一个目录挂在到容器中</p><p>默认挂载到容器内的文件，容器是有读写权限，可以在运行容器时-v后边加”:ro”限制容器的写入权限</p><p>并且还可以挂在单独文件到容器内部，一般它的使用场景是：如果不想对整个目录进行覆盖，而只希望添加某个文件，就可以使用挂载单个文件</p><h3 id="Docker-Manager-Volume"><a href="#Docker-Manager-Volume" class="headerlink" title="Docker Manager Volume"></a>Docker Manager Volume</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# docker run -itd --name t2 -P -v &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html nginx:latest</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>删除容器的操作，默认不会对dockerHost上的文件操作，如果想要在删除容器时把源文件也删除，可以在删除容器时添加-v选型（一般不推荐使用这种方式，因为文件有可能被其他容器使用）</p><h3 id="容器与容器的数据共享："><a href="#容器与容器的数据共享：" class="headerlink" title="容器与容器的数据共享："></a>容器与容器的数据共享：</h3><p>volume container：给其他容器提供volume存储卷的容器，并且可以提供bind mount，也可以提供docker manager volume</p><p>//创建一个vc_data容器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# docker create --name vc_data \</span><br><span class="line">&gt;  -v  ~&#x2F;html:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html \</span><br><span class="line">&gt;  -v  &#x2F;other&#x2F;useful&#x2F;tools  busybox</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="容器的跨主机数据共享"><a href="#容器的跨主机数据共享" class="headerlink" title="容器的跨主机数据共享"></a>容器的跨主机数据共享</h3><table><thead><tr><th>docker01</th><th>dcoker02</th><th>docker03</th></tr></thead><tbody><tr><td>httpd</td><td>httpd</td><td>nfs</td></tr></tbody></table><p>要求：</p><p>docker01和docker02的主目录是一样的</p><p>//docker03的操作：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@docker03 ~]#yum  -y  install  nfs-utils</span><br><span class="line">[root@docker03 ~]# mkdir  &#x2F;datashare</span><br><span class="line">[root@docker03 ~]# vim  &#x2F;etc&#x2F;exports</span><br><span class="line">[root@docker03 ~]# cat &#x2F;etc&#x2F;exports</span><br><span class="line">&#x2F;datashare  *(rw,sync,no_root_squash)</span><br><span class="line">[root@docker03 ~]# systemctl  start  rpcbind</span><br><span class="line">[root@docker03 ~]# systemctl  enable  rpcbind</span><br><span class="line">[root@docker03 ~]# systemctl  start  nfs-server</span><br><span class="line">[root@docker03 ~]# systemctl  enable  nfs-server</span><br><span class="line">[root@docker03 ~]# vim  &#x2F;datashare&#x2F;index.html</span><br><span class="line">[root@docker03 ~]# cat &#x2F;datashare&#x2F;index.html </span><br><span class="line">&lt;div id&#x3D;&quot;datetime&quot;&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        setInterval(&quot;document.getElementById(&#39;datetime&#39;).innerHTML&#x3D;new Date().toLocaleString();&quot;, 1000);</span><br><span class="line">    &lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">bdqn-webshare</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//验证</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# showmount  -e  192.168.1.60</span><br><span class="line">Export list for 192.168.1.60:</span><br><span class="line">&#x2F;datashare *</span><br><span class="line">[root@docker02 ~]# showmount  -e  192.168.1.60</span><br><span class="line">Export list for 192.168.1.60:</span><br><span class="line">&#x2F;datashare *</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//docker01的操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# mkdir  &#x2F;htdocs</span><br><span class="line">[root@docker01 ~]# mount  -t  nfs  192.168.1.60:&#x2F;datashare  &#x2F;htdocs&#x2F;</span><br><span class="line">&#x2F;&#x2F;-t：指定类型（type）</span><br><span class="line">[root@docker01 ~]# cat &#x2F;htdocs&#x2F;index.html </span><br><span class="line">&lt;div id&#x3D;&quot;datetime&quot;&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        setInterval(&quot;document.getElementById(&#39;datetime&#39;).innerHTML&#x3D;new Date().toLocaleString();&quot;, 1000);</span><br><span class="line">    &lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">bdqn-webshare</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//docker02的操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@docker02 ~]# mkdir   &#x2F;htdocs</span><br><span class="line">[root@docker02 ~]# mount  -t  nfs  192.168.1.60:&#x2F;datashare  &#x2F;htdocs&#x2F;</span><br><span class="line">[root@docker02 ~]# cat  &#x2F;htdocs&#x2F;index.html </span><br><span class="line">&lt;div id&#x3D;&quot;datetime&quot;&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        setInterval(&quot;document.getElementById(&#39;datetime&#39;).innerHTML&#x3D;new Date().toLocaleString();&quot;, 1000);</span><br><span class="line">    &lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">bdqn-webshare</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>这里先不考虑将代码写入镜像，先以这种方式，分别在docker01和docker02部署httpd服务</p><p>//docker01</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# docker run  -itd  --name  bdqn-web1 -P  -v  &#x2F;htdocs&#x2F;:&#x2F;usr&#x2F;local&#x2F;apache2&#x2F;htdocs  httpd:latest</span><br><span class="line">PS：查看端口映射0.0.0.0:32778-&gt;80&#x2F;tcp   bdqn-web1</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//docker02</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@docker02 ~]# docker run  -itd  --name  bdqn-web2 -P  -v  &#x2F;htdocs&#x2F;:&#x2F;usr&#x2F;local&#x2F;apache2&#x2F;htdocs  httpd:latest</span><br><span class="line">PS：查看端口映射0.0.0.0:32768-&gt;80&#x2F;tcp   bdqn-web2</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>此时用浏览器访问，两个web服务的主界面是一样的，但如果NFS服务器上源文件丢失，则两个web服务都会异常</p><p>想办法将源数据写入镜像内，在基于镜像做一个vc_data容器，这里因为没有接触到docker-compose和docker swarm等docker编排工具，所以我们在docker01和docker02上手动创建镜像</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# cd  &#x2F;htdocs&#x2F;</span><br><span class="line">[root@docker01 htdocs]# vim  Dockerfile</span><br><span class="line">[root@docker01 htdocs]# cat Dockerfile </span><br><span class="line">FROM busybox</span><br><span class="line">ADD  index.html  &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;htdocs&#x2F;index.html</span><br><span class="line">VOLUME  &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;htdocs</span><br><span class="line">[root@docker01 htdocs]# docker build  -t  back_data  .</span><br><span class="line">[root@docker01 htdocs]# docker create --name back_container1 back_data:latest </span><br><span class="line">[root@docker01 htdocs]# docker run -itd --name web3 -P --volumes-from back_container1 httpd:latest </span><br><span class="line">[root@docker01 htdocs]# pwd</span><br><span class="line">&#x2F;htdocs</span><br><span class="line">[root@docker01 htdocs]# docker save  &gt; back_data.tar back_data:latest</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>//docker02上操作：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@docker02 ~]# cd &#x2F;htdocs&#x2F;</span><br><span class="line">[root@docker02 htdocs]# ls</span><br><span class="line">back_data.tar  Dockerfile  index.html</span><br><span class="line">[root@docker02 htdocs]# docker load &lt; back_data.tar </span><br><span class="line">[root@docker02 htdocs]# docker create --name back_container2 back_data:latest</span><br><span class="line">[root@docker02 htdocs]# docker run -itd --name web4 -P --volumes-from back_container2 httpd:latest</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>测试：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 htdocs]# rm -rf index.html</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>通过浏览器访问，一开始运行的web1和web2容器，无法访问了。web3和web4还是可以访问的。</p><p>但是数据无法同步了</p>]]></content>
    
    <summary type="html">
    
      Docker
    
    </summary>
    
    
      <category term="Docker" scheme="http://yoursite.com/categories/Docker/"/>
    
    
      <category term="Docker" scheme="http://yoursite.com/tags/Docker/"/>
    
  </entry>
  
</feed>
