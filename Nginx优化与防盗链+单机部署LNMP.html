<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width, initial-scale=1, maximum-scale=2"><meta name=theme-color content=#222><meta name=generator content="Hexo 4.2.0"><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-next.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32-next.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16-next.png><link rel=mask-icon href=/images/logo.svg color=#222><meta name=msvalidate.01 content=true><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><link rel=stylesheet href=//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css><script id=hexo-configurations>
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pdxblog.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"b2t":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":{"enable":true,"onlypost":false,"loadingImg":null},"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script><meta name=description content=架构><meta property=og:type content=article><meta property=og:title content=Nginx优化与防盗链+单机部署LNMP><meta property=og:url content=https://pdxblog.top/Nginx%E4%BC%98%E5%8C%96%E4%B8%8E%E9%98%B2%E7%9B%97%E9%93%BE+%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2LNMP.html><meta property=og:site_name content=Maisyの博客><meta property=og:description content=架构><meta property=og:locale content=zh_CN><meta property=og:image content="https://img-blog.csdnimg.cn/20200613112819353.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content=https://img-blog.csdnimg.cn/20200613112914586.png><meta property=og:image content=https://img-blog.csdnimg.cn/20200613112942881.png><meta property=og:image content="https://img-blog.csdnimg.cn/20200613113001613.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200613113033135.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200613113056145.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200613113159446.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/2020061311332680.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=article:published_time content=2020-06-12T16:00:00.000Z><meta property=article:modified_time content=2020-06-13T03:39:56.520Z><meta property=article:author content=Maisy><meta property=article:tag content=架构><meta name=twitter:card content=summary><meta name=twitter:image content="https://img-blog.csdnimg.cn/20200613112819353.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><link rel=canonical href=https://pdxblog.top/Nginx%E4%BC%98%E5%8C%96%E4%B8%8E%E9%98%B2%E7%9B%97%E9%93%BE+%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2LNMP.html><script id=page-configurations>
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script><title>Nginx优化与防盗链+单机部署LNMP | Maisyの博客</title><noscript><style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style></noscript><link rel=alternate href=/atom.xml title=Maisyの博客 type=application/atom+xml></head><body itemscope itemtype=http://schema.org/WebPage><div class="container use-motion"><div class=headband></div><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class=site-meta><a href="/" class=brand rel=start><span class=logo-line-before><i></i></span><h1 class=site-title>Maisyの博客</h1><span class=logo-line-after><i></i></span></a><p class=site-subtitle itemprop=description>记录生活中的点点滴滴</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul id=menu class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel=section><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-top"><a href="/top/" rel=section><i class="fa fa-signal fa-fw"></i>排行榜</a></li><li class="menu-item menu-item-about"><a href="/about/" rel=section><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel=section><i class="fa fa-tags fa-fw"></i>标签<span class=badge>7</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel=section><i class="fa fa-th fa-fw"></i>分类<span class=badge>7</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel=section><i class="fa fa-archive fa-fw"></i>归档<span class=badge>69</span></a></li></ul></nav></div></header><div class=back-to-top><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class=main><div class=main-inner><div class=content-wrap><div class="content post posts-expand"><article itemscope itemtype=http://schema.org/Article class=post-block lang=zh-CN><link itemprop=mainEntityOfPage href=https://pdxblog.top/Nginx%E4%BC%98%E5%8C%96%E4%B8%8E%E9%98%B2%E7%9B%97%E9%93%BE+%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2LNMP.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/author.jpg><meta itemprop=name content=Maisy><meta itemprop=description content=人的一生就是一个储蓄的过程，在奋斗的时候储存了希望；在耕耘的时候储存了一粒种子；在旅行的时候储存了风景；在微笑的时候储存了快乐。聪明的人善于储蓄，在漫长而短暂的人生旅途中，学会储蓄每一个闪光的瞬间，然后用它们酿成一杯美好的回忆，在四季的变幻与交替之间，散发浓香，珍藏一生></span> <span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content=Maisyの博客></span><header class=post-header><h1 class=post-title itemprop="name headline">Nginx优化与防盗链+单机部署LNMP</h1><div class=post-meta><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span> <span class=post-meta-item-text>发表于</span><time title="创建时间：2020-06-13 00:00:00 / 修改时间：11:39:56" itemprop="dateCreated datePublished" datetime=2020-06-13T00:00:00+08:00>2020-06-13</time></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder"></i></span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href="/categories/%E6%9E%B6%E6%9E%84/" itemprop=url rel=index><span itemprop=name>架构</span></a></span></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-comment"></i></span> <span class=post-meta-item-text>Valine：</span> <a title=valine href=/Nginx%E4%BC%98%E5%8C%96%E4%B8%8E%E9%98%B2%E7%9B%97%E9%93%BE+%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2LNMP.html#valine-comments itemprop=discussionUrl><span class="post-comments-count valine-comment-count" data-xid=/Nginx%E4%BC%98%E5%8C%96%E4%B8%8E%E9%98%B2%E7%9B%97%E9%93%BE+%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2LNMP.html itemprop=commentCount></span></a></span><br><span class=post-meta-item title=本文字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span> <span class=post-meta-item-text>本文字数：</span> <span>26k</span></span> <span class=post-meta-item title=阅读时长><span class=post-meta-item-icon><i class="far fa-clock"></i></span> <span class=post-meta-item-text>阅读时长 &asymp;</span> <span>24 分钟</span></span><div class=post-description>架构</div></div></header><div class=post-body itemprop=articleBody><h3 id=Nginx优化与防盗链-单机部署LNMP><a class=header-anchor href=#Nginx优化与防盗链-单机部署LNMP>¶</a>Nginx优化与防盗链+单机部署LNMP</h3><p>Nginx 是俄罗斯人编写的十分轻量级的 HTTP 服务器,Nginx，它的发音为“engine X”，是一个高性能的 HTTP 和反向代理服务器，同时也是一个 IMAP/POP3/SMTP 代理服务器．Nginx 是由俄罗斯人 Igor Sysoev 为俄罗斯访问量第二的 <a href=http://Rambler.ru target=_blank rel=noopener>Rambler.ru</a> 站点开发</p><p>Nginx 以事件驱动（epoll）的方式编写，所以有非常好的性能，同时也是一个非常高效的反<br>向代理、负载平衡。但是 Nginx 并不支持 cgi 方式运行，原因是可以减少因此带来的一些程<br>序上的漏洞。所以必须使用 FastCGI 方式来执行 PHP 程序</p><p>由于 Nginx 本身的一些优点，轻量，开源，易用，越来越多的公司使用 nginx 作为自己公司<br>的 web 应用服务器，本文详细介绍 nginx 源码安装的同时并对 nginx 进行优化配置</p><h4 id=一、Nginx的优化><a class=header-anchor href=#一、Nginx的优化>¶</a>一、Nginx的优化</h4><h5 id=1、编译安装前的优化><a class=header-anchor href=#1、编译安装前的优化>¶</a>1、编译安装前的优化</h5><p>编译前的优化主要是用来修改程序名等等，目的更改源码隐藏软件名称和版本号</p><h6 id=（1）安装-zlib-devel、pcre-devel-等依赖包><a class=header-anchor href=#（1）安装-zlib-devel、pcre-devel-等依赖包>¶</a>（1）安装 zlib-devel、pcre-devel 等依赖包</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># yum -y install gcc gcc-c++ make libtool zlib zlib-devel pcre pcre-devel openssl openssl-devel</span></span><br></pre></td></tr></table></figure><h6 id=（2）下载Nginx源码包><a class=header-anchor href=#（2）下载Nginx源码包>¶</a>（2）下载Nginx源码包</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># wget http://nginx.org/download/nginx-1.10.2.tar.gz</span></span><br></pre></td></tr></table></figure><h6 id=（3）解压源码包><a class=header-anchor href=#（3）解压源码包>¶</a>（3）解压源码包</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># tar zxf nginx-1.10.2.tar.gz </span></span><br><span class=line>[root@nginx ~]<span class=comment># cd nginx-1.10.2/</span></span><br></pre></td></tr></table></figure><h6 id=（4）隐藏软件名称和版本号><a class=header-anchor href=#（4）隐藏软件名称和版本号>¶</a>（4）隐藏软件名称和版本号</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@nginx nginx-1.10.2]<span class=comment># vim src/core/nginx.h</span></span><br><span class=line><span class=comment># 此行修改的是你想要的版本</span></span><br><span class=line><span class=comment>#define NGINX_VERSION      "1.10.2"  # 第13行</span></span><br><span class=line><span class=comment># 此行修改的是你想修改的软件名称</span></span><br><span class=line><span class=comment>#define NGINX_VER          "nginx/" NGINX_VERSION  # 第14行</span></span><br></pre></td></tr></table></figure><p>修改上面的信息，即可更改 nginx 显示版本。例如：(curl –I 可看到，请求头和响应头显示)</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line><span class=comment>#define NGINX_VERSION      "7.0"</span></span><br><span class=line><span class=comment>#define NGINX_VER          "IIS/" NGINX_VERSION</span></span><br></pre></td></tr></table></figure><p>修改 HTTP 头信息中的 connection 字段，防止回显具体版本号</p><p>拓展：</p><blockquote><p>通用 http 头 ，通用头包含请求和响应消息都支持的头，通用头包含 Cache-Control、<br>Connection、Date、Pragma、Transfer-Encoding、Upgrade、Via。对通用头的扩展要求通讯双方都支持此扩展，如果存在不支持的通用头，一般将会作为实体头处理。那么也就是说有部分设备，或者是软件，能获取到 connection，部分不能，要隐藏就要彻底！</p></blockquote><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@nginx nginx-1.10.2]<span class=comment># vim src/http/ngx_http_header_filter_module.c</span></span><br><span class=line><span class=comment># 修改前</span></span><br><span class=line>static char ngx_http_server_string[] = <span class=string>"Server: nginx"</span> CRLF; <span class=comment># 第49行</span></span><br><span class=line><span class=comment># 修改后</span></span><br><span class=line>static char ngx_http_server_string[] = <span class=string>"Server: IIS"</span> CRLF;</span><br></pre></td></tr></table></figure><p>定义了 http 错误码的返回：</p><p>有时候我们页面程序出现错误，Nginx 会代我们返回相应的错误代码，回显的时候，会带上<br>nginx 和版本号，我们把他隐藏起来</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre></td><td class=code><pre><span class=line>[root@nginx nginx-1.10.2]<span class=comment># vim src/http/ngx_http_special_response.c</span></span><br><span class=line><span class=comment># 修改前</span></span><br><span class=line>static u_char ngx_http_error_tail[] =</span><br><span class=line><span class=string>"&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;"</span> CRLF <span class=comment># 第29行</span></span><br><span class=line><span class=string>"&lt;/body&gt;"</span> CRLF</span><br><span class=line><span class=string>"&lt;/html&gt;"</span> CRLF</span><br><span class=line>;</span><br><span class=line><span class=comment># 修改后</span></span><br><span class=line>static u_char ngx_http_error_tail[] =</span><br><span class=line><span class=string>"&lt;hr&gt;&lt;center&gt;IIS&lt;/center&gt;"</span> CRLF</span><br><span class=line><span class=string>"&lt;/body&gt;"</span> CRLF</span><br><span class=line><span class=string>"&lt;/html&gt;"</span> CRLF</span><br><span class=line>;</span><br></pre></td></tr></table></figure><h5 id=2、安装nginx><a class=header-anchor href=#2、安装nginx>¶</a>2、安装nginx</h5><h6 id=（1）添加-nginx-组><a class=header-anchor href=#（1）添加-nginx-组>¶</a>（1）添加 nginx 组</h6><p>创建nginx运行账户nginx并加入到nginx 组，不允许 www 用户直接登录系统</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@nginx nginx-1.10.2]<span class=comment># groupadd nginx</span></span><br><span class=line>[root@nginx nginx-1.10.2]<span class=comment># useradd -g nginx nginx -s /sbin/nologin</span></span><br></pre></td></tr></table></figure><h6 id=（2）编译安装><a class=header-anchor href=#（2）编译安装>¶</a>（2）编译安装</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>[root@nginx nginx-1.10.2]<span class=comment># ./configure --prefix=/usr/local/nginx1.10 \</span></span><br><span class=line>&gt;  --with-http_dav_module --with-http_stub_status_module \</span><br><span class=line>&gt;  --with-http_addition_module --with-http_sub_module \</span><br><span class=line>&gt;  --with-http_flv_module --with-http_mp4_module --with-pcre \</span><br><span class=line>&gt;  --with-http_ssl_module --with-http_gzip_static_module \</span><br><span class=line>&gt;  --user=nginx --group=nginx</span><br><span class=line>[root@nginx nginx-1.10.2]<span class=comment># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><p>相关选项说明：</p><p>–with-http_dav_module</p><blockquote><p>增加 PUT,DELETE,MKCOL：创建集合，COPY 和 MOVE 方法</p></blockquote><p>–with-http_stub_status_module</p><blockquote><p>获取 Nginx 的状态统计信息</p></blockquote><p>–with-http_addition_module</p><blockquote><p>作为一个输出过滤器，支持不完全缓冲，分部分相应请求</p></blockquote><p>–with-http_sub_module</p><blockquote><p>允许一些其他文本替换 Nginx 相应中的一些文本</p></blockquote><p>–with-http_flv_module</p><blockquote><p>提供支持 flv 视频文件支持</p></blockquote><p>–with-http_mp4_module</p><blockquote><p>提供支持 mp4 视频文件支持，提供伪流媒体服务端支持</p></blockquote><p>–with-http_ssl_module</p><blockquote><p>启用 ngx_http_ssl_module如果 pcre 是通过编译安装的话，例如</p></blockquote><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>tar zxvf /usr/<span class=built_in>local</span>/src/pcre-8.36.tar.gz -C /usr/<span class=built_in>local</span>/src/</span><br><span class=line><span class=built_in>cd</span> /usr/<span class=built_in>local</span>/src/pcre-8.36</span><br><span class=line> ./configure &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure><blockquote><p>则–with-pcre=/usr/local/src/pcre-8.36</p><p>需要注意，这里指的是源码,用<code>./configure --help | grep pcre</code> 查看帮助</p></blockquote><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>[root@nginx nginx-1.10.2]<span class=comment># ln -s /usr/local/nginx1.10/sbin/nginx /usr/local/sbin/</span></span><br><span class=line>[root@nginx nginx-1.10.2]<span class=comment># nginx -t</span></span><br><span class=line>nginx: the configuration file /usr/<span class=built_in>local</span>/nginx1.10/conf/nginx.conf syntax is ok</span><br><span class=line>nginx: configuration file /usr/<span class=built_in>local</span>/nginx1.10/conf/nginx.conf <span class=built_in>test</span> is successful</span><br></pre></td></tr></table></figure><h6 id=（3）启动-nginx><a class=header-anchor href=#（3）启动-nginx>¶</a>（3）启动 nginx</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>[root@nginx nginx-1.10.2]<span class=comment># nginx</span></span><br><span class=line>[root@nginx nginx-1.10.2]<span class=comment># netstat -anpt | grep nginx</span></span><br><span class=line>tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      8303/nginx: master</span><br></pre></td></tr></table></figure><h6 id=（4）测试是否隐藏了版本和软件名><a class=header-anchor href=#（4）测试是否隐藏了版本和软件名>¶</a>（4）测试是否隐藏了版本和软件名</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># curl -I 127.0.0.1</span></span><br><span class=line>HTTP/1.1 200 OK</span><br><span class=line>Server: IIS/7.0</span><br><span class=line>Date: Fri, 12 Jun 2020 01:08:48 GMT</span><br><span class=line>Content-Type: text/html</span><br><span class=line>Content-Length: 612</span><br><span class=line>Last-Modified: Fri, 12 Jun 2020 00:59:55 GMT</span><br><span class=line>Connection: keep-alive</span><br><span class=line>ETag: <span class=string>"5ee2d38b-264"</span></span><br><span class=line>Accept-Ranges: bytes</span><br></pre></td></tr></table></figure><h5 id=3、nginx配置项优化><a class=header-anchor href=#3、nginx配置项优化>¶</a>3、nginx配置项优化</h5><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># ps -ef | grep nginx</span></span><br><span class=line>root       8303      1  0 09:07 ?        00:00:00 nginx: master process nginx</span><br><span class=line>nginx      8304   8303  0 09:07 ?        00:00:00 nginx: worker process</span><br></pre></td></tr></table></figure><p>在这里我们还可以看到在查看的时候，work 进程是 nginx 程序用户，但是 master 进程还是<br>root，其中，master 是监控进程，也叫主进程，work 是工作进程，部分还有 cache 相关进程，关系如图：<br><img data-src="https://img-blog.csdnimg.cn/20200613112819353.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><p>可以直接理解为 master 是管理员，work 进程才是为用户提供服务的！</p><h6 id=（1）Nginx-运行-工作置-进程个数><a class=header-anchor href=#（1）Nginx-运行-工作置-进程个数>¶</a>（1）Nginx 运行 工作置 进程个数</h6><p>一般我们设置 CPU 的核心或者核心数 x2</p><p>如果不了解 cpu 的核数，可以 top 命令之后按 1 也可以看出来，也可以查看/proc/cpuinfo 文件</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># grep ^processor /proc/cpuinfo | wc -l</span></span><br><span class=line>1</span><br><span class=line>[root@nginx ~]<span class=comment># vim /usr/local/nginx1.10/conf/nginx.conf</span></span><br><span class=line>worker_processes  2;</span><br><span class=line>[root@nginx ~]<span class=comment># nginx -s reload</span></span><br><span class=line>[root@nginx ~]<span class=comment># ps -aux | grep nginx | grep -v grep</span></span><br><span class=line>root       8303  0.0  0.1  46028  1920 ?        Ss   09:07   0:00 nginx: master process nginx</span><br><span class=line>nginx     10242  0.0  0.2  48540  2072 ?        S    09:14   0:00 nginx: worker process</span><br><span class=line>nginx     10243  0.0  0.2  48540  2072 ?        S    09:14   0:00 nginx: worker process</span><br></pre></td></tr></table></figure><h6 id=（2）Nginx-运行-CPU-亲和力><a class=header-anchor href=#（2）Nginx-运行-CPU-亲和力>¶</a>（2）Nginx 运行 CPU 亲和力</h6><p>比如 4 核配置</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>worker_processes 4;</span><br><span class=line>worker_cpu_affinity 0001 0010 0100 1000</span><br></pre></td></tr></table></figure><p>比如 8 核配置</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>worker_processes 8;</span><br><span class=line>worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;</span><br></pre></td></tr></table></figure><p>worker_processes 最多开启 8 个，8 个以上性能提升不会再提升了，而且稳定性变得更低，<br>所以 8 个进程够用了</p><h6 id=（3）Nginx-最多可以打开文件数><a class=header-anchor href=#（3）Nginx-最多可以打开文件数>¶</a>（3）Nginx 最多可以打开文件数</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>worker_rlimit_nofile 65535;</span><br></pre></td></tr></table></figure><p>这个指令是指当一个 nginx 进程打开的最多文件描述符数目，理论值应该是最多打开文件数<br>（ulimit -n）与 nginx 进程数相除，但是 nginx 分配请求并不是那么均匀，所以最好与 ulimit -n的值保持一致</p><p>注：</p><p>文件资源限制的配置可以在<code>/etc/security/limits.conf</code> 设置，针对 root/user 等各个用户或者*代表所有用户来设置。</p><p>用户重新登录生效（ulimit -n）</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># vim /etc/security/limits.conf</span></span><br><span class=line>*               soft    nofile          65535</span><br><span class=line>*               hard    nofile          65535</span><br><span class=line>[root@nginx ~]<span class=comment># ulimit -n</span></span><br><span class=line>65535</span><br></pre></td></tr></table></figure><h6 id=（4）Nginx-事件处理模型><a class=header-anchor href=#（4）Nginx-事件处理模型>¶</a>（4）Nginx 事件处理模型</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>events &#123;</span><br><span class=line>    use epoll;</span><br><span class=line>    worker_connections  65535;</span><br><span class=line>    multi_accept on;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>nginx 采用 epoll 事件模型，处理效率高</p><p><code>work_connections</code> 是单个 worker 进程允许客户端最大连接数，这个数值一般根据服务器性<br>能和内存来制定，实际最大值就是 worker 进程数乘以 work_connections实际我们填入一个 65535，足够了，这些都算并发值，一个网站的并发达到这么大的数量，也算一个大站了！</p><p><code>multi_accept</code> 告诉 nginx 收到一个新连接通知后接受尽可能多的连接</p><h6 id=（5）开启高效传输模式><a class=header-anchor href=#（5）开启高效传输模式>¶</a>（5）开启高效传输模式</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>http &#123;</span><br><span class=line>    include       mime.types;</span><br><span class=line>    default_type  application/octet-stream;</span><br><span class=line>    ......</span><br><span class=line>    sendfile        on;</span><br><span class=line>    tcp_nopush     on;</span><br></pre></td></tr></table></figure><p>Include mime.types;</p><blockquote><p>媒体类型, include 只是一个在当前文件中包含另一个文件内容的指令</p></blockquote><p>default_type application/octet-stream;</p><blockquote><p>默认媒体类型足够</p></blockquote><p>sendfile on；</p><blockquote><p>开启高效文件传输模式，sendfile 指令指定 nginx 是否调用 sendfile 函数来<br>输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘 IO 重负载应用，可设置为off，以平衡磁盘与网络 I/O 处理速度，降低系统的负载</p><p>注意：如果图片显示不正常把这个改成 off。</p></blockquote><p>tcp_nopush on；</p><blockquote><p>必须在 sendfile 开启模式才有效，防止网路阻塞，积极的减少网络报文段的数量（告诉 nginx 在一个数据包里发送所有头文件，而不一个接一个的发送。）</p></blockquote><h6 id=（6）连接超时时间><a class=header-anchor href=#（6）连接超时时间>¶</a>（6）连接超时时间</h6><p>主要目的是保护服务器资源，CPU，内存，控制连接数，因为建立连接也是需要消耗资源的</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre></td><td class=code><pre><span class=line>keepalive_timeout  65;</span><br><span class=line>tcp_nodelay on;</span><br><span class=line>client_header_buffer_size 4k;</span><br><span class=line>open_file_cache max=102400 inactive=20s;</span><br><span class=line>open_file_cache_valid 30s;</span><br><span class=line>open_file_cache_min_uses 1;</span><br><span class=line>client_header_timeout 15;</span><br><span class=line>client_body_timeout 15;</span><br><span class=line>reset_timedout_connection on;</span><br><span class=line>send_timeout 15;</span><br><span class=line>server_tokens off;</span><br><span class=line>client_max_body_size 10m;</span><br></pre></td></tr></table></figure><p>keepalived_timeout</p><blockquote><p>客户端连接保持会话超时时间，超过这个时间，服务器断开这个链接</p></blockquote><p>tcp_nodelay;</p><blockquote><p>也是防止网络阻塞，不过要包涵在 keepalived 参数才有效</p></blockquote><p>client_header_buffer_size 4k;</p><blockquote><p>客户端请求头部的缓冲区大小，这个可以根据你的系统分页大小来设置，一般一个请求头的大小不会超过 1k，不过由于一般系统分页都要大于 1k，所以这里设置为分页大小。分页大小可以用命令 getconf PAGESIZE 取得</p></blockquote><p>open_file_cache max=102400 inactive=20s;</p><blockquote><p>这个将为打开文件指定缓存，默认是没有启用的，max 指定缓存数量，建议和打开文件<br>数一致，inactive 是指经过多长时间文件没被请求后删除缓存</p></blockquote><p>open_file_cache_valid 30s;</p><blockquote><p>这个是指多长时间检查一次缓存的有效信息</p></blockquote><p>open_file_cache_min_uses 1;</p><blockquote><p>open_file_cache 指令中的 inactive 参数时间内文件的最少使用次数，如果超过这个数字，文件描述符一直是在缓存中打开的，如上例，如果有一个文件在 inactive 时间内一次没被使用，它将被移除</p></blockquote><p>client_header_timeout</p><blockquote><p>设置请求头的超时时间。我们也可以把这个设置低些，如果超过这个时间没有发送任何数据，nginx 将返回 request time out 的错误</p></blockquote><p>client_body_timeout</p><blockquote><p>设置请求体的超时时间。我们也可以把这个设置低些，超过这个时间没有发送任何数据，和上面一样的错误提示</p></blockquote><p>reset_timeout_connection</p><blockquote><p>告诉 nginx 关闭不响应的客户端连接。这将会释放那个客户端所占有的内存空间</p></blockquote><p>send_timeout</p><blockquote><p>响应客户端超时时间，这个超时时间仅限于两个活动之间的时间，如果超过这个时间，客户端没有任何活动，nginx 关闭连接</p></blockquote><p>server_tokens</p><blockquote><p>并不会让 nginx 执行的速度更快，但它可以关闭在错误页面中的 nginx 版本数字，这样对于安全性是有好处的</p></blockquote><p>client_max_body_size</p><blockquote><p>上传文件大小限制</p></blockquote><h6 id=（7）fastcgi-调优><a class=header-anchor href=#（7）fastcgi-调优>¶</a>（7）fastcgi 调优</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 接上个位置继续写</span></span><br><span class=line>    fastcgi_connect_timeout 600;</span><br><span class=line>    fastcgi_send_timeout 600;</span><br><span class=line>    fastcgi_read_timeout 600;</span><br><span class=line>    fastcgi_buffer_size 64k;</span><br><span class=line>    fastcgi_buffers 4 64k;</span><br><span class=line>    fastcgi_busy_buffers_size 128k;</span><br><span class=line>    fastcgi_temp_file_write_size 128k;</span><br><span class=line>    fastcgi_temp_path /usr/<span class=built_in>local</span>/nginx1.10/nginx_tmp;</span><br><span class=line>    fastcgi_intercept_errors on;</span><br><span class=line>    fastcgi_cache_path /usr/<span class=built_in>local</span>/nginx1.10/fastcgi_cache levels=1:2 keys_zone=cache_fastcgi:128m inactive=1d max_size=10g;</span><br></pre></td></tr></table></figure><blockquote><p>Cache： 写入缓存区</p><p>Buffer： 读取缓存区</p><p>Fastcgi 是静态服务和动态服务的一个接口</p></blockquote><p>fastcgi_connect_timeout 600;</p><blockquote><p>指定连接到后端 FastCGI 的超时时间</p></blockquote><p>fastcgi_send_timeout 600;</p><blockquote><p>向 FastCGI 传送请求的超时时间</p></blockquote><p>fastcgi_read_timeout 600;</p><blockquote><p>指定接收 FastCGI 应答的超时时间</p></blockquote><p>fastcgi_buffer_size 64k;</p><blockquote><p>指定读取 FastCGI 应答第一部分需要用多大的缓冲区，默认的缓冲区大小为 fastcgi_buffers 指令中的每块大小，可以将这个值设置更小</p></blockquote><p>fastcgi_buffers 4 64k;</p><blockquote><p>指定本地需要用多少和多大的缓冲区来缓冲 FastCGI 的应答请求，如果<br>一个 php 脚本所产生的页面大小为 256KB，那么会分配 4 个 64KB 的缓冲区来缓存，如果页面大小大于 256KB，那么大于 256KB 的部分会缓存到 fastcgi_temp_path 指定的路径中，但是这并不是好方法，因为内存中的数据处理速度要快于磁盘。一般这个值应该为站点中 php脚本所产生的页面大小的中间值，如果站点大部分脚本所产生的页面大小为 256KB，那么可以把这个值设置为“8 32K”、“4 64k”等</p></blockquote><p>fastcgi_busy_buffers_size 128k;</p><blockquote><p>建议设置为 fastcgi_buffers 的两倍，繁忙时候的 buffer</p></blockquote><p>fastcgi_temp_file_write_size 128k;</p><blockquote><p>在写入 fastcgi_temp_path 时将用多大的数据块，默认值是 fastcgi_buffers 的两倍，该数值设置小时若负载上来时可能报 502 Bad Gateway</p></blockquote><p>fastcgi_temp_path</p><blockquote><p>缓存临时目录</p></blockquote><p>fastcgi_intercept_errors on;</p><blockquote><p>这个指令指定是否传递 4xx 和 5xx 错误信息到客户端，或者允许nginx 使用 error_page 处理错误信息</p><p>注：静态文件不存在会返回 404 页面，但是 php 页面则返回空白页！！</p></blockquote><p>fastcgi_cache_path /usr/local/nginx1.10/fastcgi_cache levels=1:2 keys_zone=cache_fastcgi:128minactive=1d max_size=10g;</p><blockquote><p>fastcgi_cache 缓存目录，可以设置目录层级，比如 1:2 会生成<br>16*256 个子目录，cache_fastcgi 是这个缓存空间的名字，cache 是用多少内存（这样热门的<br>内容 nginx 直接放内存，提高访问速度），inactive 表示默认失效时间，如果缓存数据在失效<br>时间内没有被访问,将被删除，max_size 表示最多用多少硬盘空间</p></blockquote><p>fastcgi_cache cache_fastcgi;</p><blockquote><p>表示开启 FastCGI 缓存并为其指定一个名称。开启缓存非常有用，可以有效降低 CPU 的负载，并且防止 502 的错误放生。cache_fastcgi 为 proxy_cache_path指令创建的缓存区名称</p></blockquote><p>fastcgi_cache_valid 200 302 1h;</p><blockquote><p>用来指定应答代码的缓存时间，实例中的值表示将 200 和302 应答缓存一小时，要和 fastcgi_cache 配合使用</p></blockquote><p>fastcgi_cache_valid 301 1d;</p><blockquote><p>将 301 应答缓存一天</p></blockquote><p>fastcgi_cache_valid any 1m;</p><blockquote><p>将其他应答缓存为 1 分钟</p></blockquote><p>fastcgi_cache_min_uses 1;</p><blockquote><p>该指令用于设置经过多少次请求的相同 URL 将被缓存。fastcgi_cache_key http://$host$request_uri; #该指令用来设置web缓存的Key值,nginx根据Key值 md5 哈希存储.一般根据$host(域名)、$request_uri(请求的路径)等变量组合成proxy_cache_key</p></blockquote><p>fastcgi_pass</p><blockquote><p>指定 FastCGI 服务器监听端口与地址，可以是本机或者其它</p></blockquote><p>总结：</p><blockquote><p>nginx 的缓存功能有：proxy_cache / fastcgi_cache</p><p>proxy_cache的作用是缓存后端服务器的内容，可能是任何内容，包括静态的和动态</p><p>fastcgi_cache的作用是缓存 fastcgi 生成的内容，很多情况是 php 生成的动态的内容</p><p>proxy_cache 缓存减少了 nginx 与后端通信的次数，节省了传输时间和后端宽带</p><p>fastcgi_cache缓存减少了nginx与php的通信的次数，更减轻了php和数据库(mysql)的压力</p></blockquote><h6 id=（8）gzip调优><a class=header-anchor href=#（8）gzip调优>¶</a>（8）gzip调优</h6><p>使用 gzip 压缩功能，可能为我们节约带宽，加快传输速度，有更好的体验，也为我们节约<br>成本，所以说这是一个重点</p><p>Nginx 启用压缩功能需要你来 ngx_http_gzip_module 模块，apache 使用的是 mod_deflate一般我们需要压缩的内容有：文本，js，html，css，对于图片，视频，flash 什么的不压缩，同时也要注意，我们使用 gzip 的功能是需要消耗 CPU 的！</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>gzip  on;</span><br><span class=line>gzip_min_length 2k;</span><br><span class=line>gzip_buffers 4 32k;</span><br><span class=line>gzip_http_version 1.1;</span><br><span class=line>gzip_comp_level 6;    gzip_types  text/plain  text/css  text/javascript  application/json  application/javascript application/x-javascript application/xml;</span><br><span class=line>gzip_vary on;</span><br><span class=line>gzip_proxied any;</span><br></pre></td></tr></table></figure><p>gzip on;</p><blockquote><p>开启压缩功能</p></blockquote><p>gzip_min_length 1k;</p><blockquote><p>设置允许压缩的页面最小字节数，页面字节数从 header 头的Content-Length 中获取，默认值是 0，不管页面多大都进行压缩，建议设置成大于 1K，如果小与 1K 可能会越压越大</p></blockquote><p>gzip_buffers 4 32k;</p><blockquote><p>压缩缓冲区大小，表示申请4个单位为32K的内存作为压缩结果流缓存，默认值是申请与原始数据大小相同的内存空间来存储 gzip 压缩结果</p></blockquote><p>gzip_http_version 1.1;</p><blockquote><p>压缩版本，用于设置识别 HTTP 协议版本，默认是 1.1，目前大部分浏览器已经支持 GZIP 解压，使用默认即可</p></blockquote><p>gzip_comp_level 6;</p><blockquote><p>压缩比例，用来指定 GZIP 压缩比，1 压缩比最小，处理速度最快，9 压缩比最大，传输速度快，但是处理慢，也比较消耗 CPU 资源</p></blockquote><p>gzip_types text/css text/xml application/javascript;</p><blockquote><p>用来指定压缩的类型，‘text/html’类型总是会被压缩</p><p>默认值: gzip_types text/html (默认不对 js/css 文件进行压缩)</p><p>压缩类型，匹配 MIME 类型进行压缩</p><p>不能用通配符 text/*</p><p>(无论是否指定)text/html 默认已经压缩</p><p>设置哪压缩种文本文件可参考 conf/mime.types</p></blockquote><p>gzip_vary on;</p><blockquote><p>vary header 支持，改选项可以让前端的缓存服务器缓存经过 GZIP 压缩的页面，例如用 Squid 缓存经过 nginx 压缩的数据</p></blockquote><h6 id=（9）expires-缓存调优><a class=header-anchor href=#（9）expires-缓存调优>¶</a>（9）expires 缓存调优</h6><p>缓存，主要针对于图片，css，js 等元素更改机会比较少的情况下使用，特别是图片，占用<br>带宽大，我们完全可以设置图片在浏览器本地缓存 365d，css，js，html 可以缓存个 10 来天，这样用户第一次打开加载慢一点，第二次，就非常快了！缓存的时候，我们需要将需要缓存的拓展名列出来， Expires 缓存配置在 server 字段里面</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre></td><td class=code><pre><span class=line>location ~* \.(ico|jpe?g|gif|png|bmp|swf|flv)$ &#123;</span><br><span class=line>    expires 30d;</span><br><span class=line>    <span class=comment>#log_not_found off;</span></span><br><span class=line>    access_log off;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line>location ~* \.(js|css)$ &#123;</span><br><span class=line>    expires 7d;</span><br><span class=line>    log_not_found off;</span><br><span class=line>    access_log off;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>注：log_not_found off;是否在 error_log 中记录不存在的错误。默认是</p><p>总结：</p><p>expire 功能优点：</p><ul><li>expires 可以降低网站购买的带宽，节约成本</li><li>同时提升用户访问体验</li><li>减轻服务的压力，节约服务器成本，是 web 服务非常重要的功能</li></ul><p>expire 功能缺点：</p><ul><li>被缓存的页面或数据更新了，用户看到的可能还是旧的内容，反而影响用户体验</li></ul><p>解决办法：</p><ul><li>第一个缩短缓存时间，例如：1 天，但不彻底，除非更新频率大于 1 天；</li><li>第二个对缓存的对象改名</li></ul><p>网站不希望被缓存的内容：</p><ul><li>网站流量统计工具</li><li>更新频繁的文件</li></ul><h6 id=（10）防盗链><a class=header-anchor href=#（10）防盗链>¶</a>（10）防盗链</h6><p>防止别人直接从你网站引用图片等链接，消耗了你的资源和网络流量，那么我们的解决办法<br>由几种：</p><ul><li>水印，品牌宣传，你的带宽，服务器足够</li><li>防火墙，直接控制，前提是你知道 IP 来源</li><li>防盗链策略 下面的方法是直接给予 404 的错误提示</li></ul><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line>location ~* ^.+\.(jpg|gif|png|swf|flv|wma|wmv|asf|mp3|mmf|zip|rar)$ &#123;</span><br><span class=line>    valid_referers none blocked 192.168.1.20;</span><br><span class=line>    <span class=keyword>if</span> (<span class=variable>$invalid_referer</span>) &#123;</span><br><span class=line>        <span class=comment>#return 302 http://192.168.1.20/img/nolink.jpg;</span></span><br><span class=line>        <span class=built_in>return</span> 404;</span><br><span class=line>        <span class=built_in>break</span>;</span><br><span class=line>    &#125;</span><br><span class=line>    access_log off;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h6 id=（11）内核参数优化><a class=header-anchor href=#（11）内核参数优化>¶</a>（11）内核参数优化</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># vim /etc/sysctl.conf</span></span><br><span class=line>fs.file-max = 999999</span><br><span class=line>net.ipv4.ip_forward = 0</span><br><span class=line>net.ipv4.conf.default.rp_filter = 1</span><br><span class=line>net.ipv4.conf.default.accept_source_route = 0</span><br><span class=line>kernel.sysrq = 0</span><br><span class=line>kernel.core_uses_pid = 1</span><br><span class=line>net.ipv4.tcp_syncookies = 1</span><br><span class=line>kernel.msgmnb = 65536</span><br><span class=line>kernel.msgmax = 65536</span><br><span class=line>kernel.shmmax = 68719476736</span><br><span class=line>kernel.shmall = 4294967296</span><br><span class=line>net.ipv4.tcp_max_tw_buckets = 6000</span><br><span class=line>net.ipv4.tcp_sack = 1</span><br><span class=line>net.ipv4.tcp_window_scaling = 1</span><br><span class=line>net.ipv4.tcp_rmem = 10240 87380 12582912</span><br><span class=line>net.ipv4.tcp_wmem = 10240 87380 12582912</span><br><span class=line>net.core.wmem_default = 8388608</span><br><span class=line>net.core.rmem_default = 8388608</span><br><span class=line>net.core.rmem_max = 16777216</span><br><span class=line>net.core.wmem_max = 16777216</span><br><span class=line>net.core.netdev_max_backlog = 262144</span><br><span class=line>net.core.somaxconn = 40960</span><br><span class=line>net.ipv4.tcp_max_orphans = 3276800</span><br><span class=line>net.ipv4.tcp_max_syn_backlog = 262144</span><br><span class=line>net.ipv4.tcp_timestamps = 0</span><br><span class=line>net.ipv4.tcp_synack_retries = 1</span><br><span class=line>net.ipv4.tcp_syn_retries = 1</span><br><span class=line>net.ipv4.tcp_tw_recycle = 1</span><br><span class=line>net.ipv4.tcp_tw_reuse = 1</span><br><span class=line>net.ipv4.tcp_mem = 94500000 915000000 927000000</span><br><span class=line>net.ipv4.tcp_fin_timeout = 1</span><br><span class=line>net.ipv4.tcp_keepalive_time = 30</span><br><span class=line>net.ipv4.ip_local_port_range = 1024 65000</span><br><span class=line>[root@nginx ~]<span class=comment># sysctl -p</span></span><br></pre></td></tr></table></figure><p>fs.file-max = 999999</p><blockquote><p>这个参数表示进程（比如一个 worker 进程）可以同时打开的最大句柄数，这个参数直线限制最大并发连接数，需根据实际情况配置</p></blockquote><p>net.ipv4.tcp_max_tw_buckets = 6000</p><blockquote><p>这个参数表示操作系统允许 TIME_WAIT 套接字数量的最大值，如果超过这个数字，TIME_WAIT 套接字将立刻被清除并打印警告信息。该参数默认为 180000，过多的TIME_WAIT 套接字会使 Web 服务器变慢</p><p>注：主动关闭连接的服务端会产生 TIME_WAIT 状态的连接</p></blockquote><p>net.ipv4.ip_local_port_range = 1024 65000</p><blockquote><p>允许系统打开的端口范围</p></blockquote><p>net.ipv4.tcp_tw_recycle = 1</p><blockquote><p>启用 timewait 快速回收</p></blockquote><p>net.ipv4.tcp_tw_reuse = 1</p><blockquote><p>开启重用。允许将 TIME-WAIT sockets 重新用于新的 TCP 连接。这对于服务器来说很有意义，因为服务器上总会有大量 TIME-WAIT 状态的连接</p></blockquote><p>net.ipv4.tcp_keepalive_time = 30</p><blockquote><p>这个参数表示当 keepalive 启用时，TCP 发送 keepalive 消息的频度。默认是 2 小时，若将其设置的小一些，可以更快地清理无效的连接</p></blockquote><p>net.ipv4.tcp_syncookies = 1</p><blockquote><p>开启 SYN Cookies，当出现 SYN 等待队列溢出时，启用 cookies 来处理</p></blockquote><p>net.core.somaxconn = 40960</p><blockquote><p>web 应用中 listen 函数的 backlog 默认会给我们内核参数的net.core.somaxconn 限制到 128，而 nginx 定义的 NGX_LISTEN_BACKLOG 默认为 511，所以有必要调整这个值</p><p>注：</p><p>对于一个 TCP 连接，Server 与 Client 需要通过三次握手来建立网络连接.当三次手成后,我们可以看到端口的状态由 LISTEN 转变为 ESTABLISHED,接着这条链路上就可以开始传送数据了.每一个处于监听(Listen)状态的端口,都有自己的监听队列.监听队列的长度与如somaxconn 参数和使用该端口的程序中 listen()函数有关</p><p>somaxconn参数:定义了系统中每一个端口最大的监听队列的长度,这是个全局的参数,默认值为 128，对于一个经常处理新连接的高负载 web 服务环境来说，默认的 128 太小了。大多数环境这个值建议增加到 1024 或者更多。大的侦听队列对防止拒绝服务 DoS 攻击也会有所帮助</p></blockquote><p>net.core.netdev_max_backlog = 262144</p><blockquote><p>每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目</p></blockquote><p>net.ipv4.tcp_max_syn_backlog = 262144</p><blockquote><p>这个参数标示 TCP 三次握手建立阶段接受 SYN 请求队列的最大长度，默认为 1024，将其设置得大一些可以使出现 Nginx 繁忙来不及 accept 新连接的情况时，Linux 不至于丢失客户端发起的连接请求</p></blockquote><p>net.ipv4.tcp_rmem = 10240 87380 12582912</p><blockquote><p>这个参数定义了 TCP 接受缓存（用于 TCP 接受滑动窗口）的最小值、默认值、最大值</p></blockquote><p>net.ipv4.tcp_wmem = 10240 87380 12582912</p><blockquote><p>这个参数定义了 TCP 发送缓存（用于 TCP 发送滑动窗口）的最小值、默认值、最大值</p></blockquote><p>net.core.rmem_default = 6291456</p><blockquote><p>这个参数表示内核套接字接受缓存区默认的大小</p></blockquote><p>net.core.wmem_default = 6291456</p><blockquote><p>这个参数表示内核套接字发送缓存区默认的大小</p></blockquote><p>net.core.rmem_max = 12582912</p><blockquote><p>这个参数表示内核套接字接受缓存区的最大大小</p></blockquote><p>net.core.wmem_max = 12582912</p><blockquote><p>这个参数表示内核套接字发送缓存区的最大大小</p></blockquote><p>net.ipv4.tcp_syncookies = 1</p><blockquote><p>该参数与性能无关，用于解决 TCP 的 SYN 攻击</p></blockquote><h6 id=（12）关于系统连接数的优化：><a class=header-anchor href=#（12）关于系统连接数的优化：>¶</a>（12）关于系统连接数的优化：</h6><p>linux 默认值 open files 为 1024】</p><p>说明 server 只允许同时打开 1024 个文件】</p><p>使用 ulimit -a 可以查看当前系统的所有限制值，使用 ulimit -n 可以查看当前的最大打开文<br>件数</p><p>新装的 linux 默认只有 1024 ，当作负载较大的服务器时，很容易遇到 error: too many openfiles。因此，需要将其改大</p><p>在/etc/security/limits.conf 最后增加：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>* soft nofile 65535</span><br><span class=line>* hard nofile 65535</span><br><span class=line>* soft noproc 65535</span><br><span class=line>* hard noproc 65535</span><br></pre></td></tr></table></figure><h4 id=二、部署LNMP><a class=header-anchor href=#二、部署LNMP>¶</a>二、部署LNMP</h4><p><a href=https://pan.baidu.com/s/1b6dvnukVS0BBnP4Y-aeBrg target=_blank rel=noopener>软件连接</a></p><p>提取码：vzsu</p><h5 id=1、安装php><a class=header-anchor href=#1、安装php>¶</a>1、安装php</h5><h6 id=（1）解决依赖关系><a class=header-anchor href=#（1）解决依赖关系>¶</a>（1）解决依赖关系</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># yum -y install libxml2-devel libcurl-devel openssl-devel bzip2-devel</span></span><br></pre></td></tr></table></figure><p>安装libmcypt</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@nginx libmcrypt-2.5.7]<span class=comment># ./configure --prefix=/usr/local/libmcrypt &amp;&amp; make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h6 id=（2）编译安装php><a class=header-anchor href=#（2）编译安装php>¶</a>（2）编译安装php</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># tar zxf php-5.6.27.tar.gz </span></span><br><span class=line>[root@nginx ~]<span class=comment># cd php-5.6.27/</span></span><br><span class=line>[root@nginx php-5.6.27]<span class=comment># ./configure --prefix=/usr/local/php5.6  --with-mysql=mysqlnd \</span></span><br><span class=line>&gt;  --with-pdo-mysql=mysqlnd --with-mysqli=mysqlnd --with-openssl --<span class=built_in>enable</span>-fpm \</span><br><span class=line>&gt;  --<span class=built_in>enable</span>-sockets --<span class=built_in>enable</span>-sysvshm --<span class=built_in>enable</span>-mbstring --with-freetype-dir --with-jpeg-dir \</span><br><span class=line>&gt;  --with-png-dir --with-zlib --with-libxml-dir=/usr --<span class=built_in>enable</span>-xml --with-mhash \</span><br><span class=line>&gt;  --with-mcrypt=/usr/<span class=built_in>local</span>/libmcrypt --with-config-file-path=/etc \</span><br><span class=line>&gt;  --with-config-file-scan-dir=/etc/php.d --with-bz2 --<span class=built_in>enable</span>-maintainer-zts</span><br><span class=line>[root@nginx php-5.6.27]<span class=comment># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h6 id=（3）提供php配置文件><a class=header-anchor href=#（3）提供php配置文件>¶</a>（3）提供php配置文件</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@nginx php-5.6.27]<span class=comment># cp php.ini-production /etc/php.ini</span></span><br></pre></td></tr></table></figure><h6 id=（4）为-php-fpm-提供脚本><a class=header-anchor href=#（4）为-php-fpm-提供脚本>¶</a>（4）为 php-fpm 提供脚本</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>[root@nginx php-5.6.27]<span class=comment># cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm</span></span><br><span class=line>[root@nginx php-5.6.27]<span class=comment># chmod +x /etc/init.d/php-fpm </span></span><br><span class=line>[root@nginx php-5.6.27]<span class=comment># chkconfig --add php-fpm</span></span><br><span class=line>[root@nginx php-5.6.27]<span class=comment># chkconfig php-fpm on</span></span><br></pre></td></tr></table></figure><h6 id=（5）提供-php-fpm-配置文件并编辑><a class=header-anchor href=#（5）提供-php-fpm-配置文件并编辑>¶</a>（5）提供 php-fpm 配置文件并编辑</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line>[root@nginx php-5.6.27]<span class=comment># cp /usr/local/php5.6/etc/php-fpm.conf.default /usr/local/php5.6/etc/php-fpm.conf</span></span><br><span class=line>[root@nginx php-5.6.27]<span class=comment># vim /usr/local/php5.6/etc/php-fpm.conf</span></span><br><span class=line><span class=comment># 修改内容如下</span></span><br><span class=line>pid = run/php-fpm.pid</span><br><span class=line>listen = 0.0.0.0:9000</span><br><span class=line>pm.max_children = 50</span><br><span class=line>pm.start_servers = 5</span><br><span class=line>pm.min_spare_servers = 5</span><br><span class=line>pm.max_spare_servers = 35</span><br></pre></td></tr></table></figure><p>启动php-fpm服务</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line>[root@nginx php-5.6.27]<span class=comment># service php-fpm start</span></span><br><span class=line>Starting php-fpm  <span class=keyword>done</span></span><br><span class=line>[root@nginx php-5.6.27]<span class=comment># netstat -anpt | grep php-fpm</span></span><br><span class=line>tcp        0      0 0.0.0.0:9000            0.0.0.0:*               LISTEN      125567/php-fpm: mas</span><br><span class=line>[root@nginx ~]<span class=comment># firewall-cmd --permanent --add-port=9000/tcp</span></span><br><span class=line>success</span><br><span class=line>[root@nginx ~]<span class=comment># firewall-cmd --reload</span></span><br><span class=line>Success</span><br></pre></td></tr></table></figure><p>在 nginx.conf 文件的 server 中添加下面内容支持 php</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># vim /usr/local/nginx1.10/conf/nginx.conf</span></span><br><span class=line>        location / &#123;</span><br><span class=line>            root   html;</span><br><span class=line>            index  index.php index.html index.htm;</span><br><span class=line>        &#125;</span><br><span class=line>        </span><br><span class=line>        location ~ .*\.(php|php5)?$ &#123;</span><br><span class=line>            root html;</span><br><span class=line>            fastcgi_pass 127.0.0.1:9000;</span><br><span class=line>            fastcgi_index index.php;</span><br><span class=line>            include fastcgi.conf;</span><br><span class=line>            fastcgi_cache cache_fastcgi;</span><br><span class=line>            fastcgi_cache_valid 200 302 1h;</span><br><span class=line>            fastcgi_cache_valid 301 1d;</span><br><span class=line>            fastcgi_cache_valid any 1m;</span><br><span class=line>            fastcgi_cache_min_uses 1;</span><br><span class=line>            fastcgi_cache_use_stale error timeout invalid_header http_500;</span><br><span class=line>            fastcgi_cache_key http://<span class=variable>$host</span><span class=variable>$request_uri</span>;</span><br><span class=line>        &#125;</span><br></pre></td></tr></table></figure><p>重载 nginx 服务</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># nginx -s reload</span></span><br></pre></td></tr></table></figure><p>下面是 nginx.conf 的一个完整配置文件</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br><span class=line>119</span><br><span class=line>120</span><br><span class=line>121</span><br><span class=line>122</span><br><span class=line>123</span><br><span class=line>124</span><br><span class=line>125</span><br><span class=line>126</span><br><span class=line>127</span><br><span class=line>128</span><br><span class=line>129</span><br><span class=line>130</span><br><span class=line>131</span><br><span class=line>132</span><br><span class=line>133</span><br><span class=line>134</span><br><span class=line>135</span><br><span class=line>136</span><br><span class=line>137</span><br><span class=line>138</span><br><span class=line>139</span><br><span class=line>140</span><br><span class=line>141</span><br><span class=line>142</span><br><span class=line>143</span><br><span class=line>144</span><br><span class=line>145</span><br><span class=line>146</span><br><span class=line>147</span><br><span class=line>148</span><br><span class=line>149</span><br><span class=line>150</span><br><span class=line>151</span><br><span class=line>152</span><br><span class=line>153</span><br><span class=line>154</span><br><span class=line>155</span><br><span class=line>156</span><br><span class=line>157</span><br><span class=line>158</span><br><span class=line>159</span><br><span class=line>160</span><br><span class=line>161</span><br><span class=line>162</span><br><span class=line>163</span><br><span class=line>164</span><br><span class=line>165</span><br><span class=line>166</span><br><span class=line>167</span><br><span class=line>168</span><br><span class=line>169</span><br><span class=line>170</span><br><span class=line>171</span><br><span class=line>172</span><br><span class=line>173</span><br><span class=line>174</span><br><span class=line>175</span><br><span class=line>176</span><br><span class=line>177</span><br><span class=line>178</span><br><span class=line>179</span><br><span class=line>180</span><br><span class=line>181</span><br><span class=line>182</span><br><span class=line>183</span><br><span class=line>184</span><br><span class=line>185</span><br><span class=line>186</span><br><span class=line>187</span><br><span class=line>188</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># cat /usr/local/nginx1.10/conf/nginx.conf</span></span><br><span class=line></span><br><span class=line>user  nginx nginx;</span><br><span class=line>worker_processes  2;</span><br><span class=line>worker_cpu_affinity 01 10;</span><br><span class=line>worker_rlimit_nofile 65535;</span><br><span class=line></span><br><span class=line><span class=comment>#error_log  logs/error.log;</span></span><br><span class=line><span class=comment>#error_log  logs/error.log  notice;</span></span><br><span class=line><span class=comment>#error_log  logs/error.log  info;</span></span><br><span class=line></span><br><span class=line><span class=comment>#pid        logs/nginx.pid;</span></span><br><span class=line></span><br><span class=line></span><br><span class=line>events &#123;</span><br><span class=line>    use epoll;</span><br><span class=line>    worker_connections  65535;</span><br><span class=line>    multi_accept on;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line></span><br><span class=line>http &#123;</span><br><span class=line>    include       mime.types;</span><br><span class=line>    default_type  application/octet-stream;</span><br><span class=line></span><br><span class=line>    <span class=comment>#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class=line>    <span class=comment>#                  '$status $body_bytes_sent "$http_referer" '</span></span><br><span class=line>    <span class=comment>#                  '"$http_user_agent" "$http_x_forwarded_for"';</span></span><br><span class=line></span><br><span class=line>    <span class=comment>#access_log  logs/access.log  main;</span></span><br><span class=line></span><br><span class=line>    sendfile        on;</span><br><span class=line>    tcp_nopush     on;</span><br><span class=line></span><br><span class=line>    <span class=comment>#keepalive_timeout  0;</span></span><br><span class=line>    keepalive_timeout  65;</span><br><span class=line>    tcp_nodelay on;</span><br><span class=line>    client_header_buffer_size 4k;</span><br><span class=line>    open_file_cache max=102400 inactive=20s;</span><br><span class=line>    open_file_cache_valid 30s;</span><br><span class=line>    open_file_cache_min_uses 1;</span><br><span class=line>    client_header_timeout 15;</span><br><span class=line>    client_body_timeout 15;</span><br><span class=line>    reset_timedout_connection on;</span><br><span class=line>    send_timeout 15;</span><br><span class=line>    server_tokens off;</span><br><span class=line>    client_max_body_size 10m;</span><br><span class=line>    fastcgi_connect_timeout 600;</span><br><span class=line>    fastcgi_send_timeout 600;</span><br><span class=line>    fastcgi_read_timeout 600;</span><br><span class=line>    fastcgi_buffer_size 64k;</span><br><span class=line>    fastcgi_buffers 4 64k;</span><br><span class=line>    fastcgi_busy_buffers_size 128k;</span><br><span class=line>    fastcgi_temp_file_write_size 128k;</span><br><span class=line>    fastcgi_temp_path /usr/<span class=built_in>local</span>/nginx1.10/nginx_tmp;</span><br><span class=line>    fastcgi_intercept_errors on;</span><br><span class=line>    fastcgi_cache_path /usr/<span class=built_in>local</span>/nginx1.10/fastcgi_cache levels=1:2 keys_zone=cache_fastcgi:128m inactive=1d max_size=10g;</span><br><span class=line></span><br><span class=line>    gzip  on;</span><br><span class=line>    gzip_min_length 2k;</span><br><span class=line>    gzip_buffers 4 32k;</span><br><span class=line>    gzip_http_version 1.1;</span><br><span class=line>    gzip_comp_level 6;</span><br><span class=line>    gzip_types  text/plain  text/css  text/javascript  application/json  application/javascript application/x-javascript application/xml;</span><br><span class=line>    gzip_vary on;</span><br><span class=line>    gzip_proxied any;</span><br><span class=line></span><br><span class=line>    server &#123;</span><br><span class=line>        listen       80;</span><br><span class=line>        server_name  localhost;</span><br><span class=line></span><br><span class=line>        <span class=comment>#charset koi8-r;</span></span><br><span class=line></span><br><span class=line>        <span class=comment>#access_log  logs/host.access.log  main;</span></span><br><span class=line></span><br><span class=line>	location ~* ^.+\.(jpg|gif|png|swf|flv|wma|wmv|asf|mp3|mmf|zip|rar)$ &#123;</span><br><span class=line>	    valid_referers none blocked 192.168.1.20;</span><br><span class=line>	    <span class=keyword>if</span> (<span class=variable>$invalid_referer</span>) &#123;</span><br><span class=line>		<span class=comment>#return 302 http://192.168.1.20/img/nolink.jpg;</span></span><br><span class=line>		<span class=built_in>return</span> 404;</span><br><span class=line>		<span class=built_in>break</span>;</span><br><span class=line>	    &#125;</span><br><span class=line>	    access_log off;</span><br><span class=line>	&#125;	</span><br><span class=line></span><br><span class=line></span><br><span class=line>        location / &#123;</span><br><span class=line>            root   html;</span><br><span class=line>            index  index.php index.html index.htm;</span><br><span class=line>        &#125;</span><br><span class=line>  	</span><br><span class=line>	location ~* \.(ico|jpe?g|gif|png|bmp|swf|flv)$ &#123;</span><br><span class=line>	    expires 30d;</span><br><span class=line>	    <span class=comment>#log_not_found off;</span></span><br><span class=line>	    access_log off;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	location ~* \.(js|css)$ &#123;</span><br><span class=line>	    expires 7d;</span><br><span class=line>	    log_not_found off;</span><br><span class=line>	    access_log off;</span><br><span class=line>	&#125;</span><br><span class=line>	location ~ .*\.(php|php5)?$ &#123;</span><br><span class=line>	    root html;</span><br><span class=line>	    fastcgi_pass 127.0.0.1:9000;</span><br><span class=line> 	    fastcgi_index index.php;</span><br><span class=line>	    include fastcgi.conf;</span><br><span class=line>	    fastcgi_cache cache_fastcgi;</span><br><span class=line>	    fastcgi_cache_valid 200 302 1h;</span><br><span class=line>	    fastcgi_cache_valid 301 1d;</span><br><span class=line>	    fastcgi_cache_valid any 1m;</span><br><span class=line>	    fastcgi_cache_min_uses 1;</span><br><span class=line>	    fastcgi_cache_use_stale error timeout invalid_header http_500;</span><br><span class=line>	    fastcgi_cache_key http://<span class=variable>$host</span><span class=variable>$request_uri</span>;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	</span><br><span class=line>	</span><br><span class=line>        <span class=comment>#error_page  404              /404.html;</span></span><br><span class=line></span><br><span class=line>        <span class=comment># redirect server error pages to the static page /50x.html</span></span><br><span class=line>        <span class=comment>#</span></span><br><span class=line>        error_page   500 502 503 504  /50x.html;</span><br><span class=line>        location = /50x.html &#123;</span><br><span class=line>            root   html;</span><br><span class=line>        &#125;</span><br><span class=line></span><br><span class=line>        <span class=comment># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class=line>        <span class=comment>#</span></span><br><span class=line>        <span class=comment>#location ~ \.php$ &#123;</span></span><br><span class=line>        <span class=comment>#    proxy_pass   http://127.0.0.1;</span></span><br><span class=line>        <span class=comment>#&#125;</span></span><br><span class=line></span><br><span class=line>        <span class=comment># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class=line>        <span class=comment>#</span></span><br><span class=line>        <span class=comment>#location ~ \.php$ &#123;</span></span><br><span class=line>        <span class=comment>#    root           html;</span></span><br><span class=line>        <span class=comment>#    fastcgi_pass   127.0.0.1:9000;</span></span><br><span class=line>        <span class=comment>#    fastcgi_index  index.php;</span></span><br><span class=line>        <span class=comment>#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></span><br><span class=line>        <span class=comment>#    include        fastcgi_params;</span></span><br><span class=line>        <span class=comment>#&#125;</span></span><br><span class=line></span><br><span class=line>        <span class=comment># deny access to .htaccess files, if Apache's document root</span></span><br><span class=line>        <span class=comment># concurs with nginx's one</span></span><br><span class=line>        <span class=comment>#</span></span><br><span class=line>        <span class=comment>#location ~ /\.ht &#123;</span></span><br><span class=line>        <span class=comment>#    deny  all;</span></span><br><span class=line>        <span class=comment>#&#125;</span></span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line></span><br><span class=line>    <span class=comment># another virtual host using mix of IP-, name-, and port-based configuration</span></span><br><span class=line>    <span class=comment>#</span></span><br><span class=line>    <span class=comment>#server &#123;</span></span><br><span class=line>    <span class=comment>#    listen       8000;</span></span><br><span class=line>    <span class=comment>#    listen       somename:8080;</span></span><br><span class=line>    <span class=comment>#    server_name  somename  alias  another.alias;</span></span><br><span class=line></span><br><span class=line>    <span class=comment>#    location / &#123;</span></span><br><span class=line>    <span class=comment>#        root   html;</span></span><br><span class=line>    <span class=comment>#        index  index.html index.htm;</span></span><br><span class=line>    <span class=comment>#    &#125;</span></span><br><span class=line>    <span class=comment>#&#125;</span></span><br><span class=line></span><br><span class=line></span><br><span class=line>    <span class=comment># HTTPS server</span></span><br><span class=line>    <span class=comment>#</span></span><br><span class=line>    <span class=comment>#server &#123;</span></span><br><span class=line>    <span class=comment>#    listen       443 ssl;</span></span><br><span class=line>    <span class=comment>#    server_name  localhost;</span></span><br><span class=line></span><br><span class=line>    <span class=comment>#    ssl_certificate      cert.pem;</span></span><br><span class=line>    <span class=comment>#    ssl_certificate_key  cert.key;</span></span><br><span class=line></span><br><span class=line>    <span class=comment>#    ssl_session_cache    shared:SSL:1m;</span></span><br><span class=line>    <span class=comment>#    ssl_session_timeout  5m;</span></span><br><span class=line></span><br><span class=line>    <span class=comment>#    ssl_ciphers  HIGH:!aNULL:!MD5;</span></span><br><span class=line>    <span class=comment>#    ssl_prefer_server_ciphers  on;</span></span><br><span class=line></span><br><span class=line>    <span class=comment>#    location / &#123;</span></span><br><span class=line>    <span class=comment>#        root   html;</span></span><br><span class=line>    <span class=comment>#        index  index.html index.htm;</span></span><br><span class=line>    <span class=comment>#    &#125;</span></span><br><span class=line>    <span class=comment>#&#125;</span></span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h4 id=三、验证、压力测试><a class=header-anchor href=#三、验证、压力测试>¶</a>三、验证、压力测试</h4><h5 id=1、验证防盗链><a class=header-anchor href=#1、验证防盗链>¶</a>1、验证防盗链</h5><p>使用<code>httpd</code>做为一个测试站点，192.168.1.30，在测试页上做一个超链接，链接 nginx站点的一张图片</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@httpd ~]<span class=comment># vim /var/www/html/index.html</span></span><br><span class=line>&lt;a href=<span class=string>"http://192.168.1.20/11.gif"</span>&gt;lianjie&lt;/a&gt;</span><br></pre></td></tr></table></figure><p>Nginx 站点的网页目录结如下</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># tree /usr/local/nginx1.10/html/</span></span><br><span class=line>/usr/<span class=built_in>local</span>/nginx1.10/html/</span><br><span class=line>├── 11.gif</span><br><span class=line>├── 50x.html</span><br><span class=line>├── img</span><br><span class=line>│   └── nolink.jpg</span><br><span class=line>├── index.html</span><br><span class=line>└── test.php</span><br></pre></td></tr></table></figure><p>在客户端浏览器中输入192.168.1.30<br><img data-src=https://img-blog.csdnimg.cn/20200613112914586.png></p><p>点击页面链接<br><img data-src=https://img-blog.csdnimg.cn/20200613112942881.png></p><p>将return的404关闭，指定跳转文件</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line><span class=built_in>return</span> 302 http://192.168.1.20/img/nolink.jpg;</span><br><span class=line>                <span class=comment>#return 404;</span></span><br></pre></td></tr></table></figure><p>11.gif图片<br><img data-src="https://img-blog.csdnimg.cn/20200613113001613.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><br>nolink.jpg图片<br><img data-src="https://img-blog.csdnimg.cn/20200613113033135.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><p>根据防盗链的设置，会跳转到nolink.jpg图片<br><img data-src="https://img-blog.csdnimg.cn/20200613113056145.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70">配置已经生效</p><h5 id=2、验证gzip功能><a class=header-anchor href=#2、验证gzip功能>¶</a>2、验证gzip功能</h5><p><img data-src="https://img-blog.csdnimg.cn/20200613113159446.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><p>用户访问test.php文件，在上图中content-encoding:gzip表明响应给用户的数据是压缩传输</p><h5 id=3、压力测试><a class=header-anchor href=#3、压力测试>¶</a>3、压力测试</h5><p>安装 httpd-tools 软件包</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># yum -y install httpd-tools</span></span><br><span class=line>[root@nginx ~]<span class=comment># ab -c 500 -n 50000 http://192.168.1.20/index.html</span></span><br><span class=line>This is ApacheBench, Version 2.3 &lt;<span class=variable>$Revision</span>: 1430300 $&gt;</span><br><span class=line>Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class=line>Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class=line></span><br><span class=line>Benchmarking 192.168.1.20 (be patient)</span><br><span class=line>Completed 5000 requests</span><br><span class=line>Completed 10000 requests</span><br><span class=line>Completed 15000 requests</span><br><span class=line>Completed 20000 requests</span><br><span class=line>Completed 25000 requests</span><br><span class=line>Completed 30000 requests</span><br><span class=line>Completed 35000 requests</span><br><span class=line>Completed 40000 requests</span><br><span class=line>Completed 45000 requests</span><br><span class=line>Completed 50000 requests</span><br><span class=line>Finished 50000 requests</span><br><span class=line></span><br><span class=line></span><br><span class=line>Server Software:        IIS</span><br><span class=line>Server Hostname:        192.168.1.20</span><br><span class=line>Server Port:            80</span><br><span class=line></span><br><span class=line>Document Path:          /index.html</span><br><span class=line>Document Length:        612 bytes</span><br><span class=line></span><br><span class=line>Concurrency Level:      500</span><br><span class=line>Time taken <span class=keyword>for</span> tests:   2.544 seconds</span><br><span class=line>Complete requests:      50000</span><br><span class=line>Failed requests:        0</span><br><span class=line>Write errors:           0</span><br><span class=line>Total transferred:      41800000 bytes</span><br><span class=line>HTML transferred:       30600000 bytes</span><br><span class=line>Requests per second:    19657.71 [<span class=comment>#/sec] (mean)</span></span><br><span class=line>Time per request:       25.435 [ms] (mean)</span><br><span class=line>Time per request:       0.051 [ms] (mean, across all concurrent requests)</span><br><span class=line>Transfer rate:          16048.68 [Kbytes/sec] received</span><br><span class=line></span><br><span class=line>Connection Times (ms)</span><br><span class=line>              min  mean[+/-sd] median   max</span><br><span class=line>Connect:        0   10   3.9     10      20</span><br><span class=line>Processing:     9   16   4.0     15      29</span><br><span class=line>Waiting:        0    8   1.0      8      12</span><br><span class=line>Total:         15   25   1.5     25      36</span><br><span class=line></span><br><span class=line>Percentage of the requests served within a certain time (ms)</span><br><span class=line>  50%     25</span><br><span class=line>  66%     26</span><br><span class=line>  75%     26</span><br><span class=line>  80%     26</span><br><span class=line>  90%     27</span><br><span class=line>  95%     28</span><br><span class=line>  98%     29</span><br><span class=line>  99%     30</span><br><span class=line> 100%     36 (longest request)</span><br></pre></td></tr></table></figure><p>第二次压力测试，比较两次的差异</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># ab -c 1000 -n 100000 http://192.168.1.20/index.html</span></span><br><span class=line>This is ApacheBench, Version 2.3 &lt;<span class=variable>$Revision</span>: 1430300 $&gt;</span><br><span class=line>Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class=line>Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class=line></span><br><span class=line>Benchmarking 192.168.1.20 (be patient)</span><br><span class=line>Completed 10000 requests</span><br><span class=line>Completed 20000 requests</span><br><span class=line>Completed 30000 requests</span><br><span class=line>Completed 40000 requests</span><br><span class=line>Completed 50000 requests</span><br><span class=line>Completed 60000 requests</span><br><span class=line>Completed 70000 requests</span><br><span class=line>Completed 80000 requests</span><br><span class=line>Completed 90000 requests</span><br><span class=line>Completed 100000 requests</span><br><span class=line>Finished 100000 requests</span><br><span class=line></span><br><span class=line></span><br><span class=line>Server Software:        IIS</span><br><span class=line>Server Hostname:        192.168.1.20</span><br><span class=line>Server Port:            80</span><br><span class=line></span><br><span class=line>Document Path:          /index.html</span><br><span class=line>Document Length:        612 bytes</span><br><span class=line></span><br><span class=line>Concurrency Level:      1000</span><br><span class=line>Time taken <span class=keyword>for</span> tests:   5.633 seconds</span><br><span class=line>Complete requests:      100000</span><br><span class=line>Failed requests:        0</span><br><span class=line>Write errors:           0</span><br><span class=line>Total transferred:      83600000 bytes</span><br><span class=line>HTML transferred:       61200000 bytes</span><br><span class=line>Requests per second:    17753.07 [<span class=comment>#/sec] (mean)</span></span><br><span class=line>Time per request:       56.328 [ms] (mean)</span><br><span class=line>Time per request:       0.056 [ms] (mean, across all concurrent requests)</span><br><span class=line>Transfer rate:          14493.71 [Kbytes/sec] received</span><br><span class=line></span><br><span class=line>Connection Times (ms)</span><br><span class=line>              min  mean[+/-sd] median   max</span><br><span class=line>Connect:        0   17   8.0     17      44</span><br><span class=line>Processing:     9   39   7.9     39      69</span><br><span class=line>Waiting:        0   24   5.4     24      48</span><br><span class=line>Total:         28   56   5.9     56     101</span><br><span class=line></span><br><span class=line>Percentage of the requests served within a certain time (ms)</span><br><span class=line>  50%     56</span><br><span class=line>  66%     58</span><br><span class=line>  75%     59</span><br><span class=line>  80%     60</span><br><span class=line>  90%     62</span><br><span class=line>  95%     64</span><br><span class=line>  98%     68</span><br><span class=line>  99%     75</span><br><span class=line> 100%    101 (longest request)</span><br></pre></td></tr></table></figure><blockquote><p>第一次：Requests per second: 19657.71 [#/sec] (mean)</p><p>第二次：Requests per second: 17753.07 [#/sec] (mean)</p></blockquote><h5 id=5、xcache加速php><a class=header-anchor href=#5、xcache加速php>¶</a>5、xcache加速php</h5><h6 id=（1）安装-xcache><a class=header-anchor href=#（1）安装-xcache>¶</a>（1）安装 xcache</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># wget http://xcache.lighttpd.net/pub/Releases/3.2.0/xcache-3.2.0.tar.gz</span></span><br><span class=line>[root@nginx ~]<span class=comment># tar zxf xcache-3.2.0.tar.gz </span></span><br><span class=line>[root@nginx ~]<span class=comment># cd xcache-3.2.0/</span></span><br><span class=line><span class=comment># 用 phpize 生成 configure 配置文件</span></span><br><span class=line>[root@nginx xcache-3.2.0]<span class=comment># /usr/local/php5.6/bin/phpize</span></span><br><span class=line>[root@nginx xcache-3.2.0]<span class=comment># ./configure  --enable-xcache  --enable-xcache-coverager --enable-xcache-optimizer --with-php-config=/usr/local/php5.6/bin/php-config</span></span><br><span class=line>[root@nginx xcache-3.2.0]<span class=comment># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><p>安装完成之后，出现下面的界面，记住以下路径，后面会用到</p><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>Installing shared extensions:     /usr/local/php5.6/lib/php/extensions/no-debug-zts-20131226/</span><br></pre></td></tr></table></figure><h6 id=（2）创建-xcache-缓存文件><a class=header-anchor href=#（2）创建-xcache-缓存文件>¶</a>（2）创建 xcache 缓存文件</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@nginx xcache-3.2.0]<span class=comment># touch /tmp/xcache</span></span><br><span class=line>[root@nginx xcache-3.2.0]<span class=comment># chmod 777 /tmp/xcache</span></span><br></pre></td></tr></table></figure><h6 id=（3）拷贝xcache后台管理程序到网站根目录><a class=header-anchor href=#（3）拷贝xcache后台管理程序到网站根目录>¶</a>（3）拷贝xcache后台管理程序到网站根目录</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@nginx xcache-3.2.0]<span class=comment># cp -r htdocs/ /usr/local/nginx1.10/html/xcache</span></span><br></pre></td></tr></table></figure><h6 id=（4）配置-php-支持-xcache><a class=header-anchor href=#（4）配置-php-支持-xcache>¶</a>（4）配置 php 支持 xcache</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># vim /etc/php.ini</span></span><br><span class=line><span class=comment># 最后一样添加</span></span><br><span class=line>[xcache-common]</span><br><span class=line>extension = /usr/<span class=built_in>local</span>/php5.6/lib/php/extensions/no-debug-zts-20131226/xcache.so</span><br><span class=line><span class=comment># 注意目录</span></span><br><span class=line>[xcache.admin]</span><br><span class=line>xcache.admin.enable_auth = Off</span><br><span class=line>[xcache]</span><br><span class=line>xcache.shm_scheme =<span class=string>"mmap"</span></span><br><span class=line>xcache.size=60M</span><br><span class=line>xcache.count =1</span><br><span class=line>xcache.slots =8K</span><br><span class=line>xcache.ttl=0</span><br><span class=line>xcache.gc_interval =0</span><br><span class=line>xcache.var_size=64M</span><br><span class=line>xcache.var_count =1</span><br><span class=line>xcache.var_slots =8K</span><br><span class=line>xcache.var_ttl=0</span><br><span class=line>xcache.var_maxttl=0</span><br><span class=line>xcache.var_gc_interval =300</span><br><span class=line>xcache.test =Off</span><br><span class=line>xcache.readonly_protection = Off</span><br><span class=line>xcache.mmap_path =<span class=string>"/tmp/xcache"</span></span><br><span class=line>xcache.coredump_directory =<span class=string>""</span></span><br><span class=line>xcache.cacher =On</span><br><span class=line>xcache.stat=On</span><br><span class=line>xcache.optimizer =Off</span><br><span class=line>[xcache.coverager]</span><br><span class=line>xcache.coverager =On</span><br><span class=line>xcache.coveragedump_directory =<span class=string>""</span></span><br></pre></td></tr></table></figure><h5 id=6、测试><a class=header-anchor href=#6、测试>¶</a>6、测试</h5><p>重启php-fpm</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># service php-fpm restart</span></span><br><span class=line>Gracefully shutting down php-fpm . <span class=keyword>done</span></span><br><span class=line>Starting php-fpm  <span class=keyword>done</span></span><br></pre></td></tr></table></figure><p>浏览器打开网站根目录下面的 xcache<br><img data-src="https://img-blog.csdnimg.cn/2020061311332680.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><p>测试对 php 动态页面的压力测试</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># ab -c 1000 -n 100000 http://192.168.1.20/test.php</span></span><br><span class=line>This is ApacheBench, Version 2.3 &lt;<span class=variable>$Revision</span>: 1430300 $&gt;</span><br><span class=line>Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class=line>Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class=line></span><br><span class=line>Benchmarking 192.168.1.20 (be patient)</span><br><span class=line>Completed 10000 requests</span><br><span class=line>Completed 20000 requests</span><br><span class=line>Completed 30000 requests</span><br><span class=line>Completed 40000 requests</span><br><span class=line>Completed 50000 requests</span><br><span class=line>Completed 60000 requests</span><br><span class=line>Completed 70000 requests</span><br><span class=line>Completed 80000 requests</span><br><span class=line>Completed 90000 requests</span><br><span class=line>Completed 100000 requests</span><br><span class=line>Finished 100000 requests</span><br><span class=line></span><br><span class=line></span><br><span class=line>Server Software:        IIS</span><br><span class=line>Server Hostname:        192.168.1.20</span><br><span class=line>Server Port:            80</span><br><span class=line></span><br><span class=line>Document Path:          /test.php</span><br><span class=line>Document Length:        84586 bytes</span><br><span class=line></span><br><span class=line>Concurrency Level:      1000</span><br><span class=line>Time taken <span class=keyword>for</span> tests:   9.496 seconds</span><br><span class=line>Complete requests:      100000</span><br><span class=line>Failed requests:        0</span><br><span class=line>Write errors:           0</span><br><span class=line>Total transferred:      8476300000 bytes</span><br><span class=line>HTML transferred:       8458600000 bytes</span><br><span class=line>Requests per second:    10531.17 [<span class=comment>#/sec] (mean)</span></span><br><span class=line>Time per request:       94.956 [ms] (mean)</span><br><span class=line>Time per request:       0.095 [ms] (mean, across all concurrent requests)</span><br><span class=line>Transfer rate:          871732.00 [Kbytes/sec] received</span><br><span class=line></span><br><span class=line>Connection Times (ms)</span><br><span class=line>              min  mean[+/-sd] median   max</span><br><span class=line>Connect:        0   14   7.4     13      58</span><br><span class=line>Processing:    13   81  12.3     81     146</span><br><span class=line>Waiting:        2   26   9.2     25      79</span><br><span class=line>Total:         35   95  11.7     93     165</span><br><span class=line></span><br><span class=line>Percentage of the requests served within a certain time (ms)</span><br><span class=line>  50%     93</span><br><span class=line>  66%     97</span><br><span class=line>  75%    100</span><br><span class=line>  80%    103</span><br><span class=line>  90%    110</span><br><span class=line>  95%    114</span><br><span class=line>  98%    124</span><br><span class=line>  99%    130</span><br><span class=line> 100%    165 (longest request)</span><br><span class=line> Requests per second:    10531.17 [<span class=comment>#/sec] (mean)</span></span><br></pre></td></tr></table></figure></div><div><ul class=post-copyright><li class=post-copyright-author><strong>本文作者：</strong>Maisy</li><li class=post-copyright-link><strong>本文链接：</strong> <a href=https://pdxblog.top/Nginx%E4%BC%98%E5%8C%96%E4%B8%8E%E9%98%B2%E7%9B%97%E9%93%BE+%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2LNMP.html title=Nginx优化与防盗链+单机部署LNMP>https://pdxblog.top/Nginx优化与防盗链+单机部署LNMP.html</a></li><li class=post-copyright-license><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel=noopener target=_blank><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class=post-footer><div class=post-tags><a href="/tags/%E6%9E%B6%E6%9E%84/" rel=tag># 架构</a></div><div class=post-nav><div class=post-nav-item><a href=/Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%84%E5%BB%BA.html rel=prev title=Nginx反向代理缓存服务器构建><i class="fa fa-chevron-left"></i> Nginx反向代理缓存服务器构建</a></div><div class=post-nav-item><a href=/Varnish4.0%E7%BC%93%E5%AD%98%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE.html rel=next title=Varnish4.0缓存代理配置>Varnish4.0缓存代理配置 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class=comments id=valine-comments></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class=nav><li class="nav-item nav-level-3"><a class=nav-link href=#Nginx优化与防盗链-单机部署LNMP><span class=nav-number>1.</span> <span class=nav-text>¶Nginx优化与防盗链+单机部署LNMP</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#一、Nginx的优化><span class=nav-number>1.1.</span> <span class=nav-text>¶一、Nginx的优化</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#1、编译安装前的优化><span class=nav-number>1.1.1.</span> <span class=nav-text>¶1、编译安装前的优化</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#（1）安装-zlib-devel、pcre-devel-等依赖包><span class=nav-number>1.1.1.1.</span> <span class=nav-text>¶（1）安装 zlib-devel、pcre-devel 等依赖包</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（2）下载Nginx源码包><span class=nav-number>1.1.1.2.</span> <span class=nav-text>¶（2）下载Nginx源码包</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（3）解压源码包><span class=nav-number>1.1.1.3.</span> <span class=nav-text>¶（3）解压源码包</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（4）隐藏软件名称和版本号><span class=nav-number>1.1.1.4.</span> <span class=nav-text>¶（4）隐藏软件名称和版本号</span></a></li></ol></li><li class="nav-item nav-level-5"><a class=nav-link href=#2、安装nginx><span class=nav-number>1.1.2.</span> <span class=nav-text>¶2、安装nginx</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#（1）添加-nginx-组><span class=nav-number>1.1.2.1.</span> <span class=nav-text>¶（1）添加 nginx 组</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（2）编译安装><span class=nav-number>1.1.2.2.</span> <span class=nav-text>¶（2）编译安装</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（3）启动-nginx><span class=nav-number>1.1.2.3.</span> <span class=nav-text>¶（3）启动 nginx</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（4）测试是否隐藏了版本和软件名><span class=nav-number>1.1.2.4.</span> <span class=nav-text>¶（4）测试是否隐藏了版本和软件名</span></a></li></ol></li><li class="nav-item nav-level-5"><a class=nav-link href=#3、nginx配置项优化><span class=nav-number>1.1.3.</span> <span class=nav-text>¶3、nginx配置项优化</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#（1）Nginx-运行-工作置-进程个数><span class=nav-number>1.1.3.1.</span> <span class=nav-text>¶（1）Nginx 运行 工作置 进程个数</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（2）Nginx-运行-CPU-亲和力><span class=nav-number>1.1.3.2.</span> <span class=nav-text>¶（2）Nginx 运行 CPU 亲和力</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（3）Nginx-最多可以打开文件数><span class=nav-number>1.1.3.3.</span> <span class=nav-text>¶（3）Nginx 最多可以打开文件数</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（4）Nginx-事件处理模型><span class=nav-number>1.1.3.4.</span> <span class=nav-text>¶（4）Nginx 事件处理模型</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（5）开启高效传输模式><span class=nav-number>1.1.3.5.</span> <span class=nav-text>¶（5）开启高效传输模式</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（6）连接超时时间><span class=nav-number>1.1.3.6.</span> <span class=nav-text>¶（6）连接超时时间</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（7）fastcgi-调优><span class=nav-number>1.1.3.7.</span> <span class=nav-text>¶（7）fastcgi 调优</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（8）gzip调优><span class=nav-number>1.1.3.8.</span> <span class=nav-text>¶（8）gzip调优</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（9）expires-缓存调优><span class=nav-number>1.1.3.9.</span> <span class=nav-text>¶（9）expires 缓存调优</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（10）防盗链><span class=nav-number>1.1.3.10.</span> <span class=nav-text>¶（10）防盗链</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（11）内核参数优化><span class=nav-number>1.1.3.11.</span> <span class=nav-text>¶（11）内核参数优化</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（12）关于系统连接数的优化：><span class=nav-number>1.1.3.12.</span> <span class=nav-text>¶（12）关于系统连接数的优化：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#二、部署LNMP><span class=nav-number>1.2.</span> <span class=nav-text>¶二、部署LNMP</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#1、安装php><span class=nav-number>1.2.1.</span> <span class=nav-text>¶1、安装php</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#（1）解决依赖关系><span class=nav-number>1.2.1.1.</span> <span class=nav-text>¶（1）解决依赖关系</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（2）编译安装php><span class=nav-number>1.2.1.2.</span> <span class=nav-text>¶（2）编译安装php</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（3）提供php配置文件><span class=nav-number>1.2.1.3.</span> <span class=nav-text>¶（3）提供php配置文件</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（4）为-php-fpm-提供脚本><span class=nav-number>1.2.1.4.</span> <span class=nav-text>¶（4）为 php-fpm 提供脚本</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（5）提供-php-fpm-配置文件并编辑><span class=nav-number>1.2.1.5.</span> <span class=nav-text>¶（5）提供 php-fpm 配置文件并编辑</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#三、验证、压力测试><span class=nav-number>1.3.</span> <span class=nav-text>¶三、验证、压力测试</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#1、验证防盗链><span class=nav-number>1.3.1.</span> <span class=nav-text>¶1、验证防盗链</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#2、验证gzip功能><span class=nav-number>1.3.2.</span> <span class=nav-text>¶2、验证gzip功能</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#3、压力测试><span class=nav-number>1.3.3.</span> <span class=nav-text>¶3、压力测试</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#5、xcache加速php><span class=nav-number>1.3.4.</span> <span class=nav-text>¶5、xcache加速php</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#（1）安装-xcache><span class=nav-number>1.3.4.1.</span> <span class=nav-text>¶（1）安装 xcache</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（2）创建-xcache-缓存文件><span class=nav-number>1.3.4.2.</span> <span class=nav-text>¶（2）创建 xcache 缓存文件</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（3）拷贝xcache后台管理程序到网站根目录><span class=nav-number>1.3.4.3.</span> <span class=nav-text>¶（3）拷贝xcache后台管理程序到网站根目录</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（4）配置-php-支持-xcache><span class=nav-number>1.3.4.4.</span> <span class=nav-text>¶（4）配置 php 支持 xcache</span></a></li></ol></li><li class="nav-item nav-level-5"><a class=nav-link href=#6、测试><span class=nav-number>1.3.5.</span> <span class=nav-text>¶6、测试</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Maisy src=/images/author.jpg><p class=site-author-name itemprop=name>Maisy</p><div class=site-description itemprop=description>人的一生就是一个储蓄的过程，在奋斗的时候储存了希望；在耕耘的时候储存了一粒种子；在旅行的时候储存了风景；在微笑的时候储存了快乐。聪明的人善于储蓄，在漫长而短暂的人生旅途中，学会储蓄每一个闪光的瞬间，然后用它们酿成一杯美好的回忆，在四季的变幻与交替之间，散发浓香，珍藏一生</div></div><div class="site-state-wrap motion-element"><nav class=site-state><div class="site-state-item site-state-posts"><a href="/archives/"><span class=site-state-item-count>69</span> <span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class=site-state-item-count>7</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class=site-state-item-count>7</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/Gilbert2/Gilbert2.github.io title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Gilbert2&#x2F;Gilbert2.github.io" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a></span> <span class=links-of-author-item><a href=https://blog.csdn.net/weixin_45636702 title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_45636702" rel=noopener target=_blank><i class="fab fa-crosshairs fa-fw"></i>CSDN</a></span></div><div class="cc-license motion-element" itemprop=license><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class=cc-opacity rel=noopener target=_blank><img src=/images/cc-by-nc-sa.svg alt="Creative Commons"></a></div></div></div></aside><div id=sidebar-dimmer></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy; 2019 – <span itemprop=copyrightYear>2020</span> <span class=with-love><i class="fa fa-heart"></i></span> <span class=author itemprop=copyrightHolder>Maisy</span> <span class=post-meta-divider>|</span> <span class=post-meta-item-icon><i class="fa fa-chart-area"></i></span> <span class=post-meta-item-text>站点总字数：</span> <span title=站点总字数>572k</span> <span class=post-meta-divider>|</span> <span class=post-meta-item-icon><i class="fa fa-coffee"></i></span> <span class=post-meta-item-text>站点阅读时长 &asymp;</span> <span title=站点阅读时长>8:40</span></div><div class=powered-by>由 <a href="https://hexo.io/" class=theme-link rel=noopener target=_blank>Hexo</a> & <a href="https://muse.theme-next.org/" class=theme-link rel=noopener target=_blank>NexT.Muse</a> 强力驱动</div></div></footer></div><script src=/lib/anime.min.js></script><script src=//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js></script><script src=//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js></script><script src=//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js></script><script src=/lib/velocity/velocity.min.js></script><script src=/lib/velocity/velocity.ui.min.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/schemes/muse.js></script><script src=/js/next-boot.js></script><script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script><script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.3.9/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'yK6nF3Ng27WevBtHAbTkt8Jv-gzGzoHsz',
      appKey     : 'DXAxzx0igQL9KzyblmtXnVkh',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script></body></html>