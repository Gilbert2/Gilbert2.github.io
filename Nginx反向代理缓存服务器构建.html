<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width, initial-scale=1, maximum-scale=2"><meta name=theme-color content=#222><meta name=generator content="Hexo 4.2.0"><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-next.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32-next.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16-next.png><link rel=mask-icon href=/images/logo.svg color=#222><meta name=msvalidate.01 content=true><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><link rel=stylesheet href=//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css><script id=hexo-configurations>
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pdxblog.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"b2t":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":{"enable":true,"onlypost":false,"loadingImg":null},"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script><meta name=description content=架构><meta property=og:type content=article><meta property=og:title content=Nginx反向代理缓存服务器构建><meta property=og:url content=https://pdxblog.top/Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%84%E5%BB%BA.html><meta property=og:site_name content=Maisyの博客><meta property=og:description content=架构><meta property=og:locale content=zh_CN><meta property=og:image content="https://img-blog.csdnimg.cn/20200611131809239.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content=https://img-blog.csdnimg.cn/20200611131834340.png><meta property=og:image content="https://img-blog.csdnimg.cn/20200611131847319.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200611131911282.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/2020061113202580.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200611132221666.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200611132323290.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200611132524563.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200611132430847.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200611132603607.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=article:published_time content=2020-06-10T16:00:00.000Z><meta property=article:modified_time content=2020-06-11T05:30:53.138Z><meta property=article:author content=Maisy><meta property=article:tag content=架构><meta name=twitter:card content=summary><meta name=twitter:image content="https://img-blog.csdnimg.cn/20200611131809239.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><link rel=canonical href=https://pdxblog.top/Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%84%E5%BB%BA.html><script id=page-configurations>
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script><title>Nginx反向代理缓存服务器构建 | Maisyの博客</title><noscript><style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style></noscript><link rel=alternate href=/atom.xml title=Maisyの博客 type=application/atom+xml></head><body itemscope itemtype=http://schema.org/WebPage><div class="container use-motion"><div class=headband></div><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class=site-meta><a href="/" class=brand rel=start><span class=logo-line-before><i></i></span><h1 class=site-title>Maisyの博客</h1><span class=logo-line-after><i></i></span></a><p class=site-subtitle itemprop=description>记录生活中的点点滴滴</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul id=menu class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel=section><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-top"><a href="/top/" rel=section><i class="fa fa-signal fa-fw"></i>排行榜</a></li><li class="menu-item menu-item-about"><a href="/about/" rel=section><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel=section><i class="fa fa-tags fa-fw"></i>标签<span class=badge>6</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel=section><i class="fa fa-th fa-fw"></i>分类<span class=badge>6</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel=section><i class="fa fa-archive fa-fw"></i>归档<span class=badge>58</span></a></li></ul></nav></div></header><div class=back-to-top><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class=main><div class=main-inner><div class=content-wrap><div class="content post posts-expand"><article itemscope itemtype=http://schema.org/Article class=post-block lang=zh-CN><link itemprop=mainEntityOfPage href=https://pdxblog.top/Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%84%E5%BB%BA.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/author.jpg><meta itemprop=name content=Maisy><meta itemprop=description content=人的一生就是一个储蓄的过程，在奋斗的时候储存了希望；在耕耘的时候储存了一粒种子；在旅行的时候储存了风景；在微笑的时候储存了快乐。聪明的人善于储蓄，在漫长而短暂的人生旅途中，学会储蓄每一个闪光的瞬间，然后用它们酿成一杯美好的回忆，在四季的变幻与交替之间，散发浓香，珍藏一生></span> <span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content=Maisyの博客></span><header class=post-header><h1 class=post-title itemprop="name headline">Nginx反向代理缓存服务器构建</h1><div class=post-meta><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span> <span class=post-meta-item-text>发表于</span><time title="创建时间：2020-06-11 00:00:00 / 修改时间：13:30:53" itemprop="dateCreated datePublished" datetime=2020-06-11T00:00:00+08:00>2020-06-11</time></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder"></i></span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href="/categories/%E6%9E%B6%E6%9E%84/" itemprop=url rel=index><span itemprop=name>架构</span></a></span></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-comment"></i></span> <span class=post-meta-item-text>Valine：</span> <a title=valine href=/Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%84%E5%BB%BA.html#valine-comments itemprop=discussionUrl><span class="post-comments-count valine-comment-count" data-xid=/Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%84%E5%BB%BA.html itemprop=commentCount></span></a></span><br><span class=post-meta-item title=本文字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span> <span class=post-meta-item-text>本文字数：</span> <span>22k</span></span> <span class=post-meta-item title=阅读时长><span class=post-meta-item-icon><i class="far fa-clock"></i></span> <span class=post-meta-item-text>阅读时长 &asymp;</span> <span>20 分钟</span></span><div class=post-description>架构</div></div></header><div class=post-body itemprop=articleBody><h3 id=Nginx反向代理缓存服务器构建><a class=header-anchor href=#Nginx反向代理缓存服务器构建>¶</a>Nginx反向代理缓存服务器构建</h3><p>代理服务可简单的分为正向代理和反向代理:</p><p>正向代理:</p><p>用于代理内部网络对 Internet 的连接请求(如 VPN/NAT),客户端指定代理服务器,并将本来要直接发送给目标Web服务器的HTTP请求先发送到代理服务器上, 然后由代理服务 器去访问 Web 服务器, 并将 Web 服务器的 Response 回传给客户端</p><p>反向代理:</p><p>与正向代理相反,如果局域网向Internet提供资源,并让Internet上的其他用户可以 访问局域网内资源, 也可以设置一个代理服务器, 它提供的服务就是反向代理. 反向代理服 务器接受来自 Internet 的连接,然后将请求转发给内部网络上的服务器,并将 Response 回传给 Internet 上请求连接的客户端</p><h4 id=一、nginx-反向代理：Web-服务器的调度器><a class=header-anchor href=#一、nginx-反向代理：Web-服务器的调度器>¶</a>一、nginx 反向代理：Web 服务器的调度器</h4><h5 id=1、反向代理方式><a class=header-anchor href=#1、反向代理方式>¶</a>1、反向代理方式</h5><p>反向代理（Reverse Proxy）方式是指以代理服务器来接受客户端的连接请求，然后将请 求转发给网络上的 web 服务器（可能是 apache、nginx、tomcat、iis 等），并将从 web 服务 器上得到的结果返回给请求连接的客户端，此时代理服务器对外就表现为一个服务器<br><img data-src="https://img-blog.csdnimg.cn/20200611131809239.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><p>从上图可以看出：反向代理服务器代理网站 Web 服务器接收 Http 请求，对请求进行转发。 而且nginx作为反向代理服务器可以根据用户请求的内容把请求转发给后端不同的web服务 器，例如静动分离，再例如在 nginx 上创建多个虚拟主机，这样就成功的做到了在浏览器中 输入不同域名（url）的时候访问后端的不同 web 服务器或 web 群集</p><h5 id=2、反向代理的作用><a class=header-anchor href=#2、反向代理的作用>¶</a>2、反向代理的作用</h5><h6 id=（1）保护网站安全：><a class=header-anchor href=#（1）保护网站安全：>¶</a>（1）保护网站安全：</h6><p>任何来自 Internet 的请求都必须先经过代理服务器<br><img data-src=https://img-blog.csdnimg.cn/20200611131834340.png></p><h6 id=（2）通过配置缓存功能加速-Web-请求：><a class=header-anchor href=#（2）通过配置缓存功能加速-Web-请求：>¶</a>（2）通过配置缓存功能加速 Web 请求：</h6><p>可以缓存真实 Web 服务器上的某些静态资源，减轻真 实 Web 服务器的负载压力<br><img data-src="https://img-blog.csdnimg.cn/20200611131847319.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><h6 id=（3）实现负载均衡：><a class=header-anchor href=#（3）实现负载均衡：>¶</a>（3）实现负载均衡：</h6><p>充当负载均衡服务器均衡地分发请求，平衡集群中各个服务器的负载压力<br><img data-src="https://img-blog.csdnimg.cn/20200611131911282.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><h4 id=二、什么是-nginx：><a class=header-anchor href=#二、什么是-nginx：>¶</a>二、什么是 nginx：</h4><h5 id=1、nginx简介><a class=header-anchor href=#1、nginx简介>¶</a>1、nginx简介</h5><blockquote><p>Nginx 是一款轻量级的网页服务器、反向代理器以及电子邮件代理服务器。因它的稳定性、 丰富的功能集、示例配置文件和低系统资源的消耗而闻名。Nginx（发音同 engine x），它是 由俄罗斯程序员 Igor Sysoev 所开发的。起初是供俄国大型的门户网站及搜索引擎 Rambler （俄语：Рамблер）使用。此软件 BSD-like 协议下发行，可以在 UNIX、GNU/Linux、 BSD、Mac OS X、Solaris，以及 Microsoft Windows 等操作系统中运行</p></blockquote><h5 id=2、Nginx-的应用现状：><a class=header-anchor href=#2、Nginx-的应用现状：>¶</a>2、Nginx 的应用现状：</h5><blockquote><p>Nginx 已经在俄罗斯最大的门户网站── Rambler Media（<a href=http://www.rambler.ru target=_blank rel=noopener>www.rambler.ru</a>）上运行，同时俄 罗斯超过 20%的虚拟主机平台采用 Nginx 作为反向代理服务器</p><p>在国内，已经有 淘宝、新浪博客、新浪播客、网易新闻、六间房、<a href=http://56.com target=_blank rel=noopener>56.com</a>、Discuz!、水木 社区、豆瓣、YUPOO、海内、迅雷在线 等多家网站使用 Nginx 作为 Web 服务器或反向代 理服务器</p></blockquote><h5 id=3、Nginx-的核心特点：><a class=header-anchor href=#3、Nginx-的核心特点：>¶</a>3、Nginx 的核心特点：</h5><h6 id=（1）跨平台：><a class=header-anchor href=#（1）跨平台：>¶</a>（1）跨平台：</h6><p>Nginx 可以在大多数 OS 编译运行，而且也有 Windows 的版本</p><h6 id=（2）配置异常简单：><a class=header-anchor href=#（2）配置异常简单：>¶</a>（2）配置异常简单：</h6><p>非常容易上手</p><h6 id=（3）非阻塞、高并发连接：><a class=header-anchor href=#（3）非阻塞、高并发连接：>¶</a>（3）非阻塞、高并发连接：</h6><p>官方测试能够支撑 5 万并发连接，在实际生产环境中跑到 2～3 万并发连接数。（这得益于 Nginx 使用了最新的 epoll 模型）</p><p>注：</p><blockquote><p>对于一个 Web 服务器来说，首先看一个请求的基本过程：建立连接—接收数据—发送数据， 在系统底层看来 ：上述过程（建立连接—接收数据—发送数据）在系统底层就是读写事件。</p><p>如果采用阻塞调用的方式，当读写事件没有准备好时，那么就只能等待，当前线程被挂起，等事件准备好了，才能进行读写事件。</p><p>如果采用非阻塞调用的方式：事件马上返回，告诉你事件还没准备好呢，过会再来吧。过一 会，再来检查一下事件，直到事件准备好了为止，在这期间，你就可以先去做其它事情，然 后再来看看事件好了没。虽然不阻塞了，但你得不时地过来检查一下事件的状态，你可以做 更多的事情了，但带来的开销也是不小的。非阻塞调用指在不能立刻得到结果之前，该调用 不会阻塞当前线程</p></blockquote><h6 id=（4）事件驱动：><a class=header-anchor href=#（4）事件驱动：>¶</a>（4）事件驱动：</h6><p>通信机制采用 epoll 模型，支持更大的并发连接</p><p>阻塞通过不断检查事件的状态来判断是否进行读写操作，这样带来的开销很大，因此就有 了异步非阻塞的事件处理机制。这 种机制让你可以同时监控多个事件，调用他们是非阻塞的， 但可以设置超时时间，在超时时间之内，如果有事件准备好了，就返回。这种机制解决了上 面阻塞调用与非阻塞调用的两个问题。</p><p>以 epoll 模型为例：</p><blockquote><p>当事件没有准备好时，就放入 epoll(队列)里面。如果有事件准备好了， 那么就去处理；当事件没有准备好时，才在 epoll 里面等着。这样，我们就可以并发处理大 量的并发了，当然，这里的并发请求，是指未处理完的请求。线程只有一个，所以同时能处 理的请求当然只有一个了，只是在请求之间进行不断地切换而已，切换也是因为异步事件未 准备好，而主动让出的。这里的切换是没有任何代价，你可以理解为循环处理多个准备好的 事件。</p><p>多线程方式相比，这种事件处理方式是有很大的优势的，不需要创建线程，每个请求占用的 内存也很少，没有上下文切换， 事件处理非常的轻量级，并发数再多也不会导致无谓的资 源浪费（上下文切换）。对于 apache 服务器，每个请求会独占一个工作线程，当并发数上到 几千时，就同时有几千的线程在处理请求了。这对操作系统来说，是个不小的挑战：因为线 程带来的内存占用非常大，线程的上下文切换带来的 cpu 开销很大，自然性能就上不 去， 从而导致在高并发场景下性能下降严重</p><p>总结：通过异步非阻塞的事件处理机制，Nginx 实现由进程循环处理多个准备好的事件，从 而实现高并发和轻量级</p></blockquote><h6 id=（5）Master-Worker-结构：><a class=header-anchor href=#（5）Master-Worker-结构：>¶</a>（5）Master/Worker 结构：</h6><p>一个 master 进程，生成一个或多个 worker 进程<br><img data-src="https://img-blog.csdnimg.cn/2020061113202580.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><br>注：</p><blockquote><p>Master-Worker 设计模式主要包含两个主要组件 Master 和 Worker，Master 维护着 Worker 队列，将请求下发到多个 Worker 并行执行，Worker 主要进行实际逻辑计算，并将结果返回 给 Maste</p><p>nginx 采用这种进程模型有什么好处？采用独立的进程，可以让互相之间不会影响，一个进 程退出后，其它进程还在工作，服务不会中断，Master 进程则很快重新启动新的 Worker进程。当然，Worker 进程的异常退出，肯定是程序有 bug 了，异常退出，会导致当前 Worker 上的所有请求失败，不过不会影响到所有请求，所以降低了风险</p></blockquote><h6 id=（6）内存消耗小：><a class=header-anchor href=#（6）内存消耗小：>¶</a>（6）内存消耗小：</h6><p>处理大并发的请求内存消耗非常小。在 3 万并发连接下，开启的 10 个 Nginx 进程才消耗 150M 内存（15M*10=150M）</p><h6 id=（7）内置的健康检查功能：><a class=header-anchor href=#（7）内置的健康检查功能：>¶</a>（7）内置的健康检查功能：</h6><p>如果 Nginx 代理的后端的某台 Web 服务器宕机了，不会影响 前端访问</p><h6 id=（8）节省带宽：><a class=header-anchor href=#（8）节省带宽：>¶</a>（8）节省带宽：</h6><p>支持 GZIP 压缩，可以添加浏览器本地缓存的 Header 头</p><h6 id=（9）稳定性高：><a class=header-anchor href=#（9）稳定性高：>¶</a>（9）稳定性高：</h6><p>用于反向代理，宕机的概率微乎其微</p><h4 id=三、Nginx-apache构筑-Web-服务器集群的负载均衡><a class=header-anchor href=#三、Nginx-apache构筑-Web-服务器集群的负载均衡>¶</a>三、Nginx+apache构筑 Web 服务器集群的负载均衡</h4><p>nginx 配置反向代理</p><p>配置 nginx 作为反向代理和负载均衡，同时利用其缓存功能，将静态页面在 nginx 缓存，以达到降低后端服务器连接数的目的并检查后端 web 服务器的健康状况<img data-src="https://img-blog.csdnimg.cn/20200611132221666.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><h5 id=1、安装nginx><a class=header-anchor href=#1、安装nginx>¶</a>1、安装nginx</h5><p>环境：</p><table><thead><tr><th><strong>OS</strong></th><th>centos7.5</th></tr></thead><tbody><tr><td><strong>nginx</strong></td><td><strong>192.168.1.20</strong></td></tr><tr><td><strong>apache1</strong></td><td><strong>192.168.1.30</strong></td></tr><tr><td><strong>apache2</strong></td><td><strong>192.168.1.40</strong></td></tr></tbody></table><h6 id=（1）安装-zlib-devel、pcre-devel-等依赖包><a class=header-anchor href=#（1）安装-zlib-devel、pcre-devel-等依赖包>¶</a>（1）安装 zlib-devel、pcre-devel 等依赖包</h6><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># yum -y install gcc gcc-c++ make libtool zlib zlib-devel pcre pcre-devel opensll openssl-devel</span></span><br></pre></td></tr></table></figure><p>注：</p><blockquote><p>结合 proxy 和 upstream 模块实现后端 web 负载均衡</p><p>使用 proxy 模块实现静态文件缓存</p><p>结合 nginx 默认自带的 ngx_http_proxy_module 模块和ngx_http_upstream_module 模块实现后端服务器的健康检查，也可以使用第三方模块 nginx_upstream_check_module</p><p>使用 nginx-sticky-module 扩展模块实现 Cookie 会话黏贴（保持会话）</p><p>使用 ngx_cache_purge 实现更强大的缓存清除功能</p><p>上面提到的 2 个模块都属于第三方扩展模块，需要提前下好源码，然后编译时通过–add-moudle=src_path 一起安装</p></blockquote><h6 id=（2）安装nginx><a class=header-anchor href=#（2）安装nginx>¶</a>（2）安装nginx</h6><p>添加nginx组</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># groupadd nginx</span></span><br></pre></td></tr></table></figure><p>创建nginx的运行账户nginx，加入到nginx组中，不允许nginx直接登录系统</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># useradd -g nginx nginx -s /sbin/nologin</span></span><br></pre></td></tr></table></figure><p>所需要的软件包</p><blockquote><p>nginx-1.14.0.tar.gz</p><p>ngx_cache_purge-2.3.tar.gz</p><p>nginx-sticky-module.zip</p></blockquote><p><a href=https://pan.baidu.com/s/1C4Wk8a2WCVjUTbnPmfxq_w target=_blank rel=noopener>软件链接</a></p><p>提取码：tfax</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># tar zxf nginx-1.14.0.tar.gz -C /usr/src/</span></span><br><span class=line>[root@nginx ~]<span class=comment># tar zxf ngx_cache_purge-2.3.tar.gz -C /usr/src/</span></span><br><span class=line>[root@nginx ~]<span class=comment># unzip nginx-sticky-module.zip -d /usr/src/</span></span><br><span class=line>[root@nginx ~]<span class=comment># cd /usr/src/nginx-1.14.0/</span></span><br><span class=line>[root@nginx nginx-1.14.0]<span class=comment># ./configure --prefix=/usr/local/nginx1.14 \</span></span><br><span class=line>&gt;  --user=nginx --group=nginx --with-http_stub_status_module \</span><br><span class=line>&gt;  --with-http_realip_module --with-http_ssl_module --with-http_gzip_static_module \</span><br><span class=line>&gt;  --http-client-body-temp-path=/var/tmp/nginx/client \</span><br><span class=line>&gt;  --http-proxy-temp-path=/var/tmp/nginx/proxy \</span><br><span class=line>&gt;  --http-fastcgi-temp-path=/var/tmp/nginx/fcgi --with-pcre --with-http_flv_module \</span><br><span class=line>&gt;  --add-module=/usr/src/nginx-sticky-module \</span><br><span class=line>&gt;  --add-module=/usr/src/ngx_cache_purge-2.3</span><br><span class=line>[root@nginx nginx-1.14.0]<span class=comment># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><p>注：nginx 的所有模块必须在编译的时候添加，不能再运行的时候动态加载</p><p>相关参数解释：</p><p>–with-http-stub-status-module：</p><blockquote><p>通过网页监控nginx的状态</p></blockquote><p>–with-http-realip-module：</p><blockquote><p>获取客户端的真实IP地址</p></blockquote><p>–with-http-ssl module：</p><blockquote><p>开启nginx的加密传输功能</p></blockquote><p>–with-httpgzipstaticmodule：</p><blockquote><p>开启压缩功能</p></blockquote><p>–http-client-body-temp-path=/var/tmp/nginx/client：</p><blockquote><p>客户端访问数据临吁存放路径</p></blockquote><p>–with-pcre：</p><blockquote><p>支持正则匹配表达式</p></blockquote><p>–add-module=/usr/src/ngx_cache_purge-2.3：</p><blockquote><p>添加nginx的第三方模块语法为—add-module=第三方模块路径</p></blockquote><p>–with-http flv module：</p><blockquote><p>支持flv视频流</p></blockquote><h5 id=2、优化-nginx-程序的执行路径><a class=header-anchor href=#2、优化-nginx-程序的执行路径>¶</a>2、优化 nginx 程序的执行路径</h5><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@nginx nginx-1.14.0]<span class=comment># ln -s /usr/local/nginx1.14/sbin/nginx /usr/local/sbin/</span></span><br><span class=line>[root@nginx nginx-1.14.0]<span class=comment># nginx -t</span></span><br><span class=line>nginx: the configuration file /usr/<span class=built_in>local</span>/nginx1.14/conf/nginx.conf syntax is ok</span><br><span class=line>nginx: [emerg] mkdir() <span class=string>"/var/tmp/nginx/client"</span> failed (2: No such file or directory)</span><br><span class=line>nginx: configuration file /usr/<span class=built_in>local</span>/nginx1.14/conf/nginx.conf <span class=built_in>test</span> failed</span><br></pre></td></tr></table></figure><p>这里会报错，根据提示创建相应的目录即可</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@nginx nginx-1.14.0]<span class=comment># mkdir -p /var/tmp/nginx/client</span></span><br><span class=line>[root@nginx nginx-1.14.0]<span class=comment># chown -R nginx:nginx /var/tmp/nginx/</span></span><br><span class=line>[root@nginx nginx-1.14.0]<span class=comment># nginx -t</span></span><br><span class=line>nginx: the configuration file /usr/<span class=built_in>local</span>/nginx1.14/conf/nginx.conf syntax is ok</span><br><span class=line>nginx: configuration file /usr/<span class=built_in>local</span>/nginx1.14/conf/nginx.conf <span class=built_in>test</span> is successful</span><br></pre></td></tr></table></figure><h5 id=3、编写nginx服务脚本><a class=header-anchor href=#3、编写nginx服务脚本>¶</a>3、编写nginx服务脚本</h5><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># cat /etc/init.d/nginx </span></span><br><span class=line><span class=meta>#!/bin/bash </span></span><br><span class=line><span class=comment># chkconfig: 2345 99 20 </span></span><br><span class=line><span class=comment># description: Nginx Service Control Script </span></span><br><span class=line>PROG=<span class=string>"/usr/local/nginx1.14/sbin/nginx"</span></span><br><span class=line>PIDF=<span class=string>"/usr/local/nginx-1.14/logs/nginx.pid"</span></span><br><span class=line><span class=keyword>case</span> <span class=string>"<span class=variable>$1</span>"</span> <span class=keyword>in</span></span><br><span class=line>  start)</span><br><span class=line>   netstat -anplt |grep <span class=string>":80"</span> &amp;&gt; /dev/null &amp;&amp; pgrep <span class=string>"nginx"</span> &amp;&gt; /dev/null</span><br><span class=line>   <span class=keyword>if</span> [ $? -eq 0 ]</span><br><span class=line>   <span class=keyword>then</span></span><br><span class=line>     <span class=built_in>echo</span> <span class=string>"Nginx service already running."</span> </span><br><span class=line>   <span class=keyword>else</span></span><br><span class=line>     <span class=variable>$PROG</span> -t &amp;&gt; /dev/null</span><br><span class=line>     <span class=keyword>if</span> [ $? -eq 0 ] ; <span class=keyword>then</span></span><br><span class=line>       <span class=variable>$PROG</span></span><br><span class=line>       <span class=built_in>echo</span> <span class=string>"Nginx service start success."</span></span><br><span class=line>     <span class=keyword>else</span></span><br><span class=line>     <span class=variable>$PROG</span> -t</span><br><span class=line>     <span class=keyword>fi</span></span><br><span class=line>   <span class=keyword>fi</span></span><br><span class=line>   ;;</span><br><span class=line>  stop)</span><br><span class=line>   netstat -anplt |grep <span class=string>":80"</span> &amp;&gt; /dev/null &amp;&amp; pgrep <span class=string>"nginx"</span> &amp;&gt; /dev/nul</span><br><span class=line>   <span class=keyword>if</span> [ $? -eq 0 ]</span><br><span class=line>   <span class=keyword>then</span></span><br><span class=line>    <span class=built_in>kill</span> -s QUIT $(cat <span class=variable>$PIDF</span>)</span><br><span class=line>    <span class=built_in>echo</span> <span class=string>"Nginx service stop success."</span></span><br><span class=line>   <span class=keyword>else</span></span><br><span class=line>    <span class=built_in>echo</span> <span class=string>"Nginx service already stop"</span></span><br><span class=line>   <span class=keyword>fi</span></span><br><span class=line>   ;;</span><br><span class=line>  restart)</span><br><span class=line>    <span class=variable>$0</span> stop</span><br><span class=line>    <span class=variable>$0</span> start</span><br><span class=line>    ;;</span><br><span class=line>  status)</span><br><span class=line>   netstat -anplt |grep <span class=string>":80"</span> &amp;&gt; /dev/null &amp;&amp; pgrep <span class=string>"nginx"</span> &amp;&gt; /dev/null</span><br><span class=line>   <span class=keyword>if</span> [ $? -eq 0</span><br><span class=line>   <span class=keyword>then</span></span><br><span class=line>     <span class=built_in>echo</span> <span class=string>"Nginx service is running."</span></span><br><span class=line>   <span class=keyword>else</span></span><br><span class=line>     <span class=built_in>echo</span> <span class=string>"Nginx is stop."</span></span><br><span class=line>   <span class=keyword>fi</span></span><br><span class=line>  ;;</span><br><span class=line>  reload)</span><br><span class=line>   netstat -anplt |grep <span class=string>":80"</span> &amp;&gt; /dev/null &amp;&amp; pgrep <span class=string>"nginx"</span> &amp;&gt; /dev/nul</span><br><span class=line>   <span class=keyword>if</span> [ $? -eq 0 ]</span><br><span class=line>   <span class=keyword>then</span></span><br><span class=line>    <span class=variable>$PROG</span> -t &amp;&gt; /dev/null</span><br><span class=line>    <span class=keyword>if</span> [ $? -eq 0 ] ; <span class=keyword>then</span></span><br><span class=line>      <span class=built_in>kill</span> -s HUP $(cat <span class=variable>$PIDF</span>)</span><br><span class=line>      <span class=built_in>echo</span> <span class=string>"reload Nginx config success."</span></span><br><span class=line>    <span class=keyword>else</span></span><br><span class=line>      <span class=variable>$PROG</span> -t</span><br><span class=line>    <span class=keyword>fi</span></span><br><span class=line>   <span class=keyword>else</span></span><br><span class=line>    <span class=built_in>echo</span> <span class=string>"Nginx service is not run."</span></span><br><span class=line>   <span class=keyword>fi</span></span><br><span class=line>    ;;</span><br><span class=line>  *)</span><br><span class=line>   <span class=built_in>echo</span> <span class=string>"Usage: <span class=variable>$0</span> &#123;start|stop|restart|reload&#125;"</span></span><br><span class=line>   <span class=built_in>exit</span> 1</span><br><span class=line><span class=keyword>esac</span></span><br></pre></td></tr></table></figure><p>测试脚本是否能用：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># chmod +x /etc/init.d/nginx </span></span><br><span class=line>[root@nginx ~]<span class=comment># chkconfig --add nginx</span></span><br><span class=line>[root@nginx ~]<span class=comment># chkconfig nginx on</span></span><br><span class=line>[root@nginx ~]<span class=comment># /etc/init.d/nginx start</span></span><br><span class=line>Nginx service start success.</span><br><span class=line>[root@nginx ~]<span class=comment># netstat -anput | grep 80</span></span><br><span class=line>tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      6162/nginx: master</span><br></pre></td></tr></table></figure><p>注：如果你想在已安装好的 nginx 上添加第三方模块，依然需要重新编译，但为了不覆盖你原有的配置，请不要 make install，而是直接拷贝可执行文件：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>[root@localhost nginx-1.14.0]<span class=comment>#./configure --add-module=……  #你的第三方模块</span></span><br><span class=line></span><br><span class=line>[root@localhost nginx-1.14.0]<span class=comment># make 后不要 make install,改为手动拷贝，先备份</span></span><br><span class=line></span><br><span class=line>[root@localhost nginx-1.14.0]<span class=comment># cp /usr/local/nginx-1.14/sbin/nginx /usr/local/nginx-1.14/sbin/nginx.bak</span></span><br><span class=line></span><br><span class=line>[root@localhost nginx-1.14.0]<span class=comment># cp objs/nginx /usr/local/nginx-1.14/sbin/nginx</span></span><br></pre></td></tr></table></figure><h4 id=四、开启nginx网页界面认证><a class=header-anchor href=#四、开启nginx网页界面认证>¶</a>四、开启nginx网页界面认证</h4><h5 id=1、安装httpd-tools软件包><a class=header-anchor href=#1、安装httpd-tools软件包>¶</a>1、安装httpd-tools软件包</h5><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># yum -y install httpd-tools</span></span><br></pre></td></tr></table></figure><h5 id=2、使用htppasswd命令生成账号密码><a class=header-anchor href=#2、使用htppasswd命令生成账号密码>¶</a>2、使用htppasswd命令生成账号密码</h5><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># /usr/bin/htpasswd -c /usr/local/nginx1.14/nginx.passwd admin</span></span><br><span class=line>New password: </span><br><span class=line>Re-type new password: </span><br><span class=line>Adding password <span class=keyword>for</span> user admin</span><br></pre></td></tr></table></figure><h5 id=3、添加配置文件：><a class=header-anchor href=#3、添加配置文件：>¶</a>3、添加配置文件：</h5><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># vim /usr/local/nginx1.14/conf/nginx.conf</span></span><br><span class=line>        location /auth &#123;</span><br><span class=line>            root   html;</span><br><span class=line>            index  index.html index.htm;</span><br><span class=line>            auth_basic  <span class=string>"提示语句"</span>;</span><br><span class=line>            auth_basic_user_file  /usr/<span class=built_in>local</span>/nginx1.14/nginx.passwd;</span><br><span class=line>        &#125;</span><br></pre></td></tr></table></figure><h5 id=4、创建文件夹及网页><a class=header-anchor href=#4、创建文件夹及网页>¶</a>4、创建文件夹及网页</h5><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># mkdir /usr/local/nginx1.14/auth</span></span><br><span class=line>[root@nginx ~]<span class=comment># cat /usr/local/nginx1.14/auth/index.html</span></span><br><span class=line>This is a <span class=built_in>test</span> file!</span><br></pre></td></tr></table></figure><h5 id=5、重载nginx，访问测试><a class=header-anchor href=#5、重载nginx，访问测试>¶</a>5、重载nginx，访问测试</h5><p>[root@nginx ~]# nginx -s reload<br><img data-src="https://img-blog.csdnimg.cn/20200611132323290.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><br>输入用户名密码就可以访问了</p><h4 id=五、配置-nginx-反向代理：反向代理-负载均衡-健康探测><a class=header-anchor href=#五、配置-nginx-反向代理：反向代理-负载均衡-健康探测>¶</a>五、配置 nginx 反向代理：反向代理+负载均衡+健康探测</h4><p>查看 nginx 加载的模块</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># nginx -V</span></span><br><span class=line>nginx version: nginx/1.14.0</span><br><span class=line>built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) </span><br><span class=line>built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class=line>TLS SNI support enabled</span><br><span class=line>configure arguments: --prefix=/usr/<span class=built_in>local</span>/nginx1.14 --user=nginx --group=nginx --with-http_stub_status_module --with-http_realip_module --with-http_ssl_module --with-http_gzip_static_module --http-client-body-temp-path=/var/tmp/nginx/client --http-proxy-temp-path=/var/tmp/nginx/proxy --http-fastcgi-temp-path=/var/tmp/nginx/fcgi --with-pcre --with-http_flv_module --add-module=/usr/src/nginx-sticky-module --add-module=/usr/src/ngx_cache_purge-2.3</span><br></pre></td></tr></table></figure><p>nginx 的所有模块必须在编译的时候添加，不能再运行的时候动态加载</p><h5 id=1、nginx-sticky-module-模块：><a class=header-anchor href=#1、nginx-sticky-module-模块：>¶</a>1、nginx-sticky-module 模块：</h5><blockquote><p>这个模块的作用是通过 cookie 黏贴的方式将来自同一个客户端（浏览器）的请求发送到同一个后端服务器上处理，这样一定程度上可以解决多个 backend servers 的 session 同步的问题 —— 因为不再需要同步，而 RR 轮询模式必须要运维人员自己考虑 session 同步的实现另外内置的 ip_hash 也可以实现根据客户端 IP 来分发请求，但它很容易造成负载不均衡的情况，而如果 nginx 前面有 CDN 网络或者来自同一局域网的访问，它接收的客户端 IP 是一样的，容易造成负载不均衡现象。nginx-sticky-module 的 cookie 过期时间，默认浏览器关闭就过期</p><p>这个模块并不合适不支持 Cookie 或手动禁用了 cookie 的浏览器，此时默认 sticky 就会切换成 RR。它不能与 ip_hash 同时使用</p></blockquote><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>upstream backend &#123;</span><br><span class=line>        server 192.168.31.141:80 weight=1;</span><br><span class=line>	        server 192.168.31.250:80 weight=1;</span><br><span class=line>        sticky;</span><br><span class=line>	&#125;</span><br></pre></td></tr></table></figure><p>配置起来超级简单，一般来说一个 sticky 指令就够了</p><p>相关信息可以查看<a href=https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng target=_blank rel=noopener>官方文档</a></p><h5 id=2、load-balance-其它调度方案：><a class=header-anchor href=#2、load-balance-其它调度方案：>¶</a>2、load-balance 其它调度方案：</h5><p>这里顺带介绍一下 nginx 的负载均衡模块支持的其它调度算法：</p><p>轮询（默认）：</p><blockquote><p>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端某台服务器宕机，故障系统被自动剔除，使用户访问不受影响。Weight 指定轮询权值，Weight 值越大，分配到的访问机率越高，主要用于后端每个服务器性能不均的情况下</p></blockquote><p>ip_hash ：</p><blockquote><p>每个请求按访问 IP 的 hash 结果分配，这样来自同一个 IP 的访客固定访问一个后端服务器，有效解决了动态网页存在的 session 共享问题。当然如果这个节点不可用了，会发到下个节点，而此时没有 session 同步的话就注销掉了</p></blockquote><p>least_conn ：</p><blockquote><p>请求被发送到当前活跃连接最少的 realserver 上。会考虑 weight 的值</p></blockquote><p>url_hash：</p><blockquote><p>此方法按访问 url 的 hash 结果来分配请求，使每个 url 定向到同一个后端服务器，可以进一步提高后端缓存服务器的效率。Nginx 本身是不支持 url_hash 的，如果需要使用这种调度算法，必须安装 Nginx 的 hash 软件包 nginx_upstream_hash</p></blockquote><p>fair：</p><blockquote><p>这是比上面两个更加智能的负载均衡算法。此种算法可以依据页面大小和加载时间长短智能地进行负载均衡，也就是根据后端服务器的响应时间来分配请求，响应时间短的优先分配。Nginx 本身是不支持 fair 的，如果需要使用这种调度算法，必须下载 Nginx 的upstream_fair 模块</p></blockquote><h5 id=3、负载均衡与健康检查：><a class=header-anchor href=#3、负载均衡与健康检查：>¶</a>3、负载均衡与健康检查：</h5><p>严格来说，nginx 自带是没有针对负载均衡后端节点的健康检查的，但是可以通过默认自带的 ngx_http_proxy_module 模块和 ngx_http_upstream_module 模块中的相关指令来完成当后端节点出现故障时，自动切换到下一个节点来提供访问</p><p>修改配置文件：（vim /usr/local/nginx-1.14/conf/nginx.config）</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre></td><td class=code><pre><span class=line><span class=comment># http模块下添加</span></span><br><span class=line>upstream backend &#123;</span><br><span class=line>        server 192.168.1.30:80 max_fails=2 fail_timeout=10s;</span><br><span class=line>        server 192.168.1.40:80 max_fails=2 fail_timeout=10s;</span><br><span class=line>        sticky;</span><br><span class=line>&#125;</span><br><span class=line><span class=comment># location模块添加</span></span><br><span class=line>        location / &#123;</span><br><span class=line>            root   html;</span><br><span class=line>            index  index.html index.htm;</span><br><span class=line>            proxy_pass http://backend;</span><br><span class=line>        &#125;</span><br><span class=line>[root@nginx ~]<span class=comment># nginx -s reload</span></span><br><span class=line>[root@nginx ~]<span class=comment># curl 127.0.0.1</span></span><br><span class=line>apache1</span><br><span class=line>[root@nginx ~]<span class=comment># curl 127.0.0.1</span></span><br><span class=line>apache2</span><br><span class=line><span class=comment># 访问nginx服务器，nginx就代理了后端两台apache服务，并进行轮询</span></span><br></pre></td></tr></table></figure><p>weight ：</p><blockquote><p>轮询权值也是可以用在 ip_hash 的，默认值为 1</p></blockquote><p>max_fails ：</p><blockquote><p>允许请求失败的次数，默认为 1。当超过最大次数时，返回proxy_next_upstream 模块定义的错误</p></blockquote><p>fail_timeout ：</p><blockquote><p>有两层含义，一是在 10s 时间内最多容许 2 次失败；二是在经历了 2 次 失败以后，10s 时间内不分配请求到这台服务器</p></blockquote><h5 id=4、nginx的proxy缓存的使用><a class=header-anchor href=#4、nginx的proxy缓存的使用>¶</a>4、nginx的proxy缓存的使用</h5><p>缓存也就是将 js、css、image 等静态文件从后端服务器缓存到 nginx 指定的缓存目录下，既可以减轻后端服务器负担，也可以加快访问速度，但这样缓存及时清理成为了一个问题，所以需要 ngx_cache_purge 这个模块来在过期时间未到之前，手动清理缓存</p><p>proxy 模块中常用的指令是 proxy_pass 和 proxy_cache</p><p>nginx 的 web 缓存功能的主要是由 proxy_cache、fastcgi_cache 指令集和相关指令集完成， proxy_cache 指令负责反向代理缓存后端服务器的静态内容，fastcgi_cache 主要用来处理 FastCGI 动态进程缓存</p><p>在配置文件中添加修改：注：在添加文件前请查看文件中是否有，如果没有再添加</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br></pre></td><td class=code><pre><span class=line>    log_format  main  <span class=string>'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class=line>                      <span class=string>'$status $body_bytes_sent "$http_referer" '</span></span><br><span class=line>                      <span class=string>'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class=line></span><br><span class=line>    access_log  logs/access.log  main;</span><br><span class=line>    proxy_buffering on;</span><br><span class=line>    proxy_temp_path /usr/<span class=built_in>local</span>/nginx1.14/proxy_temp;</span><br><span class=line>    proxy_cache_path /usr/<span class=built_in>local</span>/nginx1.14/proxy_cache levels=1:2 keys_zone=my-cache:100m inactive=600m max_size=2g;</span><br><span class=line>    </span><br><span class=line>        location ~/purge(/.*) &#123;</span><br><span class=line>            allow 127.0.0.1;</span><br><span class=line>            allow 192.168.1.0/24;</span><br><span class=line>            deny all;</span><br><span class=line>            proxy_cache_purge my-cache <span class=variable>$host</span><span class=variable>$1</span><span class=variable>$is_args</span><span class=variable>$args</span>;</span><br><span class=line>        &#125;</span><br><span class=line>    </span><br><span class=line>        location / &#123;</span><br><span class=line>            root   html;</span><br><span class=line>            index  index.html index.htm;</span><br><span class=line>            proxy_pass http://backend;</span><br><span class=line>            proxy_redirect off;</span><br><span class=line>            proxy_set_header Host <span class=variable>$host</span>;</span><br><span class=line>            proxy_set_header X-Real-IP <span class=variable>$remote_addr</span>;</span><br><span class=line>            proxy_set_header X-Forwarded-For <span class=variable>$proxy_add_x_forwarded_for</span>;</span><br><span class=line>            proxy_next_upstream error timeout invalid_header http_500 http_502 http_504;</span><br><span class=line>            proxy_cache my-cache;</span><br><span class=line>            add_header Nginx-Cache <span class=variable>$upstream_cache_status</span>;</span><br><span class=line>            proxy_cache_valid 200 304 301 302 8h;</span><br><span class=line>            proxy_cache_valid 404 1m;</span><br><span class=line>            proxy_cache_valid any 1d;</span><br><span class=line>            proxy_cache_key <span class=variable>$host</span><span class=variable>$uri</span><span class=variable>$is_args</span><span class=variable>$args</span>;</span><br><span class=line>        &#125;</span><br><span class=line>[root@nginx ~]<span class=comment># nginx -s reload</span></span><br></pre></td></tr></table></figure><p>相关选项说明：</p><p>proxy_buffering on：</p><blockquote><p>代理的时候，开启或关闭缓冲后端服务器的响应</p><p>当开启缓冲时，nginx 尽可能快地从被代理的服务器接收响应，再将它存入缓冲区中</p></blockquote><p>proxy_temp_path：</p><blockquote><p>缓存临时目录。后端的响应并不直接返回客户端，而是先写到一个临 时文件中，然后被 rename 一下当做缓存放在 proxy_cache_path 。0.8.9 版本以后允许 temp 和 cache 两个目录在不同文件系统上（分区），然而为了减少性能损失还是建议把它们设成 一个文件系统上</p></blockquote><p>proxy_cache_path：</p><blockquote><p>设置缓存目录，目录里的文件名是 cache_key 的 MD5 值。 levels=1:2 keys_zone=my-cache:50m 表示采用 2 级目录结构，第一层目录只有一个字符，是 由levels=1:2设置，总共二层目录，子目录名字由二个字符组成。Web缓存区名称为my-cache， 内存缓存空间大小为 100MB，这个缓冲 zone 可以被多次使用。文件系统上看到的缓存文件 名类似于 /usr/local/nginx1.14/proxy_cache/c/29/b7f54b2df7773722d382f4809d65029c 。 inactive=600 max_size=2g 表示 600 分钟没有被访问的内容自动清除，硬盘最大缓存空间为 2GB，超过这个大学将清除最近最少使用的数据</p></blockquote><p>proxy_cache：</p><blockquote><p>用前面定义的缓存区 my-cache</p></blockquote><p>proxy_cache_key：</p><blockquote><p>定义如何生成缓存的键，设置 web 缓存的 key 值，nginx 根据 key 值 md5 哈希存储缓存</p></blockquote><p>proxy_cache_valid：</p><blockquote><p>为不同的响应状态码设置不同的缓存时间，比如 200、302 等正常结果 可以缓存的时间长点，而 404、500 等缓存时间设置短一些，这个时间到了文件就会过期， 而不论是否刚被访问过</p></blockquote><p>add_header：</p><blockquote><p>指令来设置 response header, 语法: add_header name value;</p></blockquote><p>$upstream_cache_status：</p><blockquote><p>这个变量来显示缓存的状态，我们可以在配置中添加一个 http 头来显示这一状态</p></blockquote><p>$upstream_cache_status 包含以下几种状态：</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line>MISS 未命中，请求被传送到后端</span><br><span class=line></span><br><span class=line>HIT 缓存命中</span><br><span class=line></span><br><span class=line>EXPIRED 缓存已经过期请求被传送到后端 </span><br><span class=line></span><br><span class=line>UPDATING 正在更新缓存，将使用旧的应答 </span><br><span class=line></span><br><span class=line>STALE 后端将得到过期的应答</span><br></pre></td></tr></table></figure><p>expires：</p><blockquote><p>在响应头里设置 Expires:或 Cache-Control:max-age，返回给客户端的浏览器缓存失 效时间</p></blockquote><h5 id=5、访问测试><a class=header-anchor href=#5、访问测试>¶</a>5、访问测试<img data-src="https://img-blog.csdnimg.cn/20200611132524563.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></h5><p>查看这个文件，里面就有了缓存文件</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># ll /usr/local/nginx1.14/proxy_cache/d/a0/</span></span><br><span class=line>总用量 4</span><br><span class=line>-rw-------. 1 nginx nginx 622 6月  11 11:22 d5bd6fad23957bb6e6023525d18aba0d</span><br></pre></td></tr></table></figure><p>如果在缓存时间之内需要更新被缓存的静态文件怎么办呢，这时候就需要手动来清除缓存了</p><p>浏览器访问 192.168.1.20/purge/来清除缓存</p><p>备注：</p><ul><li>purge 是 ngx_cache_pure 模块指令</li><li>index.html是要清除的缓存文件 URL 路径<br><img data-src="https://img-blog.csdnimg.cn/20200611132430847.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></li></ul><p>缓存数据已经没有了</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># ll /usr/local/nginx1.14/proxy_cache/d/a0/</span></span><br><span class=line>总用量 0</span><br></pre></td></tr></table></figure><h4 id=六、开启gzip压缩输出，减少网络传输><a class=header-anchor href=#六、开启gzip压缩输出，减少网络传输>¶</a>六、开启gzip压缩输出，减少网络传输</h4><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line>    <span class=comment>#keepalive_timeout  0;</span></span><br><span class=line>    keepalive_timeout  65;</span><br><span class=line></span><br><span class=line>    gzip  on;</span><br><span class=line>    gzip_comp_level 6;</span><br><span class=line>    gzip_http_version 1.1;</span><br><span class=line>    gzip_proxied any;</span><br><span class=line>    gzip_min_length 1k;</span><br><span class=line>    gzip_buffers 16 8k;</span><br><span class=line>    gzip_types text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;</span><br><span class=line>     gzip_vary on;</span><br><span class=line>     client_max_body_size   10m;</span><br><span class=line>     client_body_buffer_size   128k;</span><br><span class=line>     proxy_connect_timeout   75;</span><br><span class=line>     proxy_send_timeout   75;</span><br><span class=line>     proxy_read_timeout   75;</span><br><span class=line>     proxy_buffer_size   4k;</span><br><span class=line>     proxy_buffers   4 32k;</span><br><span class=line>     proxy_busy_buffers_size   64k;</span><br><span class=line>     proxy_temp_file_write_size  64k;</span><br><span class=line>[root@nginx ~]<span class=comment># nginx -s reload</span></span><br></pre></td></tr></table></figure><p>相关解释：</p><p>proxy_busy_buffers_size 64k：</p><blockquote><p>高负荷下缓冲大小（默认大小是 proxy_buffers 指令设置单块缓冲大小的 2 倍）</p></blockquote><p>proxy_temp_file_write_size 64k ：</p><blockquote><p>当缓存被代理的服务器响应到临时文件时，这个选项限制每次写临时文件的大小</p></blockquote><p>gzip on :</p><blockquote><p>开启 gzip 压缩输出，减少网络传输</p></blockquote><p>gzip_min_length 1k：</p><blockquote><p>置允许压缩的页面最小字节数，页面字节数从 header 头得 content-length 中进行获取。建议设置成大于 1k 的字节数，小于 1k 可能会越压越大</p></blockquote><p>gzip_buffers 16 8k：</p><blockquote><p>设置系统获取几个单位的缓存用于存储 gzip 的压缩结果数据流。16 8k 代表以8k 为单位，按照原始数据大小以 8k 为单位的16倍申请内存。如果没有设置，默认值是申请跟原始数据相同大小的内存空间去存储 gzip 压缩结果</p></blockquote><p>gzip_http_version 1.1：</p><blockquote><p>用于识别 http 协议的版本，早期的浏览器不支持 Gzip 压缩，用户 就会看到乱码，所以为了支持前期版本加上了这个选项，如果你用了 Nginx 的反向代理并 期望也 启用 Gzip 压缩的话，由于末端通信是 http/1.1，故请设置为 1.1</p></blockquote><p>gzip_comp_level 6：</p><blockquote><p>gzip 压缩比，1 压缩比最小处理速度最快，9 压缩比最大但处理速度最 慢(传输快但比较消耗 cpu)</p></blockquote><p>gzip_types：</p><blockquote><p>匹配 mime 类型进行压缩，无论是否指定”text/html”类型总是会被压缩的。 默认值: gzip_types text/html (默认不对 js/css 文件进行压缩)</p></blockquote><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>压缩类型，匹配 MIME 类型进行压缩</span><br><span class=line></span><br><span class=line>不能用通配符 text&#x2F;*</span><br><span class=line></span><br><span class=line>(无论是否指定)text&#x2F;html 默认已经压缩 </span><br><span class=line></span><br><span class=line>设置哪压缩种文本文件可参考 conf&#x2F;mime.types</span><br></pre></td></tr></table></figure><p>gzip_proxied any：</p><blockquote><p>Nginx 作为反向代理的时候启用，根据某些请求和应答来决定是否在对 代理请求的应答启用 gzip 压缩，是否压缩取决于请求头中的“Via”字段，指令中可以同时指 定多个不同的参数</p></blockquote><p>意义如下：</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre></td><td class=code><pre><span class=line>off – 关闭所有的代理结果数据的压缩</span><br><span class=line></span><br><span class=line>expired – 启用压缩，如果 header 头中包含 “Expires” 头信息</span><br><span class=line></span><br><span class=line>no-cache – 启用压缩，如果 header 头中包含 “Cache-Control:no-cache” 头信息</span><br><span class=line></span><br><span class=line>no-store – 启用压缩，如果 header 头中包含 “Cache-Control:no-store” 头信息</span><br><span class=line></span><br><span class=line>private – 启用压缩，如果 header 头中包含 “Cache-Control:private” 头信息</span><br><span class=line></span><br><span class=line>no_last_modified – 启用压缩,如果 header 头中不包含 “Last-Modified” 头信息</span><br><span class=line></span><br><span class=line>no_etag – 启用压缩 ,如果 header 头中不包含 “ETag” 头信息</span><br><span class=line></span><br><span class=line>auth – 启用压缩 , 如果 header 头中包含 “Authorization” 头信息</span><br><span class=line></span><br><span class=line>any – 无条件启用压缩</span><br></pre></td></tr></table></figure><p>gzip_vary on：</p><blockquote><p>和 http 头有关系，加个 vary 头，给代理服务器用的，有的浏览器支持压缩，</p><p>有的不支持，所以避免浪费不支持的也压缩，所以根据客户端的 HTTP 头来判断，是否需要压缩</p></blockquote><p>将httpd服务的网页制造大点，访问测试：<br><img data-src="https://img-blog.csdnimg.cn/20200611132603607.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><h4 id=七、开启br压缩><a class=header-anchor href=#七、开启br压缩>¶</a>七、开启br压缩</h4><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># tar zxf ngx_brotli.tar.gz -C /usr/src/</span></span><br><span class=line>[root@nginx ~]<span class=comment># cd /usr/src/nginx-1.14.0/</span></span><br></pre></td></tr></table></figure><h5 id=1、使用nginx-V查看编译时的信息><a class=header-anchor href=#1、使用nginx-V查看编译时的信息>¶</a>1、使用nginx -V查看编译时的信息</h5><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>[root@nginx nginx-1.14.0]<span class=comment># nginx -V</span></span><br><span class=line>nginx version: nginx/1.14.0</span><br><span class=line>built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) </span><br><span class=line>built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class=line>TLS SNI support enabled</span><br><span class=line>configure arguments: --prefix=/usr/<span class=built_in>local</span>/nginx1.14 --user=nginx --group=nginx --with-http_stub_status_module --with-http_realip_module --with-http_ssl_module --with-http_gzip_static_module --http-client-body-temp-path=/var/tmp/nginx/client --http-proxy-temp-path=/var/tmp/nginx/proxy --http-fastcgi-temp-path=/var/tmp/nginx/fcgi --with-pcre --with-http_flv_module --add-module=/usr/src/nginx-sticky-module --add-module=/usr/src/ngx_cache_purge-2.3</span><br></pre></td></tr></table></figure><h5 id=2、进行编译><a class=header-anchor href=#2、进行编译>¶</a>2、进行编译</h5><p>最后加上<code>--add-module=/usr/src/ngx_brotli</code>即可</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@nginx nginx-1.14.0]<span class=comment># ./configure --prefix=/usr/local/nginx1.14 --user=nginx --group=nginx --with-http_stub_status_module --with-http_realip_module --with-http_ssl_module --with-http_gzip_static_module --http-client-body-temp-path=/var/tmp/nginx/client --http-proxy-temp-path=/var/tmp/nginx/proxy --http-fastcgi-temp-path=/var/tmp/nginx/fcgi --with-pcre --with-http_flv_module --add-module=/usr/src/nginx-sticky-module --add-module=/usr/src/ngx_cache_purge-2.3 --add-module=/usr/src/ngx_brotli</span></span><br><span class=line>[root@nginx nginx-1.14.0]<span class=comment># make # 不要make install</span></span><br></pre></td></tr></table></figure><h5 id=3、将新的nginx命令文件替换旧的><a class=header-anchor href=#3、将新的nginx命令文件替换旧的>¶</a>3、将新的nginx命令文件替换旧的</h5><p>替换前先做个备份</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@nginx nginx-1.14.0]<span class=comment># mv /usr/local/nginx1.14/sbin/nginx /usr/local/nginx1.14/sbin/nginx.bak</span></span><br><span class=line>[root@nginx nginx-1.14.0]<span class=comment># cp objs/nginx /usr/local/nginx1.14/sbin/</span></span><br></pre></td></tr></table></figure><h5 id=4、重启nginx><a class=header-anchor href=#4、重启nginx>¶</a>4、重启nginx</h5><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@nginx nginx-1.14.0]<span class=comment># nginx -s stop</span></span><br><span class=line>[root@nginx nginx-1.14.0]<span class=comment># nginx</span></span><br></pre></td></tr></table></figure><h5 id=5、添加配置文件内容><a class=header-anchor href=#5、添加配置文件内容>¶</a>5、添加配置文件内容</h5><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># vim /usr/local/nginx1.14/conf/nginx.conf</span></span><br><span class=line>    <span class=comment>#keepalive_timeout  0;</span></span><br><span class=line>    keepalive_timeout  65;</span><br><span class=line>    brotli on;</span><br><span class=line>    brotli_types text/plain text/css text/xml application/xml application/json ;</span><br><span class=line>    brotli_static off; </span><br><span class=line>    brotli_comp_level 11;</span><br><span class=line>    brotli_buffers 16 8k;</span><br><span class=line>    brotli_window 512k;</span><br><span class=line>    brotli_min_length 20;</span><br><span class=line>[root@nginx ~]<span class=comment># nginx -s reload</span></span><br></pre></td></tr></table></figure><p>相关参数解释：</p><p>brotli_static off;</p><blockquote><p>否允许查找预处理好的、以.br结尾的压缩 件,可inyon off always</p></blockquote><p>brotli_comp_level 11;</p><blockquote><p>压缩级别</p></blockquote><p>brotli_buffers 16 8k;</p><blockquote><p>读取缓冲区数量和大小</p></blockquote><p>brotli_window 512k;</p><blockquote><p>滑动窗口大小</p></blockquote><p>brotli_min_length 20;</p><blockquote><p>指定压缩数据的最小字节</p></blockquote><h5 id=6、访问测试><a class=header-anchor href=#6、访问测试>¶</a>6、访问测试</h5><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># curl -I -H "Accept-Encoding: gzip, deflate,br" 127.0.0.1</span></span><br><span class=line>HTTP/1.1 200 OK</span><br><span class=line>Server: nginx/1.14.0</span><br><span class=line>Date: Thu, 11 Jun 2020 04:01:16 GMT</span><br><span class=line>Content-Type: text/html; charset=UTF-8</span><br><span class=line>Connection: keep-alive</span><br><span class=line>Vary: Accept-Encoding</span><br><span class=line>Set-Cookie: route=617ff1b025324ae95a8a4e10c70854c9; Path=/</span><br><span class=line>Last-Modified: Thu, 11 Jun 2020 03:46:40 GMT</span><br><span class=line>ETag: W/<span class=string>"1cb0-5a7c6cef388ea"</span></span><br><span class=line>Nginx-Cache: MISS</span><br><span class=line>Content-Encoding: br</span><br></pre></td></tr></table></figure><h4 id=八、nginx完整配置文件><a class=header-anchor href=#八、nginx完整配置文件>¶</a>八、nginx完整配置文件</h4><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br><span class=line>119</span><br><span class=line>120</span><br><span class=line>121</span><br><span class=line>122</span><br><span class=line>123</span><br><span class=line>124</span><br><span class=line>125</span><br><span class=line>126</span><br><span class=line>127</span><br><span class=line>128</span><br><span class=line>129</span><br><span class=line>130</span><br><span class=line>131</span><br><span class=line>132</span><br><span class=line>133</span><br><span class=line>134</span><br><span class=line>135</span><br><span class=line>136</span><br><span class=line>137</span><br><span class=line>138</span><br><span class=line>139</span><br><span class=line>140</span><br><span class=line>141</span><br><span class=line>142</span><br><span class=line>143</span><br><span class=line>144</span><br><span class=line>145</span><br><span class=line>146</span><br><span class=line>147</span><br><span class=line>148</span><br><span class=line>149</span><br><span class=line>150</span><br><span class=line>151</span><br><span class=line>152</span><br><span class=line>153</span><br><span class=line>154</span><br><span class=line>155</span><br><span class=line>156</span><br><span class=line>157</span><br><span class=line>158</span><br><span class=line>159</span><br><span class=line>160</span><br><span class=line>161</span><br><span class=line>162</span><br><span class=line>163</span><br><span class=line>164</span><br><span class=line>165</span><br><span class=line>166</span><br><span class=line>167</span><br><span class=line>168</span><br><span class=line>169</span><br><span class=line>170</span><br><span class=line>171</span><br><span class=line>172</span><br><span class=line>173</span><br><span class=line>174</span><br><span class=line>175</span><br><span class=line>176</span><br><span class=line>177</span><br><span class=line>178</span><br><span class=line>179</span><br><span class=line>180</span><br><span class=line>181</span><br><span class=line>182</span><br><span class=line>183</span><br><span class=line>184</span><br><span class=line>185</span><br><span class=line>186</span><br><span class=line>187</span><br><span class=line>188</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># cat /usr/local/nginx1.14/conf/nginx.conf</span></span><br><span class=line></span><br><span class=line>user  nginx nginx;</span><br><span class=line>worker_processes  1;</span><br><span class=line></span><br><span class=line><span class=comment>#error_log  logs/error.log;</span></span><br><span class=line><span class=comment>#error_log  logs/error.log  notice;</span></span><br><span class=line><span class=comment>#error_log  logs/error.log  info;</span></span><br><span class=line></span><br><span class=line><span class=comment>#pid        logs/nginx.pid;</span></span><br><span class=line></span><br><span class=line></span><br><span class=line>events &#123;</span><br><span class=line>    worker_connections  1024;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line></span><br><span class=line>http &#123;</span><br><span class=line>    include       mime.types;</span><br><span class=line>    default_type  application/octet-stream;</span><br><span class=line></span><br><span class=line>upstream backend &#123;</span><br><span class=line>        server 192.168.1.30:80 max_fails=2 fail_timeout=10s;</span><br><span class=line>	server 192.168.1.40:80 max_fails=2 fail_timeout=10s;</span><br><span class=line>        sticky;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line>    log_format  main  <span class=string>'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class=line>                      <span class=string>'$status $body_bytes_sent "$http_referer" '</span></span><br><span class=line>                      <span class=string>'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class=line></span><br><span class=line>    access_log  logs/access.log  main;</span><br><span class=line>    proxy_buffering on;</span><br><span class=line>    proxy_temp_path /usr/<span class=built_in>local</span>/nginx1.14/proxy_temp;</span><br><span class=line>    proxy_cache_path /usr/<span class=built_in>local</span>/nginx1.14/proxy_cache levels=1:2 keys_zone=my-cache:100m inactive=600m max_size=2g;</span><br><span class=line></span><br><span class=line></span><br><span class=line></span><br><span class=line>    sendfile        on;</span><br><span class=line>    <span class=comment>#tcp_nopush     on;</span></span><br><span class=line></span><br><span class=line>    <span class=comment>#keepalive_timeout  0;</span></span><br><span class=line>    keepalive_timeout  65;</span><br><span class=line>    brotli on;</span><br><span class=line>    brotli_types text/plain text/css text/xml application/xml application/json ;</span><br><span class=line>    brotli_static off; </span><br><span class=line>    brotli_comp_level 11;</span><br><span class=line>    brotli_buffers 16 8k;</span><br><span class=line>    brotli_window 512k;</span><br><span class=line>    brotli_min_length 20;</span><br><span class=line></span><br><span class=line></span><br><span class=line>    gzip  on;</span><br><span class=line>    gzip_comp_level 6;</span><br><span class=line>    gzip_http_version 1.1;</span><br><span class=line>    gzip_proxied any;</span><br><span class=line>    gzip_min_length 1k;</span><br><span class=line>    gzip_buffers 16 8k;</span><br><span class=line>    gzip_types text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;</span><br><span class=line>     gzip_vary on;</span><br><span class=line>     client_max_body_size   10m;</span><br><span class=line>     client_body_buffer_size   128k;</span><br><span class=line>     proxy_connect_timeout   75;</span><br><span class=line>     proxy_send_timeout   75;</span><br><span class=line>     proxy_read_timeout   75;</span><br><span class=line>     proxy_buffer_size   4k;</span><br><span class=line>     proxy_buffers   4 32k;</span><br><span class=line>     proxy_busy_buffers_size   64k;</span><br><span class=line>     proxy_temp_file_write_size  64k;</span><br><span class=line>     <span class=comment>#proxy_buffering on;</span></span><br><span class=line>     <span class=comment>#proxy_temp_path /usr/local/nginx1.14/proxy_temp;</span></span><br><span class=line>     <span class=comment>#proxy_cache_path /usr/local/nginx1.14/proxy_cache levels=1:2 keys_zone=my-cache:100m inactive=600m max_size=2g;</span></span><br><span class=line></span><br><span class=line></span><br><span class=line>    server &#123;</span><br><span class=line>        listen       80;</span><br><span class=line>        server_name  localhost;</span><br><span class=line></span><br><span class=line>        <span class=comment>#charset koi8-r;</span></span><br><span class=line></span><br><span class=line>        <span class=comment>#access_log  logs/host.access.log  main;</span></span><br><span class=line>	location ~/purge(/.*) &#123;</span><br><span class=line>	    allow 127.0.0.1;</span><br><span class=line>	    allow 192.168.1.0/24;</span><br><span class=line>	    deny all;</span><br><span class=line>	    proxy_cache_purge my-cache <span class=variable>$host</span><span class=variable>$1</span><span class=variable>$is_args</span><span class=variable>$args</span>;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>        location / &#123;</span><br><span class=line>            root   html;</span><br><span class=line>            index  index.html index.htm;</span><br><span class=line>	    proxy_pass http://backend;</span><br><span class=line>	    proxy_redirect off;</span><br><span class=line>	    proxy_set_header Host <span class=variable>$host</span>;</span><br><span class=line>	    proxy_set_header X-Real-IP <span class=variable>$remote_addr</span>;</span><br><span class=line>	    proxy_set_header X-Forwarded-For <span class=variable>$proxy_add_x_forwarded_for</span>;</span><br><span class=line>	    proxy_next_upstream error timeout invalid_header http_500 http_502 http_504;</span><br><span class=line>	    proxy_cache my-cache;</span><br><span class=line>	    add_header Nginx-Cache <span class=variable>$upstream_cache_status</span>;</span><br><span class=line>	    proxy_cache_valid 200 304 301 302 8h;</span><br><span class=line>	    proxy_cache_valid 404 1m;</span><br><span class=line>	    proxy_cache_valid any 1d;</span><br><span class=line>	    proxy_cache_key <span class=variable>$host</span><span class=variable>$uri</span><span class=variable>$is_args</span><span class=variable>$args</span>;</span><br><span class=line>        &#125;</span><br><span class=line></span><br><span class=line>        location /index.html &#123;</span><br><span class=line>            root   html;</span><br><span class=line>            index  index.html index.htm;</span><br><span class=line>        &#125;</span><br><span class=line></span><br><span class=line>        location /auth &#123;</span><br><span class=line>            root   html;</span><br><span class=line>            index  index.html index.htm;</span><br><span class=line>	    auth_basic  <span class=string>"提示语句"</span>;</span><br><span class=line>	    auth_basic_user_file  /usr/<span class=built_in>local</span>/nginx1.14/nginx.passwd;</span><br><span class=line>        &#125;</span><br><span class=line>	</span><br><span class=line></span><br><span class=line>        <span class=comment>#error_page  404              /404.html;</span></span><br><span class=line></span><br><span class=line>        <span class=comment># redirect server error pages to the static page /50x.html</span></span><br><span class=line>        <span class=comment>#</span></span><br><span class=line>        error_page   500 502 503 504  /50x.html;</span><br><span class=line>        location = /50x.html &#123;</span><br><span class=line>            root   html;</span><br><span class=line>        &#125;</span><br><span class=line></span><br><span class=line>        <span class=comment># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class=line>        <span class=comment>#</span></span><br><span class=line>        <span class=comment>#location ~ \.php$ &#123;</span></span><br><span class=line>        <span class=comment>#    proxy_pass   http://127.0.0.1;</span></span><br><span class=line>        <span class=comment>#&#125;</span></span><br><span class=line></span><br><span class=line>        <span class=comment># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class=line>        <span class=comment>#</span></span><br><span class=line>        <span class=comment>#location ~ \.php$ &#123;</span></span><br><span class=line>        <span class=comment>#    root           html;</span></span><br><span class=line>        <span class=comment>#    fastcgi_pass   127.0.0.1:9000;</span></span><br><span class=line>        <span class=comment>#    fastcgi_index  index.php;</span></span><br><span class=line>        <span class=comment>#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></span><br><span class=line>        <span class=comment>#    include        fastcgi_params;</span></span><br><span class=line>        <span class=comment>#&#125;</span></span><br><span class=line></span><br><span class=line>        <span class=comment># deny access to .htaccess files, if Apache's document root</span></span><br><span class=line>        <span class=comment># concurs with nginx's one</span></span><br><span class=line>        <span class=comment>#</span></span><br><span class=line>        <span class=comment>#location ~ /\.ht &#123;</span></span><br><span class=line>        <span class=comment>#    deny  all;</span></span><br><span class=line>        <span class=comment>#&#125;</span></span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line></span><br><span class=line>    <span class=comment># another virtual host using mix of IP-, name-, and port-based configuration</span></span><br><span class=line>    <span class=comment>#</span></span><br><span class=line>    <span class=comment>#server &#123;</span></span><br><span class=line>    <span class=comment>#    listen       8000;</span></span><br><span class=line>    <span class=comment>#    listen       somename:8080;</span></span><br><span class=line>    <span class=comment>#    server_name  somename  alias  another.alias;</span></span><br><span class=line></span><br><span class=line>    <span class=comment>#    location / &#123;</span></span><br><span class=line>    <span class=comment>#        root   html;</span></span><br><span class=line>    <span class=comment>#        index  index.html index.htm;</span></span><br><span class=line>    <span class=comment>#    &#125;</span></span><br><span class=line>    <span class=comment>#&#125;</span></span><br><span class=line></span><br><span class=line></span><br><span class=line>    <span class=comment># HTTPS server</span></span><br><span class=line>    <span class=comment>#</span></span><br><span class=line>    <span class=comment>#server &#123;</span></span><br><span class=line>    <span class=comment>#    listen       443 ssl;</span></span><br><span class=line>    <span class=comment>#    server_name  localhost;</span></span><br><span class=line></span><br><span class=line>    <span class=comment>#    ssl_certificate      cert.pem;</span></span><br><span class=line>    <span class=comment>#    ssl_certificate_key  cert.key;</span></span><br><span class=line></span><br><span class=line>    <span class=comment>#    ssl_session_cache    shared:SSL:1m;</span></span><br><span class=line>    <span class=comment>#    ssl_session_timeout  5m;</span></span><br><span class=line></span><br><span class=line>    <span class=comment>#    ssl_ciphers  HIGH:!aNULL:!MD5;</span></span><br><span class=line>    <span class=comment>#    ssl_prefer_server_ciphers  on;</span></span><br><span class=line></span><br><span class=line>    <span class=comment>#    location / &#123;</span></span><br><span class=line>    <span class=comment>#        root   html;</span></span><br><span class=line>    <span class=comment>#        index  index.html index.htm;</span></span><br><span class=line>    <span class=comment>#    &#125;</span></span><br><span class=line>    <span class=comment>#&#125;</span></span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h4 id=九、扩展知识><a class=header-anchor href=#九、扩展知识>¶</a>九、扩展知识</h4><p>nginx 修改版本等信息</p><h5 id=1、更改ngnix显示版本><a class=header-anchor href=#1、更改ngnix显示版本>¶</a>1、更改ngnix显示版本</h5><p>编译前编辑</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># vim /usr/src/nginx-1.14.0/src/core/nginx.h</span></span><br><span class=line><span class=comment>#define nginx_version</span></span><br><span class=line><span class=comment>#define NGINX_VERSION</span></span><br><span class=line><span class=comment>#define NGINX_VER</span></span><br><span class=line><span class=comment>#define NGINX_VAR</span></span><br></pre></td></tr></table></figure><p>修改上面的信息，即可更改 nginx 显示版本</p><h5 id=2、自定义信息><a class=header-anchor href=#2、自定义信息>¶</a>2、自定义信息</h5><p>编译前编辑</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># vim /usr/src/nginx-1.14.0/src/http/ngx_http_special_response.c</span></span><br><span class=line>static u_char ngx_http_error_full_tail[] =</span><br><span class=line>static u_char ngx_http_error_tail[] =</span><br><span class=line>[root@nginx ~]<span class=comment># vim /usr/src/nginx-1.14.0/src/http/ngx_http_header_filter_module.c</span></span><br><span class=line>static char ngx_http_server_string[]=</span><br></pre></td></tr></table></figure><p>修改上面的信息为你自己的</p><h5 id=3、修改nginx版本名称><a class=header-anchor href=#3、修改nginx版本名称>¶</a>3、修改nginx版本名称</h5><p>编译完成后修改<code>/usr/local/nginx1.14/conf/</code>目录下面</p><p><code>fastcgi.conf</code>、<code>fastcgi.conf.default</code>、<code>fastcgi_params</code>、<code>fastcgi_params.default</code>这四个文件里面的版本名称</p><p>查看 nginx 版本号</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>[root@nginx ~]<span class=comment># nginx -v</span></span><br></pre></td></tr></table></figure></div><div><ul class=post-copyright><li class=post-copyright-author><strong>本文作者：</strong>Maisy</li><li class=post-copyright-link><strong>本文链接：</strong> <a href=https://pdxblog.top/Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%84%E5%BB%BA.html title=Nginx反向代理缓存服务器构建>https://pdxblog.top/Nginx反向代理缓存服务器构建.html</a></li><li class=post-copyright-license><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel=noopener target=_blank><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class=post-footer><div class=post-tags><a href="/tags/%E6%9E%B6%E6%9E%84/" rel=tag># 架构</a></div><div class=post-nav><div class=post-nav-item><a href=/Apache%E4%B9%8BFCGI%E6%A8%A1%E5%BC%8F%E9%83%A8%E7%BD%B2LAMP.html rel=prev title=Apache之FCGI模式部署LAMP><i class="fa fa-chevron-left"></i> Apache之FCGI模式部署LAMP</a></div><div class=post-nav-item></div></div></footer></article></div><div class=comments id=valine-comments></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class=nav><li class="nav-item nav-level-3"><a class=nav-link href=#Nginx反向代理缓存服务器构建><span class=nav-number>1.</span> <span class=nav-text>¶Nginx反向代理缓存服务器构建</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#一、nginx-反向代理：Web-服务器的调度器><span class=nav-number>1.1.</span> <span class=nav-text>¶一、nginx 反向代理：Web 服务器的调度器</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#1、反向代理方式><span class=nav-number>1.1.1.</span> <span class=nav-text>¶1、反向代理方式</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#2、反向代理的作用><span class=nav-number>1.1.2.</span> <span class=nav-text>¶2、反向代理的作用</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#（1）保护网站安全：><span class=nav-number>1.1.2.1.</span> <span class=nav-text>¶（1）保护网站安全：</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（2）通过配置缓存功能加速-Web-请求：><span class=nav-number>1.1.2.2.</span> <span class=nav-text>¶（2）通过配置缓存功能加速 Web 请求：</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（3）实现负载均衡：><span class=nav-number>1.1.2.3.</span> <span class=nav-text>¶（3）实现负载均衡：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#二、什么是-nginx：><span class=nav-number>1.2.</span> <span class=nav-text>¶二、什么是 nginx：</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#1、nginx简介><span class=nav-number>1.2.1.</span> <span class=nav-text>¶1、nginx简介</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#2、Nginx-的应用现状：><span class=nav-number>1.2.2.</span> <span class=nav-text>¶2、Nginx 的应用现状：</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#3、Nginx-的核心特点：><span class=nav-number>1.2.3.</span> <span class=nav-text>¶3、Nginx 的核心特点：</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#（1）跨平台：><span class=nav-number>1.2.3.1.</span> <span class=nav-text>¶（1）跨平台：</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（2）配置异常简单：><span class=nav-number>1.2.3.2.</span> <span class=nav-text>¶（2）配置异常简单：</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（3）非阻塞、高并发连接：><span class=nav-number>1.2.3.3.</span> <span class=nav-text>¶（3）非阻塞、高并发连接：</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（4）事件驱动：><span class=nav-number>1.2.3.4.</span> <span class=nav-text>¶（4）事件驱动：</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（5）Master-Worker-结构：><span class=nav-number>1.2.3.5.</span> <span class=nav-text>¶（5）Master&#x2F;Worker 结构：</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（6）内存消耗小：><span class=nav-number>1.2.3.6.</span> <span class=nav-text>¶（6）内存消耗小：</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（7）内置的健康检查功能：><span class=nav-number>1.2.3.7.</span> <span class=nav-text>¶（7）内置的健康检查功能：</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（8）节省带宽：><span class=nav-number>1.2.3.8.</span> <span class=nav-text>¶（8）节省带宽：</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（9）稳定性高：><span class=nav-number>1.2.3.9.</span> <span class=nav-text>¶（9）稳定性高：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#三、Nginx-apache构筑-Web-服务器集群的负载均衡><span class=nav-number>1.3.</span> <span class=nav-text>¶三、Nginx+apache构筑 Web 服务器集群的负载均衡</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#1、安装nginx><span class=nav-number>1.3.1.</span> <span class=nav-text>¶1、安装nginx</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#（1）安装-zlib-devel、pcre-devel-等依赖包><span class=nav-number>1.3.1.1.</span> <span class=nav-text>¶（1）安装 zlib-devel、pcre-devel 等依赖包</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（2）安装nginx><span class=nav-number>1.3.1.2.</span> <span class=nav-text>¶（2）安装nginx</span></a></li></ol></li><li class="nav-item nav-level-5"><a class=nav-link href=#2、优化-nginx-程序的执行路径><span class=nav-number>1.3.2.</span> <span class=nav-text>¶2、优化 nginx 程序的执行路径</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#3、编写nginx服务脚本><span class=nav-number>1.3.3.</span> <span class=nav-text>¶3、编写nginx服务脚本</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#四、开启nginx网页界面认证><span class=nav-number>1.4.</span> <span class=nav-text>¶四、开启nginx网页界面认证</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#1、安装httpd-tools软件包><span class=nav-number>1.4.1.</span> <span class=nav-text>¶1、安装httpd-tools软件包</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#2、使用htppasswd命令生成账号密码><span class=nav-number>1.4.2.</span> <span class=nav-text>¶2、使用htppasswd命令生成账号密码</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#3、添加配置文件：><span class=nav-number>1.4.3.</span> <span class=nav-text>¶3、添加配置文件：</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#4、创建文件夹及网页><span class=nav-number>1.4.4.</span> <span class=nav-text>¶4、创建文件夹及网页</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#5、重载nginx，访问测试><span class=nav-number>1.4.5.</span> <span class=nav-text>¶5、重载nginx，访问测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#五、配置-nginx-反向代理：反向代理-负载均衡-健康探测><span class=nav-number>1.5.</span> <span class=nav-text>¶五、配置 nginx 反向代理：反向代理+负载均衡+健康探测</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#1、nginx-sticky-module-模块：><span class=nav-number>1.5.1.</span> <span class=nav-text>¶1、nginx-sticky-module 模块：</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#2、load-balance-其它调度方案：><span class=nav-number>1.5.2.</span> <span class=nav-text>¶2、load-balance 其它调度方案：</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#3、负载均衡与健康检查：><span class=nav-number>1.5.3.</span> <span class=nav-text>¶3、负载均衡与健康检查：</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#4、nginx的proxy缓存的使用><span class=nav-number>1.5.4.</span> <span class=nav-text>¶4、nginx的proxy缓存的使用</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#5、访问测试><span class=nav-number>1.5.5.</span> <span class=nav-text>¶5、访问测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#六、开启gzip压缩输出，减少网络传输><span class=nav-number>1.6.</span> <span class=nav-text>¶六、开启gzip压缩输出，减少网络传输</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#七、开启br压缩><span class=nav-number>1.7.</span> <span class=nav-text>¶七、开启br压缩</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#1、使用nginx-V查看编译时的信息><span class=nav-number>1.7.1.</span> <span class=nav-text>¶1、使用nginx -V查看编译时的信息</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#2、进行编译><span class=nav-number>1.7.2.</span> <span class=nav-text>¶2、进行编译</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#3、将新的nginx命令文件替换旧的><span class=nav-number>1.7.3.</span> <span class=nav-text>¶3、将新的nginx命令文件替换旧的</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#4、重启nginx><span class=nav-number>1.7.4.</span> <span class=nav-text>¶4、重启nginx</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#5、添加配置文件内容><span class=nav-number>1.7.5.</span> <span class=nav-text>¶5、添加配置文件内容</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#6、访问测试><span class=nav-number>1.7.6.</span> <span class=nav-text>¶6、访问测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#八、nginx完整配置文件><span class=nav-number>1.8.</span> <span class=nav-text>¶八、nginx完整配置文件</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#九、扩展知识><span class=nav-number>1.9.</span> <span class=nav-text>¶九、扩展知识</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#1、更改ngnix显示版本><span class=nav-number>1.9.1.</span> <span class=nav-text>¶1、更改ngnix显示版本</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#2、自定义信息><span class=nav-number>1.9.2.</span> <span class=nav-text>¶2、自定义信息</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#3、修改nginx版本名称><span class=nav-number>1.9.3.</span> <span class=nav-text>¶3、修改nginx版本名称</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Maisy src=/images/author.jpg><p class=site-author-name itemprop=name>Maisy</p><div class=site-description itemprop=description>人的一生就是一个储蓄的过程，在奋斗的时候储存了希望；在耕耘的时候储存了一粒种子；在旅行的时候储存了风景；在微笑的时候储存了快乐。聪明的人善于储蓄，在漫长而短暂的人生旅途中，学会储蓄每一个闪光的瞬间，然后用它们酿成一杯美好的回忆，在四季的变幻与交替之间，散发浓香，珍藏一生</div></div><div class="site-state-wrap motion-element"><nav class=site-state><div class="site-state-item site-state-posts"><a href="/archives/"><span class=site-state-item-count>58</span> <span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class=site-state-item-count>6</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class=site-state-item-count>6</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/Gilbert2/Gilbert2.github.io title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Gilbert2&#x2F;Gilbert2.github.io" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a></span> <span class=links-of-author-item><a href=https://blog.csdn.net/weixin_45636702 title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_45636702" rel=noopener target=_blank><i class="fab fa-crosshairs fa-fw"></i>CSDN</a></span></div><div class="cc-license motion-element" itemprop=license><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class=cc-opacity rel=noopener target=_blank><img src=/images/cc-by-nc-sa.svg alt="Creative Commons"></a></div></div></div></aside><div id=sidebar-dimmer></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy; 2019 – <span itemprop=copyrightYear>2020</span> <span class=with-love><i class="fa fa-heart"></i></span> <span class=author itemprop=copyrightHolder>Maisy</span> <span class=post-meta-divider>|</span> <span class=post-meta-item-icon><i class="fa fa-chart-area"></i></span> <span class=post-meta-item-text>站点总字数：</span> <span title=站点总字数>391k</span> <span class=post-meta-divider>|</span> <span class=post-meta-item-icon><i class="fa fa-coffee"></i></span> <span class=post-meta-item-text>站点阅读时长 &asymp;</span> <span title=站点阅读时长>5:55</span></div><div class=powered-by>由 <a href="https://hexo.io/" class=theme-link rel=noopener target=_blank>Hexo</a> & <a href="https://muse.theme-next.org/" class=theme-link rel=noopener target=_blank>NexT.Muse</a> 强力驱动</div></div></footer></div><script src=/lib/anime.min.js></script><script src=//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js></script><script src=//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js></script><script src=//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js></script><script src=/lib/velocity/velocity.min.js></script><script src=/lib/velocity/velocity.ui.min.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/schemes/muse.js></script><script src=/js/next-boot.js></script><script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script><script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.3.9/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'yK6nF3Ng27WevBtHAbTkt8Jv-gzGzoHsz',
      appKey     : 'DXAxzx0igQL9KzyblmtXnVkh',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script></body></html>