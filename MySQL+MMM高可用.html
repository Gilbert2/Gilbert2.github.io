<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width, initial-scale=1, maximum-scale=2"><meta name=theme-color content=#222><meta name=generator content="Hexo 4.2.0"><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-next.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32-next.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16-next.png><link rel=mask-icon href=/images/logo.svg color=#222><meta name=msvalidate.01 content=true><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><link rel=stylesheet href=//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css><script id=hexo-configurations>
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pdxblog.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"b2t":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":{"enable":true,"onlypost":false,"loadingImg":null},"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script><meta name=description content=MySQL><meta property=og:type content=article><meta property=og:title content=MySQL+MMM高可用><meta property=og:url content=https://pdxblog.top/MySQL+MMM%E9%AB%98%E5%8F%AF%E7%94%A8.html><meta property=og:site_name content=Maisyの博客><meta property=og:description content=MySQL><meta property=og:locale content=zh_CN><meta property=og:image content="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9zMy41MWN0by5jb20vd3lmczAyL00wMC8xMS9FMi93S2lvbTFMaUUwVGpxb2RQQUFGZTEyaVBjb00wMzYuanBn?x-oss-process=image/format,png"><meta property=og:image content=https://img-blog.csdnimg.cn/20200711175219538.png><meta property=og:image content=https://img-blog.csdnimg.cn/20200711175231970.png><meta property=og:image content="https://img-blog.csdnimg.cn/20200711175256541.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200711175352659.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200711175420932.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200711175441667.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=og:image content="https://img-blog.csdnimg.cn/20200711175452434.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><meta property=article:published_time content=2020-07-10T16:00:00.000Z><meta property=article:modified_time content=2020-07-11T11:38:10.993Z><meta property=article:author content=Maisy><meta property=article:tag content=MySQL><meta name=twitter:card content=summary><meta name=twitter:image content="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9zMy41MWN0by5jb20vd3lmczAyL00wMC8xMS9FMi93S2lvbTFMaUUwVGpxb2RQQUFGZTEyaVBjb00wMzYuanBn?x-oss-process=image/format,png"><link rel=canonical href=https://pdxblog.top/MySQL+MMM%E9%AB%98%E5%8F%AF%E7%94%A8.html><script id=page-configurations>
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script><title>MySQL+MMM高可用 | Maisyの博客</title><noscript><style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style></noscript><link rel=alternate href=/atom.xml title=Maisyの博客 type=application/atom+xml></head><body itemscope itemtype=http://schema.org/WebPage><div class="container use-motion"><div class=headband></div><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class=site-meta><a href="/" class=brand rel=start><span class=logo-line-before><i></i></span><h1 class=site-title>Maisyの博客</h1><span class=logo-line-after><i></i></span></a><p class=site-subtitle itemprop=description>记录生活中的点点滴滴</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul id=menu class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel=section><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-top"><a href="/top/" rel=section><i class="fa fa-signal fa-fw"></i>排行榜</a></li><li class="menu-item menu-item-about"><a href="/about/" rel=section><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel=section><i class="fa fa-tags fa-fw"></i>标签<span class=badge>7</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel=section><i class="fa fa-th fa-fw"></i>分类<span class=badge>7</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel=section><i class="fa fa-archive fa-fw"></i>归档<span class=badge>69</span></a></li></ul></nav></div></header><div class=back-to-top><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class=main><div class=main-inner><div class=content-wrap><div class="content post posts-expand"><article itemscope itemtype=http://schema.org/Article class=post-block lang=zh-CN><link itemprop=mainEntityOfPage href=https://pdxblog.top/MySQL+MMM%E9%AB%98%E5%8F%AF%E7%94%A8.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/author.jpg><meta itemprop=name content=Maisy><meta itemprop=description content=人的一生就是一个储蓄的过程，在奋斗的时候储存了希望；在耕耘的时候储存了一粒种子；在旅行的时候储存了风景；在微笑的时候储存了快乐。聪明的人善于储蓄，在漫长而短暂的人生旅途中，学会储蓄每一个闪光的瞬间，然后用它们酿成一杯美好的回忆，在四季的变幻与交替之间，散发浓香，珍藏一生></span> <span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content=Maisyの博客></span><header class=post-header><h1 class=post-title itemprop="name headline">MySQL+MMM高可用</h1><div class=post-meta><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span> <span class=post-meta-item-text>发表于</span><time title="创建时间：2020-07-11 00:00:00 / 修改时间：19:38:10" itemprop="dateCreated datePublished" datetime=2020-07-11T00:00:00+08:00>2020-07-11</time></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder"></i></span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href="/categories/MySQL/" itemprop=url rel=index><span itemprop=name>MySQL</span></a></span></span><br><span class=post-meta-item title=本文字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span> <span class=post-meta-item-text>本文字数：</span> <span>8.7k</span></span> <span class=post-meta-item title=阅读时长><span class=post-meta-item-icon><i class="far fa-clock"></i></span> <span class=post-meta-item-text>阅读时长 &asymp;</span> <span>8 分钟</span></span><div class=post-description>MySQL</div></div></header><div class=post-body itemprop=articleBody><h2 id=MySQL-MMM高可用><a class=header-anchor href=#MySQL-MMM高可用>¶</a>MySQL+MMM高可用</h2><h3 id=一、环境简述><a class=header-anchor href=#一、环境简述>¶</a>一、环境简述</h3><h4 id=1、工作逻辑图><a class=header-anchor href=#1、工作逻辑图>¶</a>1、工作逻辑图</h4><p><a href=https://s3.51cto.com/wyfs02/M00/11/E2/wKiom1LiE0TjqodPAAFe12iPcoM036.jpg target=_blank rel=noopener><img data-src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9zMy41MWN0by5jb20vd3lmczAyL00wMC8xMS9FMi93S2lvbTFMaUUwVGpxb2RQQUFGZTEyaVBjb00wMzYuanBn?x-oss-process=image/format,png" alt=wKiom1LiE0TjqodPAAFe12iPcoM036.jpg></a></p><h4 id=2、MySQL-MMM优缺点><a class=header-anchor href=#2、MySQL-MMM优缺点>¶</a>2、MySQL-MMM优缺点</h4><p>优点：高可用性，扩展性好，出现故障自动切换，对于主主同步，在同一时间只提供一台数据库写操作，保证的数据的一致性。</p><p>缺点：Monitor节点是单点，可以结合Keepalived实现高可用。</p><h4 id=3、MySQL-MMM工作原理><a class=header-anchor href=#3、MySQL-MMM工作原理>¶</a>3、MySQL-MMM工作原理</h4><p>MMM(Master-Master replication managerfor Mysql，Mysql主主复制管理器)是一套灵活的脚本程序，基于perl实现，用来对mysql replication进行监控和故障迁移，并能管理mysql Master-Master复制的配置(同一时间只有一个节点是可写的)。</p><p>mmm_mond：监控进程，负责所有的监控工作，决定和处理所有节点角色活动。此脚本需要在监管机上运行。</p><p>mmm_agentd：运行在每个mysql服务器上的代理进程，完成监控的探针工作和执行简单的远端服务设置。此脚本需要在被监管机上运行。</p><p>mmm_control：一个简单的脚本，提供管理mmm_mond进程的命令。</p><p>mysql-mmm的监管端会提供多个虚拟IP（VIP），包括一个可写VIP，多个可读VIP，通过监管的管理，这些IP会绑定在可用mysql之上，当某一台mysql宕机时，监管会将VIP迁移至其他mysql。</p><p>在整个监管过程中，需要在mysql中添加相关授权用户，以便让mysql可以支持监理机的维护。授权的用户包括一个mmm_monitor用户和一个mmm_agent用户，如果想使用mmm的备份工具则还要添加一个mmm_tools用户。</p><h4 id=4、需求描述><a class=header-anchor href=#4、需求描述>¶</a>4、需求描述</h4><p>操作系统：CentOS 7.8</p><p>数据库：MySQL 5.7</p><p>MMM：MySQL-MMM 2.2.1</p><p>数据库分配：</p><table><thead><tr><th><strong>function</strong></th><th><strong>ip</strong></th><th><strong>hostname</strong></th><th><strong>server id</strong></th></tr></thead><tbody><tr><td>monitoring host</td><td>192.168.206.120</td><td>monitor</td><td>无</td></tr><tr><td>master 1</td><td>192.168.206.121</td><td>master1</td><td>1</td></tr><tr><td>master 2</td><td>192.168.206.122</td><td>master2</td><td>2</td></tr><tr><td>slave 1</td><td>192.168.206.123</td><td>slave1</td><td>3</td></tr><tr><td>slave 2</td><td>192.168.206.124</td><td>slave2</td><td>4</td></tr></tbody></table><p>虚拟IP地址（VIP）：</p><table><thead><tr><th><strong>ip</strong></th><th><strong>role</strong></th></tr></thead><tbody><tr><td>192.168.0.211</td><td>writer</td></tr><tr><td>192.168.0.212</td><td>reader</td></tr><tr><td>192.168.0.213</td><td>reader</td></tr></tbody></table><p>数据库同步需要的用户：</p><table><thead><tr><th><strong>function</strong></th><th><strong>description</strong></th><th><strong>privileges</strong></th></tr></thead><tbody><tr><td>monitor user</td><td>mmm监控用于对mysql服务器进程健康检查</td><td>REPLICATION CLIENT</td></tr><tr><td>agent user</td><td>mmm代理用来更改只读模式，复制的主服务器等</td><td>SUPER, REPLICATION CLIENT, PROCESS</td></tr><tr><td>replication user</td><td>用于复制</td><td>REPLICATION SLAVE</td></tr></tbody></table><h3 id=二、4台服务器安装MySQL并配置><a class=header-anchor href=#二、4台服务器安装MySQL并配置>¶</a>二、4台服务器安装MySQL并配置</h3><h4 id=1、通用配置><a class=header-anchor href=#1、通用配置>¶</a>1、通用配置</h4><p>在这个步骤中，可以先在1台mysql服务器（192.168.206.121）上进行以下配置：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre></td><td class=code><pre><span class=line>[root@master1 ~]# vi /etc/my.cnf   #添加如下</span><br><span class=line>[mysqld]</span><br><span class=line>binlog-do-db=test           #需要记录二进制日志的数据库，多个用逗号隔开</span><br><span class=line>binlog-ignore-db=mysql，information_schema  #不需要记录二进制日志的数据库，多个用逗号隔开</span><br><span class=line>auto_increment_increment=2  #字段一次递增多少</span><br><span class=line>auto_increment_offset=1     #自增字段的起始值，值设置不同</span><br><span class=line>replicate-do-db=test        #同步的数据库，多个写多行</span><br><span class=line>replicate-ignore-db = information_schema #不同步的数据库，多个写多行</span><br><span class=line>server_id = 1               #每台设置不同</span><br><span class=line>log_bin = mysql-bin</span><br><span class=line>log_slave_updates           #当一个主故障，另一个立即接管</span><br><span class=line>sync-binlog=1               #每条自动更新，安全性高，默认是0</span><br><span class=line>[root@master1 ~]# systemctl restart mysqld</span><br></pre></td></tr></table></figure><h4 id=2、修改配置><a class=header-anchor href=#2、修改配置>¶</a>2、修改配置</h4><p>按照第一台服务器克隆出3台，分别修改以下信息：</p><h5 id=（1）网卡的IP><a class=header-anchor href=#（1）网卡的IP>¶</a>（1）网卡的IP</h5><h5 id=（2）mysql的UUID><a class=header-anchor href=#（2）mysql的UUID>¶</a>（2）mysql的UUID</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>vim /var/lib/mysql/autoconf</span><br></pre></td></tr></table></figure><h5 id=（3）my-cnf文件><a class=header-anchor href=#（3）my-cnf文件>¶</a>（3）my.cnf文件</h5><p>关于mysql的配置，只需要在master1的基础上修改个别参数的值即可。</p><h6 id=1）master2><a class=header-anchor href=#1）master2>¶</a>1）master2</h6><figure class="highlight ini"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line><span class=attr>auto_increment_offset</span>=<span class=number>2</span>		<span class=comment>#自增字段的起始值，值设置不同</span></span><br><span class=line><span class=attr>server_id</span>=<span class=number>2</span>					<span class=comment>#每台设置不同</span></span><br></pre></td></tr></table></figure><h6 id=2）slave1和slave2><a class=header-anchor href=#2）slave1和slave2>¶</a>2）slave1和slave2</h6><p>删除以下2项：</p><figure class="highlight ini"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line><span class=attr>auto_increment_increment</span>=<span class=number>2</span>  <span class=comment>#字段一次递增多少</span></span><br><span class=line><span class=attr>auto_increment_offset</span>=<span class=number>1</span>     <span class=comment>#自增字段的起始值，值设置不同</span></span><br></pre></td></tr></table></figure><p>server_id分别设置为3和4</p><figure class="highlight ini"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=comment># slave1</span></span><br><span class=line><span class=attr>server_id</span>=<span class=number>3</span>					<span class=comment>#每台设置不同</span></span><br><span class=line><span class=comment># slave2</span></span><br><span class=line><span class=attr>server_id</span>=<span class=number>4</span>					<span class=comment>#每台设置不同</span></span><br></pre></td></tr></table></figure><p>修改完毕之后别忘了重启mysql服务：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>systemctl restart mysqld</span><br></pre></td></tr></table></figure><h3 id=三、配置master1和master2主主同步><a class=header-anchor href=#三、配置master1和master2主主同步>¶</a>三、配置master1和master2主主同步</h3><h4 id=1、先查看下log-bin日志和pos值位置><a class=header-anchor href=#1、先查看下log-bin日志和pos值位置>¶</a>1、先查看下log bin日志和pos值位置</h4><h6 id=（1）master1><a class=header-anchor href=#（1）master1>¶</a>（1）master1</h6><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@master1 ~]# mysql -uroot -p</span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> show master status;</span></span><br></pre></td></tr></table></figure><p><img data-src=https://img-blog.csdnimg.cn/20200711175219538.png></p><h6 id=（2）master2><a class=header-anchor href=#（2）master2>¶</a>（2）master2</h6><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@master2 ~]# mysql -uroot -p</span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> show master status;</span></span><br></pre></td></tr></table></figure><p><img data-src=https://img-blog.csdnimg.cn/20200711175231970.png></p><h4 id=2、配置主主同步><a class=header-anchor href=#2、配置主主同步>¶</a>2、配置主主同步</h4><h5 id=（1）master1配置><a class=header-anchor href=#（1）master1配置>¶</a>（1）master1配置</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line><span class=meta>mysql&gt;</span><span class=bash> <span class=built_in>set</span> global validate_password_policy=0;</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> <span class=built_in>set</span> global validate_password_length=6;</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> grant replication slave on *.* to <span class=string>'repl'</span>@<span class=string>'192.168.206.%'</span> identified by <span class=string>'123456'</span>;</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> flush privileges;</span></span><br><span class=line></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> stop slave;</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> change master to master_host=<span class=string>'192.168.206.122'</span>,master_user=<span class=string>'repl'</span>,master_password=<span class=string>'123456'</span>,master_log_file=<span class=string>'mysql-bin.000001'</span>,master_log_pos=154;</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> start slave;</span></span><br></pre></td></tr></table></figure><h5 id=（2）master2配置><a class=header-anchor href=#（2）master2配置>¶</a>（2）master2配置</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line><span class=meta>mysql&gt;</span><span class=bash> <span class=built_in>set</span> global validate_password_policy=0;</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> <span class=built_in>set</span> global validate_password_length=6;</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> grant replication slave on *.* to <span class=string>'repl'</span>@<span class=string>'192.168.206.%'</span> identified by <span class=string>'123456'</span>;</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> flush privileges;</span></span><br><span class=line></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> stop slave;</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> change master to master_host=<span class=string>'192.168.206.121'</span>,master_user=<span class=string>'repl'</span>,master_password=<span class=string>'123456'</span>,master_log_file=<span class=string>'mysql-bin.000001'</span>,master_log_pos=154;</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> start slave;</span></span><br></pre></td></tr></table></figure><h5 id=（3）测试主主同步><a class=header-anchor href=#（3）测试主主同步>¶</a>（3）测试主主同步</h5><p>主主同步配置完毕，查看同步状态Slave_IO和Slave_SQL是YES说明主主同步成功。</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; show slave status\G</span><br></pre></td></tr></table></figure><p><img data-src="https://img-blog.csdnimg.cn/20200711175256541.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><p>如果Slave_IO_Running和Slave_SQL_Running都为yes，那么主从就已经配置OK了。</p><h6 id=1）在master1上增加数据><a class=header-anchor href=#1）在master1上增加数据>¶</a>1）在master1上增加数据</h6><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; create database test;</span><br><span class=line>mysql&gt; use test;</span><br><span class=line>mysql&gt; create table grade(id int);</span><br><span class=line>mysql&gt; insert into grade values(1),(2),(3);</span><br></pre></td></tr></table></figure><h6 id=2）在master2上查看是否数据同步><a class=header-anchor href=#2）在master2上查看是否数据同步>¶</a>2）在master2上查看是否数据同步</h6><p><img data-src="https://img-blog.csdnimg.cn/20200711175352659.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"><br>可以看到已经成功同步过去，同样在master2插入到grade表数据，也能同步过去。我们的双主就成功了，开始做主从复制。</p><h5 id=（4）可能出现的错误><a class=header-anchor href=#（4）可能出现的错误>¶</a>（4）可能出现的错误</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>Last_IO_Error: Got fatal error 1236 from master when reading data from binary log: &#39;Client requested master to start replication from position &gt; file size&#39;</span><br></pre></td></tr></table></figure><p><strong>解决方案：</strong></p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>stop slave;</span><br><span class=line>reset slave;</span><br><span class=line>start slave;</span><br></pre></td></tr></table></figure><h3 id=四、配置slave1和slave2做为master1的从库><a class=header-anchor href=#四、配置slave1和slave2做为master1的从库>¶</a>四、配置slave1和slave2做为master1的从库</h3><h4 id=1、先看下master1状态值><a class=header-anchor href=#1、先看下master1状态值>¶</a>1、先看下master1状态值</h4><p><img data-src="https://img-blog.csdnimg.cn/20200711175420932.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><h4 id=2、配置主从库><a class=header-anchor href=#2、配置主从库>¶</a>2、配置主从库</h4><h5 id=（1）在slave1和slave2分别修改权限><a class=header-anchor href=#（1）在slave1和slave2分别修改权限>¶</a>（1）在slave1和slave2分别修改权限</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; change master to master_host&#x3D;&#39;192.168.206.121&#39;,master_user&#x3D;&#39;repl&#39;,master_password&#x3D;&#39;123456&#39;,master_log_file&#x3D;&#39;mysql-bin.000001&#39;,master_log_pos&#x3D;759;</span><br></pre></td></tr></table></figure><h5 id=（2）在slave1和slave2查看结果><a class=header-anchor href=#（2）在slave1和slave2查看结果>¶</a>（2）在slave1和slave2查看结果</h5><p><img data-src="https://img-blog.csdnimg.cn/20200711175441667.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><p>如上图所示，说明主从复制成功。但是数据没过来，这是因为主从复制原理只同步配置完后的增删改记录，以前的数据是不能同步的。我们可以把主的数据库备份了，然后在送数据库还原。</p><h4 id=3、还原数据库><a class=header-anchor href=#3、还原数据库>¶</a>3、还原数据库</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line>[root@master1 ~]# mysqldump -uroot -p123456 test &gt; test.sql</span><br><span class=line>[root@master1 ~]# scp test.sql root@192.168.206.123:/root/</span><br><span class=line>[root@master1 ~]# scp test.sql root@192.168.206.124:/root/</span><br><span class=line></span><br><span class=line>[root@slave1 ~]# mysql -uroot -p -e "create database test;"</span><br><span class=line>[root@slave1 ~]# mysql -uroot -p test &lt;test.sql</span><br><span class=line></span><br><span class=line>[root@slave2 ~]# mysql -uroot -p -e "create database test;"</span><br><span class=line>[root@slave2 ~]# mysql -uroot -p test &lt;test.sql</span><br></pre></td></tr></table></figure><h3 id=五、MySQL-MMM安装配置><a class=header-anchor href=#五、MySQL-MMM安装配置>¶</a>五、MySQL-MMM安装配置</h3><p>CentOS默认没有mysql-mmm软件包，官方推荐使用epel的网络源，五台都安装epel：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class=line></span><br><span class=line>rpm -ivh http://mirrors.ustc.edu.cn/fedora/epel/6/x86_64/epel-release-6-8.noarch.rpm</span><br><span class=line></span><br><span class=line>yum -y install perl-* libart_lgpl.x86_64 rrdtool.x86_64 rrdtool-perl.x86_64</span><br></pre></td></tr></table></figure><h4 id=1、monitor节点安装><a class=header-anchor href=#1、monitor节点安装>¶</a>1、monitor节点安装</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>yum -y install mysql-mmm-monitor</span><br></pre></td></tr></table></figure><h4 id=2、四台db节点安装><a class=header-anchor href=#2、四台db节点安装>¶</a>2、四台db节点安装</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>yum -y install mysql-mmm-agent</span><br></pre></td></tr></table></figure><p><img data-src="https://img-blog.csdnimg.cn/20200711175452434.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTYzNjcwMg==,size_16,color_FFFFFF,t_70"></p><h4 id=3、在四台db节点授权monitor访问><a class=header-anchor href=#3、在四台db节点授权monitor访问>¶</a>3、在四台db节点授权monitor访问</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre></td><td class=code><pre><span class=line><span class=meta>mysql&gt;</span><span class=bash> <span class=built_in>set</span> global validate_password_policy=0;</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> <span class=built_in>set</span> global validate_password_length=6;</span></span><br><span class=line></span><br><span class=line><span class=meta>#</span><span class=bash> 监听帐号，是MMM监控服务器用来对MySQL服务器做健康检查的</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> grant replication client on *.* to <span class=string>'mmm_monitor'</span>@<span class=string>'192.168.206.%'</span> identified by <span class=string>'123456'</span>;</span></span><br><span class=line></span><br><span class=line><span class=meta>#</span><span class=bash> 代理帐号，是MMM代理用来变成只读模式和同步master等的</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> grant super,process,replication client on *.* to <span class=string>'mmm_agent'</span>@<span class=string>'192.168.206.%'</span> identified by <span class=string>'123456'</span>;</span></span><br><span class=line></span><br><span class=line><span class=meta>#</span><span class=bash> 刷新权限</span></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> flush privileges;</span></span><br></pre></td></tr></table></figure><h4 id=4、修改mmm-common-conf文件（5台相同）><a class=header-anchor href=#4、修改mmm-common-conf文件（5台相同）>¶</a>4、修改mmm_common.conf文件（5台相同）</h4><h5 id=（1）配置示例说明><a class=header-anchor href=#（1）配置示例说明>¶</a>（1）配置示例说明</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br></pre></td><td class=code><pre><span class=line>[root@monitor ~]# vim /etc/mysql-mmm/mmm_common.conf</span><br><span class=line>active_master_role      writer    #积极的master角色的标示，所有的db服务器要开启read_only参数，对于writer服务器监控代理会自动将read_only属性关闭。</span><br><span class=line></span><br><span class=line>&lt;host default&gt;</span><br><span class=line>    cluster_interface       eth0 #群集的网络接口</span><br><span class=line>    pid_path                /var/run/mysql-mmm/mmm_agentd.pid　　#pid路径</span><br><span class=line>    bin_path                /usr/libexec/mysql-mmm/　　#可执行文件路径</span><br><span class=line>    replication_user        replication　　　　#复制用户</span><br><span class=line>    replication_password    123456　　　　　　#复制用户密码</span><br><span class=line>    agent_user              mmm_agent　　　　#代理用户</span><br><span class=line>    agent_password          123456　　　　　　#代理用户密码</span><br><span class=line>&lt;/host&gt;</span><br><span class=line></span><br><span class=line>&lt;host master-db1&gt;　　 #master-db1的host名称</span><br><span class=line>    ip      192.168.1.11　　 #master-db1的ip</span><br><span class=line>    mode    master      　　#角色属性，master代表是主</span><br><span class=line>    peer    master-db2　　 #与master-db1对等的服务器的host名，也就是master-db2的服务器host名</span><br><span class=line>&lt;/host&gt;</span><br><span class=line></span><br><span class=line>&lt;host master-db2&gt;　　 #和master-db1的概念一样</span><br><span class=line>    ip      192.168.1.12</span><br><span class=line>    mode    master</span><br><span class=line>    peer    master-db1</span><br><span class=line>&lt;/host&gt;</span><br><span class=line></span><br><span class=line>&lt;host slave-db1&gt; 　　　　#从库的host名,如果存在多个从库可以重复一样的配置</span><br><span class=line>    ip      192.168.1.13　　　　#从的ip</span><br><span class=line>    mode    slave  　　　　#slave的角色属性代表当前host是从</span><br><span class=line>&lt;/host&gt;</span><br><span class=line></span><br><span class=line>&lt;host slave-db2&gt; 　　　　 #和slave-db1的概念一样</span><br><span class=line>    ip      192.168.1.14</span><br><span class=line>    mode    slave</span><br><span class=line>&lt;/host&gt;</span><br><span class=line>&lt;role writer&gt; 　　　　 #writer角色配置</span><br><span class=line>    hosts   master-db1, master-db2 　　#能进行写操作的服务器的host名，如果不想切换写操作这里可以只配置master,这样也可以避免因为网络延时而进行write的切换，但是一旦master出现故障那么当前的MMM就没有writer了只有对外的read操作。</span><br><span class=line>    ips     192.168.1.250　　　　#对外提供的写操作的虚拟IP</span><br><span class=line>    mode    exclusive　　　　#exclusive代表只允许存在一个主，也就是只能提供一个写的IP</span><br><span class=line>&lt;/role&gt;</span><br><span class=line></span><br><span class=line>&lt;role reader&gt; 　　#read角色配置</span><br><span class=line>    hosts   master-db1, master-db2, slave-db1, slave-db2　　　　#对外提供读操作的服务器的host名,当然这里也可以把master加进来</span><br><span class=line>    ips     192.168.1.251, 192.168.1.252, 192.168.1.253, 192.168.1.254　　　　#对外提供读操作的虚拟ip，这三个ip和host不是一一对应的,并且ips也hosts的数目也可以不相同，如果这样配置的话其中一个hosts会分配两个ip</span><br><span class=line>    mode    balanced</span><br><span class=line>&lt;/role&gt;</span><br></pre></td></tr></table></figure><h5 id=（2）实际配置参数><a class=header-anchor href=#（2）实际配置参数>¶</a>（2）实际配置参数</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br></pre></td><td class=code><pre><span class=line>[root@monitor ~]# mkdir /etc/mysql-mmm</span><br><span class=line>[root@monitor ~]# vim /etc/mysql-mmm/mmm_common.conf</span><br><span class=line>active_master_role      writer</span><br><span class=line></span><br><span class=line>&lt;host default&gt;</span><br><span class=line>        cluster_interface       ens33</span><br><span class=line>        pid_path                /var/run/mysql-mmm/mmm_agentd.pid</span><br><span class=line>        bin_path                /usr/libexec/mysql-mmm</span><br><span class=line>        replication_user        repl</span><br><span class=line>        replecation_password    123456</span><br><span class=line>        agent_user              mmm_agent</span><br><span class=line>        agent_password          123456</span><br><span class=line>&lt;host&gt;</span><br><span class=line></span><br><span class=line>&lt;host master1&gt;</span><br><span class=line>        ip      192.168.206.121</span><br><span class=line>        mode    master</span><br><span class=line>        peer    master2</span><br><span class=line>&lt;host&gt;</span><br><span class=line></span><br><span class=line>&lt;host master2&gt;</span><br><span class=line>        ip      192.168.206.122</span><br><span class=line>        mode    master</span><br><span class=line>        peer    master1</span><br><span class=line>&lt;host&gt;</span><br><span class=line></span><br><span class=line>&lt;host slave1&gt;</span><br><span class=line>        ip      192.168.206.123</span><br><span class=line>        mode    slave</span><br><span class=line>&lt;host&gt;</span><br><span class=line></span><br><span class=line>&lt;host slave2&gt;</span><br><span class=line>        ip      192.168.206.124</span><br><span class=line>        mode    slave</span><br><span class=line>&lt;host&gt;</span><br><span class=line></span><br><span class=line>&lt;role writer&gt;</span><br><span class=line>        hosts   master1,master2</span><br><span class=line>        ips     192.168.206.250</span><br><span class=line>        mode    exclusive</span><br><span class=line>&lt;role&gt;</span><br><span class=line></span><br><span class=line>&lt;role reader&gt;</span><br><span class=line>        hosts   master1,master2,slave1,slave2</span><br><span class=line>        ips     192.168.206.251, 192.168.206.252, 192.168.206.253, 192.168.206.254</span><br><span class=line>        mode    balanced</span><br><span class=line>&lt;role&gt;</span><br></pre></td></tr></table></figure><h5 id=（3）通过scp命令传送到其他4台><a class=header-anchor href=#（3）通过scp命令传送到其他4台>¶</a>（3）通过scp命令传送到其他4台</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>[root@monitor ~]# scp -r /etc/mysql-mmm/ root@192.168.206.121:/etc</span><br><span class=line>[root@monitor ~]# scp -r /etc/mysql-mmm/ root@192.168.206.122:/etc</span><br><span class=line>[root@monitor ~]# scp -r /etc/mysql-mmm/ root@192.168.206.123:/etc</span><br><span class=line>[root@monitor ~]# scp -r /etc/mysql-mmm/ root@192.168.206.124:/etc</span><br></pre></td></tr></table></figure><h4 id=5、修改4台db代理端mmm-agent-conf文件><a class=header-anchor href=#5、修改4台db代理端mmm-agent-conf文件>¶</a>5、修改4台db代理端mmm_agent.conf文件</h4><p>在所有的MySQL上修改mmm_agent.conf，只需要修改master-db1这里，是哪台就改成哪台，这里只给出master1的：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>[root@master2 ~]# vim /etc/mysql-mmm/mmm_agent.conf</span><br><span class=line></span><br><span class=line>include mmm_common.conf</span><br><span class=line>this</span><br></pre></td></tr></table></figure><h4 id=6、修改管理端mmm-mon-conf文件><a class=header-anchor href=#6、修改管理端mmm-mon-conf文件>¶</a>6、修改管理端mmm_mon.conf文件</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre></td><td class=code><pre><span class=line>[root@monitor ~]# vim /etc/mysql-mmm/mmm_mon.conf</span><br><span class=line>include mmm_common.conf</span><br><span class=line></span><br><span class=line>&lt;monitor&gt;</span><br><span class=line>        ip              192.168.206.120</span><br><span class=line>        pid_path        /var/run/mysql-mmm/mmm_mond.pid</span><br><span class=line>        bin_path        /usr/libexec/mysql-mmm</span><br><span class=line>        status_path     /var/lib/mysql-mmm/mmm_mond.status</span><br><span class=line>        ping_ips        192.168.206.121.192.168.206.122,192.168.206.123,192.168.206.124</span><br><span class=line>        auto_set_online 60	#恢复后自动设置在线的时间</span><br><span class=line>&lt;monitor&gt;</span><br><span class=line></span><br><span class=line>&lt;host default&gt;</span><br><span class=line>        monitor_user            mmm_monitor</span><br><span class=line>        monitor_password        123456</span><br><span class=line>&lt;host&gt;</span><br><span class=line></span><br><span class=line>debug   0</span><br></pre></td></tr></table></figure><h3 id=六、启动MySQL-MMM><a class=header-anchor href=#六、启动MySQL-MMM>¶</a>六、启动MySQL-MMM</h3><h4 id=1、db代理端启动><a class=header-anchor href=#1、db代理端启动>¶</a>1、db代理端启动</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@db1 ~]# /etc/init.d/mysql-mmm-agent start</span><br><span class=line>[root@db1 ~]# chkconfigmysql-mmm-agent on</span><br></pre></td></tr></table></figure><h4 id=2、monitor管理端启动><a class=header-anchor href=#2、monitor管理端启动>¶</a>2、monitor管理端启动</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@monitor ~]# /etc/init.d/mysql-mmm-monitor start</span><br><span class=line>[root@monitor ~]# chkconfigmysql-mmm-monitor on</span><br></pre></td></tr></table></figure></div><div><ul class=post-copyright><li class=post-copyright-author><strong>本文作者：</strong>Maisy</li><li class=post-copyright-link><strong>本文链接：</strong> <a href=https://pdxblog.top/MySQL+MMM%E9%AB%98%E5%8F%AF%E7%94%A8.html title=MySQL+MMM高可用>https://pdxblog.top/MySQL+MMM高可用.html</a></li><li class=post-copyright-license><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel=noopener target=_blank><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class=post-footer><div class=post-tags><a href="/tags/MySQL/" rel=tag># MySQL</a></div><div class=post-nav><div class=post-nav-item><a href=/MySQL%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C.html rel=prev title=MySQL基本操作><i class="fa fa-chevron-left"></i> MySQL基本操作</a></div><div class=post-nav-item><a href=/Keepalived+mysql%E5%8F%8C%E4%B8%BB%E6%9D%A5%E5%AE%9E%E7%8E%B0MySQL-HA.html rel=next title=Keepalived+mysql双主来实现MySQL-HA>Keepalived+mysql双主来实现MySQL-HA <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class=nav><li class="nav-item nav-level-2"><a class=nav-link href=#MySQL-MMM高可用><span class=nav-number>1.</span> <span class=nav-text>¶MySQL+MMM高可用</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#一、环境简述><span class=nav-number>1.1.</span> <span class=nav-text>¶一、环境简述</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、工作逻辑图><span class=nav-number>1.1.1.</span> <span class=nav-text>¶1、工作逻辑图</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、MySQL-MMM优缺点><span class=nav-number>1.1.2.</span> <span class=nav-text>¶2、MySQL-MMM优缺点</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#3、MySQL-MMM工作原理><span class=nav-number>1.1.3.</span> <span class=nav-text>¶3、MySQL-MMM工作原理</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#4、需求描述><span class=nav-number>1.1.4.</span> <span class=nav-text>¶4、需求描述</span></a></li></ol></li><li class="nav-item nav-level-3"><a class=nav-link href=#二、4台服务器安装MySQL并配置><span class=nav-number>1.2.</span> <span class=nav-text>¶二、4台服务器安装MySQL并配置</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、通用配置><span class=nav-number>1.2.1.</span> <span class=nav-text>¶1、通用配置</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、修改配置><span class=nav-number>1.2.2.</span> <span class=nav-text>¶2、修改配置</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）网卡的IP><span class=nav-number>1.2.2.1.</span> <span class=nav-text>¶（1）网卡的IP</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）mysql的UUID><span class=nav-number>1.2.2.2.</span> <span class=nav-text>¶（2）mysql的UUID</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（3）my-cnf文件><span class=nav-number>1.2.2.3.</span> <span class=nav-text>¶（3）my.cnf文件</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#1）master2><span class=nav-number>1.2.2.3.1.</span> <span class=nav-text>¶1）master2</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#2）slave1和slave2><span class=nav-number>1.2.2.3.2.</span> <span class=nav-text>¶2）slave1和slave2</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class=nav-link href=#三、配置master1和master2主主同步><span class=nav-number>1.3.</span> <span class=nav-text>¶三、配置master1和master2主主同步</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、先查看下log-bin日志和pos值位置><span class=nav-number>1.3.1.</span> <span class=nav-text>¶1、先查看下log bin日志和pos值位置</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#（1）master1><span class=nav-number>1.3.1.0.1.</span> <span class=nav-text>¶（1）master1</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#（2）master2><span class=nav-number>1.3.1.0.2.</span> <span class=nav-text>¶（2）master2</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、配置主主同步><span class=nav-number>1.3.2.</span> <span class=nav-text>¶2、配置主主同步</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）master1配置><span class=nav-number>1.3.2.1.</span> <span class=nav-text>¶（1）master1配置</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）master2配置><span class=nav-number>1.3.2.2.</span> <span class=nav-text>¶（2）master2配置</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（3）测试主主同步><span class=nav-number>1.3.2.3.</span> <span class=nav-text>¶（3）测试主主同步</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#1）在master1上增加数据><span class=nav-number>1.3.2.3.1.</span> <span class=nav-text>¶1）在master1上增加数据</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#2）在master2上查看是否数据同步><span class=nav-number>1.3.2.3.2.</span> <span class=nav-text>¶2）在master2上查看是否数据同步</span></a></li></ol></li><li class="nav-item nav-level-5"><a class=nav-link href=#（4）可能出现的错误><span class=nav-number>1.3.2.4.</span> <span class=nav-text>¶（4）可能出现的错误</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class=nav-link href=#四、配置slave1和slave2做为master1的从库><span class=nav-number>1.4.</span> <span class=nav-text>¶四、配置slave1和slave2做为master1的从库</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、先看下master1状态值><span class=nav-number>1.4.1.</span> <span class=nav-text>¶1、先看下master1状态值</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、配置主从库><span class=nav-number>1.4.2.</span> <span class=nav-text>¶2、配置主从库</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）在slave1和slave2分别修改权限><span class=nav-number>1.4.2.1.</span> <span class=nav-text>¶（1）在slave1和slave2分别修改权限</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）在slave1和slave2查看结果><span class=nav-number>1.4.2.2.</span> <span class=nav-text>¶（2）在slave1和slave2查看结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#3、还原数据库><span class=nav-number>1.4.3.</span> <span class=nav-text>¶3、还原数据库</span></a></li></ol></li><li class="nav-item nav-level-3"><a class=nav-link href=#五、MySQL-MMM安装配置><span class=nav-number>1.5.</span> <span class=nav-text>¶五、MySQL-MMM安装配置</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、monitor节点安装><span class=nav-number>1.5.1.</span> <span class=nav-text>¶1、monitor节点安装</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、四台db节点安装><span class=nav-number>1.5.2.</span> <span class=nav-text>¶2、四台db节点安装</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#3、在四台db节点授权monitor访问><span class=nav-number>1.5.3.</span> <span class=nav-text>¶3、在四台db节点授权monitor访问</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#4、修改mmm-common-conf文件（5台相同）><span class=nav-number>1.5.4.</span> <span class=nav-text>¶4、修改mmm_common.conf文件（5台相同）</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）配置示例说明><span class=nav-number>1.5.4.1.</span> <span class=nav-text>¶（1）配置示例说明</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）实际配置参数><span class=nav-number>1.5.4.2.</span> <span class=nav-text>¶（2）实际配置参数</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（3）通过scp命令传送到其他4台><span class=nav-number>1.5.4.3.</span> <span class=nav-text>¶（3）通过scp命令传送到其他4台</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#5、修改4台db代理端mmm-agent-conf文件><span class=nav-number>1.5.5.</span> <span class=nav-text>¶5、修改4台db代理端mmm_agent.conf文件</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#6、修改管理端mmm-mon-conf文件><span class=nav-number>1.5.6.</span> <span class=nav-text>¶6、修改管理端mmm_mon.conf文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class=nav-link href=#六、启动MySQL-MMM><span class=nav-number>1.6.</span> <span class=nav-text>¶六、启动MySQL-MMM</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、db代理端启动><span class=nav-number>1.6.1.</span> <span class=nav-text>¶1、db代理端启动</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、monitor管理端启动><span class=nav-number>1.6.2.</span> <span class=nav-text>¶2、monitor管理端启动</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Maisy src=/images/author.jpg><p class=site-author-name itemprop=name>Maisy</p><div class=site-description itemprop=description>人的一生就是一个储蓄的过程，在奋斗的时候储存了希望；在耕耘的时候储存了一粒种子；在旅行的时候储存了风景；在微笑的时候储存了快乐。聪明的人善于储蓄，在漫长而短暂的人生旅途中，学会储蓄每一个闪光的瞬间，然后用它们酿成一杯美好的回忆，在四季的变幻与交替之间，散发浓香，珍藏一生</div></div><div class="site-state-wrap motion-element"><nav class=site-state><div class="site-state-item site-state-posts"><a href="/archives/"><span class=site-state-item-count>69</span> <span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class=site-state-item-count>7</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class=site-state-item-count>7</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/Gilbert2/Gilbert2.github.io title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Gilbert2&#x2F;Gilbert2.github.io" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a></span> <span class=links-of-author-item><a href=https://blog.csdn.net/weixin_45636702 title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_45636702" rel=noopener target=_blank><i class="fab fa-crosshairs fa-fw"></i>CSDN</a></span></div><div class="cc-license motion-element" itemprop=license><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class=cc-opacity rel=noopener target=_blank><img src=/images/cc-by-nc-sa.svg alt="Creative Commons"></a></div></div></div></aside><div id=sidebar-dimmer></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy; 2019 – <span itemprop=copyrightYear>2020</span> <span class=with-love><i class="fa fa-heart"></i></span> <span class=author itemprop=copyrightHolder>Maisy</span> <span class=post-meta-divider>|</span> <span class=post-meta-item-icon><i class="fa fa-chart-area"></i></span> <span class=post-meta-item-text>站点总字数：</span> <span title=站点总字数>573k</span> <span class=post-meta-divider>|</span> <span class=post-meta-item-icon><i class="fa fa-coffee"></i></span> <span class=post-meta-item-text>站点阅读时长 &asymp;</span> <span title=站点阅读时长>8:41</span></div><div class=powered-by>由 <a href="https://hexo.io/" class=theme-link rel=noopener target=_blank>Hexo</a> & <a href="https://muse.theme-next.org/" class=theme-link rel=noopener target=_blank>NexT.Muse</a> 强力驱动</div></div></footer></div><script src=/lib/anime.min.js></script><script src=//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js></script><script src=//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js></script><script src=//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js></script><script src=/lib/velocity/velocity.min.js></script><script src=/lib/velocity/velocity.ui.min.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/schemes/muse.js></script><script src=/js/next-boot.js></script><script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script></body></html>