<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width, initial-scale=1, maximum-scale=2"><meta name=theme-color content=#222><meta name=generator content="Hexo 4.2.0"><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-next.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32-next.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16-next.png><link rel=mask-icon href=/images/logo.svg color=#222><meta name=msvalidate.01 content=true><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><link rel=stylesheet href=//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css><script id=hexo-configurations>
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pdxblog.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"b2t":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":{"enable":true,"onlypost":false,"loadingImg":null},"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script><meta name=description content=MySQL><meta property=og:type content=article><meta property=og:title content=MySQL-MHA高可用方案><meta property=og:url content=https://pdxblog.top/MySQL-MHA%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88.html><meta property=og:site_name content=Maisyの博客><meta property=og:description content=MySQL><meta property=og:locale content=zh_CN><meta property=article:published_time content=2020-07-10T16:00:00.000Z><meta property=article:modified_time content=2020-07-11T11:38:10.993Z><meta property=article:author content=Maisy><meta property=article:tag content=MySQL><meta name=twitter:card content=summary><link rel=canonical href=https://pdxblog.top/MySQL-MHA%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88.html><script id=page-configurations>
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script><title>MySQL-MHA高可用方案 | Maisyの博客</title><noscript><style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style></noscript><link rel=alternate href=/atom.xml title=Maisyの博客 type=application/atom+xml></head><body itemscope itemtype=http://schema.org/WebPage><div class="container use-motion"><div class=headband></div><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class=site-meta><a href="/" class=brand rel=start><span class=logo-line-before><i></i></span><h1 class=site-title>Maisyの博客</h1><span class=logo-line-after><i></i></span></a><p class=site-subtitle itemprop=description>记录生活中的点点滴滴</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul id=menu class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel=section><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-top"><a href="/top/" rel=section><i class="fa fa-signal fa-fw"></i>排行榜</a></li><li class="menu-item menu-item-about"><a href="/about/" rel=section><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel=section><i class="fa fa-tags fa-fw"></i>标签<span class=badge>7</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel=section><i class="fa fa-th fa-fw"></i>分类<span class=badge>7</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel=section><i class="fa fa-archive fa-fw"></i>归档<span class=badge>69</span></a></li></ul></nav></div></header><div class=back-to-top><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class=main><div class=main-inner><div class=content-wrap><div class="content post posts-expand"><article itemscope itemtype=http://schema.org/Article class=post-block lang=zh-CN><link itemprop=mainEntityOfPage href=https://pdxblog.top/MySQL-MHA%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/author.jpg><meta itemprop=name content=Maisy><meta itemprop=description content=人的一生就是一个储蓄的过程，在奋斗的时候储存了希望；在耕耘的时候储存了一粒种子；在旅行的时候储存了风景；在微笑的时候储存了快乐。聪明的人善于储蓄，在漫长而短暂的人生旅途中，学会储蓄每一个闪光的瞬间，然后用它们酿成一杯美好的回忆，在四季的变幻与交替之间，散发浓香，珍藏一生></span> <span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content=Maisyの博客></span><header class=post-header><h1 class=post-title itemprop="name headline">MySQL-MHA高可用方案</h1><div class=post-meta><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span> <span class=post-meta-item-text>发表于</span><time title="创建时间：2020-07-11 00:00:00 / 修改时间：19:38:10" itemprop="dateCreated datePublished" datetime=2020-07-11T00:00:00+08:00>2020-07-11</time></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder"></i></span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href="/categories/MySQL/" itemprop=url rel=index><span itemprop=name>MySQL</span></a></span></span><br><span class=post-meta-item title=本文字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span> <span class=post-meta-item-text>本文字数：</span> <span>40k</span></span> <span class=post-meta-item title=阅读时长><span class=post-meta-item-icon><i class="far fa-clock"></i></span> <span class=post-meta-item-text>阅读时长 &asymp;</span> <span>36 分钟</span></span><div class=post-description>MySQL</div></div></header><div class=post-body itemprop=articleBody><h2 id=MySQL-MHA高可用方案><a class=header-anchor href=#MySQL-MHA高可用方案>¶</a>MySQL-MHA高可用方案</h2><h3 id=一、MHA简介><a class=header-anchor href=#一、MHA简介>¶</a>一、MHA简介</h3><p>MHA（Master High Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，它由日本DeNA公司youshimaton（现就职于Facebook公司）开发，是一套优秀的作为MySQL高可用性环境下故障切换和主从提升的高可用软件。在MySQL故障切换过程中，MHA能做到在0~30秒之内自动完成数据库的故障切换操作，并且在进行故障切换的过程中，MHA能在最大程度上保证数据的一致性，以达到真正意义上的高可用。</p><p>MHA里有两个角色一个是MHA Node（数据节点）另一个是MHA Manager（管理节点）。 MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台<br>MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p><p>在MHA自动故障切换过程中，MHA试图从宕机的主服务器上保存二进制日志，最大程度的保证数据的不丢失，但这并不总是可行的。例如，如果主服务器硬件故障或无法通过ssh访问，MHA没法保存二进制日志，只进行故障转移而丢失了最新的数据。使用MySQL 5.5的半同步复制，可以大大降低数据丢失的风险。MHA可以与半同步复制结合起来。如果只有一个slave已经收到了最新的二进制日志，MHA可以将最新的二进制日志应用于其他所有的slave服务器上，因此可以保证所有节点的数据一致性。</p><blockquote><p>注：从MySQL5.5开始，MySQL以插件的形式支持半同步复制。</p></blockquote><p><strong>如何理解半同步呢？首先我们来看看异步，全同步的概念。</strong></p><h4 id=1、异步复制（Asynchronous-replication）><a class=header-anchor href=#1、异步复制（Asynchronous-replication）>¶</a>1、异步复制（Asynchronous replication）</h4><p>MySQL默认的复制即是异步的，主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理，这样就会有一个问题，主如果crash掉了，此时主上已经提交的事务可能并没有传到从上，如果此时，强行将从提升为主，可能导致新主上的数据不完整。</p><h4 id=2、全同步复制（Fully-synchronous-replication）><a class=header-anchor href=#2、全同步复制（Fully-synchronous-replication）>¶</a>2、全同步复制（Fully synchronous replication）</h4><p>指当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。因为需要等待所有从库执行完该事务才能返回，所以全同步复制的性能必然会收到严重的影响。</p><h4 id=3、半同步复制（Semisynchronous-replication）><a class=header-anchor href=#3、半同步复制（Semisynchronous-replication）>¶</a>3、半同步复制（Semisynchronous replication）</h4><p>介于异步复制和全同步复制之间，主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到relay log中才返回给客户端。相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间。所以，半同步复制最好在低延时的网络中使用。</p><h4 id=4、异步与半同步异同><a class=header-anchor href=#4、异步与半同步异同>¶</a>4、异步与半同步异同</h4><p>默认情况下MySQL的复制是异步的，Master上所有的更新操作写入Binlog之后并不确保所有的更新都被复制到Slave之上。异步操作虽然效率高，但是在Master/Slave出现问题的时候，存在很高数据不同步的风险，甚至可能丢失数据。</p><p>MySQL5.5引入半同步复制功能的目的是为了保证在master出问题的时候，至少有一台Slave的数据是完整的。在超时的情况下也可以临时转入异步复制，保障业务的正常使用，直到一台salve追赶上之后，继续切换到半同步模式。</p><h4 id=5、MHA工作原理><a class=header-anchor href=#5、MHA工作原理>¶</a>5、MHA工作原理</h4><p>相较于其它HA软件，MHA的目的在于维持MySQL Replication中Master库的高可用性，其最大特点是可以修复多个Slave之间的差异日志，最终使所有Slave保持数据一致，然后从中选择一个充当新的Master，并将其它Slave指向它。</p><ul><li><p>从宕机崩溃的master保存二进制日志事件(binlogevents)。</p></li><li><p>识别含有最新更新的slave。</p></li><li><p>应用差异的中继日志(relay log)到其它slave。</p></li><li><p>应用从master保存的二进制日志事件(binlogevents)。</p></li><li><p>提升一个slave为新master。 -使其它的slave连接新的master进行复制。</p></li></ul><p>目前MHA主要支持一主多从的架构，要搭建MHA,要求一个复制集群中必须最少有三台数据库服务器，一主二从，即一台充当master，一台充当备用master，另外一台充当从库，因为至少需要三台服务器。</p><h3 id=二、搭建实验环境><a class=header-anchor href=#二、搭建实验环境>¶</a>二、搭建实验环境</h3><p>接下来部署MHA，具体的搭建环境如下：</p><table><thead><tr><th>角色</th><th>IP地址</th><th>主机名</th><th>server id</th><th>类型</th><th>OS</th></tr></thead><tbody><tr><td>Manager</td><td>192.168.206.200</td><td>manager</td><td></td><td>管理节点</td><td>centos 7.8</td></tr><tr><td>Master</td><td>192.168.206.201</td><td>maser</td><td>1</td><td>主MySQL（写入）</td><td>centos 7.8</td></tr><tr><td>CandidateMaster</td><td>192.168.206.202</td><td>c-master</td><td>2</td><td>从MySQL（读）</td><td>centos 7.8</td></tr><tr><td>slave</td><td>192.168.206.203</td><td>slave</td><td>3</td><td>从MySQL（读）</td><td>centos 7.8</td></tr></tbody></table><p>其中master对外提供写服务，备选master（实际的slave，主机名m3）提供读服务，slave也提供相关的读服务，一旦master宕机，将会把备选master提升为新的master，slave指向新的master，manager作为管理服务器。</p><h3 id=三、基础环境准备><a class=header-anchor href=#三、基础环境准备>¶</a>三、基础环境准备</h3><h4 id=1、基础配置><a class=header-anchor href=#1、基础配置>¶</a>1、基础配置</h4><p>在配置好IP地址和主机名后，检查selinux、防火墙设置，关闭 selinux ，防火墙服务，以便后期主从同步不出错。</p><blockquote><p>注：时间要同步</p></blockquote><h4 id=2、-在4台机器都配置epel源><a class=header-anchor href=#2、-在4台机器都配置epel源>¶</a>2、 在4台机器都配置epel源</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#</span><span class=bash> 安装epel源</span></span><br><span class=line>yum install -y epel-release</span><br><span class=line><span class=meta>#</span><span class=bash> 下载阿里开源镜像的epel源文件</span></span><br><span class=line>wget -O /etc/yum.repos.d/epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class=line><span class=meta>#</span><span class=bash> 清除系统yum缓存</span></span><br><span class=line>yum clean all</span><br><span class=line><span class=meta>#</span><span class=bash> 重新生成新的yum缓存</span></span><br><span class=line>yum makecache</span><br></pre></td></tr></table></figure><h4 id=3、建立ssh无交互登录环境><a class=header-anchor href=#3、建立ssh无交互登录环境>¶</a>3、建立ssh无交互登录环境</h4><h5 id=（1）Manager主机><a class=header-anchor href=#（1）Manager主机>¶</a>（1）Manager主机</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@manager ~]# ssh-keygen </span><br><span class=line>[root@manager ~]# for i in 1 2 3;do ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.206.20$i;done</span><br></pre></td></tr></table></figure><h5 id=（2）Candidate-master主机><a class=header-anchor href=#（2）Candidate-master主机>¶</a>（2）Candidate master主机</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@slave-master ~]# ssh-keygen </span><br><span class=line>[root@slave-master ~]# for i in 1 2 3;do ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.206.20$i;done</span><br></pre></td></tr></table></figure><h5 id=（3）master主机><a class=header-anchor href=#（3）master主机>¶</a>（3）master主机</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@master ~]# ssh-keygen </span><br><span class=line>[root@master ~]# for i in 1 2 3;do ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.206.20$i;done</span><br></pre></td></tr></table></figure><h5 id=（4）slave主机><a class=header-anchor href=#（4）slave主机>¶</a>（4）slave主机</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@slave ~]# ssh-keygen </span><br><span class=line>[root@slave ~]# for i in 1 2 3;do ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.206.20$i;done</span><br></pre></td></tr></table></figure><h4 id=4、测试ssh无交互登录><a class=header-anchor href=#4、测试ssh无交互登录>¶</a>4、测试ssh无交互登录</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line>[root@manager ~]# ssh root@192.168.206.201</span><br><span class=line>Last login: Tue Jul  7 16:24:46 2020 from 192.168.206.1</span><br><span class=line>[root@master ~]# exit</span><br><span class=line>登出</span><br><span class=line>Connection to 192.168.206.201 closed.</span><br><span class=line>[root@manager ~]# </span><br><span class=line></span><br><span class=line><span class=meta>#</span><span class=bash> 其它服务器测试省略</span></span><br></pre></td></tr></table></figure><h4 id=5、配置hosts环境><a class=header-anchor href=#5、配置hosts环境>¶</a>5、配置hosts环境</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre></td><td class=code><pre><span class=line>[root@manager ~]# vim /etc/hosts</span><br><span class=line>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class=line>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class=line></span><br><span class=line><span class=meta>#</span><span class=bash> 将4台服务器的ip和对应的主机名添加到下面</span></span><br><span class=line>192.168.206.200	manager</span><br><span class=line>192.168.206.201	master</span><br><span class=line>192.168.206.202	slave-master</span><br><span class=line>192.168.206.203	slave</span><br><span class=line></span><br><span class=line><span class=meta>#</span><span class=bash> 每台服务器的hosts文件都一样</span></span><br><span class=line>[root@manager ~]# scp /etc/hosts root@192.168.206.201:/etc/hosts</span><br><span class=line>hosts                                        100%  256   139.0KB/s   00:00    </span><br><span class=line>[root@manager ~]# scp /etc/hosts root@192.168.206.202:/etc/hosts</span><br><span class=line>hosts                                        100%  256   208.7KB/s   00:00    </span><br><span class=line>[root@manager ~]# scp /etc/hosts root@192.168.206.203:/etc/hosts</span><br><span class=line>hosts                                        100%  256   236.3KB/s   00:00</span><br></pre></td></tr></table></figure><h3 id=四、配置mysql半同步复制><a class=header-anchor href=#四、配置mysql半同步复制>¶</a>四、配置mysql半同步复制</h3><p>为了尽可能的减少主库硬件损坏宕机造成的数据丢失，因此在配置MHA的同时建议配置成MySQL的半同步复制。</p><blockquote><p>注：mysql半同步插件是由谷歌提供，具体位置/usr/local/mysql/lib/plugin/下，一个是master用的semisync_master.so，一个是slave用的semisync_slave.so。</p></blockquote><p>下面我们就来具体配置一下，如果不清楚Plugin的目录，用如下命令查找：</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; show variables like &#39;%plugin_dir%&#39;;</span><br><span class=line>+---------------+------------------------------+</span><br><span class=line>| Variable_name | Value                        |</span><br><span class=line>+---------------+------------------------------+</span><br><span class=line>| plugin_dir    | &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;lib&#x2F;plugin&#x2F; |</span><br><span class=line>+---------------+------------------------------+</span><br><span class=line>1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure><h4 id=1、主从节点安装插件><a class=header-anchor href=#1、主从节点安装插件>¶</a>1、主从节点安装插件</h4><h5 id=（1）分别在主从节点上安装相关的插件><a class=header-anchor href=#（1）分别在主从节点上安装相关的插件>¶</a>（1）分别在主从节点上安装相关的插件</h5><blockquote><p>master</p><p>Candicate master</p><p>slave</p></blockquote><p>在MySQL上安装插件需要数据库支持动态载入，检查是否支持，用如下命令检测：</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; show variables like &#39;%have_dynamic%&#39;;</span><br><span class=line>+----------------------+-------+</span><br><span class=line>| Variable_name        | Value |</span><br><span class=line>+----------------------+-------+</span><br><span class=line>| have_dynamic_loading | YES   |</span><br><span class=line>+----------------------+-------+</span><br><span class=line>1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>所有mysql数据库服务器，安装半同步插件(semisync_master.so,semisync_slave.so)</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; install plugin rpl_semi_sync_master soname &#39;semisync_master.so&#39;;</span><br><span class=line>Query OK, 0 rows affected (0.24 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; install plugin rpl_semi_sync_slave soname &#39;semisync_slave.so&#39;;</span><br><span class=line>Query OK, 0 rows affected (0.03 sec)</span><br></pre></td></tr></table></figure><p>其他mysql主机采用同样的方法安装。</p><h5 id=（2）检查Plugin是否已正确安装><a class=header-anchor href=#（2）检查Plugin是否已正确安装>¶</a>（2）检查Plugin是否已正确安装</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; show plugins;</span><br><span class=line>或</span><br><span class=line>mysql&gt; select plugin_name from information_schema.plugins;</span><br></pre></td></tr></table></figure><h5 id=（3）查看半同步相关信息><a class=header-anchor href=#（3）查看半同步相关信息>¶</a>（3）查看半同步相关信息</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; show variables like &#39;%rpl_semi_sync%&#39;;</span><br><span class=line>+-------------------------------------------+------------+</span><br><span class=line>| Variable_name                             | Value      |</span><br><span class=line>+-------------------------------------------+------------+</span><br><span class=line>| rpl_semi_sync_master_enabled              | OFF        |</span><br><span class=line>| rpl_semi_sync_master_timeout              | 10000      |</span><br><span class=line>| rpl_semi_sync_master_trace_level          | 32         |</span><br><span class=line>| rpl_semi_sync_master_wait_for_slave_count | 1          |</span><br><span class=line>| rpl_semi_sync_master_wait_no_slave        | ON         |</span><br><span class=line>| rpl_semi_sync_master_wait_point           | AFTER_SYNC |</span><br><span class=line>| rpl_semi_sync_slave_enabled               | OFF        |</span><br><span class=line>| rpl_semi_sync_slave_trace_level           | 32         |</span><br><span class=line>+-------------------------------------------+------------+</span><br><span class=line>8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>上图可以看到半同复制插件已经安装，只是还没有启用，所以是off。</p><h4 id=2、修改my-cnf文件><a class=header-anchor href=#2、修改my-cnf文件>¶</a>2、修改my.cnf文件</h4><blockquote><p>注：若主MYSQL服务器已经存在，只是后期才搭建从MYSQL服务器，在置配数据同步前应先将主<br>MYSQL服务器的要同步的数据库拷贝到从MYSQL服务器上（如先在主MYSQL上备份数据库，再用备份<br>在从MYSQL服务器上恢复）</p></blockquote><h5 id=（1）master主机><a class=header-anchor href=#（1）master主机>¶</a>（1）master主机</h5><figure class="highlight ini"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line><span class=attr>server-id</span>=<span class=number>1</span></span><br><span class=line><span class=attr>log-bin</span>=mysql-bin</span><br><span class=line><span class=attr>binlog_format</span>=mixed</span><br><span class=line><span class=attr>log-bin-index</span>=mysql-bin.index</span><br><span class=line><span class=attr>rpl_semi_sync_master_enabled</span>=<span class=number>1</span></span><br><span class=line><span class=attr>rpl_semi_sync_master_timeout</span>=<span class=number>1000</span></span><br><span class=line><span class=attr>rpl_semi_sync_slave_enabled</span>=<span class=number>1</span></span><br><span class=line><span class=attr>relay_log_purge</span>=<span class=number>0</span></span><br><span class=line><span class=attr>relay-log</span>=relay-bin</span><br><span class=line><span class=attr>relay-log-index</span>=slave-relay-bin.index</span><br></pre></td></tr></table></figure><blockquote><p>注：</p><p>rpl_semi_sync_master_enabled=1 1表是启用，0表示关闭</p><p>rpl_semi_sync_master_timeout=10000：毫秒单位 ，该参数主服务器等待确认消息10秒后，不再等待，变为异步方式。</p></blockquote><h5 id=（2）Candidate-master主机-v2><a class=header-anchor href=#（2）Candidate-master主机-v2>¶</a>（2）Candidate master主机</h5><figure class="highlight ini"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line><span class=attr>server-id</span>=<span class=number>2</span></span><br><span class=line><span class=attr>log-bin</span>=mysql-bin</span><br><span class=line><span class=attr>binlog_format</span>=mixed</span><br><span class=line><span class=attr>log-bin-index</span>=mysql-bin.index</span><br><span class=line><span class=attr>rpl_semi_sync_master_enabled</span>=<span class=number>1</span></span><br><span class=line><span class=attr>rpl_semi_sync_master_timeout</span>=<span class=number>10000</span></span><br><span class=line><span class=attr>rpl_semi_sync_slave_enabled</span>=<span class=number>1</span></span><br><span class=line><span class=attr>relay_log_purge</span>=<span class=number>0</span></span><br><span class=line><span class=attr>relay-log</span> = relay-bin</span><br><span class=line><span class=attr>relay-log-index</span> = slave-relay-bin.index</span><br></pre></td></tr></table></figure><blockquote><p>注：relay_log_purge=0，禁止 SQL 线程在执行完一个 relay log 后自动将其删除，对于MHA场景下，对<br>于某些滞后从库的恢复依赖于其他从库的relay log，因此采取禁用自动删除功能</p></blockquote><h5 id=（3）slave主机><a class=header-anchor href=#（3）slave主机>¶</a>（3）slave主机</h5><figure class="highlight ini"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line><span class=attr>server-id</span>=<span class=number>3</span></span><br><span class=line><span class=attr>log-bin</span>=mysql-bin</span><br><span class=line><span class=attr>relay-log</span> = relay-bin</span><br><span class=line><span class=attr>relay-log-index</span> = slave-relay-bin.index</span><br><span class=line><span class=attr>read_only</span>=<span class=number>1</span></span><br><span class=line><span class=attr>rpl_semi_sync_slave_enabled</span>=<span class=number>1</span></span><br></pre></td></tr></table></figure><h5 id=（4）查看半同步相关信息><a class=header-anchor href=#（4）查看半同步相关信息>¶</a>（4）查看半同步相关信息</h5><p>在所有服务器上重启mysql服务。</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>systemctl restart mysqld</span><br></pre></td></tr></table></figure><p>进入mysql，查看半同步相关信息。</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; show variables like &#39;%rpl_semi_sync%&#39;;</span><br><span class=line>+-------------------------------------------+------------+</span><br><span class=line>| Variable_name                             | Value      |</span><br><span class=line>+-------------------------------------------+------------+</span><br><span class=line>| rpl_semi_sync_master_enabled              | ON         |</span><br><span class=line>| rpl_semi_sync_master_timeout              | 1000       |</span><br><span class=line>| rpl_semi_sync_master_trace_level          | 32         |</span><br><span class=line>| rpl_semi_sync_master_wait_for_slave_count | 1          |</span><br><span class=line>| rpl_semi_sync_master_wait_no_slave        | ON         |</span><br><span class=line>| rpl_semi_sync_master_wait_point           | AFTER_SYNC |</span><br><span class=line>| rpl_semi_sync_slave_enabled               | ON         |</span><br><span class=line>| rpl_semi_sync_slave_trace_level           | 32         |</span><br><span class=line>+-------------------------------------------+------------+</span><br><span class=line>8 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><h5 id=（5）查看半同步状态><a class=header-anchor href=#（5）查看半同步状态>¶</a>（5）查看半同步状态</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; show status like &#39;%rpl_semi_sync%&#39;;</span><br><span class=line>+--------------------------------------------+-------+</span><br><span class=line>| Variable_name                              | Value |</span><br><span class=line>+--------------------------------------------+-------+</span><br><span class=line>| Rpl_semi_sync_master_clients               | 0     |</span><br><span class=line>| Rpl_semi_sync_master_net_avg_wait_time     | 0     |</span><br><span class=line>| Rpl_semi_sync_master_net_wait_time         | 0     |</span><br><span class=line>| Rpl_semi_sync_master_net_waits             | 0     |</span><br><span class=line>| Rpl_semi_sync_master_no_times              | 0     |</span><br><span class=line>| Rpl_semi_sync_master_no_tx                 | 0     |</span><br><span class=line>| Rpl_semi_sync_master_status                | ON    |</span><br><span class=line>| Rpl_semi_sync_master_timefunc_failures     | 0     |</span><br><span class=line>| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |</span><br><span class=line>| Rpl_semi_sync_master_tx_wait_time          | 0     |</span><br><span class=line>| Rpl_semi_sync_master_tx_waits              | 0     |</span><br><span class=line>| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |</span><br><span class=line>| Rpl_semi_sync_master_wait_sessions         | 0     |</span><br><span class=line>| Rpl_semi_sync_master_yes_tx                | 0     |</span><br><span class=line>| Rpl_semi_sync_slave_status                 | OFF   |</span><br><span class=line>+--------------------------------------------+-------+</span><br><span class=line>15 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>有几个状态参数值得关注的：</p><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>rpl_semi_sync_master_status ：显示主服务是异步复制模式还是半同步复制模式</span><br><span class=line>rpl_semi_sync_master_clients ：显示有多少个从服务器配置为半同步复制模式</span><br><span class=line>rpl_semi_sync_master_yes_tx ：显示从服务器确认成功提交的数量</span><br><span class=line>rpl_semi_sync_master_no_tx ：显示从服务器确认不成功提交的数量</span><br><span class=line>rpl_semi_sync_master_tx_avg_wait_time ：事务因开启 semi_sync ，平均需要额外等待的时间</span><br><span class=line>rpl_semi_sync_master_net_avg_wait_time ：事务进入等待队列后，到网络平均等待时间</span><br></pre></td></tr></table></figure><h4 id=3、配置主从同步><a class=header-anchor href=#3、配置主从同步>¶</a>3、配置主从同步</h4><h5 id=（1）master主机-v2><a class=header-anchor href=#（1）master主机-v2>¶</a>（1）master主机</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; stop slave;</span><br><span class=line>Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; grant replication slave on *.* to mharep@&#39;192.168.206.%&#39; identified by &#39;123456&#39;;</span><br><span class=line>Query OK, 0 rows affected, 1 warning (1.00 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; grant all privileges on *.* to manager@&#39;192.168.206.%&#39; identified by &#39;123456&#39;;</span><br><span class=line>Query OK, 0 rows affected, 1 warning (0.22 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; show master status;</span><br><span class=line>+------------------+----------+--------------+------------------+-------------------+</span><br><span class=line>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class=line>+------------------+----------+--------------+------------------+-------------------+</span><br><span class=line>| mysql-bin.000001 |      746 |              |                  |                   |</span><br><span class=line>+------------------+----------+--------------+------------------+-------------------+</span><br><span class=line>1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>第一条grant命令是创建一个用于主从复制的帐号，在master和candicate master的主机上创建即可。</p><p>第二条grant命令是创建MHA管理账号，所有mysql服务器上都需要执行。MHA会在配置文件里要求能远程登录到数据库，所以要进行必要的赋权。</p><h5 id=（2）Candidate-master主机-v3><a class=header-anchor href=#（2）Candidate-master主机-v3>¶</a>（2）Candidate master主机</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; stop slave;</span><br><span class=line>Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; grant replication slave on *.* to mharep@&#39;192.168.206.%&#39; identified by &#39;123456&#39;;</span><br><span class=line>Query OK, 0 rows affected, 1 warning (10.01 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; grant all privileges on *.* to manager@&#39;192.168.206.%&#39; identified by &#39;123456&#39;;</span><br><span class=line>Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; change master to master_host&#x3D;&#39;192.168.206.201&#39;,master_port&#x3D;3306,master_user&#x3D;&#39;mharep&#39;,master_password&#x3D;&#39;123456&#39;,master_log_file&#x3D;&#39;mysql-bin.000001&#39;,master_log_pos&#x3D;746;</span><br><span class=line>Query OK, 0 rows affected, 2 warnings (0.04 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; start slave;</span><br><span class=line>Query OK, 0 rows affected (0.00 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; show slave status\G</span><br><span class=line>*************************** 1. row ***************************</span><br><span class=line>               Slave_IO_State: Waiting for master to send event</span><br><span class=line>                  Master_Host: 192.168.206.201</span><br><span class=line>                  Master_User: mharep</span><br><span class=line>                  Master_Port: 3306</span><br><span class=line>                Connect_Retry: 60</span><br><span class=line>              Master_Log_File: mysql-bin.000001</span><br><span class=line>          Read_Master_Log_Pos: 154</span><br><span class=line>               Relay_Log_File: relay-bin.000002</span><br><span class=line>                Relay_Log_Pos: 320</span><br><span class=line>        Relay_Master_Log_File: mysql-bin.000001</span><br><span class=line>             Slave_IO_Running: Yes</span><br><span class=line>            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><p>查看从的状态，以下两个值必须为yes，代表从服务器能正常连接主服务器。</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>Slave_IO_Running:Yes</span><br><span class=line>Slave_SQL_Running:Yes</span><br></pre></td></tr></table></figure><h5 id=（3）slave主机-v2><a class=header-anchor href=#（3）slave主机-v2>¶</a>（3）slave主机</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; stop slave;</span><br><span class=line>Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; grant all privileges on *.* to manager@&#39;192.168.206.%&#39; identified by &#39;123456&#39;;</span><br><span class=line>Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; change master to master_host&#x3D;&#39;192.168.206.201&#39;,master_port&#x3D;3306,master_user&#x3D;&#39;mharep&#39;,master_password&#x3D;&#39;123456&#39;,master_log_file&#x3D;&#39;mysql-bin.000001&#39;,master_log_pos&#x3D;746;</span><br><span class=line>Query OK, 0 rows affected, 2 warnings (0.03 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; start slave;</span><br><span class=line>Query OK, 0 rows affected (0.00 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; show slave status\G</span><br><span class=line>*************************** 1. row ***************************</span><br><span class=line>               Slave_IO_State: Waiting for master to send event</span><br><span class=line>                  Master_Host: 192.168.206.201</span><br><span class=line>                  Master_User: mharep</span><br><span class=line>                  Master_Port: 3306</span><br><span class=line>                Connect_Retry: 60</span><br><span class=line>              Master_Log_File: mysql-bin.000001</span><br><span class=line>          Read_Master_Log_Pos: 154</span><br><span class=line>               Relay_Log_File: relay-bin.000002</span><br><span class=line>                Relay_Log_Pos: 320</span><br><span class=line>        Relay_Master_Log_File: mysql-bin.000001</span><br><span class=line>             Slave_IO_Running: Yes</span><br><span class=line>            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><p>查看从的状态，以下两个值必须为yes，代表从服务器能正常连接主服务器。</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>Slave_IO_Running:Yes</span><br><span class=line>Slave_SQL_Running:Yes</span><br></pre></td></tr></table></figure><h5 id=（4）查看master服务器的半同步状态><a class=header-anchor href=#（4）查看master服务器的半同步状态>¶</a>（4）查看master服务器的半同步状态</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; show status like &#39;%rpl_semi_sync%&#39;;</span><br><span class=line>+--------------------------------------------+-------+</span><br><span class=line>| Variable_name                              | Value |</span><br><span class=line>+--------------------------------------------+-------+</span><br><span class=line>| Rpl_semi_sync_master_clients               | 2     |</span><br><span class=line>| Rpl_semi_sync_master_net_avg_wait_time     | 0     |</span><br><span class=line>| Rpl_semi_sync_master_net_wait_time         | 0     |</span><br><span class=line>| Rpl_semi_sync_master_net_waits             | 0     |</span><br><span class=line>| Rpl_semi_sync_master_no_times              | 0     |</span><br><span class=line>| Rpl_semi_sync_master_no_tx                 | 0     |</span><br><span class=line>| Rpl_semi_sync_master_status                | ON    |</span><br><span class=line>| Rpl_semi_sync_master_timefunc_failures     | 0     |</span><br><span class=line>| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |</span><br><span class=line>| Rpl_semi_sync_master_tx_wait_time          | 0     |</span><br><span class=line>| Rpl_semi_sync_master_tx_waits              | 0     |</span><br><span class=line>| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |</span><br><span class=line>| Rpl_semi_sync_master_wait_sessions         | 0     |</span><br><span class=line>| Rpl_semi_sync_master_yes_tx                | 0     |</span><br><span class=line>| Rpl_semi_sync_slave_status                 | OFF   |</span><br><span class=line>+--------------------------------------------+-------+</span><br><span class=line>15 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>rpl_semi_sync_master_clients ：显示有2个从服务器配置为半同步复制模式。</p><h3 id=五、配置mysql-mha><a class=header-anchor href=#五、配置mysql-mha>¶</a>五、配置mysql-mha</h3><p>mha包括manager节点和data节点：</p><ul><li><p>data节点：包括原有的MySQL复制结构中的主机，至少3台，即1主2从，当masterfailover后，还能保证主从结构；只需安装node包。</p></li><li><p>manager节点：运行监控脚本，负责monitoring 和 auto-failover；需要安装node包和manager包。</p></li></ul><h4 id=1、-在所有主机上安装mha所依赖的软件包><a class=header-anchor href=#1、-在所有主机上安装mha所依赖的软件包>¶</a>1、 在所有主机上安装mha所依赖的软件包</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>yum -y install perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Config-IniFiles ncftp perl-Params-Validate perl-CPAN perl-Test-Mock-LWP.noarch perl-LWP-Authen-Negotiate.noarch perl-devel perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker</span><br></pre></td></tr></table></figure><h4 id=2、-安装mha4mysql-node><a class=header-anchor href=#2、-安装mha4mysql-node>¶</a>2、 安装mha4mysql-node</h4><blockquote><p>需要2个管理节点（4台服务器）都安装</p></blockquote><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>tar zxvf mha4mysql-node-0.58.tar.gz</span><br><span class=line>cd mha4mysql-node-0.58/</span><br><span class=line>perl Makefile.PL</span><br><span class=line>make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>在3台数据库节点只要安装mha4mysql-node。</p><h4 id=3、安装mha4mysql-manager><a class=header-anchor href=#3、安装mha4mysql-manager>¶</a>3、安装mha4mysql-manager</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>tar zxvf mha4mysql-manager-0.58.tar.gz </span><br><span class=line>cd mha4mysql-manager-0.58/</span><br><span class=line>perl Makefile.PL</span><br><span class=line>make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>在管理节点需要mha4mysql-node和mha4mysql-manager都安装。</p><p>根据提示输入：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@manager mha4mysql-manager-0.58]# mkdir /etc/masterha</span><br><span class=line>[root@manager mha4mysql-manager-0.58]# mkdir -p /masterha/app1</span><br><span class=line>[root@manager mha4mysql-manager-0.58]# mkdir /scripts</span><br><span class=line>[root@manager mha4mysql-manager-0.58]# cp samples/conf/* /etc/masterha/</span><br><span class=line>[root@manager mha4mysql-manager-0.58]# cp samples/scripts/* /scripts/</span><br></pre></td></tr></table></figure><h4 id=4、配置mha><a class=header-anchor href=#4、配置mha>¶</a>4、配置mha</h4><p>与绝大多数Linux应用程序类似，MHA的正确使用依赖于合理的配置文件。MHA的配置文件与mysql的my.cnf文件配置相似，采取的是param=value的方式来配置。配置文件位于管理节点，通常包括每一个mysql server的主机名、mysql用户名、密码、工作目录等等。</p><h5 id=（1）编辑mha配置文件><a class=header-anchor href=#（1）编辑mha配置文件>¶</a>（1）编辑mha配置文件</h5><p>编辑/etc/masterha/app1.conf，内容如下：</p><figure class="highlight ini"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre></td><td class=code><pre><span class=line><span class=section>[server default]</span></span><br><span class=line><span class=attr>manager_workdir</span>=/masterha/app1</span><br><span class=line><span class=attr>manager_log</span>=/masterha/app1/manager.log</span><br><span class=line><span class=attr>user</span>=manager</span><br><span class=line><span class=attr>password</span>=<span class=number>123456</span></span><br><span class=line><span class=attr>ssh_user</span>=root</span><br><span class=line><span class=attr>repl_user</span>=mharep</span><br><span class=line><span class=attr>repl_password</span>=<span class=number>123456</span></span><br><span class=line><span class=attr>ping_interval</span>=<span class=number>1</span></span><br><span class=line></span><br><span class=line><span class=section>[server1]</span></span><br><span class=line><span class=attr>hostname</span>=<span class=number>192.168</span>.<span class=number>206.201</span></span><br><span class=line><span class=attr>port</span>=<span class=number>3306</span></span><br><span class=line><span class=attr>master_binlog_dir</span>=/usr/local/mysql/data</span><br><span class=line><span class=attr>candidate_master</span>=<span class=number>1</span></span><br><span class=line></span><br><span class=line><span class=section>[server2]</span></span><br><span class=line><span class=attr>hostname</span>=<span class=number>192.168</span>.<span class=number>206.202</span></span><br><span class=line><span class=attr>port</span>=<span class=number>3306</span></span><br><span class=line><span class=attr>master_binlog_dir</span>=/usr/local/mysql/data</span><br><span class=line><span class=attr>candidate_master</span>=<span class=number>1</span></span><br><span class=line></span><br><span class=line><span class=section>[server3]</span></span><br><span class=line><span class=attr>hostname</span>=<span class=number>192.168</span>.<span class=number>206.203</span></span><br><span class=line><span class=attr>port</span>=<span class=number>3306</span></span><br><span class=line><span class=attr>master_binlog_dir</span>=/usr/local/mysql/data</span><br><span class=line><span class=attr>no_master</span>=<span class=number>1</span></span><br></pre></td></tr></table></figure><p>保存并退出。</p><h5 id=（2）配关配置项的解释><a class=header-anchor href=#（2）配关配置项的解释>¶</a>（2）配关配置项的解释</h5><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre></td><td class=code><pre><span class=line>manager_workdir=/masterha/app1 //设置manager的工作目录</span><br><span class=line></span><br><span class=line>manager_log=/masterha/app1/manager.log //设置manager的日志 </span><br><span class=line></span><br><span class=line>user=manager //设置监控用户manager</span><br><span class=line></span><br><span class=line>password=123456 //监控用户manager的密码</span><br><span class=line></span><br><span class=line>ssh_user=root //ssh连接用户 </span><br><span class=line></span><br><span class=line>repl_user=mharep //主从复制用户</span><br><span class=line></span><br><span class=line>repl_password=123.abc //主从复制用户密码</span><br><span class=line></span><br><span class=line>ping_interval=1 //设置监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行railover</span><br><span class=line></span><br><span class=line>master_binlog_dir=/usr/local/mysql/data //设置master 保存binlog的位置，以便MHA可以找到master的日志，我这里的也就是mysql的数据目录 </span><br><span class=line></span><br><span class=line>candidate_master=1 //设置为候选master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库。</span><br></pre></td></tr></table></figure><h5 id=（3）SSH-有效性验证><a class=header-anchor href=#（3）SSH-有效性验证>¶</a>（3）SSH 有效性验证</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line>[root@manager ~]# masterha_check_ssh --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf</span><br><span class=line>Tue Jul  7 18:53:32 2020 - [info] Reading default configuration from /etc/masterha/masterha_default.cnf..</span><br><span class=line>Tue Jul  7 18:53:32 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class=line>Tue Jul  7 18:53:32 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class=line>Tue Jul  7 18:53:32 2020 - [info] Starting SSH connection tests..</span><br><span class=line>Tue Jul  7 18:53:34 2020 - [debug] </span><br><span class=line>Tue Jul  7 18:53:32 2020 - [debug]  Connecting via SSH from root@192.168.206.201(192.168.206.201:22) to root@192.168.206.202(192.168.206.202:22)..</span><br><span class=line>Tue Jul  7 18:53:33 2020 - [debug]   ok.</span><br><span class=line>Tue Jul  7 18:53:33 2020 - [debug]  Connecting via SSH from root@192.168.206.201(192.168.206.201:22) to root@192.168.206.203(192.168.206.203:22)..</span><br><span class=line>Tue Jul  7 18:53:34 2020 - [debug]   ok.</span><br><span class=line>Tue Jul  7 18:53:35 2020 - [debug] </span><br><span class=line>Tue Jul  7 18:53:32 2020 - [debug]  Connecting via SSH from root@192.168.206.202(192.168.206.202:22) to root@192.168.206.201(192.168.206.201:22)..</span><br><span class=line>Tue Jul  7 18:53:33 2020 - [debug]   ok.</span><br><span class=line>Tue Jul  7 18:53:33 2020 - [debug]  Connecting via SSH from root@192.168.206.202(192.168.206.202:22) to root@192.168.206.203(192.168.206.203:22)..</span><br><span class=line>Tue Jul  7 18:53:34 2020 - [debug]   ok.</span><br><span class=line>Tue Jul  7 18:53:35 2020 - [debug] </span><br><span class=line>Tue Jul  7 18:53:33 2020 - [debug]  Connecting via SSH from root@192.168.206.203(192.168.206.203:22) to root@192.168.206.201(192.168.206.201:22)..</span><br><span class=line>Tue Jul  7 18:53:34 2020 - [debug]   ok.</span><br><span class=line>Tue Jul  7 18:53:34 2020 - [debug]  Connecting via SSH from root@192.168.206.203(192.168.206.203:22) to root@192.168.206.202(192.168.206.202:22)..</span><br><span class=line>Tue Jul  7 18:53:35 2020 - [debug]   ok.</span><br><span class=line>Tue Jul  7 18:53:35 2020 - [info] All SSH connection tests passed successfully.</span><br></pre></td></tr></table></figure><h5 id=（4）集群复制的有效性验证><a class=header-anchor href=#（4）集群复制的有效性验证>¶</a>（4）集群复制的有效性验证</h5><blockquote><p>mysql必须都启动</p></blockquote><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br></pre></td><td class=code><pre><span class=line>[root@manager ~]# masterha_check_ssh --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf</span><br><span class=line>Tue Jul  7 18:53:32 2020 - [info] Reading default configuration from /etc/masterha/masterha_default.cnf..</span><br><span class=line>Tue Jul  7 18:53:32 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class=line>Tue Jul  7 18:53:32 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class=line>Tue Jul  7 18:53:32 2020 - [info] Starting SSH connection tests..</span><br><span class=line>Tue Jul  7 18:53:34 2020 - [debug] </span><br><span class=line>Tue Jul  7 18:53:32 2020 - [debug]  Connecting via SSH from root@192.168.206.201(192.168.206.201:22) to root@192.168.206.202(192.168.206.202:22)..</span><br><span class=line>Tue Jul  7 18:53:33 2020 - [debug]   ok.</span><br><span class=line>Tue Jul  7 18:53:33 2020 - [debug]  Connecting via SSH from root@192.168.206.201(192.168.206.201:22) to root@192.168.206.203(192.168.206.203:22)..</span><br><span class=line>Tue Jul  7 18:53:34 2020 - [debug]   ok.</span><br><span class=line>Tue Jul  7 18:53:35 2020 - [debug] </span><br><span class=line>Tue Jul  7 18:53:32 2020 - [debug]  Connecting via SSH from root@192.168.206.202(192.168.206.202:22) to root@192.168.206.201(192.168.206.201:22)..</span><br><span class=line>Tue Jul  7 18:53:33 2020 - [debug]   ok.</span><br><span class=line>Tue Jul  7 18:53:33 2020 - [debug]  Connecting via SSH from root@192.168.206.202(192.168.206.202:22) to root@192.168.206.203(192.168.206.203:22)..</span><br><span class=line>Tue Jul  7 18:53:34 2020 - [debug]   ok.</span><br><span class=line>Tue Jul  7 18:53:35 2020 - [debug] </span><br><span class=line>Tue Jul  7 18:53:33 2020 - [debug]  Connecting via SSH from root@192.168.206.203(192.168.206.203:22) to root@192.168.206.201(192.168.206.201:22)..</span><br><span class=line>Tue Jul  7 18:53:34 2020 - [debug]   ok.</span><br><span class=line>Tue Jul  7 18:53:34 2020 - [debug]  Connecting via SSH from root@192.168.206.203(192.168.206.203:22) to root@192.168.206.202(192.168.206.202:22)..</span><br><span class=line>Tue Jul  7 18:53:35 2020 - [debug]   ok.</span><br><span class=line>Tue Jul  7 18:53:35 2020 - [info] All SSH connection tests passed successfully.</span><br><span class=line></span><br><span class=line>[root@manager ~]# masterha_check_repl --global_conf=/etc/masterha/masterha_default.cnf --conf=/etc/masterha/app1.cnf</span><br><span class=line>Tue Jul  7 18:56:57 2020 - [info] Reading default configuration from /etc/masterha/masterha_default.cnf..</span><br><span class=line>Tue Jul  7 18:56:58 2020 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class=line>Tue Jul  7 18:56:58 2020 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class=line>Tue Jul  7 18:56:58 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info] GTID failover mode = 0</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info] Dead Servers:</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info] Alive Servers:</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info]   192.168.206.201(192.168.206.201:3306)</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info]   192.168.206.202(192.168.206.202:3306)</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info]   192.168.206.203(192.168.206.203:3306)</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info] Alive Slaves:</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info]   192.168.206.202(192.168.206.202:3306)  Version=5.7.22-log (oldest major version between slaves) log-bin:enabled</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info]     Replicating from 192.168.206.201(192.168.206.201:3306)</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info]   192.168.206.203(192.168.206.203:3306)  Version=5.7.22-log (oldest major version between slaves) log-bin:enabled</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info]     Replicating from 192.168.206.201(192.168.206.201:3306)</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info]     Not candidate for the new Master (no_master is set)</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info] Current Alive Master: 192.168.206.201(192.168.206.201:3306)</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info] Checking slave configurations..</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info]  read_only=1 is not set on slave 192.168.206.202(192.168.206.202:3306).</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [warning]  relay_log_purge=0 is not set on slave 192.168.206.203(192.168.206.203:3306).</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info] Checking replication filtering settings..</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info]  Replication filtering check ok.</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info] GTID (with auto-pos) is not supported</span><br><span class=line>Tue Jul  7 18:56:59 2020 - [info] Starting SSH connection tests..</span><br><span class=line>Tue Jul  7 18:57:02 2020 - [info] All SSH connection tests passed successfully.</span><br><span class=line>Tue Jul  7 18:57:02 2020 - [info] Checking MHA Node version..</span><br><span class=line>Tue Jul  7 18:57:03 2020 - [info]  Version check ok.</span><br><span class=line>Tue Jul  7 18:57:03 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class=line>Tue Jul  7 18:57:04 2020 - [info] HealthCheck: SSH to 192.168.206.201 is reachable.</span><br><span class=line>Tue Jul  7 18:57:04 2020 - [info] Master MHA Node version is 0.58.</span><br><span class=line>Tue Jul  7 18:57:04 2020 - [info] Checking recovery script configurations on 192.168.206.201(192.168.206.201:3306)..</span><br><span class=line>Tue Jul  7 18:57:04 2020 - [info]   Executing command: save_binary_logs --command=test --start_pos=4 --binlog_dir=/usr/local/mysql/data --output_file=/data/log/masterha/save_binary_logs_test --manager_version=0.58 --start_file=mysql-bin.000001 </span><br><span class=line>Tue Jul  7 18:57:04 2020 - [info]   Connecting to root@192.168.206.201(192.168.206.201:22).. </span><br><span class=line>  Creating /data/log/masterha if not exists.. Creating directory /data/log/masterha.. done.</span><br><span class=line>   ok.</span><br><span class=line>  Checking output directory is accessible or not..</span><br><span class=line>   ok.</span><br><span class=line>  Binlog found at /usr/local/mysql/data, up to mysql-bin.000001</span><br><span class=line>Tue Jul  7 18:57:05 2020 - [info] Binlog setting check done.</span><br><span class=line>Tue Jul  7 18:57:05 2020 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..</span><br><span class=line>Tue Jul  7 18:57:05 2020 - [info]   Executing command : apply_diff_relay_logs --command=test --slave_user='manager' --slave_host=192.168.206.202 --slave_ip=192.168.206.202 --slave_port=3306 --workdir=/data/log/masterha --target_version=5.7.22-log --manager_version=0.58 --relay_log_info=/usr/local/mysql/data/relay-log.info  --relay_dir=/usr/local/mysql/data/  --slave_pass=xxx</span><br><span class=line>Tue Jul  7 18:57:05 2020 - [info]   Connecting to root@192.168.206.202(192.168.206.202:22).. </span><br><span class=line>Creating directory /data/log/masterha.. done.</span><br><span class=line>  Checking slave recovery environment settings..</span><br><span class=line>    Opening /usr/local/mysql/data/relay-log.info ... ok.</span><br><span class=line>    Relay log found at /usr/local/mysql/data, up to relay-bin.000003</span><br><span class=line>    Temporary relay log file is /usr/local/mysql/data/relay-bin.000003</span><br><span class=line>    Checking if super_read_only is defined and turned on.. not present or turned off, ignoring.</span><br><span class=line>    Testing mysql connection and privileges..</span><br><span class=line>mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class=line> done.</span><br><span class=line>    Testing mysqlbinlog output.. done.</span><br><span class=line>    Cleaning up test file(s).. done.</span><br><span class=line>Tue Jul  7 18:57:06 2020 - [info]   Executing command : apply_diff_relay_logs --command=test --slave_user='manager' --slave_host=192.168.206.203 --slave_ip=192.168.206.203 --slave_port=3306 --workdir=/data/log/masterha --target_version=5.7.22-log --manager_version=0.58 --relay_log_info=/usr/local/mysql/data/relay-log.info  --relay_dir=/usr/local/mysql/data/  --slave_pass=xxx</span><br><span class=line>Tue Jul  7 18:57:06 2020 - [info]   Connecting to root@192.168.206.203(192.168.206.203:22).. </span><br><span class=line>Creating directory /data/log/masterha.. done.</span><br><span class=line>  Checking slave recovery environment settings..</span><br><span class=line>    Opening /usr/local/mysql/data/relay-log.info ... ok.</span><br><span class=line>    Relay log found at /usr/local/mysql/data, up to relay-bin.000003</span><br><span class=line>    Temporary relay log file is /usr/local/mysql/data/relay-bin.000003</span><br><span class=line>    Checking if super_read_only is defined and turned on.. not present or turned off, ignoring.</span><br><span class=line>    Testing mysql connection and privileges..</span><br><span class=line>mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class=line> done.</span><br><span class=line>    Testing mysqlbinlog output.. done.</span><br><span class=line>    Cleaning up test file(s).. done.</span><br><span class=line>Tue Jul  7 18:57:06 2020 - [info] Slaves settings check done.</span><br><span class=line>Tue Jul  7 18:57:06 2020 - [info] </span><br><span class=line>192.168.206.201(192.168.206.201:3306) (current master)</span><br><span class=line> +--192.168.206.202(192.168.206.202:3306)</span><br><span class=line> +--192.168.206.203(192.168.206.203:3306)</span><br><span class=line></span><br><span class=line>Tue Jul  7 18:57:06 2020 - [info] Checking replication health on 192.168.206.202..</span><br><span class=line>Tue Jul  7 18:57:06 2020 - [info]  ok.</span><br><span class=line>Tue Jul  7 18:57:06 2020 - [info] Checking replication health on 192.168.206.203..</span><br><span class=line>Tue Jul  7 18:57:06 2020 - [info]  ok.</span><br><span class=line>Tue Jul  7 18:57:06 2020 - [warning] master_ip_failover_script is not defined.</span><br><span class=line>Tue Jul  7 18:57:06 2020 - [warning] shutdown_script is not defined.</span><br><span class=line>Tue Jul  7 18:57:06 2020 - [info] Got exit code 0 (Not master dead).</span><br><span class=line></span><br><span class=line>MySQL Replication Health is OK.</span><br></pre></td></tr></table></figure><p>验证成功的话会自动识别出所有服务器和主从状况。</p><p>注：在验证时，若遇到这个错误：Can’t exec “mysqlbinlog” … 解决方法是在所有服务器上执行：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>ln -s /usr/local/mysql/bin/* /usr/local/bin/</span><br></pre></td></tr></table></figure><h5 id=（5）启动-manager><a class=header-anchor href=#（5）启动-manager>¶</a>（5）启动 manager</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>[root@manager ~]# nohup masterha_manager --conf=/etc/masterha/app1.cnf&amp; &gt;/tmp/mha_manager.log &amp;</span><br><span class=line>[1] 55707</span><br><span class=line>[root@manager ~]# nohup: 忽略输入并把输出追加到"nohup.out"</span><br></pre></td></tr></table></figure><blockquote><p>注：在应用Unix/Linux时，我们一般想让某个程序在后台运行，于是我们将常会用 &amp; 在程序结尾来让程<br>序自动运行。比如我们要运行mysql在后台： /usr/local/mysql/bin/mysqld_safe –user=mysql &amp;。可是<br>有很多程序并不想mysqld一样，这样我们就需要nohup命令，</p></blockquote><h5 id=（6）状态检查><a class=header-anchor href=#（6）状态检查>¶</a>（6）状态检查</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@manager ~]# masterha_check_status --conf=/etc/masterha/app1.cnf</span><br><span class=line>app1 (pid:55707) is running(0:PING_OK), master:192.168.206.201</span><br></pre></td></tr></table></figure><h5 id=（7）故障转移验证-自动failover><a class=header-anchor href=#（7）故障转移验证-自动failover>¶</a>（7）故障转移验证(自动failover)</h5><p>master dead后，MHA当时已经开启，候选Master库（Slave）会自动failover为Master。</p><p>验证的方式是先停掉 master（192.168.206.201），因为之前的配置文件中，把Candicate master(192.168.206.202)作为了候选人，那么就到 slave(192.168.206.203) 上查看 master 的 IP 是否变为了 slave-master 的 IP。</p><h6 id=1）停掉-master><a class=header-anchor href=#1）停掉-master>¶</a>1）停掉 master</h6><p>在master（192.168.206.201） 上把 mysql 停掉。</p><h6 id=2）查看-MHA-日志><a class=header-anchor href=#2）查看-MHA-日志>¶</a>2）查看 MHA 日志</h6><p>上面的配置文件中指定了日志位置为/masterha/app1/manager.log。</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre></td><td class=code><pre><span class=line>[root@manager ~]# cat /masterha/app1/manager.log</span><br><span class=line>----- Failover Report -----</span><br><span class=line></span><br><span class=line>app1: MySQL Master failover 192.168.206.201(192.168.206.201:3306) to 192.168.206.202(192.168.206.202:3306) succeeded</span><br><span class=line></span><br><span class=line>Master 192.168.206.201(192.168.206.201:3306) is down!</span><br><span class=line></span><br><span class=line>Check MHA Manager logs at manager:/masterha/app1/manager.log for details.</span><br><span class=line></span><br><span class=line>Started automated(non-interactive) failover.</span><br><span class=line>The latest slave 192.168.206.202(192.168.206.202:3306) has all relay logs for recovery.</span><br><span class=line>Selected 192.168.206.202(192.168.206.202:3306) as a new master.</span><br><span class=line>192.168.206.202(192.168.206.202:3306): OK: Applying all logs succeeded.</span><br><span class=line>192.168.206.203(192.168.206.203:3306): This host has the latest relay log events.</span><br><span class=line>Generating relay diff files from the latest slave succeeded.</span><br><span class=line>192.168.206.203(192.168.206.203:3306): OK: Applying all logs succeeded. Slave started, replicating from 192.168.206.202(192.168.206.202:3306)</span><br><span class=line>192.168.206.202(192.168.206.202:3306): Resetting slave info succeeded.</span><br><span class=line>Master failover to 192.168.206.202(192.168.206.202:3306) completed successfully.</span><br></pre></td></tr></table></figure><p>从日志信息中可以看到 master failover 已经成功了，并可以看出故障转移的大体流程</p><h6 id=3）检查-slave的复制><a class=header-anchor href=#3）检查-slave的复制>¶</a>3）检查 slave的复制</h6><p>登录 slave（192.168.206.203） 的Mysql，查看 slave 状态：</p><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; show slave status \G</span><br><span class=line>*************************** 1. row ***************************</span><br><span class=line>               Slave_IO_State: Waiting for master to send event</span><br><span class=line>                  Master_Host: 192.168.206.202</span><br><span class=line>                  Master_User: mharep</span><br><span class=line>                  Master_Port: 3306</span><br><span class=line>                Connect_Retry: 60</span><br><span class=line>              Master_Log_File: mysql-bin.000004</span><br><span class=line>          Read_Master_Log_Pos: 154</span><br><span class=line>               Relay_Log_File: relay-bin.000002</span><br><span class=line>                Relay_Log_Pos: 320</span><br><span class=line>        Relay_Master_Log_File: mysql-bin.000004</span><br><span class=line>             Slave_IO_Running: Yes</span><br><span class=line>            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><p>可以看到 master 的 IP 现在为 192.168.206.202，已经切换到和192.168.206.202同步了。</p><p>本来是和192.168.206.201同步的，说明 MHA 已经把Candicate master(192.168.206.202) 提升为了新的 master，IO线程和SQL线程也正确运行，MHA搭建成功。</p><h3 id=六、MHA-Manager端日常主要操作步骤><a class=header-anchor href=#六、MHA-Manager端日常主要操作步骤>¶</a>六、MHA Manager端日常主要操作步骤</h3><h4 id=1、检查是否有下列文件，有则删除。><a class=header-anchor href=#1、检查是否有下列文件，有则删除。>¶</a>1、检查是否有下列文件，有则删除。</h4><p>发生主从切换后，MHAmanager服务会自动停掉，且在manager_workdir（/masterha/app1）目录下面生成文件app1.failover.complete。</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>[root@manager ~]# ll /masterha/app1/</span><br><span class=line>总用量 24</span><br><span class=line>-rw-r--r--. 1 root root     0 7月   7 19:07 app1.failover.complete</span><br><span class=line>-rw-r--r--. 1 root root 22192 7月   7 19:07 manager.log</span><br></pre></td></tr></table></figure><p>若要启动MHA，必须先确保无此文件， 如果有这个提示，那么删除此文件。</p><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>[error]</span><br><span class=line>[/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln298] </span><br><span class=line>Last failover was done at 2015/01/09 10:00:47.Current time is too early to do failover again. If you want to do failover, manually remove /masterha/app1/app1.failover.complete and run this script again.</span><br></pre></td></tr></table></figure><h4 id=2、检查MHA复制检查><a class=header-anchor href=#2、检查MHA复制检查>¶</a>2、检查MHA复制检查</h4><p>需要把master设置成candidate的从服务器</p><h5 id=（1）查看candidate的从服务器（192-168-206-202）的二进制日志><a class=header-anchor href=#（1）查看candidate的从服务器（192-168-206-202）的二进制日志>¶</a>（1）查看candidate的从服务器（192.168.206.202）的二进制日志</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; show master status\G</span><br><span class=line>*************************** 1. row ***************************</span><br><span class=line>             File: mysql-bin.000004</span><br><span class=line>         Position: 154</span><br></pre></td></tr></table></figure><h5 id=（2）将master服务器设置为candidate的从服务器><a class=header-anchor href=#（2）将master服务器设置为candidate的从服务器>¶</a>（2）将master服务器设置为candidate的从服务器</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line>[root@master ~]# systemctl start mysqld</span><br><span class=line>[root@master ~]# mysql -uroot -p</span><br><span class=line></span><br><span class=line>mysql&gt; change master to master_host&#x3D;&#39;192.168.206.202&#39;,master_port&#x3D;3306,master_user&#x3D;&#39;mharep&#39;,master_password&#x3D;&#39;123456&#39;,master_log_file&#x3D;&#39;mysql-bin.000004&#39;,master_log_pos&#x3D;154;</span><br><span class=line>Query OK, 0 rows affected, 2 warnings (0.00 sec)</span><br><span class=line></span><br><span class=line>mysql&gt; start slave;</span><br><span class=line>Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre></td><td class=code><pre><span class=line>[root@manager ~]# masterha_check_repl --conf=/etc/masterha/app1.cnf</span><br><span class=line></span><br><span class=line><span class=meta>#</span><span class=bash> 省略部分输出信息</span></span><br><span class=line></span><br><span class=line>Tue Jul  7 19:31:44 2020 - [info] Slaves settings check done.</span><br><span class=line>Tue Jul  7 19:31:44 2020 - [info] </span><br><span class=line>192.168.206.202(192.168.206.202:3306) (current master)</span><br><span class=line> +--192.168.206.201(192.168.206.201:3306)</span><br><span class=line> +--192.168.206.203(192.168.206.203:3306)</span><br><span class=line></span><br><span class=line>Tue Jul  7 19:31:44 2020 - [info] Checking replication health on 192.168.206.201..</span><br><span class=line>Tue Jul  7 19:31:44 2020 - [info]  ok.</span><br><span class=line>Tue Jul  7 19:31:44 2020 - [info] Checking replication health on 192.168.206.203..</span><br><span class=line>Tue Jul  7 19:31:44 2020 - [info]  ok.</span><br><span class=line>Tue Jul  7 19:31:44 2020 - [warning] master_ip_failover_script is not defined.</span><br><span class=line>Tue Jul  7 19:31:44 2020 - [warning] shutdown_script is not defined.</span><br><span class=line>Tue Jul  7 19:31:44 2020 - [info] Got exit code 0 (Not master dead).</span><br><span class=line></span><br><span class=line>MySQL Replication Health is OK.</span><br></pre></td></tr></table></figure><h4 id=3、停止MHA><a class=header-anchor href=#3、停止MHA>¶</a>3、停止MHA</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>masterha_stop --conf=/etc/masterha/app1.cnf</span><br></pre></td></tr></table></figure><h4 id=4、启动MHA><a class=header-anchor href=#4、启动MHA>¶</a>4、启动MHA</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;&gt;/tmp/mha_manager.log &amp;</span><br></pre></td></tr></table></figure><p>当有slave 节点宕掉时，默认是启动不了的，加上 --ignore_fail_on_start 即使有节点宕掉也能启动MHA，如下：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>nohup masterha_manager --conf=/etc/masterha/app1.cnf --ignore_fail_on_start &amp; &gt;/tmp/mha_manager.log &amp;</span><br></pre></td></tr></table></figure><h4 id=5、检查状态><a class=header-anchor href=#5、检查状态>¶</a>5、检查状态</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>masterha_check_status --conf=/etc/masterha /app1.cnf</span><br></pre></td></tr></table></figure><h4 id=6、检查日志><a class=header-anchor href=#6、检查日志>¶</a>6、检查日志</h4><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>tail -f /masterha/app1/manager.log</span><br></pre></td></tr></table></figure><h4 id=7、主从切换后续工作><a class=header-anchor href=#7、主从切换后续工作>¶</a>7、主从切换后续工作</h4><h5 id=（1）重构><a class=header-anchor href=#（1）重构>¶</a>（1）重构</h5><p>重构就是你的主挂了，切换到Candidate master上，Candidate master变成了主</p><h5 id=（2）重构的两种方案><a class=header-anchor href=#（2）重构的两种方案>¶</a>（2）重构的两种方案</h5><p>1）原主库修复成一个新的slave 主库切换后，把原主库修复成新从库，然后重新执行以上5步。</p><p>2）原主库数据文件完整的情况下，可通过以下方式找出最后执行的CHANGE MASTER命令：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre></td><td class=code><pre><span class=line>[root@manager ~]# grep "CHANGE MASTER TO MASTER" /masterha/app1/manager.log | tail -1</span><br><span class=line>Tue Jul  7 19:07:08 2020 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='192.168.206.202', MASTER_PORT=3306, MASTER_LOG_FILE='mysql-bin.000004', MASTER_LOG_POS=154, MASTER_USER='mharep', MASTER_PASSWORD='xxx';</span><br><span class=line></span><br><span class=line>[root@manager ~]# mysql -uroot -p</span><br><span class=line></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> CHANGE MASTER TO MASTER_HOST=<span class=string>'192.168.206.202'</span>, MASTER_PORT=3306, MASTER_LOG_FILE=<span class=string>'mysql-bin.000004'</span>, MASTER_LOG_POS=154, MASTER_USER=<span class=string>'mharep'</span>, MASTER_PASSWORD=<span class=string>'123456'</span>;</span></span><br><span class=line>Query OK, 0 rows affected, 2 warnings (0.01 sec)</span><br><span class=line></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> start slave;</span></span><br><span class=line>Query OK, 0 rows affected (0.00 sec)</span><br><span class=line></span><br><span class=line><span class=meta>mysql&gt;</span><span class=bash> show slave status\G</span></span><br><span class=line>*************************** 1. row ***************************</span><br><span class=line>                Slave_IO_State: Waiting for master to send event</span><br><span class=line>                Master_Host: 192.168.18.6</span><br><span class=line>                Master_User: mharep</span><br><span class=line>                Master_Port: 3306</span><br><span class=line>                Connect_Retry: 60</span><br><span class=line>                Master_Log_File: mysql-bin.000002</span><br><span class=line>                Read_Master_Log_Pos: 154</span><br><span class=line>                Relay_Log_File: relay-bin.000002</span><br><span class=line>                Relay_Log_Pos: 320</span><br><span class=line>                Relay_Master_Log_File: mysql-bin.000002</span><br><span class=line>                Slave_IO_Running: Yes</span><br><span class=line>                Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><p>3）启动manager</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@manager ~]# nohup masterha_manager --conf=/etc/masterha/app1.cnf&amp; &gt;/tmp/mha_manager.log &amp;</span><br><span class=line>[1] 55707</span><br><span class=line></span><br><span class=line>[root@manager ~]# masterha_check_status --conf=/etc/masterha/app1.cnf</span><br><span class=line>app1 (pid:55707) is running(0:PING_OK), master:192.168.206.201</span><br></pre></td></tr></table></figure><p>注意：如果正常，会显示&quot;PING_OK&quot;，否则会显示&quot;NOT_RUNNING&quot;，这代表MHA监控没有开启。</p><p>定期删除中继日志 在配置主从复制中，slave上设置了参数relay_log_purge=0，所以slave节点需要定期删除中<br>继日志，建议每个slave节点删除中继日志的时间错开。</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>corntab -e</span><br><span class=line>0 5 * * * /usr/local/bin/purge_relay_logs - -user=root --password=pwd123 --port=3306 --disable_relay_log_purge &gt;&gt; /var/log/purge_relay.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure><h3 id=七、配置VIP><a class=header-anchor href=#七、配置VIP>¶</a>七、配置VIP</h3><p>vip配置可以采用两种方式，一种通过keepalived的方式管理虚拟ip的浮动；另外一种通过脚本方式启动虚拟ip<br>的方式（即不需要keepalived或者heartbeat类似的软件）。</p><h4 id=1、keepalived方式管理虚拟ip><a class=header-anchor href=#1、keepalived方式管理虚拟ip>¶</a>1、keepalived方式管理虚拟ip</h4><h5 id=（1）keepalived配置><a class=header-anchor href=#（1）keepalived配置>¶</a>（1）keepalived配置</h5><p>下载软件并在master（192.168.206.201）和备选master（192.168.206.202）上安装软件包keepalived。</p><p>在编译安装Keepalived之前，必须先安装内核开发包kernel-devel以及openssl-devel、popt-devel等支持库。</p><h6 id=1）下载Keepalived><a class=header-anchor href=#1）下载Keepalived>¶</a>1）下载Keepalived</h6><figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>wget https://www.keepalived.org/software/keepalived<span class=literal>-2</span>.<span class=number>0.20</span>.tar.gz</span><br></pre></td></tr></table></figure><h6 id=2）安装依赖库><a class=header-anchor href=#2）安装依赖库>¶</a>2）安装依赖库</h6><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>yum -y install kernel-devel openssl-devel popt-devel gcc</span><br></pre></td></tr></table></figure><h6 id=3）解压><a class=header-anchor href=#3）解压>¶</a>3）解压</h6><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>tar zxf keepalived-2.0.20.tar.gz</span><br></pre></td></tr></table></figure><h6 id=4）安装><a class=header-anchor href=#4）安装>¶</a>4）安装</h6><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>cd keepalived-2.0.20/</span><br><span class=line>./configure --prefix=/ &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h6 id=5）使用keepalived服务><a class=header-anchor href=#5）使用keepalived服务>¶</a>5）使用keepalived服务</h6><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>systemctl enable keepalived</span><br><span class=line>systemctl start keepalived</span><br></pre></td></tr></table></figure><h6 id=6）创建防火墙规则><a class=header-anchor href=#6）创建防火墙规则>¶</a>6）创建防火墙规则</h6><p>若开启了防火墙，需要关闭防火墙或创建规则。</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>firewall-cmd --direct --permanent --add-rule ipv4 filter OUTPUT 0 --in-interface ens33 --destination 224.0.0.18 --protocol vrrp -j ACCEPT</span><br><span class=line></span><br><span class=line>firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface ens33 --destination 224.0.0.18 --protocol vrrp -j ACCEPT</span><br><span class=line></span><br><span class=line>firewall-cmd --reload</span><br></pre></td></tr></table></figure><h5 id=（2）修改Keepalived的配置文件><a class=header-anchor href=#（2）修改Keepalived的配置文件>¶</a>（2）修改Keepalived的配置文件</h5><blockquote><p>vim /etc/keepalived/keepalived.conf</p></blockquote><h6 id=1）在master上配置><a class=header-anchor href=#1）在master上配置>¶</a>1）在master上配置</h6><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre></td><td class=code><pre><span class=line>[root@master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class=line></span><br><span class=line>! Configuration File for keepalived</span><br><span class=line></span><br><span class=line>global_defs &#123;</span><br><span class=line>   router_id mysql-1</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line>vrrp_instance VI_1 &#123;</span><br><span class=line>    state BACKUP</span><br><span class=line>    interface ens33</span><br><span class=line>    virtual_router_id 51</span><br><span class=line>    priority 100</span><br><span class=line>    advert_int 1</span><br><span class=line>    nopreempt</span><br><span class=line>    authentication &#123;</span><br><span class=line>        auth_type PASS</span><br><span class=line>        auth_pass 1111</span><br><span class=line>    &#125;</span><br><span class=line>    virtual_ipaddress &#123;</span><br><span class=line>        192.168.206.100</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h6 id=2）在备选master上配置><a class=header-anchor href=#2）在备选master上配置>¶</a>2）在备选master上配置</h6><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line>! Configuration File for keepalived</span><br><span class=line></span><br><span class=line>global_defs &#123;</span><br><span class=line>   router_id mysql-2	# 此处需要修改</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line>vrrp_instance VI_1 &#123;</span><br><span class=line>    state BACKUP</span><br><span class=line>    interface ens33</span><br><span class=line>    virtual_router_id 51</span><br><span class=line>    priority 50 	# 此处需要修改</span><br><span class=line>    advert_int 1</span><br><span class=line>    nopreempt</span><br><span class=line>    authentication &#123;</span><br><span class=line>        auth_type PASS</span><br><span class=line>        auth_pass 1111</span><br><span class=line>    &#125;</span><br><span class=line>    virtual_ipaddress &#123;</span><br><span class=line>        192.168.206.100</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h6 id=3）在master上启动并查看日志><a class=header-anchor href=#3）在master上启动并查看日志>¶</a>3）在master上启动并查看日志</h6><blockquote><p>注意：需启动keepalived服务</p></blockquote><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre></td><td class=code><pre><span class=line>[root@master keepalived-2.0.20]# systemctl start keepalived.service </span><br><span class=line>[root@master keepalived-2.0.20]# ps -ef | grep keep</span><br><span class=line>gdm        1977   1813  0 03:52 ?        00:00:00 /usr/libexec/gsd-housekeeping</span><br><span class=line>gdm       59162  58971  0 05:51 ?        00:00:00 /usr/libexec/gsd-housekeeping</span><br><span class=line>root     113268      1  0 14:54 ?        00:00:00 //sbin/keepalived -D</span><br><span class=line>root     113270 113268  1 14:54 ?        00:00:00 //sbin/keepalived -D</span><br><span class=line>root     113292  92137  0 14:55 pts/0    00:00:00 grep --color=auto keep</span><br><span class=line></span><br><span class=line>[root@master keepalived-2.0.20]# ip a | grep 100</span><br><span class=line>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class=line>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class=line>    inet 192.168.206.100/32 scope global ens33</span><br><span class=line><span class=meta>#</span><span class=bash> 省略部分输出信息</span></span><br><span class=line></span><br><span class=line>[root@master keepalived-2.0.20]# tail -f /var/log/messages </span><br><span class=line><span class=meta>#</span><span class=bash> 省略部分输出信息</span></span><br><span class=line>Jul  8 14:57:31 master avahi-daemon[740]: Registering new address record for 192.168.206.100 on ens33.IPv4.</span><br><span class=line>Jul  8 14:57:31 master avahi-daemon[740]: Registering new address record for 192.168.206.201 on ens33.IPv4.</span><br><span class=line><span class=meta>#</span><span class=bash> 省略部分输出信息</span></span><br></pre></td></tr></table></figure><p>发现已经将虚拟ip 192.168.206.100绑定了网卡ens33上。</p><h6 id=4）在备选master上启动并查看日志><a class=header-anchor href=#4）在备选master上启动并查看日志>¶</a>4）在备选master上启动并查看日志</h6><p>在另外一台服务器，候选master上启动keepalived服务，并观察</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>[root@slave-master keepalived-2.0.20]# systemctl start keepalived.service </span><br><span class=line></span><br><span class=line>[root@slave-master keepalived-2.0.20]# tail -f /var/log/messages </span><br><span class=line><span class=meta>#</span><span class=bash> 省略部分输出信息</span></span><br><span class=line>Jul  8 15:01:16 slave-master Keepalived_vrrp[111159]: Assigned address 192.168.206.202 for interface ens33</span><br><span class=line><span class=meta>#</span><span class=bash> 省略部分输出信息</span></span><br></pre></td></tr></table></figure><p>从上面的信息可以看到keepalived已经配置成功。</p><p><strong>注意：</strong> 上面两台服务器的keepalived都设置为了BACKUP模式，在keepalived中2种模式，分别是master-backup模式和backup-&gt;backup模式。这两种模式有很大区别。</p><figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>1. 在master-&gt;backup模式下，一旦主库宕机，虚拟ip会自动漂移到从库，当主库修复后，keepalived启动后，还会把虚拟ip抢占过来，即使设置了非抢占模式（nopreempt）抢占ip的动作也会发生。</span><br><span class=line>2. 在backup-&gt;backup模式下，当主库宕机后虚拟ip会自动漂移到从库上，当原主库恢复和keepalived服务启动后，并不会抢占新主的虚拟ip，即使是优先级高于从库的优先级别，也不会发生抢占。</span><br></pre></td></tr></table></figure><p>为了减少ip漂移次数，通常是把修复好的主库当做新的备库。</p><h5 id=（3）MHA引入keepalived><a class=header-anchor href=#（3）MHA引入keepalived>¶</a>（3）MHA引入keepalived</h5><blockquote><p>MySQL服务进程挂掉时通过MHA 停止keepalived</p></blockquote><p>要想把keepalived服务引入MHA，我们只需要修改切换时触发的脚本文件master_ip_failover即可，在该脚本中添加在master发生宕机时对keepalived的处理。</p><p>编辑脚本/scripts/master_ip_failover，修改后如下。</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#</span><span class=bash>!/usr/bin/env perl</span></span><br><span class=line></span><br><span class=line>use strict;</span><br><span class=line>use warnings FATAL =&gt; 'all';</span><br><span class=line></span><br><span class=line>use Getopt::Long;</span><br><span class=line></span><br><span class=line>my (</span><br><span class=line><span class=meta>  $</span><span class=bash><span class=built_in>command</span>,        <span class=variable>$ssh_user</span>,         <span class=variable>$orig_master_host</span>,</span></span><br><span class=line><span class=meta>  $</span><span class=bash>orig_master_ip, <span class=variable>$orig_master_port</span>, <span class=variable>$new_master_host</span>,</span></span><br><span class=line><span class=meta>  $</span><span class=bash>new_master_ip,  <span class=variable>$new_master_port</span>,  <span class=variable>$new_master_user</span>,</span></span><br><span class=line><span class=meta>  $</span><span class=bash>new_master_password</span></span><br><span class=line>);</span><br><span class=line></span><br><span class=line>my $vip="192.168.206.100";</span><br><span class=line>my $ssh_start_vip="systemctl start keepalived.service";</span><br><span class=line>my $ssh_stop_vip="systemctl stop keepalived.service";</span><br><span class=line></span><br><span class=line>GetOptions(</span><br><span class=line>  'command=s'             =&gt; \$command,</span><br><span class=line>  'ssh_user=s'            =&gt; \$ssh_user,</span><br><span class=line>  'orig_master_host=s'    =&gt; \$orig_master_host,</span><br><span class=line>  'orig_master_ip=s'      =&gt; \$orig_master_ip,</span><br><span class=line>  'orig_master_port=i'    =&gt; \$orig_master_port,</span><br><span class=line>  'new_master_host=s'     =&gt; \$new_master_host,</span><br><span class=line>  'new_master_ip=s'       =&gt; \$new_master_ip,</span><br><span class=line>  'new_master_port=i'     =&gt; \$new_master_port,</span><br><span class=line>  'new_master_user=s'     =&gt; \$new_master_user,</span><br><span class=line>  'new_master_password=s' =&gt; \$new_master_password,</span><br><span class=line>);</span><br><span class=line></span><br><span class=line>exit &amp;main();</span><br><span class=line></span><br><span class=line>sub main &#123;</span><br><span class=line></span><br><span class=line>  print "\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n";</span><br><span class=line></span><br><span class=line>  if ( $command eq "stop" || $command eq "stopssh" ) &#123;</span><br><span class=line></span><br><span class=line>    my $exit_code = 1;</span><br><span class=line>    eval &#123;</span><br><span class=line>      print "Disabling the VIP on old master: $orig_master_host \n";</span><br><span class=line>      &amp;stop_vip();</span><br><span class=line>      $exit_code = 0;</span><br><span class=line>    &#125;;</span><br><span class=line>    if ($@) &#123;</span><br><span class=line>      warn "Got Error: $@\n";</span><br><span class=line>      exit $exit_code;</span><br><span class=line>    &#125;</span><br><span class=line>    exit $exit_code;</span><br><span class=line>  &#125;</span><br><span class=line>  elsif ( $command eq "start" ) &#123;</span><br><span class=line></span><br><span class=line>    my $exit_code = 10;</span><br><span class=line>      $exit_code = 0;</span><br><span class=line>    &#125;;</span><br><span class=line>    if ($@) &#123;</span><br><span class=line>      warn $@;</span><br><span class=line>      exit $exit_code;</span><br><span class=line>    &#125;</span><br><span class=line>    exit $exit_code;</span><br><span class=line>    #'ssh $ssh_user\@cluster1 \" $ssh_start_vip \"';</span><br><span class=line>    exit 0;</span><br><span class=line>  &#125;</span><br><span class=line>  else &#123;</span><br><span class=line>    &amp;usage();</span><br><span class=line>    exit 1;</span><br><span class=line>  &#125;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line>sub start_vip()&#123;</span><br><span class=line> `ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line>sub stop_vip()&#123;</span><br><span class=line>  return 0 unless ($ssh_user);</span><br><span class=line> `ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`;</span><br><span class=line>&#125;</span><br><span class=line>  </span><br><span class=line>sub usage &#123;</span><br><span class=line>  print</span><br><span class=line>"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n";</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>现在已经修改这个脚本了，接下来我们在/etc/masterha/app1.cnf 中调用故障切换脚本 停止MHA：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#</span><span class=bash>masterha_stop --conf=/etc/masterha/app1.cnf</span></span><br></pre></td></tr></table></figure><p>在配置文件/etc/masterha/app1.cnf 中启用下面的参数(在[server default下面添加])</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>master_ip_failover_script=/scripts/master_ip_failover</span><br></pre></td></tr></table></figure><h5 id=（4）启动MHA：><a class=header-anchor href=#（4）启动MHA：>¶</a>（4）启动MHA：</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#</span><span class=bash>nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;&gt;/tmp/mha_manager.log &amp;</span></span><br></pre></td></tr></table></figure><h5 id=（5）检查状态><a class=header-anchor href=#（5）检查状态>¶</a>（5）检查状态</h5><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>[root@centos1 ~]# masterha_check_status --conf=/etc/masterha/app1.cnf</span><br><span class=line>app1 (pid:12047) is running(0:PING_OK), master:192.168.206.202</span><br></pre></td></tr></table></figure><p>再检查集群状态，看是否会报错</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre></td><td class=code><pre><span class=line>[root@centos1 ~]# masterha_check_repl --conf=/etc/masterha/app1.cnf</span><br><span class=line>Fri Sep 30 23:05:10 2016 - [info] Slaves settings check done.</span><br><span class=line>Fri Sep 30 23:05:10 2016 - [info]</span><br><span class=line>192.168.1.102(192.168.1.102:3306) (current master)</span><br><span class=line>+--192.168.206.202(192.168.206.202:3306)</span><br><span class=line>+--192.168.206.203(192.168.206.203:3306)</span><br><span class=line></span><br><span class=line>Fri Sep 30 23:05:10 2016 - [info] Checking replication health on 192.168.206.202..</span><br><span class=line>Fri Sep 30 23:05:10 2016 - [info] ok.</span><br><span class=line>Fri Sep 30 23:05:10 2016 - [info] Checking replication health on 192.168.206.203..</span><br><span class=line>Fri Sep 30 23:05:10 2016 - [info] ok.</span><br><span class=line>Fri Sep 30 23:05:10 2016 - [info] Checking master_ip_failover_script status:</span><br><span class=line>Fri Sep 30 23:05:10 2016 - [info] /scripts/master_ip_failover --command=status -</span><br><span class=line>-ssh_user=root --orig_master_host=192.168.206.201 --orig_master_ip=192.168.206.201 --</span><br><span class=line>orig_master_port=3306</span><br><span class=line></span><br><span class=line>Checking the Status of the script.. OK</span><br><span class=line>Fri Sep 30 23:05:10 2016 - [info] OK.</span><br><span class=line>Fri Sep 30 23:05:10 2016 - [warning] shutdown_script is not defined.</span><br><span class=line>Fri Sep 30 23:05:10 2016 - [info] Got exit code 0 (Not master dead).</span><br><span class=line></span><br><span class=line>MySQL Replication Health is OK.</span><br></pre></td></tr></table></figure><h5 id=（6）测试><a class=header-anchor href=#（6）测试>¶</a>（6）测试</h5><p>在master上停掉mysql服务</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#</span><span class=bash> systemctl stop mysqld [ OK ]</span></span><br></pre></td></tr></table></figure><p>到slave(192.168.206.202)查看slave的状态：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line><span class=meta>mysql&gt;</span><span class=bash> show slave status\G</span></span><br><span class=line>*************************** 1. row ***************************</span><br><span class=line>			Slave_IO_State: Waiting for master to send event</span><br><span class=line>				Master_Host: 192.168.206.200</span><br><span class=line>				Master_User: mharep</span><br><span class=line>				Master_Port: 3306</span><br><span class=line>			  Connect_Retry: 60</span><br><span class=line>		Master_Log_File: mysql-bin.000004</span><br><span class=line>			Read_Master_Log_Pos: 154</span><br><span class=line>	  Relay_Log_File: relay-bin.000002</span><br><span class=line>		 Relay_Log_Pos: 320</span><br><span class=line>	Relay_Master_Log_File: mysql-bin.000004</span><br><span class=line>		 Slave_IO_Running: Yes</span><br><span class=line>		 Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure><p>从上图可以看出slave指向了新的master服务器（192.168.206.200） 查看VIP</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre></td><td class=code><pre><span class=line>[root@master1 keepalived]# ip a</span><br><span class=line>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default</span><br><span class=line>qlen 1000</span><br><span class=line>link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class=line>inet 127.0.0.1/8 scope host lo</span><br><span class=line>valid_lft forever preferred_lft forever</span><br><span class=line>inet6 ::1/128 scope host</span><br><span class=line>valid_lft forever preferred_lft forever</span><br><span class=line>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP</span><br><span class=line>group default qlen 1000</span><br><span class=line>link/ether 00:0c:29:ce:ea:e9 brd ff:ff:ff:ff:ff:ff</span><br><span class=line>inet 192.168.206.200/24 brd 192.168.206.255 scope global noprefixroute ens33</span><br><span class=line>valid_lft forever preferred_lft forever</span><br><span class=line>inet 192.168.206.100/24 brd 192.168.206.255 scope global secondary ens33:0</span><br><span class=line>valid_lft forever preferred_lft forever</span><br><span class=line>inet6 fe80::8afe:8575:3294:65a2/64 scope link tentative noprefixroute</span><br><span class=line>dadfailed</span><br><span class=line>valid_lft forever preferred_lft forever</span><br><span class=line>inet6 fe80::1d3d:dd62:8adb:c689/64 scope link tentative noprefixroute</span><br><span class=line>dadfailed</span><br><span class=line>valid_lft forever preferred_lft forever</span><br><span class=line>inet6 fe80::77a5:d0c0:a955:c7f3/64 scope link noprefixroute</span><br><span class=line>valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>从上图可以看到master2(原来的master)释放了VIP，master1(新的master)接管了VIP地址 主从切换后续工作 主库切换后，把原主库修复成新从库，相关操作请参考前面相关操作。 为了防止脑裂发生，推荐生产环境采用脚本的方式来管理虚拟ip，而不是使用keepalived来完成。到此为止，基本MHA集群已经配置完毕</p><h5 id=（7）总结><a class=header-anchor href=#（7）总结>¶</a>（7）总结</h5><blockquote><p>MHA软件由两部分组成，Manager工具包和Node工具包，具体的说明如下。 Manager工具包主要包括以下几个工具： masterha_check_ssh 检查MHA的SSH配置状况 masterha_check_repl 检查MySQL复制状况masterha_manger 启动MHA masterha_check_status 检测当前MHA运行状态masterha_master_monitor 检测master是否宕机 masterha_master_switch 控制故障转移（自动或者手动） masterha_conf_host 添加或删除置的server信息Node工具包（这些工具通常由MHA Manager的脚本触发，无需人为操作）主要包括以下几个工具： save_binary_logs 保存和复制master的二进制日志 apply_diff_relay_logs 识别差异的中继日志事件并将其差异的事件应用于其他的slave filter_mysqlbinlog 去除不必要的ROLLBACK事件（MHA已不再使用这个工具）purge_relay_logs 清除中继日志（不会阻塞SQL线程）</p></blockquote><h5 id=（8）mysql必备技能掌握><a class=header-anchor href=#（8）mysql必备技能掌握>¶</a>（8）mysql必备技能掌握</h5><figure class=highlight><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre></td><td class=code><pre><span class=line>1、MySQL架构:对mysql的架构，整体有个印象，才能不断的加深对mysql的理解和后继的学习。 </span><br><span class=line></span><br><span class=line>2、用各种姿势备份MySQL数据库 数据备份是DBA或运维工程师日常工作之一，如果让你来备份，你会用什么方式备份，在时间时间备份，使用什么策略备份 </span><br><span class=line></span><br><span class=line>3、mysql主从复制及读写分离 mysql的主从复制及读写分离是DBA必备技能之一 </span><br><span class=line></span><br><span class=line>4、MySQL/MariaDB数据库基于SSL实现主从复制 加强主从复制的安全性 </span><br><span class=line></span><br><span class=line>5、MySQL高可用 数据的高可用如何保证 </span><br><span class=line></span><br><span class=line>6、数据库Sharding的基本思想和切分策略 随着数据量的不断攀升，从性能和可维护的角度，需要进行一些Sharding，也就是数据库的切分，有垂直切分和水平切分 </span><br><span class=line></span><br><span class=line>7、MySQL/MariaDB 性能调整和优化技巧 掌握优化思路和技巧，对数据库的不断优化是一项长期工程</span><br></pre></td></tr></table></figure></div><div><ul class=post-copyright><li class=post-copyright-author><strong>本文作者：</strong>Maisy</li><li class=post-copyright-link><strong>本文链接：</strong> <a href=https://pdxblog.top/MySQL-MHA%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88.html title=MySQL-MHA高可用方案>https://pdxblog.top/MySQL-MHA高可用方案.html</a></li><li class=post-copyright-license><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel=noopener target=_blank><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class=post-footer><div class=post-tags><a href="/tags/MySQL/" rel=tag># MySQL</a></div><div class=post-nav><div class=post-nav-item><a href=/MySQL%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2.html rel=prev title=MySQL高级查询><i class="fa fa-chevron-left"></i> MySQL高级查询</a></div><div class=post-nav-item><a href=/MySQL%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C.html rel=next title=MySQL基本操作>MySQL基本操作 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class=nav><li class="nav-item nav-level-2"><a class=nav-link href=#MySQL-MHA高可用方案><span class=nav-number>1.</span> <span class=nav-text>¶MySQL-MHA高可用方案</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#一、MHA简介><span class=nav-number>1.1.</span> <span class=nav-text>¶一、MHA简介</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、异步复制（Asynchronous-replication）><span class=nav-number>1.1.1.</span> <span class=nav-text>¶1、异步复制（Asynchronous replication）</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、全同步复制（Fully-synchronous-replication）><span class=nav-number>1.1.2.</span> <span class=nav-text>¶2、全同步复制（Fully synchronous replication）</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#3、半同步复制（Semisynchronous-replication）><span class=nav-number>1.1.3.</span> <span class=nav-text>¶3、半同步复制（Semisynchronous replication）</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#4、异步与半同步异同><span class=nav-number>1.1.4.</span> <span class=nav-text>¶4、异步与半同步异同</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#5、MHA工作原理><span class=nav-number>1.1.5.</span> <span class=nav-text>¶5、MHA工作原理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class=nav-link href=#二、搭建实验环境><span class=nav-number>1.2.</span> <span class=nav-text>¶二、搭建实验环境</span></a></li><li class="nav-item nav-level-3"><a class=nav-link href=#三、基础环境准备><span class=nav-number>1.3.</span> <span class=nav-text>¶三、基础环境准备</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、基础配置><span class=nav-number>1.3.1.</span> <span class=nav-text>¶1、基础配置</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、-在4台机器都配置epel源><span class=nav-number>1.3.2.</span> <span class=nav-text>¶2、 在4台机器都配置epel源</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#3、建立ssh无交互登录环境><span class=nav-number>1.3.3.</span> <span class=nav-text>¶3、建立ssh无交互登录环境</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）Manager主机><span class=nav-number>1.3.3.1.</span> <span class=nav-text>¶（1）Manager主机</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）Candidate-master主机><span class=nav-number>1.3.3.2.</span> <span class=nav-text>¶（2）Candidate master主机</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（3）master主机><span class=nav-number>1.3.3.3.</span> <span class=nav-text>¶（3）master主机</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（4）slave主机><span class=nav-number>1.3.3.4.</span> <span class=nav-text>¶（4）slave主机</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#4、测试ssh无交互登录><span class=nav-number>1.3.4.</span> <span class=nav-text>¶4、测试ssh无交互登录</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#5、配置hosts环境><span class=nav-number>1.3.5.</span> <span class=nav-text>¶5、配置hosts环境</span></a></li></ol></li><li class="nav-item nav-level-3"><a class=nav-link href=#四、配置mysql半同步复制><span class=nav-number>1.4.</span> <span class=nav-text>¶四、配置mysql半同步复制</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、主从节点安装插件><span class=nav-number>1.4.1.</span> <span class=nav-text>¶1、主从节点安装插件</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）分别在主从节点上安装相关的插件><span class=nav-number>1.4.1.1.</span> <span class=nav-text>¶（1）分别在主从节点上安装相关的插件</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）检查Plugin是否已正确安装><span class=nav-number>1.4.1.2.</span> <span class=nav-text>¶（2）检查Plugin是否已正确安装</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（3）查看半同步相关信息><span class=nav-number>1.4.1.3.</span> <span class=nav-text>¶（3）查看半同步相关信息</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、修改my-cnf文件><span class=nav-number>1.4.2.</span> <span class=nav-text>¶2、修改my.cnf文件</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）master主机><span class=nav-number>1.4.2.1.</span> <span class=nav-text>¶（1）master主机</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）Candidate-master主机-v2><span class=nav-number>1.4.2.2.</span> <span class=nav-text>¶（2）Candidate master主机</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（3）slave主机><span class=nav-number>1.4.2.3.</span> <span class=nav-text>¶（3）slave主机</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（4）查看半同步相关信息><span class=nav-number>1.4.2.4.</span> <span class=nav-text>¶（4）查看半同步相关信息</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（5）查看半同步状态><span class=nav-number>1.4.2.5.</span> <span class=nav-text>¶（5）查看半同步状态</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#3、配置主从同步><span class=nav-number>1.4.3.</span> <span class=nav-text>¶3、配置主从同步</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）master主机-v2><span class=nav-number>1.4.3.1.</span> <span class=nav-text>¶（1）master主机</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）Candidate-master主机-v3><span class=nav-number>1.4.3.2.</span> <span class=nav-text>¶（2）Candidate master主机</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（3）slave主机-v2><span class=nav-number>1.4.3.3.</span> <span class=nav-text>¶（3）slave主机</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（4）查看master服务器的半同步状态><span class=nav-number>1.4.3.4.</span> <span class=nav-text>¶（4）查看master服务器的半同步状态</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class=nav-link href=#五、配置mysql-mha><span class=nav-number>1.5.</span> <span class=nav-text>¶五、配置mysql-mha</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、-在所有主机上安装mha所依赖的软件包><span class=nav-number>1.5.1.</span> <span class=nav-text>¶1、 在所有主机上安装mha所依赖的软件包</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、-安装mha4mysql-node><span class=nav-number>1.5.2.</span> <span class=nav-text>¶2、 安装mha4mysql-node</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#3、安装mha4mysql-manager><span class=nav-number>1.5.3.</span> <span class=nav-text>¶3、安装mha4mysql-manager</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#4、配置mha><span class=nav-number>1.5.4.</span> <span class=nav-text>¶4、配置mha</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）编辑mha配置文件><span class=nav-number>1.5.4.1.</span> <span class=nav-text>¶（1）编辑mha配置文件</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）配关配置项的解释><span class=nav-number>1.5.4.2.</span> <span class=nav-text>¶（2）配关配置项的解释</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（3）SSH-有效性验证><span class=nav-number>1.5.4.3.</span> <span class=nav-text>¶（3）SSH 有效性验证</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（4）集群复制的有效性验证><span class=nav-number>1.5.4.4.</span> <span class=nav-text>¶（4）集群复制的有效性验证</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（5）启动-manager><span class=nav-number>1.5.4.5.</span> <span class=nav-text>¶（5）启动 manager</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（6）状态检查><span class=nav-number>1.5.4.6.</span> <span class=nav-text>¶（6）状态检查</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（7）故障转移验证-自动failover><span class=nav-number>1.5.4.7.</span> <span class=nav-text>¶（7）故障转移验证(自动failover)</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#1）停掉-master><span class=nav-number>1.5.4.7.1.</span> <span class=nav-text>¶1）停掉 master</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#2）查看-MHA-日志><span class=nav-number>1.5.4.7.2.</span> <span class=nav-text>¶2）查看 MHA 日志</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#3）检查-slave的复制><span class=nav-number>1.5.4.7.3.</span> <span class=nav-text>¶3）检查 slave的复制</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class=nav-link href=#六、MHA-Manager端日常主要操作步骤><span class=nav-number>1.6.</span> <span class=nav-text>¶六、MHA Manager端日常主要操作步骤</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、检查是否有下列文件，有则删除。><span class=nav-number>1.6.1.</span> <span class=nav-text>¶1、检查是否有下列文件，有则删除。</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#2、检查MHA复制检查><span class=nav-number>1.6.2.</span> <span class=nav-text>¶2、检查MHA复制检查</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）查看candidate的从服务器（192-168-206-202）的二进制日志><span class=nav-number>1.6.2.1.</span> <span class=nav-text>¶（1）查看candidate的从服务器（192.168.206.202）的二进制日志</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）将master服务器设置为candidate的从服务器><span class=nav-number>1.6.2.2.</span> <span class=nav-text>¶（2）将master服务器设置为candidate的从服务器</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#3、停止MHA><span class=nav-number>1.6.3.</span> <span class=nav-text>¶3、停止MHA</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#4、启动MHA><span class=nav-number>1.6.4.</span> <span class=nav-text>¶4、启动MHA</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#5、检查状态><span class=nav-number>1.6.5.</span> <span class=nav-text>¶5、检查状态</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#6、检查日志><span class=nav-number>1.6.6.</span> <span class=nav-text>¶6、检查日志</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#7、主从切换后续工作><span class=nav-number>1.6.7.</span> <span class=nav-text>¶7、主从切换后续工作</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）重构><span class=nav-number>1.6.7.1.</span> <span class=nav-text>¶（1）重构</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）重构的两种方案><span class=nav-number>1.6.7.2.</span> <span class=nav-text>¶（2）重构的两种方案</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class=nav-link href=#七、配置VIP><span class=nav-number>1.7.</span> <span class=nav-text>¶七、配置VIP</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#1、keepalived方式管理虚拟ip><span class=nav-number>1.7.1.</span> <span class=nav-text>¶1、keepalived方式管理虚拟ip</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#（1）keepalived配置><span class=nav-number>1.7.1.1.</span> <span class=nav-text>¶（1）keepalived配置</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#1）下载Keepalived><span class=nav-number>1.7.1.1.1.</span> <span class=nav-text>¶1）下载Keepalived</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#2）安装依赖库><span class=nav-number>1.7.1.1.2.</span> <span class=nav-text>¶2）安装依赖库</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#3）解压><span class=nav-number>1.7.1.1.3.</span> <span class=nav-text>¶3）解压</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#4）安装><span class=nav-number>1.7.1.1.4.</span> <span class=nav-text>¶4）安装</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#5）使用keepalived服务><span class=nav-number>1.7.1.1.5.</span> <span class=nav-text>¶5）使用keepalived服务</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#6）创建防火墙规则><span class=nav-number>1.7.1.1.6.</span> <span class=nav-text>¶6）创建防火墙规则</span></a></li></ol></li><li class="nav-item nav-level-5"><a class=nav-link href=#（2）修改Keepalived的配置文件><span class=nav-number>1.7.1.2.</span> <span class=nav-text>¶（2）修改Keepalived的配置文件</span></a><ol class=nav-child><li class="nav-item nav-level-6"><a class=nav-link href=#1）在master上配置><span class=nav-number>1.7.1.2.1.</span> <span class=nav-text>¶1）在master上配置</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#2）在备选master上配置><span class=nav-number>1.7.1.2.2.</span> <span class=nav-text>¶2）在备选master上配置</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#3）在master上启动并查看日志><span class=nav-number>1.7.1.2.3.</span> <span class=nav-text>¶3）在master上启动并查看日志</span></a></li><li class="nav-item nav-level-6"><a class=nav-link href=#4）在备选master上启动并查看日志><span class=nav-number>1.7.1.2.4.</span> <span class=nav-text>¶4）在备选master上启动并查看日志</span></a></li></ol></li><li class="nav-item nav-level-5"><a class=nav-link href=#（3）MHA引入keepalived><span class=nav-number>1.7.1.3.</span> <span class=nav-text>¶（3）MHA引入keepalived</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（4）启动MHA：><span class=nav-number>1.7.1.4.</span> <span class=nav-text>¶（4）启动MHA：</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（5）检查状态><span class=nav-number>1.7.1.5.</span> <span class=nav-text>¶（5）检查状态</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（6）测试><span class=nav-number>1.7.1.6.</span> <span class=nav-text>¶（6）测试</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（7）总结><span class=nav-number>1.7.1.7.</span> <span class=nav-text>¶（7）总结</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#（8）mysql必备技能掌握><span class=nav-number>1.7.1.8.</span> <span class=nav-text>¶（8）mysql必备技能掌握</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Maisy src=/images/author.jpg><p class=site-author-name itemprop=name>Maisy</p><div class=site-description itemprop=description>人的一生就是一个储蓄的过程，在奋斗的时候储存了希望；在耕耘的时候储存了一粒种子；在旅行的时候储存了风景；在微笑的时候储存了快乐。聪明的人善于储蓄，在漫长而短暂的人生旅途中，学会储蓄每一个闪光的瞬间，然后用它们酿成一杯美好的回忆，在四季的变幻与交替之间，散发浓香，珍藏一生</div></div><div class="site-state-wrap motion-element"><nav class=site-state><div class="site-state-item site-state-posts"><a href="/archives/"><span class=site-state-item-count>69</span> <span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class=site-state-item-count>7</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class=site-state-item-count>7</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/Gilbert2/Gilbert2.github.io title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Gilbert2&#x2F;Gilbert2.github.io" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a></span> <span class=links-of-author-item><a href=https://blog.csdn.net/weixin_45636702 title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_45636702" rel=noopener target=_blank><i class="fab fa-crosshairs fa-fw"></i>CSDN</a></span></div><div class="cc-license motion-element" itemprop=license><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class=cc-opacity rel=noopener target=_blank><img src=/images/cc-by-nc-sa.svg alt="Creative Commons"></a></div></div></div></aside><div id=sidebar-dimmer></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy; 2019 – <span itemprop=copyrightYear>2020</span> <span class=with-love><i class="fa fa-heart"></i></span> <span class=author itemprop=copyrightHolder>Maisy</span> <span class=post-meta-divider>|</span> <span class=post-meta-item-icon><i class="fa fa-chart-area"></i></span> <span class=post-meta-item-text>站点总字数：</span> <span title=站点总字数>572k</span> <span class=post-meta-divider>|</span> <span class=post-meta-item-icon><i class="fa fa-coffee"></i></span> <span class=post-meta-item-text>站点阅读时长 &asymp;</span> <span title=站点阅读时长>8:40</span></div><div class=powered-by>由 <a href="https://hexo.io/" class=theme-link rel=noopener target=_blank>Hexo</a> & <a href="https://muse.theme-next.org/" class=theme-link rel=noopener target=_blank>NexT.Muse</a> 强力驱动</div></div></footer></div><script src=/lib/anime.min.js></script><script src=//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js></script><script src=//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js></script><script src=//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js></script><script src=/lib/velocity/velocity.min.js></script><script src=/lib/velocity/velocity.ui.min.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/schemes/muse.js></script><script src=/js/next-boot.js></script><script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script></body></html>